{
  for (  Map.Entry<Object,DiffSets<Long>> entry : referenceCount.entrySet()) {
    Object value=entry.getKey();
    int delta=entry.getValue().delta();
    if (delta > 1) {
      throw new DuplicateIndexEntryConflictException(value,asSet(entry.getValue().getAdded()));
    }
    if (delta == 1) {
      Long addedNode=single(entry.getValue().getAdded());
      Long existingNode=lookup.currentlyIndexedNode(value);
      if (existingNode != null && !addedNode.equals(existingNode)) {
        throw new PreexistingIndexEntryConflictException(value,existingNode,addedNode);
      }
    }
  }
  flushUpdates(updates);
}
