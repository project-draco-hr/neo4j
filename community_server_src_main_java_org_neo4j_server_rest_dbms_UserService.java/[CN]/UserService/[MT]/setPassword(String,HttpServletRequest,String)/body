{
  if (!req.getUserPrincipal().getName().equals(username)) {
    return output.notFound();
  }
  final Map<String,Object> deserialized;
  try {
    deserialized=input.readMap(payload);
  }
 catch (  BadInputException e) {
    return output.response(BAD_REQUEST,new ExceptionRepresentation(new Neo4jError(Status.Request.InvalidFormat,e.getMessage())));
  }
  Object o=deserialized.get(PASSWORD);
  if (o == null) {
    return output.response(UNPROCESSABLE,new ExceptionRepresentation(new Neo4jError(Status.Request.InvalidFormat,String.format("Required parameter '%s' is missing.",PASSWORD))));
  }
  if (!(o instanceof String)) {
    return output.response(UNPROCESSABLE,new ExceptionRepresentation(new Neo4jError(Status.Request.InvalidFormat,String.format("Expected '%s' to be a string.",PASSWORD))));
  }
  String newPassword=(String)o;
  final User currentUser=authManager.getUser(username);
  if (currentUser == null) {
    return output.notFound();
  }
  if (currentUser.credentials().matchesPassword(newPassword)) {
    return output.response(UNPROCESSABLE,new ExceptionRepresentation(new Neo4jError(Status.Request.Invalid,"Old password and new password cannot be the same.")));
  }
  final User updatedUser;
  try {
    updatedUser=authManager.setPassword(username,newPassword);
  }
 catch (  IOException e) {
    return output.serverErrorWithoutLegacyStacktrace(e);
  }
  if (updatedUser == null) {
    return output.notFound();
  }
  return output.ok();
}
