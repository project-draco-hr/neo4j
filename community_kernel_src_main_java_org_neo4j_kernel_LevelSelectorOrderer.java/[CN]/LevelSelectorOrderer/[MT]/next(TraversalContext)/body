{
  TraversalBranch branch=nextBranchFromCurrentSelector(metadata,false);
  Pair<AtomicInteger,TraversalBranch[]> state=getStateForCurrentSelector();
  AtomicInteger previousDepth=state.first();
  if (branch != null && branch.length() == previousDepth.get()) {
    return branch;
  }
 else {
    if (branch != null)     totalDepth.set(currentSide(),branch.length());
    if ((stopDescentOnResult && metadata.getNumberOfPathsReturned() > 0) || totalDepth.get() > maxDepth + 1) {
      nextSelector();
      return null;
    }
    if (branch != null) {
      previousDepth.set(branch.length());
      state.other()[0]=branch;
    }
    BranchSelector otherSelector=nextSelector();
    Pair<AtomicInteger,TraversalBranch[]> otherState=getStateForCurrentSelector();
    TraversalBranch otherBranch=otherState.other()[0];
    if (otherBranch != null) {
      otherState.other()[0]=null;
      return otherBranch;
    }
    otherBranch=otherSelector.next(metadata);
    return otherBranch != null ? otherBranch : branch;
  }
}
