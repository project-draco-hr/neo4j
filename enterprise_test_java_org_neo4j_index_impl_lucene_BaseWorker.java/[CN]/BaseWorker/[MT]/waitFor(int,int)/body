{
  int retries=0;
  while (!threadState.compareAndSet(expectedState,newState) && retries++ < 100) {
    try {
      Thread.sleep(10);
    }
 catch (    InterruptedException e) {
      throw new RuntimeException(e);
    }
  }
  if (retries > 300) {
    throw new IllegalStateException("Something didn't finish in a timely manner. Aborting...");
  }
}
