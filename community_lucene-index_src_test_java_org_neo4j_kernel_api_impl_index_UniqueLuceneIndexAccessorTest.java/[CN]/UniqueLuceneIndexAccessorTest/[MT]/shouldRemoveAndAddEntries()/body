{
  PartitionedIndexStorage indexStorage=getIndexStorage();
  UniqueLuceneIndexAccessor accessor=createAccessor(indexStorage);
  updateAndCommit(accessor,asList(add(1l,"value1")));
  updateAndCommit(accessor,asList(add(2l,"value2")));
  updateAndCommit(accessor,asList(add(3l,"value3")));
  updateAndCommit(accessor,asList(add(4l,"value4")));
  updateAndCommit(accessor,asList(remove(1l,"value1")));
  updateAndCommit(accessor,asList(remove(2l,"value2")));
  updateAndCommit(accessor,asList(remove(3l,"value3")));
  updateAndCommit(accessor,asList(add(1l,"value1")));
  updateAndCommit(accessor,asList(add(3l,"value3b")));
  accessor.close();
  assertEquals(asList(1l),getAllNodes(indexStorage,"value1"));
  assertEquals(emptyListOf(Long.class),getAllNodes(indexStorage,"value2"));
  assertEquals(emptyListOf(Long.class),getAllNodes(indexStorage,"value3"));
  assertEquals(asList(3l),getAllNodes(indexStorage,"value3b"));
  assertEquals(asList(4l),getAllNodes(indexStorage,"value4"));
}
