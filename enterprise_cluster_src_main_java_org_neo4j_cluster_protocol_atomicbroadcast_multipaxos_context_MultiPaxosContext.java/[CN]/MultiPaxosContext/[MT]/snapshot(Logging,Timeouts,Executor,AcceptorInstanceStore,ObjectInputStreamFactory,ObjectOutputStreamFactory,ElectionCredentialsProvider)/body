{
  CommonContextState commonStateSnapshot=commonState.snapshot(logging.getMessagesLog(ClusterConfiguration.class));
  PaxosInstanceStore paxosInstancesSnapshot=paxosInstances.snapshot();
  HeartbeatContextImpl snapshotHeartbeatContext=heartbeatContext.snapshot(commonStateSnapshot,logging,timeouts,executor);
  LearnerContextImpl snapshotLearnerContext=learnerContext.snapshot(commonStateSnapshot,logging,timeouts,paxosInstancesSnapshot,instanceStore,objectInputStreamFactory,objectOutputStreamFactory,snapshotHeartbeatContext);
  ClusterContextImpl snapshotClusterContext=clusterContext.snapshot(commonStateSnapshot,logging,timeouts,executor,objectOutputStreamFactory,objectInputStreamFactory,snapshotLearnerContext,snapshotHeartbeatContext);
  ElectionContextImpl snapshotElectionContext=electionContext.snapshot(commonStateSnapshot,logging,timeouts,snapshotClusterContext,snapshotHeartbeatContext,electionCredentialsProvider);
  ProposerContextImpl snapshotProposerContext=proposerContext.snapshot(commonStateSnapshot,logging,timeouts,paxosInstancesSnapshot);
  AcceptorContextImpl snapshotAcceptorContext=acceptorContext.snapshot(commonStateSnapshot,logging,timeouts,instanceStore);
  AtomicBroadcastContextImpl snapshotAtomicBroadcastContext=atomicBroadcastContext.snapshot(commonStateSnapshot,logging,timeouts,executor,snapshotHeartbeatContext);
  snapshotHeartbeatContext.setCircularDependencies(snapshotClusterContext,snapshotLearnerContext);
  return new MultiPaxosContext(snapshotProposerContext,snapshotAcceptorContext,snapshotLearnerContext,snapshotHeartbeatContext,snapshotElectionContext,snapshotAtomicBroadcastContext,commonStateSnapshot,paxosInstancesSnapshot,snapshotClusterContext);
}
