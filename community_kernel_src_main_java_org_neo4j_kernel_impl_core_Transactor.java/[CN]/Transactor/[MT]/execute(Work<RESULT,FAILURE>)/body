{
  Transaction previousTransaction=suspendTransaction();
  try {
    beginTransaction();
    KernelTransaction tx=persistenceManager.currentKernelTransaction();
    boolean success=false;
    try {
      RESULT result;
      try (Statement statement=tx.acquireStatement()){
        result=work.perform(statement);
      }
       success=true;
      return result;
    }
  finally {
      if (success) {
        txManager.commit();
      }
 else {
        txManager.rollback();
      }
    }
  }
 catch (  HeuristicMixedException|RollbackException|HeuristicRollbackException|SystemException|TransactionalException failure) {
    previousTransaction=null;
    throw new TransactionFailureException(failure);
  }
 finally {
    if (previousTransaction != null) {
      resumeTransaction(previousTransaction);
    }
  }
}
