{
  V currentValue=get(key);
  if (currentValue == null) {
    lock.writeLock().lock();
    try {
      V lockedValue=(V)state.get(key);
      if (lockedValue == null) {
        V newValue=creator.apply(key);
        state.put(key,newValue);
        return newValue;
      }
 else       return lockedValue;
    }
  finally {
      lock.writeLock().unlock();
    }
  }
 else   return currentValue;
}
