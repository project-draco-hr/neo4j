{
  GraphDatabaseQueryService graph=mock(GraphDatabaseQueryService.class);
  InternalTransaction initialTransaction=mock(InternalTransaction.class);
  KernelTransaction initialKTX=mock(KernelTransaction.class);
  KernelTransaction.Type transactionType=null;
  AccessMode transactionMode=null;
  Statement initialStatement=mock(Statement.class);
  QueryRegistryOperations initialQueryRegistry=mock(QueryRegistryOperations.class);
  ExecutingQuery executingQuery=mock(ExecutingQuery.class);
  PropertyContainerLocker locker=null;
  ThreadToStatementContextBridge txBridge=mock(ThreadToStatementContextBridge.class);
  DbmsOperations.Factory dbmsOperationsFactory=null;
  KernelTransaction secondKTX=mock(KernelTransaction.class);
  InternalTransaction secondTransaction=mock(InternalTransaction.class);
  Statement secondStatement=mock(Statement.class);
  QueryRegistryOperations secondQueryRegistry=mock(QueryRegistryOperations.class);
  when(executingQuery.queryText()).thenReturn("X");
  when(executingQuery.queryParameters()).thenReturn(Collections.emptyMap());
  Mockito.doThrow(RuntimeException.class).when(initialTransaction).close();
  when(initialStatement.queryRegistration()).thenReturn(initialQueryRegistry);
  when(graph.beginTransaction(transactionType,transactionMode)).thenReturn(secondTransaction);
  when(txBridge.getKernelTransactionBoundToThisThread(true)).thenReturn(initialKTX,secondKTX);
  when(txBridge.get()).thenReturn(secondStatement);
  when(secondStatement.queryRegistration()).thenReturn(secondQueryRegistry);
  Neo4jTransactionalContext context=new Neo4jTransactionalContext(graph,initialTransaction,transactionType,transactionMode,initialStatement,executingQuery,locker,txBridge,dbmsOperationsFactory,guard);
  try {
    context.commitAndRestartTx();
    throw new AssertionError("Expected RuntimeException to be thrown");
  }
 catch (  RuntimeException e) {
    Object[] mocks={txBridge,initialTransaction,initialQueryRegistry,initialKTX,secondQueryRegistry,secondKTX,secondTransaction};
    InOrder order=Mockito.inOrder(mocks);
    order.verify(txBridge).getKernelTransactionBoundToThisThread(true);
    order.verify(txBridge).unbindTransactionFromCurrentThread();
    order.verify(txBridge).get();
    order.verify(secondQueryRegistry).registerExecutingQuery(executingQuery);
    order.verify(txBridge).getKernelTransactionBoundToThisThread(true);
    order.verify(txBridge).unbindTransactionFromCurrentThread();
    order.verify(txBridge).bindTransactionToCurrentThread(initialKTX);
    order.verify(initialQueryRegistry).unregisterExecutingQuery(executingQuery);
    order.verify(initialTransaction).success();
    order.verify(initialTransaction).close();
    order.verify(txBridge).bindTransactionToCurrentThread(secondKTX);
    order.verify(secondTransaction).failure();
    order.verify(secondTransaction).close();
    order.verify(txBridge).unbindTransactionFromCurrentThread();
    verifyNoMoreInteractions(mocks);
  }
}
