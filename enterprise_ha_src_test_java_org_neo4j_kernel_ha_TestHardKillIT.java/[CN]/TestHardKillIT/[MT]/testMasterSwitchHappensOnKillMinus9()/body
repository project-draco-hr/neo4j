{
  Process proc=null;
  try {
    proc=run("1");
    Thread.sleep(12000);
    HighlyAvailableGraphDatabase dbWithId2=startDb(2);
    HighlyAvailableGraphDatabase dbWithId3=startDb(3);
    assertTrue(!dbWithId2.isMaster());
    assertTrue(!dbWithId3.isMaster());
    proc.destroy();
    proc=null;
    Thread.sleep(60000);
    assertTrue(dbWithId2.isMaster());
    assertTrue(!dbWithId3.isMaster());
    HighlyAvailableGraphDatabase oldMaster=startDb(1);
    long oldMasterNode=createNamedNode(oldMaster,"Old master");
    assertEquals(oldMasterNode,getNamedNode(dbWithId2,"Old master"));
  }
  finally {
    if (proc != null) {
      proc.destroy();
    }
  }
}
