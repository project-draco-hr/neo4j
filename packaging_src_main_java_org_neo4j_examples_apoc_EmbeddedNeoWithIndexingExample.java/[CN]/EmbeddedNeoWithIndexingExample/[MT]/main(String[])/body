{
  neo=new EmbeddedNeo(NEO_DB_PATH);
  indexService=new LuceneIndexService(neo);
  registerShutdownHookForNeoAndIndexService();
  Transaction tx=neo.beginTx();
  try {
    Node usersReferenceNode=neo.createNode();
    neo.getReferenceNode().createRelationshipTo(usersReferenceNode,RelTypes.USERS_REFERENCE);
    for (int id=0; id < 100; id++) {
      Node userNode=createAndIndexUser(formUserName(id));
      usersReferenceNode.createRelationshipTo(userNode,RelTypes.USER);
    }
    System.out.println("Users created");
    int idToFind=45;
    Node foundUser=indexService.getSingleNode(USERNAME_KEY,formUserName(idToFind));
    System.out.println("The username of user " + idToFind + " is "+ foundUser.getProperty(USERNAME_KEY));
    for (    Relationship relationship : usersReferenceNode.getRelationships(RelTypes.USER,Direction.OUTGOING)) {
      Node user=relationship.getEndNode();
      indexService.removeIndex(user,USERNAME_KEY,user.getProperty(USERNAME_KEY));
      user.delete();
      relationship.delete();
    }
    usersReferenceNode.getSingleRelationship(RelTypes.USERS_REFERENCE,Direction.INCOMING).delete();
    usersReferenceNode.delete();
    tx.success();
  }
  finally {
    tx.finish();
  }
  System.out.println("Shutting down...");
  shutdown();
}
