{
  ChannelBuffer buffer=(ChannelBuffer)e.getMessage();
  while (buffer.readable()) {
    if (state == null) {
      state=new ReadInteger(2){
        @Override ReaderState done(        long value){
          return new ReadMessage((int)value);
        }
      }
;
    }
 else {
      Response<?> response=state.read(buffer);
      if (response != null) {
        state=null;
        ctx.sendUpstream(new UpstreamMessageEvent(e.getChannel(),response,e.getRemoteAddress()));
      }
    }
  }
}
