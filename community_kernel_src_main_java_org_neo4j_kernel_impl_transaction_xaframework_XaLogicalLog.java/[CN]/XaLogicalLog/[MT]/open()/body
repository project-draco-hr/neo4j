{
  String activeFileName=fileName + ".active";
  if (!new File(activeFileName).exists()) {
    if (new File(fileName).exists()) {
      open(fileName);
    }
 else {
      open(getLog1FileName());
      setActiveLog(LOG1);
    }
  }
 else {
    FileChannel fc=new RandomAccessFile(activeFileName,"rw").getChannel();
    byte bytes[]=new byte[256];
    ByteBuffer buf=ByteBuffer.wrap(bytes);
    int read=fc.read(buf);
    fc.close();
    if (read != 4) {
      throw new IllegalStateException("Read " + read + " bytes from "+ activeFileName+ " but expected 4");
    }
    buf.flip();
    char c=buf.asCharBuffer().get();
    if (c == CLEAN) {
      String newLog=getLog1FileName();
      File file=new File(newLog);
      if (file.exists()) {
        renameLogFileToRightVersion(getLog1FileName(),file.length());
      }
      file=new File(getLog2FileName());
      if (file.exists()) {
        renameLogFileToRightVersion(getLog2FileName(),file.length());
      }
      open(newLog);
      setActiveLog(LOG1);
    }
 else     if (c == LOG1) {
      String newLog=getLog1FileName();
      if (!new File(newLog).exists()) {
        throw new IllegalStateException("Active marked as 1 but no " + newLog + " exist");
      }
      File otherLog=new File(getLog2FileName());
      if (otherLog.exists()) {
        fixDualLogFiles(getLog1FileName(),getLog2FileName());
      }
      currentLog=LOG1;
      open(newLog);
    }
 else     if (c == LOG2) {
      String newLog=getLog2FileName();
      if (!new File(newLog).exists()) {
        throw new IllegalStateException("Active marked as 2 but no " + newLog + " exist");
      }
      File otherLog=new File(getLog1FileName());
      if (otherLog.exists()) {
        fixDualLogFiles(getLog2FileName(),getLog1FileName());
      }
      currentLog=LOG2;
      open(newLog);
    }
 else {
      throw new IllegalStateException("Unknown active log: " + c);
    }
  }
  instantiateCorrectWriteBuffer();
}
