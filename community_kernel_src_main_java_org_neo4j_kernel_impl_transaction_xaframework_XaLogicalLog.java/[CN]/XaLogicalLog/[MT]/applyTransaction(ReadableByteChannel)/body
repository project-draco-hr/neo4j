{
  long logEntriesFound=0;
  scanIsComplete=false;
  LogApplier logApplier=new LogApplier(byteChannel);
  int xidIdent=getNextIdentifier();
  long startEntryPosition=writeBuffer.getFileChannelPosition();
  boolean successfullyApplied=false;
  try {
    while (logApplier.readAndWriteAndApplyEntry(xidIdent)) {
      logEntriesFound++;
    }
    successfullyApplied=true;
  }
  finally {
    if (!successfullyApplied && logApplier.startEntry != null) {
      xidIdentMap.remove(xidIdent);
      try {
        xaRm.forget(logApplier.startEntry.getXid());
      }
 catch (      XAException e) {
        throw new IOException(e);
      }
    }
  }
  byteChannel.close();
  scanIsComplete=true;
  LogEntry.Start startEntry=logApplier.startEntry;
  if (startEntry == null) {
    throw new IOException("Unable to find start entry");
  }
  startEntry.setStartPosition(startEntryPosition);
  cacheTxStartPosition(logApplier.commitEntry.getTxId(),logApplier.commitEntry.getMasterId(),startEntry);
  checkLogRotation();
}
