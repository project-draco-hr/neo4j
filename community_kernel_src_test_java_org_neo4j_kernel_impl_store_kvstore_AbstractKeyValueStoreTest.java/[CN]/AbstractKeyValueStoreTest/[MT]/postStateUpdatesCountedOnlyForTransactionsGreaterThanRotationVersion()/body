{
  final Store store=resourceManager.managed(createTestStore());
  PreparedRotation rotation=store.prepareRotation(2);
  updateStore(store,4);
  updateStore(store,3);
  updateStore(store,1);
  updateStore(store,2);
  assertEquals(2,rotation.rotate());
  Future<Long> rotationFuture=threading.executeAndAwait(store.rotation,5L,new Predicate<Thread>(){
    @Override public boolean test(    Thread thread){
      return Thread.State.TIMED_WAITING == thread.getState();
    }
  }
,100,SECONDS);
  Thread.sleep(TimeUnit.SECONDS.toMillis(1));
  assertFalse(rotationFuture.isDone());
  updateStore(store,5);
  assertEquals(5,rotationFuture.get().longValue());
}
