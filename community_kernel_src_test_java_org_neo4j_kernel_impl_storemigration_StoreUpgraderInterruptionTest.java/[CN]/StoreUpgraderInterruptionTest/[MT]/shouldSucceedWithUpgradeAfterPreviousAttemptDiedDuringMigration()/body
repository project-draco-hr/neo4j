{
  File workingDirectory=new File("target/" + StoreUpgraderInterruptionTest.class.getSimpleName());
  MigrationTestUtils.prepareSampleLegacyDatabase(workingDirectory);
  StoreMigrator failingStoreMigrator=new StoreMigrator(new SilentMigrationProgressMonitor()){
    public void migrate(    LegacyStore legacyStore,    NeoStore neoStore) throws IOException {
      super.migrate(legacyStore,neoStore);
      throw new RuntimeException("This upgrade is failing");
    }
  }
;
  assertTrue(allStoreFilesHaveVersion(workingDirectory,"v0.9.9"));
  try {
    newUpgrader(failingStoreMigrator,new DatabaseFiles()).attemptUpgrade(new File(workingDirectory,NeoStore.DEFAULT_NAME).getPath());
    fail("Should throw exception");
  }
 catch (  RuntimeException e) {
    assertEquals("This upgrade is failing",e.getMessage());
  }
  assertTrue(allStoreFilesHaveVersion(workingDirectory,"v0.9.9"));
  newUpgrader(new StoreMigrator(new SilentMigrationProgressMonitor()),new DatabaseFiles()).attemptUpgrade(new File(workingDirectory,NeoStore.DEFAULT_NAME).getPath());
  assertTrue(allStoreFilesHaveVersion(workingDirectory,ALL_STORES_VERSION));
}
