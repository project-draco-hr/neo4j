{
  File workingDirectory=directory.directory("working");
  File prepareDirectory=directory.directory("prepare");
  MigrationTestUtils.prepareSampleLegacyDatabase(version,fs,workingDirectory,prepareDirectory);
  PageCache pageCache=pageCacheRule.getPageCache(fs);
  StoreVersionCheck check=new StoreVersionCheck(pageCache);
  UpgradableDatabase upgradableDatabase=new UpgradableDatabase(fs,check,new LegacyStoreVersionCheck(fs),StandardV3_0.RECORD_FORMATS);
  SilentMigrationProgressMonitor progressMonitor=new SilentMigrationProgressMonitor();
  LogService logService=NullLogService.getInstance();
  final Config config=Config.empty();
  StoreMigrator failingStoreMigrator=new StoreMigrator(fs,pageCache,config,logService,schemaIndexProvider){
    @Override public void migrate(    File sourceStoreDir,    File targetStoreDir,    MigrationProgressMonitor.Section progressMonitor,    String versionToMigrateFrom,    String versionToMigrateTo) throws IOException {
      super.migrate(sourceStoreDir,targetStoreDir,progressMonitor,versionToMigrateFrom,versionToMigrateTo);
      throw new RuntimeException("This upgrade is failing");
    }
  }
;
  assertEquals(!StandardV2_3.STORE_VERSION.equals(version),allLegacyStoreFilesHaveVersion(fs,workingDirectory,version));
  try {
    newUpgrader(upgradableDatabase,progressMonitor,createIndexMigrator(),failingStoreMigrator).migrateIfNeeded(workingDirectory);
    fail("Should throw exception");
  }
 catch (  RuntimeException e) {
    assertEquals("This upgrade is failing",e.getMessage());
  }
  assertEquals(!StandardV2_3.STORE_VERSION.equals(version),allLegacyStoreFilesHaveVersion(fs,workingDirectory,version));
  progressMonitor=new SilentMigrationProgressMonitor();
  StoreMigrator migrator=new StoreMigrator(fs,pageCache,config,logService,schemaIndexProvider);
  SchemaIndexMigrator indexMigrator=createIndexMigrator();
  newUpgrader(upgradableDatabase,progressMonitor,indexMigrator,migrator).migrateIfNeeded(workingDirectory);
  assertTrue(checkNeoStoreHasDefaultFormatVersion(check,workingDirectory));
  assertTrue(allStoreFilesHaveNoTrailer(fs,workingDirectory));
  startStopDatabase(workingDirectory);
  assertConsistentStore(workingDirectory);
}
