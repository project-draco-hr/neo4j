{
  try (LockWrapper ignored=writeLock(updateLock)){
    KeyValueStoreState<Key,MetaData> current=state;
    if (!current.hasChanges()) {
      if (!hasMetadataChanges(current.metadata(),metadataChanges)) {
        return;
      }
    }
    state=state.rotate(updateMetadata(current.metadata(),metadataChanges));
  }
 }
