{
  try (LockWrapper ignored=writeLock(updateLock)){
    KeyValueStoreState<Key> current=state;
    if (!current.hasChanges()) {
      if (!hasHeaderChanges(current.headers(),headerChanges)) {
        return;
      }
    }
    state=state.rotate(updateHeaders(current.headers(),headerChanges));
  }
 }
