{
  final CommandHandler applier=newApplier(true);
  final CommandHandler indexApplier=newIndexApplier(TransactionApplicationMode.EXTERNAL);
  final DynamicRecord record=DynamicRecord.dynamicRecord(21,true);
  final Collection<DynamicRecord> recordsAfter=Arrays.asList(record);
  final IndexRule rule=IndexRule.constraintIndexRule(0,1,2,new SchemaIndexProvider.Descriptor("K","X.Y"),42l);
  final Command.SchemaRuleCommand command=new Command.SchemaRuleCommand().init(Collections.<DynamicRecord>emptyList(),recordsAfter,rule);
  applier.begin(transactionToApply);
  final boolean result=applier.visitSchemaRuleCommand(command) & indexApplier.visitSchemaRuleCommand(command);
  applier.end();
  applyAndClose(applier,indexApplier);
  assertFalse(result);
  verify(schemaStore,times(1)).setHighestPossibleIdInUse(record.getId());
  verify(schemaStore,times(1)).updateRecord(record);
  verify(indexingService,times(1)).activateIndex(rule.getId());
  verify(cacheAccess,times(1)).addSchemaRule(rule);
}
