{
  if (properties == null) {
    return Record.NO_NEXT_PROPERTY.intValue();
  }
  PropertyStore propStore=getPropertyStore();
  List<PropertyRecord> propRecords=new ArrayList<PropertyRecord>();
  PropertyRecord prevRecord=null;
  for (  Entry<String,Object> entry : properties.entrySet()) {
    int keyId=indexHolder.getKeyId(entry.getKey());
    if (keyId == -1) {
      keyId=createNewPropertyIndex(entry.getKey());
    }
    long propertyId=propStore.nextId();
    PropertyRecord propertyRecord=new PropertyRecord(propertyId);
    propertyRecord.setInUse(true);
    propertyRecord.setCreated();
    propertyRecord.setKeyIndexId(keyId);
    propStore.encodeValue(propertyRecord,entry.getValue());
    if (prevRecord != null) {
      prevRecord.setPrevProp(propertyId);
      propertyRecord.setNextProp(prevRecord.getId());
    }
    propRecords.add(propertyRecord);
    prevRecord=propertyRecord;
  }
  for (int i=propRecords.size() - 1; i >= 0; i--) {
    propStore.updateRecord(propRecords.get(i));
  }
  if (prevRecord != null) {
    return prevRecord.getId();
  }
  return Record.NO_NEXT_PROPERTY.intValue();
}
