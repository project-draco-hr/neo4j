{
  windowsSafeIOOperation(new FileUtils.FileOperation(){
    @Override public void perform() throws IOException {
      channel.position(highestIdInUse * format.recordSize(channel));
      ByteBuffer buffer=wrap(encode(footer()));
      channel.write(buffer);
      log.debug("Closing " + dbFileName + ", truncating at "+ channel.position()+ " vs file size "+ channel.size());
      channel.truncate(channel.position());
      channel.force(false);
      if (fileLock != null) {
        fileLock.release();
        fileLock=null;
      }
    }
  }
);
}
