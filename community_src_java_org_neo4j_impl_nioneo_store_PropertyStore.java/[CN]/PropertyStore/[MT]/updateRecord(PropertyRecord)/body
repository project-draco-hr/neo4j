{
  if (record.isTransferable() && !hasWindow(record.getId())) {
    if (!transferRecord(record)) {
      PersistenceWindow window=acquireWindow(record.getId(),OperationType.WRITE);
      try {
        updateRecord(record,window.getBuffer());
      }
  finally {
        releaseWindow(window);
      }
    }
 else {
      if (!record.inUse() && !isInRecoveryMode()) {
        freeId(record.getId());
      }
    }
  }
 else {
    PersistenceWindow window=acquireWindow(record.getId(),OperationType.WRITE);
    try {
      updateRecord(record,window.getBuffer());
    }
  finally {
      releaseWindow(window);
    }
  }
  if (!record.isLight()) {
    for (    DynamicRecord valueRecord : record.getValueRecords()) {
      if (valueRecord.getType() == PropertyType.STRING.intValue()) {
        stringPropertyStore.updateRecord(valueRecord);
      }
 else       if (valueRecord.getType() == PropertyType.ARRAY.intValue()) {
        arrayPropertyStore.updateRecord(valueRecord);
      }
 else {
        throw new RuntimeException("Unkown dynamic record");
      }
    }
  }
}
