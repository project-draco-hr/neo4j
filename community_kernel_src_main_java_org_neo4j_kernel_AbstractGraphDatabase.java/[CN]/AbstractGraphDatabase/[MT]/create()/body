{
  String separator=System.getProperty("file.separator");
  String store=this.storeDir + separator + NeoStore.DEFAULT_NAME;
  params.put(CommonAbstractStore.Configuration.store_dir.name(),this.storeDir);
  params.put("neo_store",store);
  String logicalLog=this.storeDir + separator + NeoStoreXaDataSource.LOGICAL_LOG_DEFAULT_NAME;
  params.put("logical_log",logicalLog);
  fileSystem=life.add(createFileSystemAbstraction());
  List<Class<?>> settingsClasses=new ArrayList<Class<?>>();
  settingsClasses.add(GraphDatabaseSettings.class);
  for (  KernelExtension kernelExtension : kernelExtensions) {
    Class settingsClass=kernelExtension.getSettingsClass();
    if (settingsClass != null)     settingsClasses.add(settingsClass);
  }
  config=new Config(StringLogger.logger(StaticLoggerBinder.getSingleton().getLoggerFactory().getLogger("neo4j.config")),fileSystem,params,settingsClasses);
  this.msgLog=createStringLogger();
  boolean readOnly=config.getBoolean(Configuration.read_only);
  CacheType cacheType=config.getEnum(CacheType.class,Configuration.cache_type);
  kernelEventHandlers=new KernelEventHandlers();
  diagnosticsManager=life.add(new DiagnosticsManager(StringLogger.logger(loggerContext.getLogger("neo4j.diagnostics"))));
  caches=createCaches();
  kernelPanicEventGenerator=new KernelPanicEventGenerator(kernelEventHandlers);
  txHook=createTxHook();
  xaDataSourceManager=life.add(new XaDataSourceManager(StringLogger.logger(loggerContext.getLogger("neo4j.datasource"))));
  guard=config.getBoolean(Configuration.execution_guard_enabled) ? new Guard(msgLog) : null;
  xaDataSourceManager=life.add(new XaDataSourceManager(msgLog));
  if (readOnly) {
    txManager=new ReadOnlyTxManager(xaDataSourceManager);
  }
 else {
    String serviceName=config.get(GraphDatabaseSettings.tx_manager_impl);
    if (serviceName == null) {
      txManager=new TxManager(this.storeDir,xaDataSourceManager,kernelPanicEventGenerator,txHook,StringLogger.logger(loggerContext.getLogger("neo4j.txmanager")),fileSystem);
    }
 else {
      TransactionManagerProvider provider;
      provider=Service.load(TransactionManagerProvider.class,serviceName);
      if (provider == null) {
        throw new IllegalStateException("Unknown transaction manager implementation: " + serviceName);
      }
      txManager=provider.loadTransactionManager(this.storeDir,kernelPanicEventGenerator,txHook,StringLogger.logger(loggerContext.getLogger("neo4j.txmanager")),fileSystem);
    }
  }
  life.add(txManager);
  transactionEventHandlers=new TransactionEventHandlers(txManager);
  txIdGenerator=createTxIdGenerator();
  ragManager=new RagManager(txManager);
  lockManager=createLockManager();
  idGeneratorFactory=createIdGeneratorFactory();
  relationshipTypeCreator=new DefaultRelationshipTypeCreator();
  lastCommittedTxIdSetter=createLastCommittedTxIdSetter();
  persistenceSource=life.add(new NioNeoDbPersistenceSource(xaDataSourceManager));
  syncHook=new DefaultTxEventSyncHookFactory();
  persistenceManager=new PersistenceManager(txManager,persistenceSource,syncHook,lockReleaser);
  propertyIndexManager=life.add(new PropertyIndexManager(txManager,persistenceManager,persistenceSource));
  lockReleaser=new LockReleaser(lockManager,txManager,nodeManager,propertyIndexManager);
  persistenceManager.setLockReleaser(lockReleaser);
  relationshipTypeHolder=new RelationshipTypeHolder(txManager,persistenceManager,persistenceSource,relationshipTypeCreator);
  caches.config(config);
  Cache<NodeImpl> nodeCache=diagnosticsManager.tryAppendProvider(caches.node());
  Cache<RelationshipImpl> relCache=diagnosticsManager.tryAppendProvider(caches.relationship());
  nodeManager=guard != null ? createGuardedNodeManager(readOnly,cacheType,nodeCache,relCache) : createNodeManager(readOnly,cacheType,nodeCache,relCache);
  life.add(nodeManager);
  lockReleaser.setNodeManager(nodeManager);
  indexStore=new IndexStore(this.storeDir,fileSystem);
  diagnosticsManager.prependProvider(config);
  params=config.getParams();
  logBufferFactory=new DefaultLogBufferFactory();
  extensions=life.add(createKernelData());
  if (config.getBoolean(Configuration.load_kernel_extensions)) {
    life.add(new DefaultKernelExtensionLoader(extensions));
  }
  if (indexProviders == null)   indexProviders=new LegacyIndexIterable();
  indexManager=new IndexManagerImpl(config,indexStore,xaDataSourceManager,txManager,this);
  nodeAutoIndexer=life.add(new NodeAutoIndexerImpl(config,indexManager,nodeManager));
  relAutoIndexer=life.add(new RelationshipAutoIndexerImpl(config,indexManager,nodeManager));
  indexManager.setNodeAutoIndexer(nodeAutoIndexer);
  indexManager.setRelAutoIndexer(relAutoIndexer);
  recoveryVerifier=createRecoveryVerifier();
  storeFactory=createStoreFactory();
  xaFactory=new XaFactory(config,txIdGenerator,txManager,logBufferFactory,fileSystem,StringLogger.logger(loggerContext.getLogger("neo4j.xafactory")),recoveryVerifier);
  List<Pair<TransactionInterceptorProvider,Object>> providers=new ArrayList<Pair<TransactionInterceptorProvider,Object>>(2);
  for (  TransactionInterceptorProvider provider : Service.load(TransactionInterceptorProvider.class)) {
    Object prov=params.get(TransactionInterceptorProvider.class.getSimpleName() + "." + provider.name());
    if (prov != null) {
      providers.add(Pair.of(provider,prov));
    }
  }
  try {
    neoDataSource=new NeoStoreXaDataSource(config,storeFactory,fileSystem,lockManager,lockReleaser,StringLogger.logger(loggerContext.getLogger("neo4j.datasource")),xaFactory,providers,new DependencyResolverImpl());
    xaDataSourceManager.registerDataSource(neoDataSource);
  }
 catch (  IOException e) {
    throw new IllegalStateException("Could not create Neo XA datasource",e);
  }
  life.add(new StuffToDoAfterRecovery());
  life.add(new MonitorGc(config,msgLog));
  life.add(new DatabaseAvailability());
  life.add(kernelEventHandlers);
  config.addConfigurationChangeListener(new ConfigurationChangeListener(){
    Executor executor=Executors.newSingleThreadExecutor(new DaemonThreadFactory("Database configuration restart"));
    @Override public void notifyConfigurationChanges(    final Iterable<ConfigurationChange> change){
      executor.execute(new Runnable(){
        @Override public void run(){
          try {
            life.stop();
            life.start();
            msgLog.logMessage("Database restarted with the following configuration changes:" + change);
          }
 catch (          LifecycleException e) {
            msgLog.logMessage("Could not restart database",e);
          }
        }
      }
);
    }
  }
);
}
