{
  if (retries > 20) {
    close();
  }
  if (!acquireReadBuffer()) {
    retries++;
    return false;
  }
  try {
    buffer.limit(9);
    int read=connection.read();
    log("Get greeting response");
    if (read == 1 || read == 9) {
      buffer.flip();
      byte masterGreeting=buffer.get();
      if (masterGreeting == HeaderConstants.BYE) {
        log("Problem connecting to master " + connection + ". Got BYE.");
        close();
        return true;
      }
 else       if (masterGreeting != HeaderConstants.MASTER_GREETING) {
        log("Got unkown greeting[" + masterGreeting + "] from "+ connection);
        close();
      }
 else       if (read != 9) {
        retries++;
        connection.pushBackAllReadData();
        return false;
      }
      masterVersion=buffer.getLong();
      log("Got master version: " + masterVersion);
      if (masterVersion < xaDs.getCurrentLogVersion()) {
        log("Got wrong version [" + masterVersion + "]");
        close();
        return true;
      }
      setNoRequeue();
      setChainJob(new HandleMasterConnection(connection,slave,masterVersion,xaDs));
      return true;
    }
 else {
      retries++;
      if (read > 0) {
        connection.pushBackAllReadData();
      }
      return false;
    }
  }
  finally {
    releaseReadBuffer();
  }
}
