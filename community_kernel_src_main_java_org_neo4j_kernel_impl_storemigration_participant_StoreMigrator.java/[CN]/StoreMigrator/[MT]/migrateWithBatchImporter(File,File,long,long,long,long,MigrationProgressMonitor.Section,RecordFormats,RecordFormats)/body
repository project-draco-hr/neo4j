{
  prepareBatchImportMigration(storeDir,migrationDir,oldFormat,newFormat);
  boolean requiresDynamicStoreMigration=!newFormat.dynamic().equals(oldFormat.dynamic());
  boolean requiresPropertyMigration=!newFormat.property().equals(oldFormat.property()) || requiresDynamicStoreMigration;
  File badFile=new File(storeDir,Configuration.BAD_FILE_NAME);
  try (NeoStores legacyStore=instantiateLegacyStore(oldFormat,storeDir);RecordCursors nodeInputCursors=new RecordCursors(legacyStore);RecordCursors relationshipInputCursors=new RecordCursors(legacyStore);OutputStream badOutput=new BufferedOutputStream(new FileOutputStream(badFile,false))){
    Configuration importConfig=new Configuration.Overridden(config);
    AdditionalInitialIds additionalInitialIds=readAdditionalIds(lastTxId,lastTxChecksum,lastTxLogVersion,lastTxLogByteOffset);
    BatchImporter importer=new ParallelBatchImporter(migrationDir.getAbsoluteFile(),fileSystem,importConfig,logService,withDynamicProcessorAssignment(migrationBatchImporterMonitor(legacyStore,progressMonitor,importConfig),importConfig),additionalInitialIds,config,newFormat);
    InputIterable<InputNode> nodes=legacyNodesAsInput(legacyStore,requiresPropertyMigration,nodeInputCursors);
    InputIterable<InputRelationship> relationships=legacyRelationshipsAsInput(legacyStore,requiresPropertyMigration,relationshipInputCursors);
    importer.doImport(Inputs.input(nodes,relationships,IdMappers.actual(),IdGenerators.fromInput(),Collectors.badCollector(badOutput,0)));
    Collection<StoreFile> storesToDeleteFromMigratedDirectory=new ArrayList<>();
    storesToDeleteFromMigratedDirectory.add(StoreFile.NEO_STORE);
    if (!requiresPropertyMigration) {
      storesToDeleteFromMigratedDirectory.addAll(asList(StoreFile.PROPERTY_STORE,StoreFile.PROPERTY_STRING_STORE,StoreFile.PROPERTY_ARRAY_STORE));
    }
    if (!requiresDynamicStoreMigration) {
      storesToDeleteFromMigratedDirectory.addAll(asList(StoreFile.NODE_LABEL_STORE,StoreFile.LABEL_TOKEN_STORE,StoreFile.LABEL_TOKEN_NAMES_STORE,StoreFile.RELATIONSHIP_TYPE_TOKEN_STORE,StoreFile.RELATIONSHIP_TYPE_TOKEN_NAMES_STORE,StoreFile.PROPERTY_KEY_TOKEN_STORE,StoreFile.PROPERTY_KEY_TOKEN_NAMES_STORE,StoreFile.SCHEMA_STORE));
    }
    StoreFile.fileOperation(DELETE,fileSystem,migrationDir,null,storesToDeleteFromMigratedDirectory,true,null,StoreFileType.values());
  }
 }
