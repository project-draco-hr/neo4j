{
  String serverRootPath=rootPath + "/" + HA_SERVERS_CHILD;
  try {
    zooKeeper.create(serverRootPath,new byte[0],ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  }
 catch (  KeeperException e) {
    if (e.code() != KeeperException.Code.NODEEXISTS) {
      throw e;
    }
  }
  String compatibilityPath=rootPath + "/" + COMPATIBILITY_CHILD;
  try {
    zooKeeper.create(compatibilityPath,new byte[0],ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  }
 catch (  KeeperException e) {
    if (e.code() != KeeperException.Code.NODEEXISTS) {
      throw e;
    }
  }
  String machinePath=serverRootPath + "/" + machineId;
  String compatibilityMachinePath=compatibilityPath + "/" + machineId;
  byte[] data=haServerAsData();
  boolean compatCreated=false;
  boolean machineCreated=false;
  try {
    zooKeeper.create(compatibilityMachinePath,new byte[0],ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.EPHEMERAL);
    compatCreated=true;
    zooKeeper.create(machinePath,data,ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.EPHEMERAL);
    machineCreated=true;
  }
 catch (  KeeperException e) {
    if (e.code() != KeeperException.Code.NODEEXISTS) {
      throw e;
    }
    msgLog.logMessage("HA server info already present, trying again");
    try {
      if (compatCreated)       zooKeeper.delete(compatibilityMachinePath,-1);
      if (machineCreated)       zooKeeper.delete(machinePath,-1);
    }
 catch (    KeeperException ee) {
      if (ee.code() != KeeperException.Code.NONODE) {
        msgLog.logMessage("Unable to delete " + ee.getPath(),ee);
      }
    }
 finally {
      writeHaServerConfig();
    }
  }
  zooKeeper.setData(machinePath,data,-1);
  msgLog.logMessage("Wrote HA server " + haServer + " to zoo keeper");
}
