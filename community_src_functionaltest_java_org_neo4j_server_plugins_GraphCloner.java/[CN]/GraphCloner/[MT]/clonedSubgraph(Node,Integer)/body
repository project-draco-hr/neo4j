{
  GraphDatabaseService graphDb=startNode.getGraphDatabase();
  Transaction tx=graphDb.beginTx();
  try {
    Traverser traverse=traverseToDepth(startNode,depth);
    Iterator<Node> nodes=traverse.nodes().iterator();
    HashMap<Node,Node> clonedNodes=cloneNodes(graphDb,nodes);
    for (    Node oldNode : clonedNodes.keySet()) {
      Node newStartNode=clonedNodes.get(oldNode);
      Iterator<Relationship> oldRelationships=oldNode.getRelationships(Direction.OUTGOING).iterator();
      while (oldRelationships.hasNext()) {
        Relationship oldRelationship=oldRelationships.next();
        Node newEndNode=clonedNodes.get(oldRelationship.getEndNode());
        if (newEndNode != null) {
          Relationship newRelationship=newStartNode.createRelationshipTo(newEndNode,oldRelationship.getType());
          cloneProperties(oldRelationship,newRelationship);
        }
      }
    }
    tx.success();
    return clonedNodes.get(startNode);
  }
  finally {
    tx.finish();
  }
}
