{
  ensureOk();
  try {
    for (    RaftLogEntry entry : entries) {
      state.appendIndex++;
      updateTerm(entry);
      state.segments.last().write(state.appendIndex,entry);
      cacheEntry(entry);
    }
    state.segments.last().flush();
  }
 catch (  Throwable e) {
    needsRecovery=true;
    throw e;
  }
  if (state.segments.last().position() >= rotateAtSize) {
    rotateSegment(state.appendIndex,state.appendIndex,state.currentTerm);
  }
  return state.appendIndex;
}
