{
  boolean isLoop=record.getFirstNode() == record.getSecondNode();
  if (isLoop) {
    long prevRel=cache.getAndPutRelationship(record.getFirstNode(),record.getType(),Direction.BOTH,record.getId(),false);
    if (prevRel == -1) {
      record.setFirstInFirstChain(true);
      record.setFirstInSecondChain(true);
      prevRel=cache.getCount(record.getFirstNode(),record.getType(),Direction.BOTH);
    }
    record.setFirstPrevRel(prevRel);
    record.setSecondPrevRel(prevRel);
  }
 else {
    long firstPrevRel=cache.getAndPutRelationship(record.getFirstNode(),record.getType(),Direction.OUTGOING,record.getId(),false);
    if (firstPrevRel == -1) {
      record.setFirstInFirstChain(true);
      firstPrevRel=cache.getCount(record.getFirstNode(),record.getType(),Direction.OUTGOING);
    }
    record.setFirstPrevRel(firstPrevRel);
    long secondPrevRel=cache.getAndPutRelationship(record.getSecondNode(),record.getType(),Direction.INCOMING,record.getId(),false);
    if (secondPrevRel == -1) {
      record.setFirstInSecondChain(true);
      secondPrevRel=cache.getCount(record.getSecondNode(),record.getType(),Direction.INCOMING);
    }
    record.setSecondPrevRel(secondPrevRel);
  }
  return true;
}
