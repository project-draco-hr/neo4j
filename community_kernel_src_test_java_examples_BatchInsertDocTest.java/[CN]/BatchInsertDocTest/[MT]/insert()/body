{
  FileUtils.deleteRecursively(new File("target/batchinserter-example"));
  BatchInserter inserter=null;
  try {
    inserter=BatchInserters.inserter(new File("target/batchinserter-example").getAbsolutePath(),fileSystem);
    Label personLabel=DynamicLabel.label("Person");
    inserter.createDeferredSchemaIndex(personLabel).on("name").create();
    Map<String,Object> properties=new HashMap<>();
    properties.put("name","Mattias");
    long mattiasNode=inserter.createNode(properties,personLabel);
    properties.put("name","Chris");
    long chrisNode=inserter.createNode(properties,personLabel);
    RelationshipType knows=DynamicRelationshipType.withName("KNOWS");
    inserter.createRelationship(mattiasNode,chrisNode,knows,null);
  }
  finally {
    if (inserter != null) {
      inserter.shutdown();
    }
  }
  GraphDatabaseService db=new TestGraphDatabaseFactory().setFileSystem(fileSystem).newImpermanentDatabase(new File("target/batchinserter-example").getAbsolutePath());
  try (Transaction tx=db.beginTx()){
    Label personLabelForTesting=DynamicLabel.label("Person");
    Node mNode=db.findNode(personLabelForTesting,"name","Mattias");
    Node cNode=mNode.getSingleRelationship(DynamicRelationshipType.withName("KNOWS"),Direction.OUTGOING).getEndNode();
    assertThat((String)cNode.getProperty("name"),is("Chris"));
    assertThat(db.schema().getIndexes(personLabelForTesting).iterator().hasNext(),is(true));
  }
  finally {
    db.shutdown();
  }
}
