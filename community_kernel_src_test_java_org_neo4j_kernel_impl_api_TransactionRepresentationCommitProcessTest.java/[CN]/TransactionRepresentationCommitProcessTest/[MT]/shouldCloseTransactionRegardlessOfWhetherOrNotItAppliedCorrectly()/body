{
  TransactionIdStore transactionIdStore=mock(TransactionIdStore.class);
  TransactionAppender appender=new TestableTransactionAppender(transactionIdStore);
  long txId=11;
  when(transactionIdStore.nextCommittingTransactionId()).thenReturn(txId);
  IOException rootCause=new IOException("Mock exception");
  StorageEngine storageEngine=mock(StorageEngine.class);
  doThrow(new IOException(rootCause)).when(storageEngine).apply(any(TransactionToApply.class),any(TransactionApplicationMode.class));
  TransactionCommitProcess commitProcess=new TransactionRepresentationCommitProcess(appender,storageEngine);
  TransactionToApply transaction=mockedTransaction();
  try {
    commitProcess.commit(transaction,commitEvent,INTERNAL);
  }
 catch (  TransactionFailureException e) {
    assertThat(e.getMessage(),containsString("Could not apply the transaction to the store"));
    assertTrue(contains(e,rootCause.getMessage(),rootCause.getClass()));
  }
  verify(transactionIdStore,times(1)).transactionClosed(eq(txId),anyLong(),anyLong());
}
