{
  defaultBackupPortHostParams();
  Config defaultConfig=dbRule.getConfigCopy();
  dbRule.setConfig(OnlineBackupSettings.online_backup_enabled,"false");
  Config withOnlineBackupEnabled=dbRule.getConfigCopy();
  final List<String> storesThatHaveBeenStreamed=new ArrayList<>();
  final CountDownLatch firstStoreFinishedStreaming=new CountDownLatch(1);
  final CountDownLatch transactionCommitted=new CountDownLatch(1);
  final GraphDatabaseAPI db=dbRule.getGraphDatabaseAPI();
  createAndIndexNode(db,1);
  NeoStoreDataSource ds=db.getDependencyResolver().resolveDependency(DataSourceManager.class).getDataSource();
  long expectedLastTxId=ds.getNeoStore().getLastCommittedTransactionId();
  Monitors monitors=new Monitors();
  monitors.addMonitorListener(new StoreSnoopingMonitor(firstStoreFinishedStreaming,transactionCommitted,storesThatHaveBeenStreamed));
  OnlineBackupKernelExtension backup=new OnlineBackupKernelExtension(defaultConfig,db,db.getDependencyResolver().resolveDependency(KernelPanicEventGenerator.class),new DevNullLoggingService(),monitors);
  backup.start();
  BackupService backupService=new BackupService(fileSystem);
  ExecutorService executor=Executors.newSingleThreadExecutor();
  executor.execute(new Runnable(){
    @Override public void run(){
      awaitLatch(firstStoreFinishedStreaming);
      createAndIndexNode(db,1);
      db.getDependencyResolver().resolveDependency(DataSourceManager.class).getDataSource().getNeoStore().flush();
      transactionCommitted.countDown();
    }
  }
);
  BackupService.BackupOutcome backupOutcome=backupService.doFullBackup(BACKUP_HOST,backupPort,backupDir.getAbsolutePath(),true,withOnlineBackupEnabled,BackupClient.BIG_READ_TIMEOUT,false);
  backup.stop();
  executor.shutdown();
  executor.awaitTermination(30,TimeUnit.SECONDS);
  assertEquals(DbRepresentation.of(db),DbRepresentation.of(backupDir));
  assertTrue(backupOutcome.isConsistent());
  checkPreviousCommittedTxIdFromFirstLog(expectedLastTxId);
}
