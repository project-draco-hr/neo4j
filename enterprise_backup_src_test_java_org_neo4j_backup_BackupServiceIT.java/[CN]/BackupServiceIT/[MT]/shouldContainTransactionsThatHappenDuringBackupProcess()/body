{
  defaultBackupPortHostParams();
  Config defaultConfig=dbRule.getConfigCopy();
  dbRule.setConfig(OnlineBackupSettings.online_backup_enabled,"false");
  Config withOnlineBackupEnabled=dbRule.getConfigCopy();
  final Barrier.Control barrier=new Barrier.Control();
  final GraphDatabaseAPI db=dbRule.getGraphDatabaseAPI();
  createAndIndexNode(db,1);
  final DependencyResolver resolver=db.getDependencyResolver();
  NeoStoreDataSource ds=resolver.resolveDependency(DataSourceManager.class).getDataSource();
  long expectedLastTxId=ds.getNeoStores().getMetaDataStore().getLastCommittedTransactionId();
  monitors.addMonitorListener(new StoreSnoopingMonitor(barrier));
  Dependencies dependencies=new Dependencies(resolver);
  dependencies.satisfyDependencies(defaultConfig,monitors,NullLogProvider.getInstance());
  OnlineBackupKernelExtension backup=(OnlineBackupKernelExtension)new OnlineBackupExtensionFactory().newKernelExtension(DependenciesProxy.dependencies(dependencies,OnlineBackupExtensionFactory.Dependencies.class));
  backup.start();
  BackupService backupService=backupService();
  ExecutorService executor=Executors.newSingleThreadExecutor();
  executor.execute(new Runnable(){
    @Override public void run(){
      barrier.awaitUninterruptibly();
      createAndIndexNode(db,1);
      resolver.resolveDependency(NeoStoresSupplier.class).get().flush();
      barrier.release();
    }
  }
);
  BackupService.BackupOutcome backupOutcome=backupService.doFullBackup(BACKUP_HOST,backupPort,backupDir.getAbsoluteFile(),ConsistencyCheck.DEFAULT,withOnlineBackupEnabled,BackupClient.BIG_READ_TIMEOUT,false);
  backup.stop();
  executor.shutdown();
  executor.awaitTermination(30,TimeUnit.SECONDS);
  checkPreviousCommittedTxIdFromLog(0,expectedLastTxId);
  File neoStore=new File(storeDir,MetaDataStore.DEFAULT_NAME);
  long txIdFromOrigin=MetaDataStore.getRecord(resolver.resolveDependency(PageCache.class),neoStore,Position.LAST_TRANSACTION_ID);
  checkLastCommittedTxIdInLogAndNeoStore(expectedLastTxId + 1,txIdFromOrigin);
  assertEquals(DbRepresentation.of(db),DbRepresentation.of(backupDir));
  assertTrue(backupOutcome.isConsistent());
}
