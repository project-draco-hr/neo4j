{
  EphemeralFileSystemAbstraction delegate=new EphemeralFileSystemAbstraction();
  AdversarialFileSystemAbstraction fsa=new AdversarialFileSystemAbstraction(new MethodGuardedAdversary(new CountingAdversary(100,true),StoreChannel.class.getMethod("writeAll",ByteBuffer.class)),delegate);
  LongState persistedState=new LongState(fsa,testDir.directory(),14);
  long lastValue=0;
  try {
    while (true) {
      long tempValue=lastValue + 1;
      persistedState.setTheState(tempValue);
      lastValue=tempValue;
    }
  }
 catch (  Exception expected) {
    ensureStackTraceContainsExpectedMethod(expected.getStackTrace(),"writeAll");
  }
  LongState restoredState=new LongState(delegate,testDir.directory(),4);
  assertEquals(lastValue,restoredState.getTheState());
}
