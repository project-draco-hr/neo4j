{
  txState.accept(new TxState.VisitorAdapter(){
    @Override public void visitNodePropertyChanges(    long id,    Iterator<DefinedProperty> added,    Iterator<DefinedProperty> changed,    Iterator<Integer> removed){
      NodeImpl node=nodeCache.getIfCached(id);
      if (node != null) {
        node.commitPropertyMaps(translateChangedProperties(changed),removed);
      }
    }
    @Override public void visitNodeRelationshipChanges(    long id,    RelationshipChangesForNode added,    RelationshipChangesForNode removed){
      NodeImpl node=nodeCache.getIfCached(id);
      if (node != null) {
        node.commitRelationshipMaps(translateAddedRelationships(added),translateRemovedRelationships(removed));
      }
    }
    @Override public void visitRelPropertyChanges(    long id,    Iterator<DefinedProperty> added,    Iterator<DefinedProperty> changed,    Iterator<Integer> removed){
      RelationshipImpl relationship=relationshipCache.getIfCached(id);
      if (relationship != null) {
        relationship.commitPropertyMaps(translateChangedProperties(changed),removed);
      }
    }
    @Override public void visitGraphPropertyChanges(    Iterator<DefinedProperty> added,    Iterator<DefinedProperty> changed,    Iterator<Integer> removed){
      graphProperties.commitPropertyMaps(translateChangedProperties(changed),removed);
    }
    private PrimitiveIntObjectMap<DefinedProperty> translateChangedProperties(    Iterator<DefinedProperty> properties){
      if (properties == null) {
        return null;
      }
      PrimitiveIntObjectMap<DefinedProperty> result=org.neo4j.collection.primitive.Primitive.intObjectMap();
      while (properties.hasNext()) {
        DefinedProperty property=properties.next();
        result.put(property.propertyKeyId(),property);
      }
      return result;
    }
    private PrimitiveIntObjectMap<RelIdArray> translateAddedRelationships(    RelationshipChangesForNode added){
      if (added == null) {
        return null;
      }
      PrimitiveIntObjectMap<RelIdArray> result=org.neo4j.collection.primitive.Primitive.intObjectMap();
      PrimitiveIntIterator types=added.getTypesChanged();
      while (types.hasNext()) {
        int type=types.next();
        RelIdArray idArray=new RelIdArray(type);
        addIds(idArray,added.outgoingChanges(type),DirectionWrapper.OUTGOING);
        addIds(idArray,added.incomingChanges(type),DirectionWrapper.INCOMING);
        addIds(idArray,added.loopsChanges(type),DirectionWrapper.BOTH);
      }
      return result;
    }
    private void addIds(    RelIdArray idArray,    Iterator<Long> ids,    DirectionWrapper direction){
      while (ids.hasNext()) {
        idArray.add(ids.next(),direction);
      }
    }
    private PrimitiveIntObjectMap<PrimitiveLongSet> translateRemovedRelationships(    RelationshipChangesForNode removed){
      if (removed == null) {
        return null;
      }
      PrimitiveIntObjectMap<PrimitiveLongSet> result=org.neo4j.collection.primitive.Primitive.intObjectMap();
      PrimitiveIntIterator types=removed.getTypesChanged();
      while (types.hasNext()) {
        int type=types.next();
        PrimitiveLongSet ids=org.neo4j.collection.primitive.Primitive.longSet();
        addIds(ids,removed.outgoingChanges(type));
        addIds(ids,removed.incomingChanges(type));
        addIds(ids,removed.loopsChanges(type));
      }
      return result;
    }
    private void addIds(    PrimitiveLongSet set,    Iterator<Long> ids){
      while (ids.hasNext()) {
        set.add(ids.next());
      }
    }
  }
);
}
