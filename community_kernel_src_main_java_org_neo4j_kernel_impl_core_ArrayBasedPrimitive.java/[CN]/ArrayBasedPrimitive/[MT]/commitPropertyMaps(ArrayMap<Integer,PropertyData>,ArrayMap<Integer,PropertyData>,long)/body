{
synchronized (this) {
    Property[] newArray=properties;
    if (newArray == null)     return;
    int extraLength=0;
    if (cowPropertyAddMap != null) {
      extraLength+=cowPropertyAddMap.size();
    }
    int newArraySize=newArray.length;
    if (extraLength > 0) {
      Property[] oldArray=newArray;
      newArray=new Property[oldArray.length + extraLength];
      System.arraycopy(oldArray,0,newArray,0,oldArray.length);
    }
 else {
      newArray=newArray.clone();
    }
    if (cowPropertyRemoveMap != null) {
      for (      Integer keyIndex : cowPropertyRemoveMap.keySet()) {
        for (int i=0; i < newArraySize; i++) {
          Property existingProperty=newArray[i];
          if (existingProperty.propertyKeyId() == keyIndex) {
            int swapWith=--newArraySize;
            newArray[i]=newArray[swapWith];
            newArray[swapWith]=null;
            break;
          }
        }
      }
    }
    if (cowPropertyAddMap != null) {
      for (      PropertyData addedProperty : cowPropertyAddMap.values()) {
        for (int i=0; i < newArray.length; i++) {
          Property existingProperty=newArray[i];
          if (existingProperty == null || addedProperty.getIndex() == existingProperty.propertyKeyId()) {
            newArray[i]=Property.property(addedProperty.getIndex(),addedProperty.getValue());
            if (existingProperty == null) {
              newArraySize++;
            }
            break;
          }
        }
      }
    }
    if (newArraySize < newArray.length) {
      Property[] compactedNewArray=new Property[newArraySize];
      System.arraycopy(newArray,0,compactedNewArray,0,newArraySize);
      sort(compactedNewArray);
      properties=compactedNewArray;
    }
 else {
      sort(newArray);
      properties=newArray;
    }
  }
}
