{
  CountsSnapshot countsSnapshot;
  Map<CountsKey,long[]> snapshotMap;
  Map<CountsKey,long[]> map=new ConcurrentHashMap<>();
  ConcurrentHashMap<CountsKey,long[]> updateMap=new ConcurrentHashMap<>();
  IntermediateStateTestManager intermediateStateTestManager=new IntermediateStateTestManager();
  InMemoryCountsStore countStore=new InMemoryCountsStore();
  for (int i=0; i < 1000; i++) {
    long txId=intermediateStateTestManager.getNextUpdateMap(updateMap);
    updateMapByDiff(map,updateMap);
    countStore.updateAll(txId,updateMap);
    countsSnapshot=countStore.snapshot(txId);
    snapshotMap=countsSnapshot.getMap();
    assertMapEquals(map,snapshotMap);
  }
}
