{
  try (Transaction tx=graphDb.beginTx()){
    Index<Node> usersIndex=graphDb.index().forNodes("users");
    Node userNode=usersIndex.get("name",username).getSingle();
    if (userNode != null) {
      return userNode;
    }
    tx.acquireWriteLock(lockNode);
    userNode=usersIndex.get("name",username).getSingle();
    if (userNode == null) {
      userNode=graphDb.createNode(Label.label("User"));
      usersIndex.add(userNode,"name",username);
      userNode.setProperty("name",username);
    }
    tx.success();
    return userNode;
  }
 }
