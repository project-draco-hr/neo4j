{
  startCluster(3);
  cluster.fail(cluster.getMaster());
  RepairKit masterShutdown=cluster.shutdown(cluster.getMaster());
  cluster.await(ClusterManager.masterAvailable());
  cluster.await(ClusterManager.masterSeesSlavesAsAvailable(1));
  for (  HighlyAvailableGraphDatabase db : cluster.getAllMembers()) {
    assertEquals(3,ha(db).getInstancesInCluster().length);
  }
  assertEquals("2",ha(cluster.getMaster()).getInstanceId());
  masterShutdown.repair();
  cluster.await(ClusterManager.masterAvailable());
  cluster.await(ClusterManager.masterSeesAllSlavesAsAvailable());
  assertEquals("2",ha(cluster.getMaster()).getInstanceId());
  assertFalse(cluster.getMemberByServerId(1).isMaster());
  for (  HighlyAvailableGraphDatabase db : cluster.getAllMembers()) {
    HighAvailability bean=ha(db);
    assertEquals(3,bean.getInstancesInCluster().length);
    for (    ClusterMemberInfo info : bean.getInstancesInCluster()) {
      assertTrue(bean.getInstanceId() + ": every instance should be available: " + info.getClusterId(),info.isAvailable());
    }
  }
}
