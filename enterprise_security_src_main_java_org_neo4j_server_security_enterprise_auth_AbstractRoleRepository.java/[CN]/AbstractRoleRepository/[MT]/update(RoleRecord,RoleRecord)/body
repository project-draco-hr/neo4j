{
  if (!existingRole.name().equals(updatedRole.name())) {
    throw new IllegalArgumentException("The attempt to update the role from '" + existingRole.name() + "' to '"+ updatedRole.name()+ "' failed. Changing a roles name is not allowed.");
  }
synchronized (this) {
    List<RoleRecord> newRoles=new ArrayList<>();
    boolean foundRole=false;
    for (    RoleRecord other : roles) {
      if (other.equals(existingRole)) {
        foundRole=true;
        newRoles.add(updatedRole);
      }
 else {
        newRoles.add(other);
      }
    }
    if (!foundRole) {
      throw new ConcurrentModificationException();
    }
    roles=newRoles;
    persistRoles();
    rolesByName.put(updatedRole.name(),updatedRole);
    removeFromUserMap(existingRole);
    populateUserMap(updatedRole);
  }
}
