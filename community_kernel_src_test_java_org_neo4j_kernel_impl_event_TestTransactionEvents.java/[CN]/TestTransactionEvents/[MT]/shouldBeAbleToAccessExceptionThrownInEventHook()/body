{
  commit();
class MyFancyException extends Exception {
  }
  ExceptionThrowingEventHandler handler=new ExceptionThrowingEventHandler(new MyFancyException(),null,null);
  getGraphDb().registerTransactionEventHandler(handler);
  try {
    newTransaction();
    getGraphDb().createNode().delete();
    try {
      commit();
      fail("Should fail commit");
    }
 catch (    TransactionFailureException e) {
      Throwable currentEx=e;
      do {
        currentEx=currentEx.getCause();
        if (currentEx instanceof MyFancyException) {
          return;
        }
      }
 while (currentEx.getCause() != null);
      fail("Expected to find the exception thrown in the event hook as the cause of transaction failure.");
    }
  }
  finally {
    getGraphDb().unregisterTransactionEventHandler(handler);
  }
}
