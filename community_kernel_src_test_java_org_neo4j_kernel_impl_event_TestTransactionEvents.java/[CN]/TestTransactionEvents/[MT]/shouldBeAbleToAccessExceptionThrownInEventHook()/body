{
class MyFancyException extends Exception {
  }
  ExceptionThrowingEventHandler handler=new ExceptionThrowingEventHandler(new MyFancyException(),null,null);
  GraphDatabaseService db=dbRule.getGraphDatabaseService();
  db.registerTransactionEventHandler(handler);
  try {
    Transaction tx=db.beginTx();
    try {
      db.createNode().delete();
      tx.success();
      tx.close();
      fail("Should fail commit");
    }
 catch (    TransactionFailureException e) {
      Throwable currentEx=e;
      do {
        currentEx=currentEx.getCause();
        if (currentEx instanceof MyFancyException) {
          return;
        }
      }
 while (currentEx.getCause() != null);
      fail("Expected to find the exception thrown in the event hook as the cause of transaction failure.");
    }
  }
  finally {
    db.unregisterTransactionEventHandler(handler);
  }
}
