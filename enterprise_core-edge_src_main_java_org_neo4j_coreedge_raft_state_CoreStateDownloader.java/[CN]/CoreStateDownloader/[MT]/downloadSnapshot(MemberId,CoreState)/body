{
  localDatabase.stop();
  try {
    log.info("Downloading snapshot from core server at %s",source);
    CompletableFuture<CoreSnapshot> snapshotFuture=coreClient.requestCoreSnapshot(source);
    CoreSnapshot coreSnapshot;
    try {
      coreSnapshot=snapshotFuture.get(1,MINUTES);
    }
 catch (    TimeoutException e) {
      throw new StoreCopyFailedException(e);
    }
    localDatabase.copyStoreFrom(source,storeFetcher);
    log.info("Replaced store with one downloaded from %s",source);
    coreState.installSnapshot(coreSnapshot);
    log.info("Core snapshot installed: " + coreSnapshot);
    log.info("Restarting local database",source);
    localDatabase.start();
    log.info("Restarted local database",source);
  }
 catch (  IOException|ExecutionException e) {
    localDatabase.panic(e);
    throw new StoreCopyFailedException(e);
  }
}
