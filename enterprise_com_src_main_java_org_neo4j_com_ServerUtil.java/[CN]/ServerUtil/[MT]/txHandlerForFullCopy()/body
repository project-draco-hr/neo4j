{
  return new TxHandler(){
    private final Set<String> visitedDataSources=new HashSet<String>();
    @Override public void accept(    Triplet<String,Long,TxExtractor> tx,    XaDataSource dataSource){
      if (visitedDataSources.add(tx.first())) {
        dataSource.setLastCommittedTxId(tx.second() - 1);
        maintainLastCommittedTxIdInLog(dataSource);
      }
    }
    private void maintainLastCommittedTxIdInLog(    XaDataSource dataSource){
      long version=dataSource.getCurrentLogVersion();
      try {
        dataSource.rotateLogicalLog();
      }
 catch (      IOException e) {
        throw new RuntimeException("Fails to update last committed tx id in logical log for XA data source " + dataSource.getName(),e);
      }
      dataSource.deleteLogicalLog(version);
    }
    @Override public void done(){
    }
  }
;
}
