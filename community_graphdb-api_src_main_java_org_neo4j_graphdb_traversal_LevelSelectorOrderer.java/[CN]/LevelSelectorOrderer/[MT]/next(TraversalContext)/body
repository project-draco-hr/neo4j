{
  TraversalBranch branch=nextBranchFromCurrentSelector(metadata,false);
  Entry state=getStateForCurrentSelector();
  AtomicInteger previousDepth=state.depth;
  if (branch != null && branch.length() == previousDepth.get()) {
    return branch;
  }
  if (branch != null) {
    totalDepth.set(currentSide(),branch.length());
  }
  if ((stopDescentOnResult && metadata.getNumberOfPathsReturned() > 0) || totalDepth.get() > maxDepth + 1) {
    nextSelector();
    return null;
  }
  if (branch != null) {
    previousDepth.set(branch.length());
    state.branch=branch;
  }
  BranchSelector otherSelector=nextSelector();
  Entry otherState=getStateForCurrentSelector();
  TraversalBranch otherBranch=otherState.branch;
  if (otherBranch != null) {
    otherState.branch=null;
    return otherBranch;
  }
  otherBranch=otherSelector.next(metadata);
  return otherBranch != null ? otherBranch : branch;
}
