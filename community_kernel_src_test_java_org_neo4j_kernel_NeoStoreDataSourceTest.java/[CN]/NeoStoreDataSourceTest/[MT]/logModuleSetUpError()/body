{
  Config config=new Config(stringMap(),GraphDatabaseSettings.class);
  StoreFactory storeFactory=mock(StoreFactory.class);
  Throwable openStoresError=new RuntimeException("Can't set up modules");
  when(storeFactory.openAllNeoStores(true)).thenThrow(openStoresError);
  AssertableLogProvider logProvider=new AssertableLogProvider();
  CommunityIdTypeConfigurationProvider idTypeConfigurationProvider=new CommunityIdTypeConfigurationProvider();
  NeoStoreDataSource dataSource=ds.getDataSource(dir.graphDbDir(),fs.get(),config,storeFactory,new DefaultIdGeneratorFactory(fs.get(),idTypeConfigurationProvider),idTypeConfigurationProvider,mock(KernelHealth.class),logProvider);
  try {
    dataSource.start();
    fail("Exception expected");
  }
 catch (  Exception e) {
    assertEquals(openStoresError,e);
  }
  logProvider.assertAtLeastOnce(inLog(NeoStoreDataSource.class).warn(equalTo("Exception occurred while setting up store modules. Attempting to close things down."),equalTo(openStoresError)));
}
