{
  if (size == 0) {
    return EMPTY_BYTE_ARRAY;
  }
  byte[] heapBuffer=new byte[size];
  int index=0;
  while (index < size) {
    int toRead=Math.min(in.remaining(),size - index);
    in.get(heapBuffer,index,toRead);
    index+=toRead;
    if (in.remaining() == 0 && index < size) {
      in.attemptUpTo(size - index);
      if (in.remaining() == 0) {
        throw new EndOfStream("Expected " + (size - index) + " bytes available, "+ "but no more bytes accessible from underlying stream.");
      }
    }
  }
  return heapBuffer;
}
