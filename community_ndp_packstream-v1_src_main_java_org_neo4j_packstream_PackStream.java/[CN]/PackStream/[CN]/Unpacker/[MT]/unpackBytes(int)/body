{
  if (size == 0)   return EMPTY_BYTE_ARRAY;
  byte[] heapBuffer=new byte[size];
  int index=0;
  while (index < size) {
    int toRead=Math.min(buffer.remaining(),size - index);
    buffer.get(heapBuffer,index,toRead);
    index+=toRead;
    if (buffer.remaining() == 0 && index < size) {
      ensure(Math.min(size - index,buffer.capacity()));
    }
  }
  return heapBuffer;
}
