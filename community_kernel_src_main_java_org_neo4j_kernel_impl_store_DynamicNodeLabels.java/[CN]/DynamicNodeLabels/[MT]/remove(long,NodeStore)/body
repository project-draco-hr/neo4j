{
  nodeStore.ensureHeavy(node,firstDynamicLabelRecordId(labelField));
  Collection<DynamicRecord> existingRecords=node.getDynamicLabelRecords();
  long[] existingLabelIds=nodeStore.getDynamicLabelsArray(existingRecords);
  long[] newLabelIds=filter(existingLabelIds,labelId);
  if (InlineNodeLabels.tryInlineInNodeRecord(node,newLabelIds,existingRecords)) {
    setNotInUse(existingRecords);
  }
 else {
    Collection<DynamicRecord> newRecords=nodeStore.allocateRecordsForDynamicLabels(node.getId(),newLabelIds,existingRecords.iterator());
    node.setLabelField(dynamicPointer(newRecords),existingRecords);
    if (!newRecords.equals(existingRecords)) {
      for (      DynamicRecord record : existingRecords) {
        if (!newRecords.contains(record)) {
          record.setInUse(false);
          record.setLength(0);
        }
      }
    }
  }
  return existingRecords;
}
