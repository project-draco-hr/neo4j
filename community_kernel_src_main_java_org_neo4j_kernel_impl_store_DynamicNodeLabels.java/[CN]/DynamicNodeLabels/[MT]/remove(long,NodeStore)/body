{
  nodeStore.ensureHeavy(node,firstDynamicLabelRecordId(labelField));
  long[] existingLabelIds=nodeStore.getDynamicLabelsArray(node.getUsedDynamicLabelRecords());
  long[] newLabelIds=filter(existingLabelIds,labelId);
  Collection<DynamicRecord> existingRecords=node.getDynamicLabelRecords();
  if (InlineNodeLabels.tryInlineInNodeRecord(node,newLabelIds,existingRecords)) {
    setNotInUse(existingRecords);
  }
 else {
    Collection<DynamicRecord> newRecords=nodeStore.allocateRecordsForDynamicLabels(node.getId(),newLabelIds,existingRecords.iterator());
    node.setLabelField(dynamicPointer(newRecords),existingRecords);
    if (!newRecords.equals(existingRecords)) {
      for (      DynamicRecord record : existingRecords) {
        if (!newRecords.contains(record)) {
          record.setInUse(false);
        }
      }
    }
  }
  return existingRecords;
}
