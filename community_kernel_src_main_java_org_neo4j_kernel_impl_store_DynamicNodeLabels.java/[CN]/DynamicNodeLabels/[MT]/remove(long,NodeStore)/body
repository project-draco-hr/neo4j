{
  nodeStore.ensureHeavy(node,firstDynamicLabelRecordId(node.getLabelField()));
  long[] existingLabelIds=getDynamicLabelsArray(node.getUsedDynamicLabelRecords(),nodeStore.getDynamicLabelStore());
  long[] newLabelIds=filter(existingLabelIds,labelId);
  Collection<DynamicRecord> existingRecords=node.getDynamicLabelRecords();
  if (InlineNodeLabels.tryInlineInNodeRecord(node,newLabelIds,existingRecords)) {
    setNotInUse(existingRecords);
  }
 else {
    Collection<DynamicRecord> newRecords=allocateRecordsForDynamicLabels(node.getId(),newLabelIds,existingRecords.iterator(),nodeStore.getDynamicLabelStore());
    node.setLabelField(dynamicPointer(newRecords),existingRecords);
    if (!newRecords.equals(existingRecords)) {
      for (      DynamicRecord record : existingRecords) {
        if (!newRecords.contains(record)) {
          record.setInUse(false);
        }
      }
    }
  }
  return existingRecords;
}
