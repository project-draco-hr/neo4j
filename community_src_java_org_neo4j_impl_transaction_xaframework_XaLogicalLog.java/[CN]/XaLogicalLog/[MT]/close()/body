{
  if (fileChannel == null || !fileChannel.isOpen()) {
    log.info("Logical log: " + fileName + " already closed");
    return;
  }
  long endPosition=writeBuffer.getFileChannelPosition();
  if (xidIdentMap.size() > 0) {
    log.info("Close invoked with " + xidIdentMap.size() + " running transaction(s). ");
    if (writeBuffer != null) {
      writeBuffer.force();
    }
    writeBuffer=null;
    fileChannel.close();
    log.info("Dirty log: " + fileName + "."+ currentLog+ " now closed. Recovery will be started automatically next "+ "time it is opened.");
    return;
  }
  if (!keepLogs || backupSlave) {
    if (currentLog == CLEAN) {
      deleteCurrentLogFile(fileName);
    }
 else {
      deleteCurrentLogFile(fileName + "." + currentLog);
    }
  }
 else {
    renameCurrentLogFileAndIncrementVersion(fileName + "." + currentLog,endPosition);
  }
  if (currentLog != CLEAN) {
    setActiveLog(CLEAN);
  }
}
