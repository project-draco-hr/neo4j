{
  NodeRecord firstNode=nodeRecords.getOrLoad(firstNodeId,null).forChangingLinkage();
  if (!firstNode.inUse()) {
    throw new IllegalStateException("First node[" + firstNodeId + "] is deleted and cannot be used to create a relationship");
  }
  NodeRecord secondNode=nodeRecords.getOrLoad(secondNodeId,null).forChangingLinkage();
  if (!secondNode.inUse()) {
    throw new IllegalStateException("Second node[" + secondNodeId + "] is deleted and cannot be used to create a relationship");
  }
  convertNodeToDenseIfNecessary(firstNode);
  convertNodeToDenseIfNecessary(secondNode);
  RelationshipRecord record=relRecords.create(id,null).forChangingLinkage();
  record.setLinks(firstNodeId,secondNodeId,type);
  record.setInUse(true);
  record.setCreated();
  connectRelationship(firstNode,secondNode,record);
}
