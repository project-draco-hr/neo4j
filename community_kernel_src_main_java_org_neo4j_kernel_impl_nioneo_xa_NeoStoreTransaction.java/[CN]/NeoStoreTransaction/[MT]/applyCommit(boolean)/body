{
  try (LockGroup lockGroup=new LockGroup()){
    if (isRecovered && !prepared) {
      validateIndexUpdates();
    }
    committed=true;
    CommandSorter sorter=new CommandSorter();
    if (context.getRelationshipTypeTokenCommands().size() != 0) {
      java.util.Collections.sort(context.getRelationshipTypeTokenCommands(),sorter);
      for (      RelationshipTypeTokenCommand command : context.getRelationshipTypeTokenCommands()) {
        executor.execute(command);
        if (isRecovered) {
          addRelationshipType((int)command.getKey());
        }
      }
    }
    if (context.getLabelTokenCommands().size() != 0) {
      java.util.Collections.sort(context.getLabelTokenCommands(),sorter);
      for (      LabelTokenCommand command : context.getLabelTokenCommands()) {
        executor.execute(command);
        if (isRecovered) {
          addLabel((int)command.getKey());
        }
      }
    }
    if (context.getPropertyKeyTokenCommands().size() != 0) {
      java.util.Collections.sort(context.getPropertyKeyTokenCommands(),sorter);
      for (      PropertyKeyTokenCommand command : context.getPropertyKeyTokenCommands()) {
        executor.execute(command);
        if (isRecovered) {
          addPropertyKey((int)command.getKey());
        }
      }
    }
    java.util.Collections.sort(context.getRelCommands(),sorter);
    java.util.Collections.sort(context.getPropCommands(),sorter);
    executeCreated(lockGroup,isRecovered,context.getPropCommands(),context.getRelCommands(),context.getRelGroupCommands(),context.getNodeCommands().values());
    executeModified(lockGroup,isRecovered,context.getPropCommands(),context.getRelCommands(),context.getRelGroupCommands(),context.getNodeCommands().values());
    executeDeleted(lockGroup,context.getPropCommands(),context.getRelCommands(),context.getRelGroupCommands(),context.getNodeCommands().values());
    Collection<NodeLabelUpdate> labelUpdates=gatherLabelUpdatesSortedByNodeId();
    if (!labelUpdates.isEmpty()) {
      updateLabelScanStore(labelUpdates);
      cacheAccess.applyLabelUpdates(labelUpdates);
    }
    indexes.updateIndexes(indexUpdates);
    for (    SchemaRuleCommand command : context.getSchemaRuleCommands()) {
      command.setTxId(getCommitTxId());
      executor.execute(command);
switch (command.getMode()) {
case DELETE:
        cacheAccess.removeSchemaRuleFromCache(command.getKey());
      break;
default :
    cacheAccess.addSchemaRule(command.getSchemaRule());
}
}
if (context.getNeoStoreCommand().getRecord() != null) {
executor.execute(context.getNeoStoreCommand());
if (isRecovered) {
  removeGraphPropertiesFromCache();
}
}
if (!isRecovered) {
context.updateFirstRelationships();
context.commitCows(cacheAccess);
}
neoStore.setLastCommittedTx(getCommitTxId());
if (isRecovered) {
neoStore.updateIdGenerators();
}
}
  finally {
indexUpdates.close();
}
}
