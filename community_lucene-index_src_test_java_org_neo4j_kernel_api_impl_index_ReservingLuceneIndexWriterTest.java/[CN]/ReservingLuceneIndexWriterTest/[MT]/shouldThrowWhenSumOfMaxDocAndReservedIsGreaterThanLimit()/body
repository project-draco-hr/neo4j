{
  int maxDocLimit=100;
  int toAdd=maxDocLimit / 2;
  int toReserve=maxDocLimit - toAdd + 2;
  LuceneDocumentStructure documentStructure=new LuceneDocumentStructure();
  ReservingLuceneIndexWriter indexWriter=newReservingLuceneIndexWriter(maxDocLimit);
  indexWriter.reserveInsertions(toAdd);
  for (int i=0; i < toAdd; i++) {
    indexWriter.addDocument(documentStructure.reusedDocument(i));
  }
  try {
    indexWriter.reserveInsertions(toReserve);
    fail("Should have thrown " + IndexCapacityExceededException.class.getSimpleName());
  }
 catch (  IndexCapacityExceededException e) {
    assertThat(e.getMessage(),startsWith("Unable to reserve"));
  }
}
