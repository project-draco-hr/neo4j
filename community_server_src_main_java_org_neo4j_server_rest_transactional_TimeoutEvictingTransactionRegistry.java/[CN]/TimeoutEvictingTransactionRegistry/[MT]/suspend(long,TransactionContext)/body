{
  TransactionMarker marker=registry.get(id);
  if (null == marker) {
    throw new IllegalStateException("Trying to suspend unregistered transaction");
  }
  if (marker.isSuspended()) {
    throw new IllegalStateException("Trying to suspend transaction that was already suspended");
  }
  TransitionalTxManagementTransactionContext transitionalContext=transitionalContext(txContext);
  transitionalContext.suspendSinceTransactionsAreStillThreadBound();
  SuspendedTransaction transaction=new SuspendedTransaction(transitionalContext);
  if (!registry.replace(id,marker,transaction)) {
    throw new IllegalStateException("Trying to suspend transaction that has been concurrently suspended");
  }
}
