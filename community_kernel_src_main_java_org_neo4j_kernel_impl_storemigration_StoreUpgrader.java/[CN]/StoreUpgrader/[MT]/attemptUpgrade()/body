{
  try {
    File workingDirectory=new File(storageFileName).getParentFile();
    if (!new UpgradableStoreVersions().storeFilesUpgradeable(workingDirectory)) {
      throw new UnableToUpgradeException();
    }
    File upgradeDirectory=new File(workingDirectory,"upgrade");
    File backupDirectory=new File(workingDirectory,"upgrade_backup");
    upgradeDirectory.mkdir();
    String upgradeFileName=new File(upgradeDirectory,"neostore").getPath();
    Map<Object,Object> upgradeConfig=new HashMap<Object,Object>(originalConfig);
    upgradeConfig.put("neo_store",upgradeFileName);
    NeoStore.createStore(upgradeFileName,upgradeConfig);
    NeoStore neoStore=new NeoStore(upgradeConfig);
    new StoreMigrator(new LegacyStore(storageFileName)).migrateTo(neoStore);
    neoStore.close();
    backupDirectory.mkdir();
    moveStoreFiles(workingDirectory,backupDirectory);
    moveStoreFiles(upgradeDirectory,workingDirectory);
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
