{
  File migrationDirectory=new File(storeDirectory,MIGRATION_DIRECTORY);
  cleanupLegacyLeftOverDirsIn(storeDirectory);
  List<StoreMigrationParticipant> participantsNeedingMigration=getParticipantsEagerToMigrate(storeDirectory);
  if (participantsNeedingMigration.isEmpty()) {
    deleteSilently(migrationDirectory);
    return;
  }
  monitor.migrationNeeded();
  try {
    upgradeConfiguration.checkConfigurationAllowsAutomaticUpgrade();
  }
 catch (  UpgradeNotAllowedException e) {
    monitor.migrationNotAllowed();
    throw e;
  }
  try {
    File migrationStateFile=new File(migrationDirectory,MIGRATION_STATUS_FILE);
    if (!migrationStatusIs(migrationStateFile,MigrationStatus.moving)) {
      cleanMigrationDirectory(migrationDirectory);
      setMigrationStatus(migrationStateFile,MigrationStatus.migrating);
      migrateToIsolatedDirectory(participantsNeedingMigration,storeDirectory,migrationDirectory);
      setMigrationStatus(migrationStateFile,MigrationStatus.moving);
    }
    closeParticipants();
    moveMigratedFilesToWorkingDirectory(participantsNeedingMigration,migrationDirectory,storeDirectory);
    updateUpgradeTimeAndUpgradeId(storeDirectory);
    setMigrationStatus(migrationStateFile,MigrationStatus.completed);
    cleanup(participantsNeedingMigration,migrationDirectory);
    monitor.migrationCompleted();
  }
  finally {
    closeParticipants();
  }
}
