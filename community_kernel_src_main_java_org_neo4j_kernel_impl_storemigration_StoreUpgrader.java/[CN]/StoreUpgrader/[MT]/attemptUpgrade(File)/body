{
  upgradeConfiguration.checkConfigurationAllowsAutomaticUpgrade();
  upgradableDatabase.checkUpgradeable(storageFileName);
  File workingDirectory=storageFileName.getParentFile();
  File upgradeDirectory=new File(workingDirectory,"upgrade");
  File backupDirectory=new File(workingDirectory,"upgrade_backup");
  migrateToIsolatedDirectory(storageFileName,upgradeDirectory);
  databaseFiles.moveToBackupDirectory(workingDirectory,backupDirectory);
  backupMessagesLogLeavingInPlaceForNewDatabaseMessages(workingDirectory,backupDirectory);
  databaseFiles.moveToWorkingDirectory(upgradeDirectory,workingDirectory);
}
