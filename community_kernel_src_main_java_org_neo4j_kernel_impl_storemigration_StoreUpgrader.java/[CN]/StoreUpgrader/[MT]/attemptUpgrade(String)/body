{
  upgradeConfiguration.checkConfigurationAllowsAutomaticUpgrade();
  upgradableDatabase.checkUpgradeable(new File(storageFileName));
  File workingDirectory=new File(storageFileName).getParentFile();
  File upgradeDirectory=new File(workingDirectory,"upgrade");
  File backupDirectory=new File(workingDirectory,"upgrade_backup");
  migrateToIsolatedDirectory(storageFileName,upgradeDirectory);
  databaseFiles.moveToBackupDirectory(workingDirectory,backupDirectory);
  backupMessagesLogLeavingInPlaceForNewDatabaseMessages(workingDirectory,backupDirectory);
  databaseFiles.moveToWorkingDirectory(upgradeDirectory,workingDirectory);
}
