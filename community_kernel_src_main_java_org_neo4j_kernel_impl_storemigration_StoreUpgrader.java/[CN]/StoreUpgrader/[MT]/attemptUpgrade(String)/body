{
  if (!configSaysOkToUpgrade()) {
    throw new UpgradeNotAllowedByConfigurationException(String.format("To enable automatic upgrade, please set %s in configuration properties",Config.ALLOW_STORE_UPGRADE));
  }
  try {
    File workingDirectory=new File(storageFileName).getParentFile();
    if (!new UpgradableStoreVersions().storeFilesUpgradeable(workingDirectory)) {
      throw new UnableToUpgradeException();
    }
    File upgradeDirectory=new File(workingDirectory,"upgrade");
    File backupDirectory=new File(workingDirectory,"upgrade_backup");
    upgradeDirectory.mkdir();
    String upgradeFileName=new File(upgradeDirectory,NeoStore.DEFAULT_NAME).getPath();
    Map<Object,Object> upgradeConfig=new HashMap<Object,Object>(originalConfig);
    upgradeConfig.put("neo_store",upgradeFileName);
    NeoStore.createStore(upgradeFileName,upgradeConfig);
    NeoStore neoStore=new NeoStore(upgradeConfig);
    new StoreMigrator(new LegacyStore(storageFileName)).migrateTo(neoStore);
    neoStore.close();
    backupDirectory.mkdir();
    StoreFiles.move(workingDirectory,backupDirectory);
    LogFiles.move(workingDirectory,backupDirectory);
    FileUtils.copyFile(new File(workingDirectory,"messages.log"),new File(backupDirectory,"messages.log"));
    StoreFiles.move(upgradeDirectory,workingDirectory);
    LogFiles.move(upgradeDirectory,workingDirectory);
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
