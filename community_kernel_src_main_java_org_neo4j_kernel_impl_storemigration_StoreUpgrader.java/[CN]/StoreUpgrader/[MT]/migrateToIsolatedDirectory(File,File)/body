{
  if (upgradeDirectory.exists()) {
    try {
      FileUtils.deleteRecursively(upgradeDirectory);
    }
 catch (    IOException e) {
      throw new UnableToUpgradeException(e);
    }
  }
  fileSystemAbstraction.mkdir(upgradeDirectory);
  File upgradeFileName=new File(upgradeDirectory,NeoStore.DEFAULT_NAME);
  Map<String,String> upgradeConfig=new HashMap<String,String>(originalConfig.getParams());
  upgradeConfig.put("neo_store",upgradeFileName.getPath());
  Config upgradeConfiguration=new Config(upgradeConfig);
  NeoStore neoStore=new StoreFactory(upgradeConfiguration,idGeneratorFactory,new DefaultWindowPoolFactory(),fileSystemAbstraction,StringLogger.DEV_NULL,null).createNeoStore(upgradeFileName);
  try {
    storeMigrator.migrate(new LegacyStore(fileSystemAbstraction,storageFileName,StringLogger.DEV_NULL),neoStore);
  }
 catch (  IOException e) {
    e.printStackTrace();
    throw new UnableToUpgradeException(e);
  }
catch (  Exception e) {
    e.printStackTrace();
    throw Exceptions.launderedException(e);
  }
 finally {
    neoStore.close();
  }
}
