{
  if (upgradeDirectory.exists()) {
    try {
      FileUtils.deleteRecursively(upgradeDirectory);
    }
 catch (    IOException e) {
      throw new UnableToUpgradeException(e);
    }
  }
  upgradeDirectory.mkdir();
  String upgradeFileName=new File(upgradeDirectory,NeoStore.DEFAULT_NAME).getPath();
  Map<Object,Object> upgradeConfig=new HashMap<Object,Object>(originalConfig);
  upgradeConfig.put("neo_store",upgradeFileName);
  NeoStore.createStore(upgradeFileName,upgradeConfig);
  NeoStore neoStore=new NeoStore(upgradeConfig);
  try {
    storeMigrator.migrate(new LegacyStore(storageFileName),neoStore);
  }
 catch (  IOException e) {
    throw new UnableToUpgradeException(e);
  }
 finally {
    neoStore.close();
  }
}
