{
  Pair<Map<String,String>,Boolean> result=findIndexConfig(cls,indexName,suppliedConfig,config.getParams());
  boolean createdNow=false;
  if (result.other()) {
synchronized (this) {
      Map<String,String> existing=indexStore.get(cls,indexName);
      if (existing != null) {
        assertConfigMatches(indexProviders.getTransactionAPI(existing.get(PROVIDER)),indexName,existing,result.first());
        return Pair.of(result.first(),false);
      }
      ExecutorService executorService=Executors.newSingleThreadExecutor();
      try {
        executorService.submit(new IndexCreatorJob(cls,indexName,result.first())).get();
        indexStore.set(cls,indexName,result.first());
        createdNow=true;
      }
 catch (      ExecutionException ex) {
        throw new TransactionFailureException("Index creation failed for " + indexName + ", "+ result.first(),ex.getCause());
      }
catch (      InterruptedException ex) {
        Thread.interrupted();
      }
 finally {
        executorService.shutdownNow();
      }
    }
  }
  return Pair.of(result.first(),createdNow);
}
