{
  if (!backupSlave) {
    throw new IllegalStateException("This is not a backup slave");
  }
  if (xidIdentMap.size() > 0) {
    throw new IllegalStateException("There are active transactions");
  }
  long[] header=readLogHeader(buffer,byteChannel,true);
  logVersion=header[0];
  long previousCommittedTx=header[1];
  if (logVersion != xaTf.getCurrentVersion()) {
    throw new IllegalStateException("Tried to apply version " + logVersion + " but expected version "+ xaTf.getCurrentVersion());
  }
  log.fine("Logical log version: " + logVersion + "(previous committed tx="+ previousCommittedTx+ ")");
  long logEntriesFound=0;
  LogApplier logApplier=new LogApplier(byteChannel);
  while (logApplier.readAndApplyEntry()) {
    logEntriesFound++;
  }
  byteChannel.close();
  xaTf.flushAll();
  xaTf.getAndSetNewVersion();
  xaRm.reset();
  log.info("Log[" + fileName + "] version "+ logVersion+ " applied successfully.");
}
