{
  IdGeneratorFactory idGeneratorFactory=mock(IdGeneratorFactory.class);
  IdGenerator idGenerator=mock(IdGenerator.class);
  when(idGenerator.nextId()).thenReturn(1L);
  when(idGeneratorFactory.get(any(IdType.class))).thenReturn(idGenerator);
  StorageEngine storageEngine=mockedStorageEngine();
  when(dependencies.resolveDependency(StorageEngine.class)).thenReturn(storageEngine);
  StateMachines stateMachines=new StateMachines();
  RaceConditionSimulatingReplicator replicator=new RaceConditionSimulatingReplicator(stateMachines);
  ReplicatedTokenHolder<Token,LabelTokenRecord> tokenHolder=new ReplicatedLabelTokenHolder(replicator,idGeneratorFactory,dependencies,TIMEOUT_MILLIS,NullLogProvider.getInstance());
  stateMachines.add(tokenHolder);
  tokenHolder.setLastCommittedIndex(-1);
  tokenHolder.start();
  replicator.injectLabelTokenBeforeOtherOneReplicates(new ReplicatedTokenRequest(LABEL,"Person",createCommandBytes(createCommands(INJECTED_TOKEN_ID))));
  int tokenId=tokenHolder.getOrCreateId("Person");
  assertEquals(INJECTED_TOKEN_ID,tokenId);
}
