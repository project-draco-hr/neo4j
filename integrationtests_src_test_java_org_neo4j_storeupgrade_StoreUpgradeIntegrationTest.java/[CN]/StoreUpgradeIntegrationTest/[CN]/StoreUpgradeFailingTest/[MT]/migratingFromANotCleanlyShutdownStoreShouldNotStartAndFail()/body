{
  File dir=AbstractNeo4jTestCase.unzip(testDir.graphDbDir(),getClass(),"0.A.3-to-be-recovered.zip");
  new File(dir,"messages.log").delete();
  GraphDatabaseFactory factory=new TestGraphDatabaseFactory();
  GraphDatabaseBuilder builder=factory.newEmbeddedDatabaseBuilder(dir);
  builder.setConfig(GraphDatabaseSettings.allow_store_upgrade,"true");
  builder.setConfig(GraphDatabaseSettings.pagecache_memory,"8m");
  try {
    GraphDatabaseService db=builder.newGraphDatabase();
    db.shutdown();
    fail("It should have failed.");
  }
 catch (  RuntimeException ex) {
    assertTrue(ex.getCause() instanceof LifecycleException);
    Throwable realException=ex.getCause().getCause();
    assertTrue(Exceptions.contains(realException,MetaDataStore.DEFAULT_NAME,StoreUpgrader.UnexpectedUpgradingStoreVersionException.class));
  }
}
