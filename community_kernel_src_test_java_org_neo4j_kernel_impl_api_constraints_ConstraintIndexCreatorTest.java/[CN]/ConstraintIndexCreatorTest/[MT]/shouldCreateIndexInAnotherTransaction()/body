{
  StatementOperationParts constraintCreationContext=mockedParts();
  StatementOperationParts indexCreationContext=mockedParts();
  IndexDescriptor descriptor=new IndexDescriptor(123,456);
  KernelStatement state=mockedState();
  IndexingService indexingService=mock(IndexingService.class);
  StubKernel kernel=new StubKernel();
  when(constraintCreationContext.schemaReadOperations().indexGetCommittedId(state,descriptor,CONSTRAINT)).thenReturn(2468l);
  IndexProxy indexProxy=mock(IndexProxy.class);
  when(indexingService.getProxyForRule(2468l)).thenReturn(indexProxy);
  ConstraintIndexCreator creator=new ConstraintIndexCreator(Providers.<KernelAPI>singletonProvider(kernel),indexingService);
  long indexId=creator.createUniquenessConstraintIndex(state,constraintCreationContext.schemaReadOperations(),123,456);
  assertEquals(2468l,indexId);
  assertEquals(1,kernel.statements.size());
  verify(kernel.statements.get(0).txState()).constraintIndexRuleDoAdd(descriptor);
  verifyNoMoreInteractions(indexCreationContext.schemaWriteOperations());
  verify(constraintCreationContext.schemaReadOperations()).indexGetCommittedId(state,descriptor,CONSTRAINT);
  verifyNoMoreInteractions(constraintCreationContext.schemaReadOperations());
  verify(indexProxy).awaitStoreScanCompleted();
}
