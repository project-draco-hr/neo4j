{
  T con=null;
  Transaction tx=this.getCurrentTransaction();
  if (tx == null) {
    throw new NotInTransactionException();
  }
  con=txConnectionMap.get(tx);
  if (con == null) {
    try {
      con=(T)newConnection();
      if (!tx.enlistResource(con.getXaResource())) {
        throw new RuntimeException("Unable to enlist '" + con.getXaResource() + "' in "+ tx);
      }
      tx.registerSynchronization(new TxCommitHook(tx));
      txConnectionMap.put(tx,con);
    }
 catch (    javax.transaction.RollbackException re) {
      String msg="The transaction is marked for rollback only.";
      throw new RuntimeException(msg,re);
    }
catch (    javax.transaction.SystemException se) {
      String msg="TM encountered an unexpected error condition.";
      throw new RuntimeException(msg,se);
    }
  }
  return con;
}
