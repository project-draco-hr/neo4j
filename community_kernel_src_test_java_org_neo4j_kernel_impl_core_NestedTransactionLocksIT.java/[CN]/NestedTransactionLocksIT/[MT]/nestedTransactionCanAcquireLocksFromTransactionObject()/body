{
  Transaction realTx=db.beginTx();
  Node resource=db.getReferenceNode();
  Transaction nestedTx=db.beginTx();
  assertNotSame(realTx,nestedTx);
  OtherThreadExecutor<Void> otherTx=new OtherThreadExecutor<Void>("other thread",null);
  Lock lock=nestedTx.acquireWriteLock(resource);
  Future<Lock> future=otherTx.executeDontWait(acquireWriteLock(resource));
  otherTx.waitUntilWaiting();
  try {
    future.get(1,SECONDS);
    fail("The nested transaction seems to not have acquired the lock");
  }
 catch (  TimeoutException e) {
  }
  lock.release();
  assertNotNull(future.get());
  otherTx.shutdown();
}
