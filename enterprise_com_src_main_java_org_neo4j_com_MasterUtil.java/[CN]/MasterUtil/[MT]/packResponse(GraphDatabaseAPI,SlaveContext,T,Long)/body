{
  List<Triplet<String,Long,TxExtractor>> stream=new ArrayList<Triplet<String,Long,TxExtractor>>();
  Set<String> resourceNames=new HashSet<String>();
  XaDataSourceManager dsManager=graphDb.getXaDataSourceManager();
  final List<LogExtractor> logExtractors=new ArrayList<LogExtractor>();
  try {
    for (    Tx txEntry : context.lastAppliedTransactions()) {
      String resourceName=txEntry.getDataSourceName();
      final XaDataSource dataSource=dsManager.getXaDataSource(resourceName);
      if (dataSource == null) {
        throw new RuntimeException("No data source '" + resourceName + "' found");
      }
      resourceNames.add(resourceName);
      long masterLastTx=dataSource.getLastCommittedTxId();
      if (txEntry.getTxId() >= masterLastTx)       continue;
      long endTx=endTxOrNull == null ? masterLastTx : Math.min(masterLastTx,endTxOrNull.longValue());
      LogExtractor logExtractor=getTransactionStreamForDatasource(dataSource,txEntry.getTxId() + 1,endTx,stream);
      logExtractors.add(logExtractor);
    }
    StoreId storeId=dsManager.getNeoStoreDataSource().getStoreId();
    return new Response<T>(response,storeId,createTransactionStream(resourceNames,stream,logExtractors),ResourceReleaser.NO_OP);
  }
 catch (  Throwable t) {
    for (    LogExtractor extractor : logExtractors)     extractor.close();
    throw Exceptions.launderedException(t);
  }
}
