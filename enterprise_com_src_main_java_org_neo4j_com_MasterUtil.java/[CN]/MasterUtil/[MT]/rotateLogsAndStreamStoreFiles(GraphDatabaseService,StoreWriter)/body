{
  if (Config.osIsWindows()) {
    throw new UnsupportedOperationException("Streaming store files live (as used in HA and backup) " + "isn't supported on Windows due to limitations in OS/filesystem");
  }
  File baseDir=getBaseDir(graphDb);
  XaDataSourceManager dsManager=((AbstractGraphDatabase)graphDb).getConfig().getTxModule().getXaDataSourceManager();
  Collection<XaDataSource> sources=dsManager.getAllRegisteredDataSources();
  @SuppressWarnings("unchecked") Pair<String,Long>[] appliedTransactions=new Pair[sources.size()];
  int i=0;
  for (  XaDataSource ds : sources) {
    appliedTransactions[i++]=Pair.of(ds.getName(),ds.getLastCommittedTxId());
    try {
      ds.getXaContainer().getResourceManager().rotateLogicalLog();
    }
 catch (    IOException e) {
      throw new MasterFailureException(e);
    }
  }
  SlaveContext context=new SlaveContext(-1,-1,appliedTransactions);
  ByteBuffer temporaryBuffer=ByteBuffer.allocateDirect(1024 * 1024);
  for (  XaDataSource ds : sources) {
    try {
      ClosableIterable<File> files=ds.listStoreFiles();
      try {
        for (        File storefile : files) {
          FileInputStream stream=new FileInputStream(storefile);
          try {
            writer.write(relativePath(baseDir,storefile),stream.getChannel(),temporaryBuffer,storefile.length() > 0);
          }
  finally {
            stream.close();
          }
        }
      }
  finally {
        files.close();
      }
    }
 catch (    IOException e) {
      throw new MasterFailureException(e);
    }
  }
  return context;
}
