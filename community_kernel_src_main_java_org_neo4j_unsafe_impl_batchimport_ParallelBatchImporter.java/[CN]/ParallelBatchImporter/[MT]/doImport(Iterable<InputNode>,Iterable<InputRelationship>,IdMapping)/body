{
  logger.info("Import starting");
  long startTime=currentTimeMillis();
  try (BatchingNeoStore neoStore=new BatchingNeoStore(fileSystem,storeDir,config,writeMonitor,logging,writerFactory)){
    IdMapper idMapper=idMapping.idMapper();
    IdGenerator idGenerator=idMapping.idGenerator();
    NodeRelationshipLink nodeRelationshipLink=new NodeRelationshipLinkImpl(LongArrayFactory.AUTO,config.denseNodeThreshold());
    NodeStage nodeStage=new NodeStage(nodes.iterator(),idMapper,idGenerator,neoStore);
    CalculateDenseNodesStage calculateDenseNodesStage=new CalculateDenseNodesStage(relationships.iterator(),nodeRelationshipLink,idMapper);
    if (idMapper.needsPreparation()) {
      executeStages(nodeStage);
      executeStages(calculateDenseNodesStage);
    }
 else {
      executeStages(nodeStage,calculateDenseNodesStage);
    }
    executeStages(new RelationshipStage(relationships.iterator(),idMapper,neoStore,nodeRelationshipLink));
    writerFactory.awaitEverythingWritten();
    neoStore.switchToUpdateMode();
    executeStages(new NodeFirstRelationshipStage(neoStore,nodeRelationshipLink));
    nodeRelationshipLink.clearRelationships();
    executeStages(new RelationshipLinkbackStage(neoStore,nodeRelationshipLink));
    executionMonitor.done(currentTimeMillis() - startTime);
  }
 catch (  Throwable t) {
    logger.error("Error during import",t);
    throw Exceptions.launderedException(IOException.class,t);
  }
 finally {
    writerFactory.shutdown();
  }
  logger.info("Import completed");
}
