{
  if (xaRes == null) {
    throw new IllegalArgumentException("Null xa resource");
  }
  if (status == Status.STATUS_ACTIVE || status == Status.STATUS_PREPARING) {
    try {
      if (resourceList.size() == 0) {
        ensureGlobalTxStartRecordWritten();
        registerAndStartResource(xaRes);
      }
 else {
        Pair<Xid,ResourceElement> similarResource=findAlreadyRegisteredSimilarResource(xaRes);
        if (similarResource.other() != null) {
          ResourceElement resource=similarResource.other();
          xaRes.start(resource.getXid(),resource.getStatus() == RS_SUSPENDED ? XAResource.TMRESUME : XAResource.TMJOIN);
          resource.setStatus(RS_ENLISTED);
        }
 else         if (similarResource.first() != null) {
          Xid xid=similarResource.first();
          addResourceToList(xid,xaRes);
          xaRes.start(xid,XAResource.TMJOIN);
        }
 else {
          registerAndStartResource(xaRes);
        }
      }
      return true;
    }
 catch (    XAException e) {
      logger.error("Unable to enlist resource[" + xaRes + "]",e);
      status=Status.STATUS_MARKED_ROLLBACK;
      return false;
    }
  }
 else   if (status == Status.STATUS_ROLLING_BACK || status == Status.STATUS_ROLLEDBACK || status == Status.STATUS_MARKED_ROLLBACK) {
    throw new RollbackException("Tx status is: " + txManager.getTxStatusAsString(status));
  }
  throw new IllegalStateException("Tx status is: " + txManager.getTxStatusAsString(status));
}
