{
  byte branchId[]=txManager.getBranchId(xaRes);
  Xid xid=new XidImpl(globalId,branchId);
  addResourceToList(xid,xaRes);
  xaRes.start(xid,XAResource.TMNOFLAGS);
  try {
    txManager.getTxLog().addBranch(globalId,branchId);
  }
 catch (  IOException e) {
    logger.error("Error writing transaction log",e);
    txManager.setTmNotOk(e);
    throw Exceptions.withCause(new SystemException("TM encountered a problem, " + " error writing transaction log"),e);
  }
}
