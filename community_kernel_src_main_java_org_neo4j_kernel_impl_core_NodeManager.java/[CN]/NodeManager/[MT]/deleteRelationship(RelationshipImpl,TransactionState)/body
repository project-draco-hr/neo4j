{
  NodeImpl startNode;
  NodeImpl endNode;
  boolean success=false;
  try {
    tx=getTransactionState();
    long startNodeId=rel.getStartNodeId();
    startNode=getLightNode(startNodeId);
    if (startNode != null) {
      tx.acquireWriteLock(newNodeProxyById(startNodeId));
    }
    long endNodeId=rel.getEndNodeId();
    endNode=getLightNode(endNodeId);
    if (endNode != null) {
      tx.acquireWriteLock(newNodeProxyById(endNodeId));
    }
    tx.acquireWriteLock(newRelationshipProxyById(rel.getId()));
    ArrayMap<Integer,PropertyData> skipMap=tx.getOrCreateCowPropertyRemoveMap(rel);
    tx.deleteRelationship(rel.getId());
    ArrayMap<Integer,PropertyData> removedProps=persistenceManager.relDelete(rel.getId());
    if (removedProps.size() > 0) {
      for (      int index : removedProps.keySet()) {
        skipMap.put(index,removedProps.get(index));
      }
    }
    success=true;
    int typeId=rel.getTypeId();
    long id=rel.getId();
    if (startNode != null) {
      tx.getOrCreateCowRelationshipRemoveMap(startNode,typeId).add(id);
    }
    if (endNode != null) {
      tx.getOrCreateCowRelationshipRemoveMap(endNode,typeId).add(id);
    }
    success=true;
    return removedProps;
  }
  finally {
    if (!success) {
      setRollbackOnly();
    }
  }
}
