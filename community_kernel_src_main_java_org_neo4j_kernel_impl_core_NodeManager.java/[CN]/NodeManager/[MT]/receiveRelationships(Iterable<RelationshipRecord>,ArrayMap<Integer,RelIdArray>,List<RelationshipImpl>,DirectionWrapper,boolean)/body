{
  for (  RelationshipRecord rel : rels) {
    long relId=rel.getId();
    RelationshipImpl relImpl=relCache.get(relId);
    int typeId;
    if (relImpl == null) {
      typeId=rel.getType();
      relImpl=newRelationshipImpl(relId,rel.getFirstNode(),rel.getSecondNode(),typeId,false);
      relsList.add(relImpl);
    }
 else {
      typeId=relImpl.getTypeId();
    }
    RelIdArray relationshipSet=newRelationshipMap.get(typeId);
    if (relationshipSet == null) {
      relationshipSet=hasLoops ? new RelIdArrayWithLoops(typeId) : new RelIdArray(typeId);
      newRelationshipMap.put(typeId,relationshipSet);
    }
    relationshipSet.add(relId,dir);
  }
}
