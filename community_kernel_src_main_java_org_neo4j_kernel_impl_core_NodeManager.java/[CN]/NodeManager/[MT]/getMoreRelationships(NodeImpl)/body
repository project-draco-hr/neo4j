{
  long nodeId=node.getId();
  long position=node.getRelChainPosition();
  Pair<Map<DirectionWrapper,Iterable<RelationshipRecord>>,Long> rels=persistenceManager.getMoreRelationships(nodeId,position);
  node.setRelChainPosition(rels.other());
  ArrayMap<String,RelIdArray> newRelationshipMap=new ArrayMap<String,RelIdArray>();
  Map<Long,RelationshipImpl> relsMap=new HashMap<Long,RelationshipImpl>(150);
  Iterable<RelationshipRecord> loops=rels.first().get(DirectionWrapper.BOTH);
  boolean hasLoops=loops != null;
  if (hasLoops) {
    receiveRelationships(loops,newRelationshipMap,relsMap,DirectionWrapper.BOTH,true);
  }
  receiveRelationships(rels.first().get(DirectionWrapper.OUTGOING),newRelationshipMap,relsMap,DirectionWrapper.OUTGOING,hasLoops);
  receiveRelationships(rels.first().get(DirectionWrapper.INCOMING),newRelationshipMap,relsMap,DirectionWrapper.INCOMING,hasLoops);
  return Pair.of(newRelationshipMap,relsMap);
}
