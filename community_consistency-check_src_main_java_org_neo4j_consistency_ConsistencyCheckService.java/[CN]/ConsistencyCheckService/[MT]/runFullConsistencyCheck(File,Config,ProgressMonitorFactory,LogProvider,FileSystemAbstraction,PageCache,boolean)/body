{
  Log log=logProvider.getLog(getClass());
  Config consistencyCheckerConfig=tuningConfiguration.with(MapUtil.stringMap(GraphDatabaseSettings.read_only.name(),Settings.TRUE));
  StoreFactory factory=new StoreFactory(storeDir,consistencyCheckerConfig,new DefaultIdGeneratorFactory(fileSystem),pageCache,fileSystem,logProvider);
  ConsistencySummaryStatistics summary;
  final File reportFile=chooseReportPath(storeDir,tuningConfiguration);
  Log reportLog=new ConsistencyReportLog(Suppliers.lazySingleton(new Supplier<PrintWriter>(){
    @Override public PrintWriter get(){
      try {
        return new PrintWriter(createOrOpenAsOuputStream(fileSystem,reportFile,true));
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
    }
  }
));
  try (NeoStores neoStores=factory.openNeoStores(false)){
    LabelScanStore labelScanStore=null;
    try {
      labelScanStore=new LuceneLabelScanStoreBuilder(storeDir,neoStores,fileSystem,logProvider).build();
      SchemaIndexProvider indexes=new LuceneSchemaIndexProvider(fileSystem,DirectoryFactory.PERSISTENT,storeDir);
      int numberOfThreads=defaultConsistencyCheckThreadsNumber();
      Statistics statistics;
      StoreAccess storeAccess;
      AccessStatistics stats=new AccessStatistics();
      if (verbose) {
        statistics=new VerboseStatistics(stats,new DefaultCounts(numberOfThreads),log);
        storeAccess=new AccessStatsKeepingStoreAccess(neoStores,stats);
      }
 else {
        statistics=Statistics.NONE;
        storeAccess=new StoreAccess(neoStores);
      }
      storeAccess.initialize();
      DirectStoreAccess stores=new DirectStoreAccess(storeAccess,labelScanStore,indexes);
      FullCheck check=new FullCheck(tuningConfiguration,progressFactory,statistics,numberOfThreads);
      summary=check.execute(stores,new DuplicatingLog(log,reportLog));
    }
  finally {
      try {
        if (null != labelScanStore) {
          labelScanStore.shutdown();
        }
      }
 catch (      IOException e) {
        log.error("Failure during shutdown of label scan store",e);
      }
    }
  }
   if (!summary.isConsistent()) {
    log.warn("See '%s' for a detailed consistency report.",reportFile.getPath());
    return Result.FAILURE;
  }
  return Result.SUCCESS;
}
