{
  ensurePathIsLocked(backupPath);
  try {
    File mainDbPath=new File(DatabaseLocator.getDatabaseLocation()).getAbsoluteFile();
    setupBackupFolders(backupPath);
    boolean wasRunning=DatabaseLocator.databaseIsRunning();
    if (wasRunning) {
      DatabaseLocator.shutdownAndBlockGraphDatabase();
    }
    cpTree(mainDbPath,backupPath);
    ServerConfiguration.getInstance().set("keep_logical_logs","true");
    if (wasRunning) {
      DatabaseLocator.unblockGraphDatabase();
      DatabaseLocator.getGraphDatabase();
    }
  }
 catch (  IOException e) {
    throw new BackupFailedException("IOException while creating backup foundation, see nested.",e);
  }
catch (  DatabaseBlockedException e) {
    e.printStackTrace();
  }
 finally {
    lockedPaths.remove(backupPath);
  }
}
