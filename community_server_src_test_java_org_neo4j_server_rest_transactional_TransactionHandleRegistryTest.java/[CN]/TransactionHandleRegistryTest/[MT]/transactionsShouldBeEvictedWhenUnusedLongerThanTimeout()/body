{
  FakeClock clock=new FakeClock();
  AssertableLogProvider logProvider=new AssertableLogProvider();
  TransactionHandleRegistry registry=new TransactionHandleRegistry(clock,0,logProvider);
  TransactionHandle oldTx=mock(TransactionHandle.class);
  TransactionHandle newTx=mock(TransactionHandle.class);
  TransactionHandle handle=mock(TransactionHandle.class);
  long txId1=registry.begin(handle);
  long txId2=registry.begin(handle);
  registry.release(txId1,oldTx);
  clock.forward(1,TimeUnit.MINUTES);
  registry.release(txId2,newTx);
  registry.rollbackSuspendedTransactionsIdleSince(clock.millis() - 1000);
  assertThat(registry.acquire(txId2),equalTo(newTx));
  try {
    registry.acquire(txId1);
    fail("Should have thrown exception");
  }
 catch (  InvalidTransactionId e) {
  }
  logProvider.assertExactly(inLog(TransactionHandleRegistry.class).info("Transaction with id 1 has been automatically rolled back."));
}
