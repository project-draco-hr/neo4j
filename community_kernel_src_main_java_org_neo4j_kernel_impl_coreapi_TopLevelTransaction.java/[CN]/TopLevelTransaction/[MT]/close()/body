{
  try {
    if (transaction.isOpen()) {
      transaction.close();
    }
  }
 catch (  TransientFailureException e) {
    throw e;
  }
catch (  ConstraintViolationTransactionFailureException e) {
    throw new ConstraintViolationException(e.getMessage(),e);
  }
catch (  Exception e) {
    String userMessage=successCalled ? "Transaction was marked as successful, but unable to commit transaction so rolled back." : "Unable to rollback transaction";
    if (e instanceof KernelException && ((KernelException)e).status().code().classification() == Classification.TransientError) {
      throw new TransientTransactionFailureException(userMessage,e);
    }
    throw new TransactionFailureException(userMessage,e);
  }
}
