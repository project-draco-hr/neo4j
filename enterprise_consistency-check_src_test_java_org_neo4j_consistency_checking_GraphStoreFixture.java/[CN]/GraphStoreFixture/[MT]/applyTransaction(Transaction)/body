{
  GraphDatabaseAPI database=(GraphDatabaseAPI)new GraphDatabaseFactory().newEmbeddedDatabaseBuilder(directory).setConfig(configuration(false)).newGraphDatabase();
  try {
    try (org.neo4j.graphdb.Transaction tx=database.beginTx()){
      NeoStoreXaDataSource dataSource=database.getDependencyResolver().resolveDependency(XaDataSourceManager.class).getNeoStoreDataSource();
      dataSource.applyPreparedTransaction(write(transaction,dataSource.getLastCommittedTxId()));
      tx.success();
    }
   }
  finally {
    database.shutdown();
  }
}
