{
  GraphDatabaseAPI database=(GraphDatabaseAPI)new GraphDatabaseFactory().newEmbeddedDatabaseBuilder(directory).setConfig(configuration(false)).newGraphDatabase();
  try (org.neo4j.graphdb.Transaction tx=database.beginTx()){
    DependencyResolver resolver=database.getDependencyResolver();
    XaDataSourceManager xaDataSourceManager=resolver.resolveDependency(XaDataSourceManager.class);
    NeoStoreXaDataSource dataSource=xaDataSourceManager.getNeoStoreDataSource();
    dataSource.applyPreparedTransaction(write(transaction,dataSource.getLastCommittedTxId()));
    tx.success();
  }
  finally {
    database.shutdown();
  }
}
