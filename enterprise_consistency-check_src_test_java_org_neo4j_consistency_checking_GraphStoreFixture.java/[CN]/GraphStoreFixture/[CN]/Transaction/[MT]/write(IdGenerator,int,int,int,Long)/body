{
  InMemoryLogBuffer buffer=new InMemoryLogBuffer();
  TransactionWriter writer=new TransactionWriter(buffer,localId);
  writer.start(globalId,masterId,myId,startTimestamp,txId == null ? 0l : txId);
  transactionData(new TransactionDataBuilder(writer),idGenerator);
  writer.prepare();
  if (txId != null) {
    writer.commit(false,txId);
    writer.done();
  }
  return buffer;
}
