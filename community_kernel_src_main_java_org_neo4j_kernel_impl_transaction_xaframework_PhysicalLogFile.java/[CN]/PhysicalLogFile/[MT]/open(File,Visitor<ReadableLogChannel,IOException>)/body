{
  PhysicalLogVersionedStoreChannel channel=openFileChannel(fileToOpen,"rw");
  if (new XaLogicalLogRecoveryCheck(channel).recoveryRequired()) {
    long[] header=readLogHeader(headerBuffer,channel,true);
    transactionIdStore.setCurrentLogVersion(currentLogVersion=header[0]);
    ReadableLogChannel recoveredDataChannel=new ReadAheadLogChannel(channel,NO_MORE_CHANNELS,ReadAheadLogChannel.DEFAULT_READ_AHEAD_SIZE);
    recoveredDataVisitor.visit(recoveredDataChannel);
    logRotationControl.forceEverything();
  }
 else {
    currentLogVersion=transactionIdStore.getCurrentLogVersion();
    long version=logFiles.determineNextLogVersion(currentLogVersion);
    if (version != currentLogVersion) {
      transactionIdStore.setCurrentLogVersion(currentLogVersion=version);
    }
    long lastTxId=transactionIdStore.getLastCommittingTransactionId();
    writeLogHeader(headerBuffer,currentLogVersion,lastTxId);
    positionCache.putHeader(currentLogVersion,lastTxId);
    channel.writeAll(headerBuffer);
    monitor.opened(fileToOpen,currentLogVersion,lastTxId,true);
  }
  channel.setVersion(currentLogVersion);
  return channel;
}
