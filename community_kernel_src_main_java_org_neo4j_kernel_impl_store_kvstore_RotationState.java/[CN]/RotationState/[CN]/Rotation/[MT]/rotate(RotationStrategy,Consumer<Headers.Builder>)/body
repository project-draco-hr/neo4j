{
  for (long expected=preState.version() - preState.store.version(), sleep=1; preState.applied() < expected; sleep=Math.min(sleep * 2,100)) {
    try {
      Thread.sleep(sleep);
    }
 catch (    InterruptedException e) {
      throw Exceptions.withCause(new InterruptedIOException("Rotation was interrupted."),e);
    }
  }
  Pair<File,KeyValueStoreFile> next=strategy.next(file(),updateHeaders(headersUpdater),keyFormat().filter(preState.dataProvider()));
  try {
    return postState.create(ReadableState.store(preState.keyFormat(),next.other()),next.first());
  }
  finally {
    preState.close();
  }
}
