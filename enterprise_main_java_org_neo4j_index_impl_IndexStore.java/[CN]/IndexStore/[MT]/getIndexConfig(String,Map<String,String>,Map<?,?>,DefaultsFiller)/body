{
  Map<String,String> storedConfig=get(indexName);
  userConfig=userConfig != null ? defaultsFiller.fill(userConfig) : null;
  Map<String,String> configToUse=null;
  if (storedConfig != null) {
    if (userConfig != null && !defaultsFiller.fill(storedConfig).equals(userConfig)) {
      throw new IllegalArgumentException("User index configuration:\n" + userConfig + "\ndiffer from stored config:\n"+ storedConfig+ "\nfor '"+ indexName+ "'");
    }
    configToUse=storedConfig;
  }
  if (configToUse == null && userConfig != null) {
    configToUse=userConfig;
  }
  if (configToUse == null) {
    String provider=null;
    if (dbConfig != null) {
      provider=(String)dbConfig.get("index." + indexName);
      if (provider == null) {
        provider=(String)dbConfig.get("index");
      }
    }
    if (provider == null) {
      provider="lucene";
    }
    configToUse=defaultsFiller.fill(MapUtil.stringMap("provider",provider));
  }
  boolean created=setIfNecessary(indexName,configToUse);
  return new Pair<Map<String,String>,Boolean>(configToUse,created);
}
