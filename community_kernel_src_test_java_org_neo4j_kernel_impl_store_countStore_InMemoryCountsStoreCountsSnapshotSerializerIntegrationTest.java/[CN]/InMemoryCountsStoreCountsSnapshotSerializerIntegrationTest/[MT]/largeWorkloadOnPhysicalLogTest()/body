{
  FileSystemAbstraction fs=new DefaultFileSystemAbstraction();
  File tempFile=File.createTempFile("temp","tmp");
  StoreChannel rawChannel=fs.create(tempFile);
  final LogHeader header=new LogHeader(CURRENT_LOG_VERSION,1,42l);
  PhysicalLogVersionedStoreChannel physicalLogVersionedStoreChannel=new PhysicalLogVersionedStoreChannel(rawChannel,header.logVersion,header.logFormatVersion);
  Map<CountsKey,long[]> map=CountsStoreMapGenerator.simpleCountStoreMap(100000);
  CountsSnapshot countsSnapshot=new CountsSnapshot(1,map);
  CountsSnapshot recovered;
  try (PositionAwarePhysicalFlushableChannel tempChannel=new PositionAwarePhysicalFlushableChannel(physicalLogVersionedStoreChannel)){
    serialize(tempChannel,countsSnapshot);
  }
   physicalLogVersionedStoreChannel.position(0);
  try (ReadAheadPositionableReadableChannel readAheadChannel=new ReadAheadPositionableReadableChannel(physicalLogVersionedStoreChannel,LogVersionBridge.NO_MORE_CHANNELS)){
    recovered=deserialize(readAheadChannel);
  }
   Assert.assertEquals(countsSnapshot.getTxId(),recovered.getTxId());
  for (  Map.Entry<CountsKey,long[]> pair : countsSnapshot.getMap().entrySet()) {
    long[] value=recovered.getMap().get(pair.getKey());
    Assert.assertNotNull(value);
    Assert.assertArrayEquals(value,pair.getValue());
  }
  for (  Map.Entry<CountsKey,long[]> pair : recovered.getMap().entrySet()) {
    long[] value=countsSnapshot.getMap().get(pair.getKey());
    Assert.assertNotNull(value);
    Assert.assertArrayEquals(value,pair.getValue());
  }
}
