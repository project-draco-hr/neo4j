{
  if (key == null || value == null) {
    throw new IllegalValueException("Null parameter, " + "key=" + key + ", "+ "value="+ value);
  }
  acquireLock(this,LockType.WRITE);
  NodeCommands nodeCommand=null;
  try {
    ensureFullProperties();
    nodeCommand=new NodeCommands();
    nodeCommand.setNode(this);
    PropertyIndex index=null;
    Property property=null;
    for (    PropertyIndex cachedIndex : PropertyIndex.index(key)) {
      property=propertyMap.get(cachedIndex.getKeyId());
      index=cachedIndex;
      if (property != null) {
        break;
      }
    }
    if (property == null) {
      for (      int keyId : propertyMap.keySet()) {
        PropertyIndex indexToCheck=PropertyIndex.getIndexFor(keyId);
        if (indexToCheck.getKey().equals(key)) {
          index=indexToCheck;
          property=propertyMap.get(indexToCheck.getKeyId());
          break;
        }
      }
      if (index == null) {
        index=PropertyIndex.createPropertyIndex(key);
      }
    }
    Event event=Event.NODE_ADD_PROPERTY;
    if (property != null) {
      int propertyId=property.getId();
      nodeCommand.initChangeProperty(propertyId,index,new Property(propertyId,value));
      event=Event.NODE_CHANGE_PROPERTY;
    }
 else {
      nodeCommand.initAddProperty(index,new Property(-1,value));
    }
    nodeCommand.execute();
    EventManager em=EventManager.getManager();
    EventData eventData=new EventData(nodeCommand);
    if (!em.generateProActiveEvent(event,eventData)) {
      setRollbackOnly();
      nodeCommand.undo();
      throw new IllegalValueException("Generate pro-active event failed, " + " unable to add property[" + key + ","+ value+ "] on "+ this);
    }
    em.generateReActiveEvent(event,eventData);
  }
 catch (  ExecuteFailedException e) {
    if (nodeCommand != null) {
      nodeCommand.undo();
    }
    throw new IllegalValueException("Failed executing command when " + " adding property[" + key + ","+ value+ "] on "+ this,e);
  }
 finally {
    releaseLock(this,LockType.WRITE);
  }
}
