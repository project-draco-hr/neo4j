{
  BatchInserter inserter=new BatchInserterImpl(new File(PATH,"9").getAbsolutePath());
  BatchInserterIndexProvider provider=new LuceneBatchInserterIndexProvider(inserter);
  BatchInserterIndex index=provider.nodeIndex("update",EXACT_CONFIG);
  long id=inserter.createNode(null);
  Map<String,Object> props=new HashMap<String,Object>();
  props.put("key","value");
  index.add(id,props);
  index.updateOrAdd(id,props);
  assertEquals(1,index.get("key","value").size());
  index.flush();
  props.put("key","value2");
  index.updateOrAdd(id,props);
  index.flush();
  assertEquals(1,index.get("key","value2").size());
  assertEquals(0,index.get("key","value").size());
  props.put("key2","value2");
  props.put("key","value");
  index.updateOrAdd(id,props);
  assertEquals(0,index.get("key2","value2").size());
  index.flush();
  assertEquals(1,index.get("key2","value2").size());
  assertEquals(1,index.get("key","value").size());
  long id2=inserter.createNode(null);
  props=new HashMap<String,Object>();
  props.put("2key","value");
  index.updateOrAdd(id2,props);
  props.put("2key","value2");
  props.put("2key2","value3");
  index.updateOrAdd(id2,props);
  index.flush();
  assertEquals(1,index.get("2key","value2").size());
  provider.shutdown();
  inserter.shutdown();
}
