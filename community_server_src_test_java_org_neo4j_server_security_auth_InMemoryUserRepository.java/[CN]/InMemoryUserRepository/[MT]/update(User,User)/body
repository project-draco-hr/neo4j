{
  if (!existingUser.name().equals(updatedUser.name())) {
    throw new IllegalArgumentException("updatedUser has a different name");
  }
synchronized (this) {
    boolean foundUser=false;
    for (    User other : users.values()) {
      if (other.equals(existingUser)) {
        foundUser=true;
      }
 else       if (other.token().equals(updatedUser.token())) {
        throw new IllegalTokenException("The specified token is already in use");
      }
    }
    if (!foundUser) {
      throw new ConcurrentModificationException();
    }
    users.put(updatedUser.name(),updatedUser);
  }
}
