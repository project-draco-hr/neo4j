{
  if (maxNrIterations <= 0) {
    return 0;
  }
  int localIterations=0;
  while (true) {
    ++localIterations;
    ++totalIterations;
    Map<Node,Double> newValues=new HashMap<Node,Double>();
    for (    Relationship relationship : relationshipSet) {
      if (relationDirection.equals(Direction.BOTH) || relationDirection.equals(Direction.OUTGOING)) {
        processRelationship(newValues,relationship,false);
      }
      if (relationDirection.equals(Direction.BOTH) || relationDirection.equals(Direction.INCOMING)) {
        processRelationship(newValues,relationship,true);
      }
    }
    normalize(newValues);
    if (timeToStop(values,newValues)) {
      values=newValues;
      break;
    }
    values=newValues;
    if (localIterations >= maxNrIterations) {
      break;
    }
  }
  if (values.get(nodeSet.iterator().next()) < 0) {
    for (    Node node : nodeSet) {
      values.put(node,-values.get(node));
    }
  }
  return localIterations;
}
