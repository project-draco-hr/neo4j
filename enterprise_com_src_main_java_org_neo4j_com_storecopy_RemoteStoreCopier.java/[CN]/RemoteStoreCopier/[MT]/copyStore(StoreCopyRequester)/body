{
  System.out.println("Preparing to copy the store");
  File storeDir=config.get(InternalAbstractGraphDatabase.Configuration.store_dir);
  File tempStore=new File(storeDir,COPY_FROM_MASTER_TEMP);
  Config tempConfig=configForTempStore(tempStore);
  if (!tempStore.mkdir()) {
    FileUtils.deleteRecursively(tempStore);
    tempStore.mkdir();
  }
  System.out.println("Starting to copy the store");
  Response response=requester.copyStore(decorateWithProgressIndicator(new ToFileStoreWriter(tempStore)));
  System.out.println("Done copying store, moving on to apply received transactions");
  long highestLogVersion=XaLogicalLog.getHighestHistoryLogVersion(fs,tempStore,LOGICAL_LOG_DEFAULT_NAME);
  if (highestLogVersion > -1) {
    NeoStore.setVersion(fs,tempStore,highestLogVersion + 1);
  }
  System.out.println("Copied store and updated transaction information, moving to apply transactions");
  writeTransactionsToActiveLogFile(tempConfig,response.transactions());
  response.close();
  System.out.println("Wrote transactions out, proceeding to apply them");
  GraphDatabaseAPI copiedDb=newTempDatabase(tempStore);
  copiedDb.shutdown();
  for (  File candidate : tempStore.listFiles(new FileFilter(){
    @Override public boolean accept(    File file){
      return !file.getName().startsWith("metrics") && !file.getName().equals(StringLogger.DEFAULT_NAME) && !("active_tx_log tm_tx_log.1 tm_tx_log.2").contains(file.getName());
    }
  }
)) {
    FileUtils.moveFileToDirectory(candidate,storeDir);
  }
}
