{
  IndexDescriptor descriptor=createConstraintIndex(labelId,propertyKeyId);
  UniquenessConstraint constraint=new UniquenessConstraint(labelId,propertyKeyId);
  boolean success=false;
  try {
    long indexId=schema.indexGetCommittedId(state,descriptor,SchemaStorage.IndexRuleKind.CONSTRAINT);
    awaitIndexPopulation(constraint,indexId);
    success=true;
    return indexId;
  }
 catch (  SchemaRuleNotFoundException e) {
    throw new IllegalStateException(String.format("Index (%s) that we just created does not exist.",descriptor));
  }
catch (  InterruptedException e) {
    throw new CreateConstraintFailureException(constraint,e);
  }
 finally {
    if (!success) {
      dropUniquenessConstraintIndex(descriptor);
    }
  }
}
