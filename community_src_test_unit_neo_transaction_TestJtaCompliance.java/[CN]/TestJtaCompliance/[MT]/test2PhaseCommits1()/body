{
  tm.begin();
  FakeXAResource res1=new FakeXAResource("XAResource1");
  FakeXAResource res2=new FakeXAResource("XAResource2");
  tm.getTransaction().enlistResource(res1);
  MethodCall calls1[]=res1.getAndRemoveMethodCalls();
  assertEquals(1,calls1.length);
  assertEquals("start",calls1[0].getMethodName());
  tm.getTransaction().enlistResource(res2);
  MethodCall calls2[]=res2.getAndRemoveMethodCalls();
  assertEquals(1,calls2.length);
  assertEquals("start",calls2[0].getMethodName());
  Object args[]=calls1[0].getArgs();
  Xid xid1=(Xid)args[0];
  assertEquals(XAResource.TMNOFLAGS,((Integer)args[1]).intValue());
  args=calls2[0].getArgs();
  Xid xid2=(Xid)args[0];
  assertEquals(XAResource.TMNOFLAGS,((Integer)args[1]).intValue());
  byte globalTxId1[]=xid1.getGlobalTransactionId();
  byte globalTxId2[]=xid2.getGlobalTransactionId();
  assertTrue(globalTxId1.length == globalTxId2.length);
  for (int i=0; i < globalTxId1.length; i++) {
    assertEquals(globalTxId1[i],globalTxId2[i]);
  }
  byte branch1[]=xid1.getBranchQualifier();
  byte branch2[]=xid2.getBranchQualifier();
  if (branch1.length == branch2.length) {
    boolean same=true;
    for (int i=0; i < branch1.length; i++) {
      if (branch1[i] != branch2[i]) {
        same=false;
        break;
      }
    }
    assertTrue(!same);
  }
  tm.getTransaction().delistResource(res2,XAResource.TMSUCCESS);
  calls2=res2.getAndRemoveMethodCalls();
  assertEquals(1,calls2.length);
  tm.getTransaction().delistResource(res1,XAResource.TMSUCCESS);
  calls1=res1.getAndRemoveMethodCalls();
  assertEquals(1,calls1.length);
  assertEquals("end",calls1[0].getMethodName());
  args=calls1[0].getArgs();
  assertTrue(((Xid)args[0]).equals(xid1));
  assertEquals(XAResource.TMSUCCESS,((Integer)args[1]).intValue());
  assertEquals(1,calls2.length);
  assertEquals("end",calls2[0].getMethodName());
  args=calls2[0].getArgs();
  assertTrue(((Xid)args[0]).equals(xid2));
  assertEquals(XAResource.TMSUCCESS,((Integer)args[1]).intValue());
  tm.commit();
  calls1=res1.getAndRemoveMethodCalls();
  calls2=res2.getAndRemoveMethodCalls();
  assertEquals(2,calls1.length);
  assertEquals("prepare",calls1[0].getMethodName());
  args=calls1[0].getArgs();
  assertTrue(((Xid)args[0]).equals(xid1));
  assertEquals("commit",calls1[1].getMethodName());
  args=calls1[1].getArgs();
  assertTrue(((Xid)args[0]).equals(xid1));
  assertEquals(false,((Boolean)args[1]).booleanValue());
  assertEquals(2,calls2.length);
  assertEquals("prepare",calls2[0].getMethodName());
  args=calls2[0].getArgs();
  assertTrue(((Xid)args[0]).equals(xid2));
  assertEquals("commit",calls2[1].getMethodName());
  args=calls2[1].getArgs();
  assertTrue(((Xid)args[0]).equals(xid2));
  assertEquals(false,((Boolean)args[1]).booleanValue());
}
