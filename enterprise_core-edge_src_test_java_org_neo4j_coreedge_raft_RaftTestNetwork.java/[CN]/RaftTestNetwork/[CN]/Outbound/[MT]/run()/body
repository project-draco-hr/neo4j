{
  while (!done) {
    long now=System.currentTimeMillis();
    Iterator<MessageContext> itr=msgQueue.iterator();
    MessageContext context;
    while (itr.hasNext() && (context=itr.next()).atMillis <= now) {
      itr.remove();
      Inbound inbound=inboundChannels.get(context.destination);
      if (inbound != null) {
        inbound.deliver(context.message);
      }
    }
    try {
      try {
        MessageContext first=msgQueue.first();
        long waitTime=first.atMillis - System.currentTimeMillis();
        if (waitTime > 0) {
          wait(waitTime);
        }
      }
 catch (      NoSuchElementException e) {
        wait(1000);
      }
    }
 catch (    InterruptedException e) {
      done=true;
    }
  }
}
