{
  LockableWindow window=null;
  if (brickMiss >= REFRESH_BRICK_COUNT) {
    refreshBricks();
  }
  BrickElement theBrick=null;
  while (window == null) {
    if (brickSize > 0) {
      int brickIndex=positionToBrickIndex(position);
      if (brickIndex >= brickArray.length) {
        expandBricks(brickIndex + 1);
      }
      theBrick=brickArray[brickIndex];
      window=theBrick.getAndMarkWindow();
    }
    if (window == null) {
      miss++;
      brickMiss++;
      PersistenceRow dpw=activeRowWindows.get(position);
      if (dpw != null && dpw.markAsInUse()) {
        window=dpw;
        break;
      }
      dpw=new PersistenceRow(position,blockSize,fileChannel);
      PersistenceRow existing=activeRowWindows.putIfAbsent(position,dpw);
      if (existing == null) {
        window=dpw;
      }
 else {
        dpw.close();
        if (theBrick != null) {
          theBrick.unLock();
        }
      }
    }
 else {
      hit++;
    }
  }
  window.lock(operationType);
  return window;
}
