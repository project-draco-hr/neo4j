{
  RequestType type=RequestType.values()[buffer.readByte()];
  SlaveContext context=null;
  if (type.includesSlaveContext()) {
    context=readSlaveContext(buffer);
    server.mapSlave(channel,context);
  }
  Response<?> response=type.caller.callMaster(realMaster,context,buffer);
  ChannelBuffer targetBuffer=ChannelBuffers.dynamicBuffer();
  type.serializer.write(response.response(),targetBuffer);
  if (type.includesSlaveContext()) {
    writeTransactionStreams(response.transactions(),targetBuffer);
  }
  if (type == RequestType.FINISH || type == RequestType.PULL_UPDATES) {
    server.unmapSlave(channel,context);
  }
  return targetBuffer;
}
