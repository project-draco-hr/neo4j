{
  File storeLockFile=new File(storeDir,STORE_LOCK_FILENAME);
  try {
    if (!fileSystemAbstraction.fileExists(storeLockFile)) {
      if (configuration.get(read_only)) {
        String msg="Unable to lock store as store dir does not exist and instance is in read-only mode";
        throw new IllegalStateException(msg);
      }
      fileSystemAbstraction.mkdirs(storeLockFile.getParentFile());
    }
  }
 catch (  IOException e) {
    String msg="Unable to create path for store dir: " + storeDir;
    throw new IllegalStateException(msg,e);
  }
  try {
    storeLockFileChannel=fileSystemAbstraction.open(storeLockFile,"rw");
    storeLockFileLock=fileSystemAbstraction.tryLock(storeLockFile,storeLockFileChannel);
    if (storeLockFileLock == null)     throw new IllegalStateException("Could not create lock file");
  }
 catch (  OverlappingFileLockException e) {
    String msg="Unable to obtain lock on store lock file: " + storeLockFile;
    throw new IllegalStateException(msg,e);
  }
catch (  IOException e) {
    String msg="Unable to obtain lock on store lock file: " + storeLockFile;
    throw new IllegalStateException(msg,e);
  }
}
