{
  Transaction tx=getTransaction();
  if (tx == null) {
    throw new NotInTransactionException("Unable to create property index for " + key);
  }
  TxCommitHook hook=txCommitHooks.get(tx);
  if (hook == null) {
    hook=new TxCommitHook(tx);
    txCommitHooks.put(tx,hook);
  }
  PropertyIndex index=hook.getIndex(key);
  if (index != null) {
    return index;
  }
  int id=idGenerator.nextId(PropertyIndex.class);
  index=new PropertyIndex(key,id);
  hook.addIndex(index);
  persistenceManager.createPropertyIndex(key,id);
  return index;
}
