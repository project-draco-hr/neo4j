{
  NodeImpl nodeImpl=new NodeImpl(1);
  RelationshipType loves=DynamicRelationshipType.withName("LOVES");
  TransactionState txState=mock(TransactionState.class);
  ThreadToStatementContextBridge stmCtxBridge=mock(ThreadToStatementContextBridge.class);
  NodeManager nodeManager=mock(NodeManager.class);
  RelationshipProxy.RelationshipLookups relLookup=mock(RelationshipProxy.RelationshipLookups.class);
  when(relLookup.getNodeManager()).thenReturn(nodeManager);
  when(nodeManager.getRelationshipTypeById(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_TYPE)).thenReturn(loves);
  when(relLookup.lookupRelationship(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID)).thenReturn(new RelationshipImpl(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID,1,2,TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_TYPE,false));
  when(relLookup.lookupRelationship(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID + 1)).thenReturn(new RelationshipImpl(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID + 1,1,2,TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_TYPE,false));
  when(nodeManager.getMoreRelationships(nodeImpl)).thenReturn(tripletWithValues(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID,TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID + 1)).thenReturn(noMoreRelationshipsTriplet());
  when(nodeManager.getTransactionState()).thenReturn(txState);
  when(nodeManager.newRelationshipProxyById(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID)).thenReturn(new RelationshipProxy(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID,relLookup,stmCtxBridge));
  when(nodeManager.newRelationshipProxyById(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID + 1)).thenReturn(new RelationshipProxy(TOTALLY_ARBITRARY_VALUE_DENOTING_RELATIONSHIP_ID + 1,relLookup,stmCtxBridge));
  final Iterable<Relationship> relationships=nodeImpl.getRelationships(nodeManager,loves,Direction.OUTGOING);
  assertNotNull(relationships);
  final Collection<Relationship> firstIteration=IteratorUtil.asCollection(relationships.iterator());
  assertFalse(firstIteration.isEmpty());
  final Collection<Relationship> secondIteration=IteratorUtil.asCollection(relationships.iterator());
  assertEquals(firstIteration,secondIteration);
}
