{
  EphemeralFileSystemAbstraction fs=fsRule.get();
  File path=new File("/store.db");
  MuninnPageCache cache=new MuninnPageCache(fs,1024,1024,PageCacheMonitor.NULL);
  Store<TestRecord,TestCursor> store=newStore(fs,path,cache);
  store.write(new TestRecord(2,1));
  store.write(new TestRecord(4,1));
  store.write(new TestRecord(1001,0));
  cache.flush();
  StoreIdGenerator idGenerator=spy(new TestStoreIdGenerator());
  StoreToolkit toolkit=mock(StoreToolkit.class);
  when(toolkit.fileSize()).thenReturn(1001 * 8l);
  when(toolkit.recordSize()).thenReturn(8);
  IdGeneratorRebuilder.FullDefragmentationRebuilderFactory rebuilder=new IdGeneratorRebuilder.FullDefragmentationRebuilderFactory();
  rebuilder.newIdGeneratorRebuilder(store,toolkit,idGenerator).rebuildIdGenerator();
  verify(idGenerator).free(0);
  verify(idGenerator).free(1);
  verify(idGenerator).free(3);
  verify(idGenerator).rebuild(4);
  verify(idGenerator).highestIdInUse();
  verifyNoMoreInteractions(idGenerator);
}
