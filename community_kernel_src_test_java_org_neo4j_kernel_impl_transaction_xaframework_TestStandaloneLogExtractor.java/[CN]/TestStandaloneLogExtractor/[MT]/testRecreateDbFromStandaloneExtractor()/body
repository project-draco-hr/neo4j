{
  String sourceDir=forTest(getClass()).directory("source",true).getAbsolutePath();
  GraphDatabaseService db=new EmbeddedGraphDatabase(sourceDir,stringMap(KEEP_LOGICAL_LOGS,"true"));
  BatchTransaction tx=beginBatchTx(db);
  Node node=db.createNode();
  node.setProperty("name","First");
  Node otherNode=db.createNode();
  node.createRelationshipTo(otherNode,MyRelTypes.TEST);
  tx.restart();
  for (int i=0; i < 5; i++) {
    db.createNode().setProperty("type",i);
    tx.restart();
  }
  tx.finish();
  DbRepresentation sourceRep=DbRepresentation.of(db);
  db.shutdown();
  AbstractGraphDatabase newDb=new EmbeddedGraphDatabase(TargetDirectory.forTest(getClass()).directory("target",true).getAbsolutePath());
  XaDataSource ds=newDb.getConfig().getTxModule().getXaDataSourceManager().getXaDataSource(Config.DEFAULT_DATA_SOURCE_NAME);
  LogExtractor extractor=LogExtractor.from(sourceDir);
  long expectedTxId=2;
  while (true) {
    InMemoryLogBuffer buffer=new InMemoryLogBuffer();
    long txId=extractor.extractNext(buffer);
    assertEquals(expectedTxId++,txId);
    if (expectedTxId == 9)     expectedTxId=-1;
    if (txId == -1)     break;
    ds.applyCommittedTransaction(txId,buffer);
  }
  assertEquals(sourceRep,DbRepresentation.of(newDb));
  newDb.shutdown();
}
