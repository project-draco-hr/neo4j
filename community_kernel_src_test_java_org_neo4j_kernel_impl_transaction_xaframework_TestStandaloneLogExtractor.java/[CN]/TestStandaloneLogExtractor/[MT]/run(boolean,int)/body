{
  EphemeralFileSystemAbstraction fileSystem=new EphemeralFileSystemAbstraction();
  String storeDir="dir";
  GraphDatabaseAPI db=(GraphDatabaseAPI)new TestGraphDatabaseFactory().setFileSystem(fileSystem).newImpermanentDatabase(storeDir);
  createSomeTransactions(db);
  EphemeralFileSystemAbstraction snapshot=fileSystem.snapshot();
  DbRepresentation rep=DbRepresentation.of(db);
  db.shutdown();
  GraphDatabaseAPI newDb=(GraphDatabaseAPI)new TestGraphDatabaseFactory().setFileSystem(snapshot).newImpermanentDatabase(storeDir);
  XaDataSource ds=newDb.getXaDataSourceManager().getNeoStoreDataSource();
  LogExtractor extractor=LogExtractor.from(snapshot,new File(storeDir));
  long expectedTxId=2;
  while (true) {
    InMemoryLogBuffer buffer=new InMemoryLogBuffer();
    long txId=extractor.extractNext(buffer);
    assertEquals(expectedTxId++,txId);
    if (expectedTxId == 9)     expectedTxId=-1;
    if (txId == -1)     break;
    ds.applyCommittedTransaction(txId,buffer);
  }
  DbRepresentation newRep=DbRepresentation.of(newDb);
  newDb.shutdown();
  assertEquals(rep,newRep);
}
