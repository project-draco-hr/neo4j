{
  EphemeralFileSystemAbstraction fileSystem=new EphemeralFileSystemAbstraction();
  String storeDir="source" + nr;
  GraphDatabaseAPI db=(GraphDatabaseAPI)new TestGraphDatabaseFactory().setFileSystem(fileSystem).newImpermanentDatabase(storeDir);
  createSomeTransactions(db);
  DbRepresentation rep=DbRepresentation.of(db);
  EphemeralFileSystemAbstraction snapshot;
  if (cleanShutdown) {
    db.shutdown();
    snapshot=fileSystem.snapshot();
  }
 else {
    snapshot=fileSystem.snapshot();
    db.shutdown();
  }
  GraphDatabaseAPI newDb=(GraphDatabaseAPI)new TestGraphDatabaseFactory().setFileSystem(snapshot).newImpermanentDatabase(storeDir);
  DbRepresentation newRep=DbRepresentation.of(newDb);
  newDb.shutdown();
  assertEquals(rep,newRep);
  fileSystem.shutdown();
}
