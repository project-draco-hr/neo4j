{
  EphemeralFileSystemAbstraction fileSystem=new EphemeralFileSystemAbstraction();
  String storeDir="source" + nr;
  GraphDatabaseAPI db=(GraphDatabaseAPI)new TestGraphDatabaseFactory().setFileSystem(fileSystem).newImpermanentDatabase(storeDir);
  createSomeTransactions(db);
  DbRepresentation rep=DbRepresentation.of(db);
  EphemeralFileSystemAbstraction snapshot;
  if (cleanShutdown) {
    db.shutdown();
    snapshot=fileSystem.snapshot();
  }
 else {
    snapshot=fileSystem.snapshot();
    db.shutdown();
  }
  GraphDatabaseAPI newDb=(GraphDatabaseAPI)new TestGraphDatabaseFactory().setFileSystem(snapshot).newImpermanentDatabase(storeDir);
  XaDataSource ds=newDb.getDependencyResolver().resolveDependency(XaDataSourceManager.class).getNeoStoreDataSource();
  LogExtractor extractor=LogExtractor.from(snapshot,new File(storeDir),new XaCommandReaderFactory(){
    @Override public XaCommandReader newInstance(    ByteBuffer scratch){
      return new PhysicalLogNeoXaCommandReader(scratch);
    }
  }
,new XaCommandWriterFactory(){
    @Override public XaCommandWriter newInstance(){
      return new PhysicalLogNeoXaCommandWriter();
    }
  }
,new Monitors().newMonitor(ByteCounterMonitor.class),2);
  long expectedTxId=2;
  while (true) {
    InMemoryLogBuffer buffer=new InMemoryLogBuffer();
    long txId=extractor.extractNext(buffer);
    assertEquals(expectedTxId++,txId);
    if (expectedTxId == 11) {
      expectedTxId=-1;
    }
    if (txId == -1) {
      break;
    }
    ds.applyCommittedTransaction(txId,buffer);
  }
  DbRepresentation newRep=DbRepresentation.of(newDb);
  newDb.shutdown();
  assertEquals(rep,newRep);
  fileSystem.shutdown();
}
