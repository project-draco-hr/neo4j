{
  assertValidUsername(username);
  assertValidRoleName(roleName);
  User user=userRepository.findByName(username);
  if (user == null) {
    throw new IllegalArgumentException("User " + username + " does not exist.");
  }
  RoleRecord role=roleRepository.findByName(roleName);
  if (role == null) {
    RoleRecord newRole=new RoleRecord(roleName,username);
    roleRepository.create(newRole);
  }
 else {
    RoleRecord newRole=role.augment().withUser(username).build();
    try {
      roleRepository.update(role,newRole);
    }
 catch (    ConcurrentModificationException e) {
      addUserToRole(username,roleName);
    }
  }
}
