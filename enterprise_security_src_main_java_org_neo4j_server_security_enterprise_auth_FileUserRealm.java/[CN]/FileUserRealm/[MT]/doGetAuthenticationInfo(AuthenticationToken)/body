{
  UsernamePasswordToken usernamePasswordToken=(UsernamePasswordToken)token;
  User user=userRepository.findByName(usernamePasswordToken.getUsername());
  if (user == null) {
    throw new AuthenticationException("User " + usernamePasswordToken.getUsername() + " does not exist");
  }
  SimpleAuthenticationInfo authenticationInfo=new SimpleAuthenticationInfo(user.name(),user.credentials(),getName());
  if (user.passwordChangeRequired()) {
    assertCredentialsMatch(token,authenticationInfo);
    throw new ExpiredCredentialsException("Password change required");
  }
  return authenticationInfo;
}
