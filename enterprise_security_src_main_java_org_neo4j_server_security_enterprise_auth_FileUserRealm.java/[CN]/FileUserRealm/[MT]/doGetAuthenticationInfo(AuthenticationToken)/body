{
  UsernamePasswordToken usernamePasswordToken=(UsernamePasswordToken)token;
  User user=userRepository.getUserByName(usernamePasswordToken.getUsername());
  if (user == null) {
    throw new AuthenticationException("User " + usernamePasswordToken.getUsername() + " does not exist");
  }
  SimpleAuthenticationInfo authenticationInfo=new SimpleAuthenticationInfo(user.name(),user.credentials(),getName());
  if (user.hasFlag(FileUserRealm.IS_SUSPENDED)) {
    assertCredentialsMatch(token,authenticationInfo);
    throw new AuthenticationException("User " + user.name() + " is suspended");
  }
  return authenticationInfo;
}
