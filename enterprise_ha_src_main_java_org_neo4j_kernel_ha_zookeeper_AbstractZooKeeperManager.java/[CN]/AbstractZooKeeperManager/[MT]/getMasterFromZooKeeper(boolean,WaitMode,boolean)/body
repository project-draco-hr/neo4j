{
  ZooKeeperMachine master=getMasterBasedOn(getAllMachines(wait,mode).values());
  Master masterClient=NO_MASTER;
  if (cachedMaster.other().getMachineId() != master.getMachineId()) {
    invalidateMaster();
    if (!allowChange)     return NO_MASTER_MACHINE_PAIR;
    if (master != Machine.NO_MACHINE && master.getMachineId() != getMyMachineId()) {
      masterClient=getMasterClientToMachine(master);
    }
    cachedMaster=Pair.<Master,Machine>of(masterClient,(Machine)master);
  }
  return cachedMaster;
}
