{
  Machine master=getMasterBasedOn(getAllMachines(wait).values());
  MasterClient masterClient=null;
  if (cachedMaster.other().getMachineId() != master.getMachineId()) {
    if (cachedMaster.other().getMachineId() != Machine.NO_MACHINE.getMachineId() && !allowChange) {
      throw new ComException("Needs invalidation of master");
    }
    invalidateMaster();
    if (master != Machine.NO_MACHINE && master.getMachineId() != getMyMachineId()) {
      masterClient=new MasterClient(master.getServer().first(),master.getServer().other(),graphDb,clientReadTimeout,maxConcurrentChannelsPerSlave);
    }
    cachedMaster=Pair.<Master,Machine>of(masterClient,master);
  }
  return cachedMaster;
}
