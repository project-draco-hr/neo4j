{
  T result, created=null;
  try {
    do {
      result=index.get(key,value).getSingle();
      if (result != null)       return result;
      if (created == null) {
        created=create();
        if (created == null)         throw new AssertionError("create() returned null");
      }
      result=created;
      if (index.putIfAbsent(result,key,value)) {
        initialize(result);
        created=null;
        return result;
      }
 else {
        result=null;
      }
    }
 while (result == null);
    return result;
  }
  finally {
    if (created != null)     delete(created);
  }
}
