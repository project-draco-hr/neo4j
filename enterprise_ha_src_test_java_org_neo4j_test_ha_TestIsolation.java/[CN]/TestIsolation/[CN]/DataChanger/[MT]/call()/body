{
  System.out.println("Start changing data");
  int totalDeadlocks=0;
  try {
    for (int round=0; round < 100; round++) {
      int deadLocks=0;
      DeadlockDetectedException ex=null;
      do {
        ex=null;
        Transaction tx=database.beginTx();
        try {
          for (int i=0; i < count; i++) {
            Node node=database.getNodeById(i + 1);
            int foo=(Integer)node.getProperty("foo");
            node.setProperty("foo",foo + 1);
          }
          tx.success();
        }
 catch (        DeadlockDetectedException e) {
          System.out.println("Deadlock detected");
          deadLocks=deadLocks + 1;
          ex=e;
          tx.failure();
          if (deadLocks > 100) {
            totalDeadlocks+=deadLocks;
            throw e;
          }
        }
 finally {
          tx.finish();
        }
      }
 while (ex != null);
      totalDeadlocks+=deadLocks;
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
    throw e;
  }
 finally {
    done.set(true);
    System.out.printf("Done changing data. Detected %d deadlocks\n",totalDeadlocks);
  }
  return null;
}
