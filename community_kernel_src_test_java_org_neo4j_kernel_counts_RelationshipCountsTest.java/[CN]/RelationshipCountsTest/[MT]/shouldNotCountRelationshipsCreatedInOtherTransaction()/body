{
  GraphDatabaseService graphDb=db.getGraphDatabaseAPI();
  final Barrier.Control barrier=new Barrier.Control();
  long before=numberOfRelationships();
  Future<Long> tx=threading.execute(new NamedFunction<GraphDatabaseService,Long>("create-relationships"){
    @Override public Long apply(    GraphDatabaseService graphDb){
      try (Transaction tx=graphDb.beginTx()){
        Node node=graphDb.createNode();
        node.createRelationshipTo(graphDb.createNode(),withName("KNOWS"));
        node.createRelationshipTo(graphDb.createNode(),withName("KNOWS"));
        long whatThisThreadSees=countsForRelationship(null,null,null);
        barrier.reached();
        tx.success();
        return whatThisThreadSees;
      }
     }
  }
,graphDb);
  barrier.await();
  long during=numberOfRelationships();
  barrier.release();
  long whatOtherThreadSees=tx.get();
  long after=numberOfRelationships();
  assertEquals(0,before);
  assertEquals(0,during);
  assertEquals(2,after);
  assertEquals(after,whatOtherThreadSees);
}
