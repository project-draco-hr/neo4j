{
  GraphDatabaseService graphDb=db.getGraphDatabaseService();
  final Relationship rel;
  try (Transaction tx=graphDb.beginTx()){
    Node node=graphDb.createNode();
    node.createRelationshipTo(graphDb.createNode(),withName("KNOWS"));
    rel=node.createRelationshipTo(graphDb.createNode(),withName("KNOWS"));
    node.createRelationshipTo(graphDb.createNode(),withName("KNOWS"));
    tx.success();
  }
   final Barrier.Control barrier=new Barrier.Control();
  long before=numberOfRelationships();
  Future<Long> tx=threading.execute(new NamedFunction<GraphDatabaseService,Long>("create-relationships"){
    @Override public Long apply(    GraphDatabaseService graphDb){
      long during;
      try (Transaction tx=graphDb.beginTx()){
        rel.delete();
        during=countsForRelationship(null,null,null);
        barrier.reached();
        tx.success();
      }
       return during;
    }
  }
,graphDb);
  barrier.await();
  long concurrently=numberOfRelationships();
  barrier.release();
  long during=tx.get();
  long after=numberOfRelationships();
  assertEquals(3,before);
  assertEquals(3,concurrently);
  assertEquals(2,after);
  assertEquals(before,during);
}
