{
  if (isClosed()) {
    return;
  }
  ByteBuffer writeBuffer=ByteBuffer.allocate(grabSize * 8);
  if (!releasedIdList.isEmpty()) {
    writeIdBatch(writeBuffer);
  }
  if (!idsReadFromFile.isEmpty()) {
    while (!idsReadFromFile.isEmpty()) {
      releasedIdList.add(idsReadFromFile.removeFirst());
    }
    writeIdBatch(writeBuffer);
  }
  try {
    ByteBuffer buffer=ByteBuffer.allocate(HEADER_SIZE);
    writeHeader(buffer);
    defragReusableIdsInFile(writeBuffer);
    fileChannel.force(false);
    markAsCleanlyClosed(buffer);
    closeChannel();
  }
 catch (  IOException e) {
    throw new UnderlyingStorageException("Unable to close id generator " + file,e);
  }
}
