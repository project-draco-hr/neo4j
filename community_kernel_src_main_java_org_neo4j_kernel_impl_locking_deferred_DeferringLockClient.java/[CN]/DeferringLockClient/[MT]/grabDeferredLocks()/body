{
  long[] current=new long[10];
  int cursor=0;
  Locks.ResourceType currentType=null;
  boolean currentExclusive=false;
  for (  LockUnit lockUnit : locks) {
    if (currentType == null || (currentType.typeId() != lockUnit.resourceType().typeId() || currentExclusive != lockUnit.isExclusive())) {
      if (!flushLocks(current,cursor,currentType,currentExclusive)) {
        break;
      }
      cursor=0;
      currentType=lockUnit.resourceType();
      currentExclusive=lockUnit.isExclusive();
    }
    if (cursor == current.length) {
      current=Arrays.copyOf(current,cursor * 2);
    }
    current[cursor++]=lockUnit.resourceId();
  }
  flushLocks(current,cursor,currentType,currentExclusive);
}
