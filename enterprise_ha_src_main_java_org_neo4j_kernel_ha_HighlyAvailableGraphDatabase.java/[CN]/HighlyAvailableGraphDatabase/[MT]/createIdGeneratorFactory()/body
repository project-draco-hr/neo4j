{
  idGeneratorFactory=new HaIdGeneratorFactory(masterDelegateInvocationHandler,logging,requestContextFactory);
  SwitchToSlave switchToSlaveInstance=new SwitchToSlave(logging.getConsoleLog(HighAvailabilityModeSwitcher.class),config,getDependencyResolver(),(HaIdGeneratorFactory)idGeneratorFactory,logging,masterDelegateInvocationHandler,clusterMemberAvailability,requestContextFactory,monitors,kernelExtensions.listFactories());
  SwitchToMaster switchToMasterInstance=new SwitchToMaster(logging,msgLog,this,(HaIdGeneratorFactory)idGeneratorFactory,config,getDependencyResolver(),masterDelegateInvocationHandler,clusterMemberAvailability,monitors,dataSourceManager);
  highAvailabilityModeSwitcher=new HighAvailabilityModeSwitcher(switchToSlaveInstance,switchToMasterInstance,clusterClient,clusterMemberAvailability,logging.getMessagesLog(HighAvailabilityModeSwitcher.class));
  clusterClient.addBindingListener(highAvailabilityModeSwitcher);
  memberStateMachine.addHighAvailabilityMemberListener(highAvailabilityModeSwitcher);
  paxosLife.add(highAvailabilityModeSwitcher);
  ((HaIdGeneratorFactory)idGeneratorFactory).switchToMaster();
  return idGeneratorFactory;
}
