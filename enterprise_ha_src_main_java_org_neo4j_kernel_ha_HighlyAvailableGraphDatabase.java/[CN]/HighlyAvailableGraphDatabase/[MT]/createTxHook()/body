{
  clusterEventsDelegateInvocationHandler=new DelegateInvocationHandler(ClusterMemberEvents.class);
  memberContextDelegateInvocationHandler=new DelegateInvocationHandler(HighAvailabilityMemberContext.class);
  clusterMemberAvailabilityDelegateInvocationHandler=new DelegateInvocationHandler(ClusterMemberAvailability.class);
  clusterEvents=(ClusterMemberEvents)Proxy.newProxyInstance(ClusterMemberEvents.class.getClassLoader(),new Class[]{ClusterMemberEvents.class,Lifecycle.class},clusterEventsDelegateInvocationHandler);
  memberContext=(HighAvailabilityMemberContext)Proxy.newProxyInstance(HighAvailabilityMemberContext.class.getClassLoader(),new Class[]{HighAvailabilityMemberContext.class},memberContextDelegateInvocationHandler);
  clusterMemberAvailability=(ClusterMemberAvailability)Proxy.newProxyInstance(ClusterMemberAvailability.class.getClassLoader(),new Class[]{ClusterMemberAvailability.class},clusterMemberAvailabilityDelegateInvocationHandler);
  ElectionCredentialsProvider electionCredentialsProvider=config.get(HaSettings.slave_only) ? new NotElectableElectionCredentialsProvider() : new DefaultElectionCredentialsProvider(config.get(ClusterSettings.server_id),new OnDiskLastTxIdGetter(new File(getStoreDir())),new HighAvailabilityMemberInfoProvider(){
    @Override public HighAvailabilityMemberState getHighAvailabilityMemberState(){
      return memberStateMachine.getCurrentState();
    }
  }
);
  ObjectStreamFactory objectStreamFactory=new ObjectStreamFactory();
  clusterClient=new ClusterClient(ClusterClient.adapt(config),logging,electionCredentialsProvider,objectStreamFactory,objectStreamFactory);
  PaxosClusterMemberEvents localClusterEvents=new PaxosClusterMemberEvents(clusterClient,clusterClient,clusterClient,clusterClient,logging,new Predicate<PaxosClusterMemberEvents.ClusterMembersSnapshot>(){
    @Override public boolean accept(    PaxosClusterMemberEvents.ClusterMembersSnapshot item){
      for (      MemberIsAvailable member : item.getCurrentAvailableMembers()) {
        if (member.getRoleUri().getScheme().equals("ha")) {
          if (HighAvailabilityModeSwitcher.getServerId(member.getRoleUri()) == config.get(ClusterSettings.server_id)) {
            msgLog.error(String.format("Instance %s has the same serverId as ours (%d) - will not " + "join this cluster",member.getRoleUri(),config.get(ClusterSettings.server_id)));
            return true;
          }
        }
      }
      return true;
    }
  }
,new HANewSnapshotFunction(),objectStreamFactory,objectStreamFactory);
  clusterClient.addClusterListener(new ClusterListener.Adapter(){
    boolean hasRequestedElection=true;
    @Override public void enteredCluster(    ClusterConfiguration clusterConfiguration){
      clusterClient.performRoleElections();
    }
    @Override public void elected(    String role,    InstanceId instanceId,    URI electedMember){
      if (hasRequestedElection && role.equals(ClusterConfiguration.COORDINATOR)) {
        clusterClient.removeClusterListener(this);
      }
    }
  }
);
  HighAvailabilityMemberContext localMemberContext=new SimpleHighAvailabilityMemberContext(clusterClient.getServerId());
  PaxosClusterMemberAvailability localClusterMemberAvailability=new PaxosClusterMemberAvailability(clusterClient.getServerId(),clusterClient,clusterClient,logging,objectStreamFactory,objectStreamFactory);
  memberContextDelegateInvocationHandler.setDelegate(localMemberContext);
  clusterEventsDelegateInvocationHandler.setDelegate(localClusterEvents);
  clusterMemberAvailabilityDelegateInvocationHandler.setDelegate(localClusterMemberAvailability);
  members=new ClusterMembers(clusterClient,clusterClient,clusterEvents,new InstanceId(config.get(ClusterSettings.server_id)));
  memberStateMachine=new HighAvailabilityMemberStateMachine(memberContext,availabilityGuard,members,clusterEvents,clusterClient,logging.getMessagesLog(HighAvailabilityMemberStateMachine.class));
  HighAvailabilityConsoleLogger highAvailabilityConsoleLogger=new HighAvailabilityConsoleLogger(logging.getConsoleLog(HighAvailabilityConsoleLogger.class),new InstanceId(config.get(ClusterSettings.server_id)));
  availabilityGuard.addListener(highAvailabilityConsoleLogger);
  clusterEvents.addClusterMemberListener(highAvailabilityConsoleLogger);
  clusterClient.addClusterListener(highAvailabilityConsoleLogger);
  paxosLife.add(clusterClient);
  paxosLife.add(memberStateMachine);
  paxosLife.add(clusterEvents);
  paxosLife.add(localClusterMemberAvailability);
  DelegateInvocationHandler<RemoteTxHook> txHookDelegate=new DelegateInvocationHandler<>(RemoteTxHook.class);
  RemoteTxHook txHook=(RemoteTxHook)Proxy.newProxyInstance(RemoteTxHook.class.getClassLoader(),new Class[]{RemoteTxHook.class},txHookDelegate);
  new TxHookModeSwitcher(memberStateMachine,txHookDelegate,masterDelegateInvocationHandler,new TxHookModeSwitcher.RequestContextFactoryResolver(){
    @Override public RequestContextFactory get(){
      return requestContextFactory;
    }
  }
,logging.getMessagesLog(TxHookModeSwitcher.class),dependencyResolver);
  return txHook;
}
