{
  clusterEventsDelegateInvocationHandler=new DelegateInvocationHandler();
  memberContextDelegateInvocationHandler=new DelegateInvocationHandler();
  clusterMemberAvailabilityDelegateInvocationHandler=new DelegateInvocationHandler();
  clusterEvents=(ClusterMemberEvents)Proxy.newProxyInstance(ClusterMemberEvents.class.getClassLoader(),new Class[]{ClusterMemberEvents.class,Lifecycle.class},clusterEventsDelegateInvocationHandler);
  memberContext=(HighAvailabilityMemberContext)Proxy.newProxyInstance(HighAvailabilityMemberContext.class.getClassLoader(),new Class[]{HighAvailabilityMemberContext.class},memberContextDelegateInvocationHandler);
  clusterMemberAvailability=(ClusterMemberAvailability)Proxy.newProxyInstance(ClusterMemberAvailability.class.getClassLoader(),new Class[]{ClusterMemberAvailability.class},clusterMemberAvailabilityDelegateInvocationHandler);
  ElectionCredentialsProvider electionCredentialsProvider=config.get(HaSettings.slave_only) ? new NotElectableElectionCredentialsProvider() : new DefaultElectionCredentialsProvider(config.get(ClusterSettings.server_id),new OnDiskLastTxIdGetter(new File(getStoreDir())),new HighAvailabilityMemberInfoProvider(){
    @Override public HighAvailabilityMemberState getHighAvailabilityMemberState(){
      return memberStateMachine.getCurrentState();
    }
  }
);
  ObjectStreamFactory objectStreamFactory=new ObjectStreamFactory();
  clusterClient=new ClusterClient(ClusterClient.adapt(config),logging,electionCredentialsProvider,objectStreamFactory,objectStreamFactory);
  PaxosClusterMemberEvents localClusterEvents=new PaxosClusterMemberEvents(clusterClient,clusterClient,clusterClient,clusterClient,logging,new Predicate<PaxosClusterMemberEvents.ClusterMembersSnapshot>(){
    @Override public boolean accept(    PaxosClusterMemberEvents.ClusterMembersSnapshot item){
      for (      MemberIsAvailable member : item.getCurrentAvailableMembers()) {
        if (member.getRoleUri().getScheme().equals("ha")) {
          if (HighAvailabilityModeSwitcher.getServerId(member.getRoleUri()) == config.get(ClusterSettings.server_id)) {
            msgLog.error(String.format("Instance %s has the same serverId as ours (%d) - will not join this cluster",member.getRoleUri(),config.get(ClusterSettings.server_id)));
            return true;
          }
        }
      }
      return true;
    }
  }
,new HANewSnapshotFunction(),objectStreamFactory,objectStreamFactory);
  clusterClient.addClusterListener(new ClusterListener.Adapter(){
    boolean hasRequestedElection=false;
    @Override public void enteredCluster(    ClusterConfiguration clusterConfiguration){
      hasRequestedElection=true;
      clusterClient.performRoleElections();
    }
    @Override public void elected(    String role,    InstanceId instanceId,    URI electedMember){
      if (hasRequestedElection && role.equals(ClusterConfiguration.COORDINATOR)) {
        clusterClient.refreshSnapshot();
        clusterClient.removeClusterListener(this);
      }
    }
  }
);
  HighAvailabilityMemberContext localMemberContext=new SimpleHighAvailabilityMemberContext(clusterClient.getServerId());
  PaxosClusterMemberAvailability localClusterMemberAvailability=new PaxosClusterMemberAvailability(clusterClient.getServerId(),clusterClient,clusterClient,logging,objectStreamFactory,objectStreamFactory);
  if (!config.get(HaSettings.coordinators).isEmpty() && !config.get(HaSettings.coordinators).get(0).toString().trim().equals("")) {
    compatibilityMode=true;
    compatibilityLifecycle=new LinkedList<Lifecycle>();
    Switchover switchover=new ZooToPaxosSwitchover(life,paxosLife,compatibilityLifecycle,clusterEventsDelegateInvocationHandler,memberContextDelegateInvocationHandler,clusterMemberAvailabilityDelegateInvocationHandler,localClusterEvents,localMemberContext,localClusterMemberAvailability);
    ZooKeeperHighAvailabilityEvents zkEvents=new ZooKeeperHighAvailabilityEvents(logging,config,switchover);
    compatibilityLifecycle.add(zkEvents);
    memberContextDelegateInvocationHandler.setDelegate(new SimpleHighAvailabilityMemberContext(zkEvents.getInstanceId()));
    clusterEventsDelegateInvocationHandler.setDelegate(zkEvents);
    clusterMemberAvailabilityDelegateInvocationHandler.setDelegate(zkEvents);
    paxosLife.add(localClusterEvents);
  }
 else {
    memberContextDelegateInvocationHandler.setDelegate(localMemberContext);
    clusterEventsDelegateInvocationHandler.setDelegate(localClusterEvents);
    clusterMemberAvailabilityDelegateInvocationHandler.setDelegate(localClusterMemberAvailability);
  }
  members=new ClusterMembers(clusterClient,clusterClient,clusterEvents,new InstanceId(config.get(ClusterSettings.server_id)));
  memberStateMachine=new HighAvailabilityMemberStateMachine(memberContext,availabilityGuard,members,clusterEvents,clusterClient,logging.getMessagesLog(HighAvailabilityMemberStateMachine.class));
  HighAvailabilityConsoleLogger highAvailabilityConsoleLogger=new HighAvailabilityConsoleLogger(logging.getConsoleLog(HighAvailabilityConsoleLogger.class),new InstanceId(config.get(ClusterSettings.server_id)));
  availabilityGuard.addListener(highAvailabilityConsoleLogger);
  clusterEvents.addClusterMemberListener(highAvailabilityConsoleLogger);
  clusterClient.addClusterListener(highAvailabilityConsoleLogger);
  if (compatibilityMode) {
    compatibilityLifecycle.add(memberStateMachine);
    compatibilityLifecycle.add((Lifecycle)clusterEvents);
    life.add(memberStateMachine);
    life.add(clusterEvents);
  }
  paxosLife.add(clusterClient);
  paxosLife.add(memberStateMachine);
  paxosLife.add(clusterEvents);
  paxosLife.add(localClusterMemberAvailability);
  DelegateInvocationHandler<TxHook> txHookDelegate=new DelegateInvocationHandler<TxHook>();
  TxHook txHook=(TxHook)Proxy.newProxyInstance(TxHook.class.getClassLoader(),new Class[]{TxHook.class},txHookDelegate);
  new TxHookModeSwitcher(memberStateMachine,txHookDelegate,master,new TxHookModeSwitcher.RequestContextFactoryResolver(){
    @Override public RequestContextFactory get(){
      return requestContextFactory;
    }
  }
,dependencyResolver);
  return txHook;
}
