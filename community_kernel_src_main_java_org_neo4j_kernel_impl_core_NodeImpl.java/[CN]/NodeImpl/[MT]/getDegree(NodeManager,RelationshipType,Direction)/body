{
  ensureAllRelationshipsAreLoaded(nm);
  int typeId=nm.getRelationshipTypeIdFor(type);
  RelIdArray ids=getRelationshipIds(typeId);
  DirectionWrapper dir=wrap(direction);
  int count=ids != null ? ids.length(dir) : 0;
  TransactionState transactionState=nm.getTransactionState();
  ArrayMap<Integer,RelIdArray> addMap=transactionState.getCowRelationshipAddMap(this);
  ArrayMap<Integer,SetAndDirectionCounter> removeMap=transactionState.getCowRelationshipRemoveMap(this);
  if (addMap != null) {
    RelIdArray add=addMap.get(typeId);
    if (add != null) {
      count+=add.length(dir);
    }
  }
  if (removeMap != null) {
    SetAndDirectionCounter remove=removeMap.get(typeId);
    if (remove != null) {
      count-=remove.getCount(direction);
    }
  }
  return count;
}
