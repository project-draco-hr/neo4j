{
  ensureRelationshipMapNotNull(nodeManager);
  final NodeImpl nodeImpl=this;
  return new Iterable<Relationship>(){
    public Iterator<Relationship> iterator(){
      final boolean hasMore=hasMoreRelationshipsToLoad();
      RelIdArray[] localRelationships=relationships;
      final RelIdIterator[] relIdIterators=new RelIdIterator[localRelationships.length];
      TransactionState tx=nodeManager.getTransactionState();
      ArrayMap<Integer,RelIdArray> addMap=null;
      ArrayMap<Integer,Collection<Long>> skipMap=null;
      if (tx.hasChanges()) {
        addMap=tx.getCowRelationshipAddMap(nodeImpl);
        skipMap=tx.getCowRelationshipRemoveMap(nodeImpl);
      }
      for (int i=0; i < localRelationships.length; i++) {
        RelIdArray src=localRelationships[i];
        int type=src.getType();
        RelIdIterator iterator;
        if (addMap != null || skipMap != null) {
          iterator=new CombinedRelIdIterator(type,direction,src,addMap != null ? addMap.get(type) : null,skipMap != null ? skipMap.get(type) : null);
        }
 else {
          iterator=src.iterator(direction);
        }
        relIdIterators[i]=iterator;
      }
      final RelIdIterator[] result;
      if (addMap != null) {
        RelIdIterator[] additional=new RelIdIterator[addMap.size()];
        int additionalSize=0;
        for (        int type : addMap.keySet()) {
          if (getRelIdArray(type) == null) {
            RelIdArray add=addMap.get(type);
            additional[additionalSize++]=new CombinedRelIdIterator(type,direction,null,add,skipMap != null ? skipMap.get(type) : null);
          }
        }
        RelIdIterator[] newResult=new RelIdIterator[relIdIterators.length + additionalSize];
        arraycopy(relIdIterators,0,newResult,0,relIdIterators.length);
        arraycopy(additional,0,newResult,relIdIterators.length,additionalSize);
        result=newResult;
      }
 else {
        result=relIdIterators;
      }
      if (result.length == 0) {
        return Collections.emptyIterator();
      }
      return new RelationshipIterator(result,nodeImpl,direction,nodeManager,hasMore,true);
    }
  }
;
}
