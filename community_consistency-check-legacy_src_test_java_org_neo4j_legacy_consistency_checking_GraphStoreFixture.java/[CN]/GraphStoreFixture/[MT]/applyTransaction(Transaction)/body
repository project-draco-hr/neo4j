{
  GraphDatabaseBuilder builder=new TestGraphDatabaseFactory().newEmbeddedDatabaseBuilder(directory);
  GraphDatabaseAPI database=(GraphDatabaseAPI)builder.newGraphDatabase();
  try {
    DependencyResolver dependencyResolver=database.getDependencyResolver();
    TransactionRepresentationCommitProcess commitProcess=new TransactionRepresentationCommitProcess(dependencyResolver.resolveDependency(TransactionAppender.class),dependencyResolver.resolveDependency(StorageEngine.class));
    TransactionIdStore transactionIdStore=database.getDependencyResolver().resolveDependency(TransactionIdStore.class);
    NodeStore nodes=database.getDependencyResolver().resolveDependency(NeoStores.class).getNodeStore();
    TransactionRepresentation representation=transaction.representation(idGenerator(),masterId(),myId(),transactionIdStore.getLastCommittedTransactionId(),nodes);
    commitProcess.commit(new TransactionToApply(representation),CommitEvent.NULL,TransactionApplicationMode.EXTERNAL);
  }
  finally {
    database.shutdown();
  }
}
