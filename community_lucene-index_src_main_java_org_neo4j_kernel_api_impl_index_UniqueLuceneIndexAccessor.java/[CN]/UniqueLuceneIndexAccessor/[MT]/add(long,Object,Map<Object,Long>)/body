{
  Long previousEntry=valueToNodeIdInCurrentTx.get(value);
  if (previousEntry == null) {
    IndexSearcher searcher=searcherManager.acquire();
    try {
      TopDocs docs=searcher.search(documentStructure.newQuery(value),1);
      if (docs.scoreDocs.length > 0) {
        Document doc=searcher.getIndexReader().document(docs.scoreDocs[0].doc);
        previousEntry=documentStructure.getNodeId(doc);
      }
    }
  finally {
      searcherManager.release(searcher);
    }
  }
  if (previousEntry != null) {
    if (previousEntry != nodeId) {
      throw new IndexEntryConflictException(nodeId,value,previousEntry);
    }
  }
 else {
    valueToNodeIdInCurrentTx.put(value,nodeId);
    writer.addDocument(documentStructure.newDocument(nodeId,value));
  }
}
