{
  nodeIds.add(nodeId);
  while (retry) {
    retry=false;
    first=true;
    firstRelId=-1;
    try (Cursor<NodeItem> cursor=entityReadOperations.nodeCursorById(state,nodeId)){
      RelationshipIterator relationships=cursor.get().getRelationships(Direction.BOTH);
      while (relationships.hasNext()) {
        entityReadOperations.relationshipVisit(state,relationships.next(),collectNodeIdVisitor);
      }
    }
     PrimitiveLongIterator nodeIdIterator=nodeIds.iterator();
    while (nodeIdIterator.hasNext()) {
      state.locks().optimistic().acquireExclusive(ResourceTypes.NODE,nodeIdIterator.next());
    }
    try (Cursor<NodeItem> cursor=entityReadOperations.nodeCursorById(state,nodeId)){
      RelationshipIterator relationships=cursor.get().getRelationships(Direction.BOTH);
      while (relationships.hasNext()) {
        entityReadOperations.relationshipVisit(state,relationships.next(),relationshipConsumingVisitor);
        if (retry) {
          PrimitiveLongIterator iterator=nodeIds.iterator();
          while (iterator.hasNext()) {
            state.locks().optimistic().releaseExclusive(ResourceTypes.NODE,iterator.next());
          }
          nodeIds.clear();
          break;
        }
      }
    }
   }
}
