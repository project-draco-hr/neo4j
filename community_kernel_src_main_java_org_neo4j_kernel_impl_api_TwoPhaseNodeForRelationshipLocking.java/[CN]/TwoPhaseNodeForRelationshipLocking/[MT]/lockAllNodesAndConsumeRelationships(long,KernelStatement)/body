{
  while (retry) {
    retry=false;
    first=true;
    firstRelId=-1;
    try (Cursor<NodeItem> cursor=reads.nodeCursorById(state,nodeId)){
      RelationshipIterator relationships=cursor.get().getRelationships(Direction.BOTH);
      while (relationships.hasNext()) {
        reads.relationshipVisit(state,relationships.next(),collectNodeIdVisitor);
      }
    }
 {
      PrimitiveLongIterator iterator=nodeIds.iterator();
      while (iterator.hasNext()) {
        state.locks().optimistic().acquireExclusive(ResourceTypes.NODE,iterator.next());
      }
    }
    try (Cursor<NodeItem> cursor=reads.nodeCursorById(state,nodeId)){
      RelationshipIterator relationships=cursor.get().getRelationships(Direction.BOTH);
      while (relationships.hasNext()) {
        reads.relationshipVisit(state,relationships.next(),relationshipConsumingVisitor);
        if (retry) {
          PrimitiveLongIterator iterator=nodeIds.iterator();
          while (iterator.hasNext()) {
            state.locks().optimistic().releaseExclusive(ResourceTypes.NODE,iterator.next());
          }
          nodeIds.clear();
          break;
        }
      }
    }
   }
}
