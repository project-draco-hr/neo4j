{
  String storeDir=new File("dir").getAbsolutePath();
  final GraphDatabaseAPI db=(GraphDatabaseAPI)new TestGraphDatabaseFactory().setFileSystem(fs.get()).newImpermanentDatabase(storeDir);
  produceNonCleanDefraggedStringStore(db);
  EphemeralFileSystemAbstraction snapshot=fs.snapshot(shutdownDb(db));
  assertNumberOfFreeIdsEquals(storeDir,snapshot,0);
  GraphDatabaseAPI newDb=(GraphDatabaseAPI)new TestGraphDatabaseFactory().setFileSystem(snapshot).newImpermanentDatabaseBuilder(storeDir).setConfig(GraphDatabaseSettings.rebuild_idgenerators_fast,Settings.FALSE).newGraphDatabase();
  assertNumberOfFreeIdsEquals(storeDir,snapshot,4);
  try (Transaction tx=newDb.beginTx()){
    int nameCount=0;
    int relCount=0;
    for (    Node node : GlobalGraphOperations.at(newDb).getAllNodes()) {
      nameCount++;
      assertThat(node,inTx(newDb,hasProperty("name"),true));
      relCount+=count(node.getRelationships(Direction.OUTGOING));
    }
    assertEquals(16,nameCount);
    assertEquals(12,relCount);
    tx.success();
  }
  finally {
    newDb.shutdown();
  }
}
