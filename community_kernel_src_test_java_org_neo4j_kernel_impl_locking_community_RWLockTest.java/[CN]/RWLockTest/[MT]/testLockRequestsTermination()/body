{
  RagManager ragManager=new RagManager();
  LockResource node1=new LockResource(ResourceTypes.NODE,1L);
  final RWLock lock=new RWLock(node1,ragManager);
  final LockTransaction mainTransaction=new LockTransaction();
  final LockTransaction writerTransaction=new LockTransaction();
  final CountDownLatch writerCompletedLatch=new CountDownLatch(1);
  Runnable conflictingWriter=createFailedWriter(lock,writerTransaction,writerCompletedLatch);
  final LockTransaction readerTransaction=new LockTransaction();
  final CountDownLatch readerCompletedLatch=new CountDownLatch(1);
  Runnable reader=createFailedReader(lock,readerTransaction,readerCompletedLatch);
  lock.mark();
  assertTrue(lock.acquireWriteLock(mainTransaction));
  executor.submit(reader);
  executor.submit(conflictingWriter);
  waitWaitingThreads(lock,2);
  assertEquals(3,lock.getTxLockElementCount());
  lock.terminateLockRequestsForLockTransaction(readerTransaction);
  lock.terminateLockRequestsForLockTransaction(writerTransaction);
  readerCompletedLatch.await();
  writerCompletedLatch.await();
  assertEquals(0,lock.getWaitingThreadsCount());
  assertEquals(0,lock.getReadCount());
  assertEquals(1,lock.getWriteCount());
  assertEquals(1,lock.getTxLockElementCount());
}
