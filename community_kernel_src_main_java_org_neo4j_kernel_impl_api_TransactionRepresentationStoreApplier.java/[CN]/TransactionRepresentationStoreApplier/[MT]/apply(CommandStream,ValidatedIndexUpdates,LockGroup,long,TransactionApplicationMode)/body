{
  CommandHandler storeApplier=new NeoStoreTransactionApplier(storageEngine.neoStores(),storageEngine.cacheAccess(),lockService,locks,transactionId);
  if (mode.needsIdTracking()) {
    storeApplier=new HighIdTransactionApplier(storeApplier,storageEngine.neoStores());
  }
  if (mode.needsCacheInvalidationOnUpdates()) {
    storeApplier=new CacheInvalidationTransactionApplier(storeApplier,storageEngine.neoStores(),storageEngine.cacheAccess());
  }
  IndexTransactionApplier indexApplier=new IndexTransactionApplier(storageEngine.indexingService(),indexUpdates,labelScanStoreSync);
  LegacyIndexApplier legacyIndexApplier=new LegacyIndexApplier(indexConfigStore,legacyIndexProviderLookup,legacyIndexTransactionOrdering,transactionId,mode);
  CommandHandler countsStoreApplier=getCountsStoreApplier(transactionId,mode);
  try (CommandApplierFacade applier=new CommandApplierFacade(storeApplier,indexApplier,legacyIndexApplier,countsStoreApplier)){
    representation.accept(applier);
  }
 catch (  Throwable cause) {
    storageEngine.kernelHealth().panic(cause);
    throw cause;
  }
}
