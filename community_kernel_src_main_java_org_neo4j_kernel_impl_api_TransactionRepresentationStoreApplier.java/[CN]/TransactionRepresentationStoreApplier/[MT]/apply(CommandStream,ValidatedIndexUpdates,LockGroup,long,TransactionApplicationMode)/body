{
  CommandHandler storeApplier=new NeoStoreTransactionApplier(neoStores,cacheAccess,lockService,locks,transactionId);
  if (mode.needsIdTracking()) {
    storeApplier=new HighIdTransactionApplier(storeApplier,neoStores);
  }
  if (mode.needsCacheInvalidationOnUpdates()) {
    storeApplier=new CacheInvalidationTransactionApplier(storeApplier,neoStores,cacheAccess);
  }
  IndexTransactionApplier indexApplier=new IndexTransactionApplier(indexingService,indexUpdates,labelScanStoreSync);
  LegacyIndexApplier legacyIndexApplier=new LegacyIndexApplier(indexConfigStore,legacyIndexProviderLookup,legacyIndexTransactionOrdering,transactionId,mode);
  CommandHandler countsStoreApplier=getCountsStoreApplier(transactionId,mode);
  try (CommandApplierFacade applier=new CommandApplierFacade(storeApplier,indexApplier,legacyIndexApplier,countsStoreApplier)){
    representation.accept(applier);
  }
 catch (  Throwable cause) {
    kernelHealth.panic(cause);
    throw cause;
  }
}
