{
  final BatchImporter inserter=new ParallelBatchImporter(directory.absolutePath(),new DefaultFileSystemAbstraction(),config,new DevNullLoggingService(),invisible(),writerFactory,EMPTY,memoryCalculator);
  boolean successful=false;
  int relationshipCount=NODE_COUNT * 3;
  try {
    inserter.doImport(Inputs.input(nodes(NODE_COUNT,inputIdGenerator),relationships(relationshipCount,inputIdGenerator),idMapper,idGenerator));
    GraphDatabaseService db=new GraphDatabaseFactory().newEmbeddedDatabase(directory.absolutePath());
    try (Transaction tx=db.beginTx()){
      verifyData(NODE_COUNT,db);
      tx.success();
    }
  finally {
      db.shutdown();
    }
    assertConsistent(directory.absolutePath());
    successful=true;
  }
  finally {
    if (!successful) {
      File failureFile=directory.file("input");
      try (PrintStream out=new PrintStream(failureFile)){
        out.println("Seed used in this failing run: " + random.seed());
        out.println(inputIdGenerator);
        for (        InputRelationship relationship : relationships(relationshipCount,inputIdGenerator)) {
          out.println(relationship.id() + " " + relationship.startNode()+ "-[:"+ relationship.type()+ "]->"+ relationship.endNode());
        }
      }
       System.err.println("Additional debug information stored in " + failureFile);
    }
  }
}
