{
  ctx.spi.reportError(err);
  if (ctx.hasTransaction()) {
    KernelTransaction.Type txType=ctx.currentTransaction.transactionType();
switch (txType) {
case explicit:
      ctx.currentTransaction.failure();
    break;
case implicit:
  try {
    ctx.currentTransaction.failure();
    ctx.currentTransaction.close();
  }
 catch (  Throwable t) {
    ctx.spi.reportError("While handling '" + err.status() + "', a second failure occurred when "+ "rolling back transaction: "+ t.getMessage(),t);
  }
 finally {
    ctx.currentTransaction=null;
  }
break;
default :
throw new IllegalStateException("Unknown type: " + txType);
}
}
ctx.error(err);
return ERROR;
}
