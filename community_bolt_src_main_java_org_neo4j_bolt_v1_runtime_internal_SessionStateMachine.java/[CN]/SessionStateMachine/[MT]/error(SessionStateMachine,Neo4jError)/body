{
  ctx.spi.reportError(err);
  State outcome=ERROR;
  if (ctx.hasTransaction()) {
switch (ctx.currentTransaction.transactionType()) {
case explicit:
      ctx.currentTransaction.failure();
    break;
case implicit:
  try {
    ctx.currentTransaction.failure();
    ctx.currentTransaction.close();
  }
 catch (  Throwable t) {
    ctx.spi.reportError("While handling '" + err.status() + "', a second failure occurred when "+ "rolling back transaction: "+ t.getMessage(),t);
  }
 finally {
    ctx.currentTransaction=null;
  }
break;
}
}
ctx.error(err);
return outcome;
}
