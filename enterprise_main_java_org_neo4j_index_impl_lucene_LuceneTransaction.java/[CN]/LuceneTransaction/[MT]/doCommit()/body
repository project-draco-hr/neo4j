{
  dataSource.getWriteLock();
  try {
    for (    Map.Entry<IndexIdentifier,CommandList> entry : this.commandMap.entrySet()) {
      if (entry.getValue().isEmpty()) {
        continue;
      }
      IndexIdentifier identifier=entry.getKey();
      IndexType type=identifier == LuceneCommand.CreateIndexCommand.FAKE_IDENTIFIER ? null : dataSource.getType(identifier);
      CommandList commandList=entry.getValue();
      CommitContext context=new CommitContext(dataSource,identifier,type,commandList);
      for (      LuceneCommand command : commandList.commands) {
        command.perform(context);
      }
      applyDocuments(context.writer,type,context.documents);
      if (context.writer != null && !context.isRecovery) {
        context.safeCloseWriter();
        dataSource.invalidateIndexSearcher(identifier);
      }
    }
    dataSource.setLastCommittedTxId(getCommitTxId());
    closeTxData();
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
 finally {
    dataSource.releaseWriteLock();
  }
}
