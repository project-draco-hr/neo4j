{
  int clusterSize=3;
  ClusterManager manager=new ClusterManager.Builder().withRootDirectory(dir.cleanDirectory("testcluster")).withProvider(ClusterManager.clusterOfSize(clusterSize)).withSharedConfig(stringMap(ClusterSettings.heartbeat_interval.name(),"1")).build();
  try {
    manager.start();
    ClusterManager.ManagedCluster cluster=manager.getDefaultCluster();
    cluster.await(allSeesAllAsAvailable());
    cluster.await(masterAvailable());
    HighlyAvailableGraphDatabase oldMaster=cluster.getMaster();
    CountDownLatch masterTransitionLatch=new CountDownLatch(1);
    setupForWaitOnSwitchToDetached(oldMaster,masterTransitionLatch);
    addSomeData(oldMaster);
    ClusterManager.RepairKit fail=cluster.fail(oldMaster,NetworkFlag.values());
    cluster.await(instanceEvicted(oldMaster),20);
    masterTransitionLatch.await();
    ensureInstanceIsReadOnlyInPendingState(oldMaster);
    fail.repair();
    cluster.await(allSeesAllAsAvailable());
    ensureInstanceIsWritable(oldMaster);
  }
  finally {
    manager.safeShutdown();
  }
}
