{
  if (relPhase != RelPhase.FULL_REL) {
    List<RelationshipImpl> fullRelationshipList=nodeManager.loadRelationships(this);
    ArrayIntSet addedRels=new ArrayIntSet();
    ArrayMap<String,ArrayIntSet> newRelationshipMap=new ArrayMap<String,ArrayIntSet>();
    for (    Relationship rel : fullRelationshipList) {
      int relId=(int)rel.getId();
      addedRels.add(relId);
      RelationshipType type=rel.getType();
      ArrayIntSet relationshipSet=newRelationshipMap.get(type.name());
      if (relationshipSet == null) {
        relationshipSet=new ArrayIntSet();
        newRelationshipMap.put(type.name(),relationshipSet);
      }
      relationshipSet.add(relId);
    }
    if (relationshipMap != null) {
      for (      String typeName : relationshipMap.keySet()) {
        ArrayIntSet relationshipSet=relationshipMap.get(typeName);
        for (        Integer relId : relationshipSet.values()) {
          if (!addedRels.contains(relId)) {
            ArrayIntSet newRelationshipSet=newRelationshipMap.get(typeName);
            if (newRelationshipSet == null) {
              newRelationshipSet=new ArrayIntSet();
              newRelationshipMap.put(typeName,newRelationshipSet);
            }
            newRelationshipSet.add(relId);
            addedRels.add(relId);
          }
        }
      }
    }
    this.relationshipMap=newRelationshipMap;
    relPhase=RelPhase.FULL_REL;
    return true;
  }
  if (relationshipMap == null) {
    relationshipMap=new ArrayMap<String,ArrayIntSet>();
  }
  return false;
}
