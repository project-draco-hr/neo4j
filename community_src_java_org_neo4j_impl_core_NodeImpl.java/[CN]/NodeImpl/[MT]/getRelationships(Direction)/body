{
  if (dir == Direction.BOTH) {
    return getRelationships();
  }
  boolean checkCow=isCowTx();
  ensureFullRelationships();
  ArrayIntSet relIds=new ArrayIntSet();
  for (  String type : relationshipMap.keySet()) {
    ArrayIntSet source=relationshipMap.get(type);
    for (    int relId : source.values()) {
      if (checkCow) {
        ArrayIntSet skip=nodeManager.getCowRelationshipRemoveMap(this,type);
        if (skip != null && skip.contains(relId)) {
          continue;
        }
      }
      relIds.add(relId);
    }
  }
  if (checkCow) {
    ArrayMap<String,ArrayIntSet> cowRelationshipAddMap=nodeManager.getCowRelationshipAddMap(this);
    if (cowRelationshipAddMap != null) {
      for (      String type : cowRelationshipAddMap.keySet()) {
        ArrayIntSet source=cowRelationshipAddMap.get(type);
        for (        int relId : source.values()) {
          relIds.add(relId);
        }
      }
    }
  }
  return new RelationshipArrayIntSetIterator(relIds,this,dir,nodeManager);
}
