{
  long nodeId=node.getId();
  RelationshipLoadingPosition position=node.getRelChainPosition();
  Pair<Map<RelIdArray.DirectionWrapper,Iterable<RelationshipRecord>>,RelationshipLoadingPosition> rels=threadToTransactionBridge.getNeoStoreTransactionBoundToThisThread(true).getMoreRelationships(nodeId,position,direction,types);
  ArrayMap<Integer,RelIdArray> newRelationshipMap=new ArrayMap<>();
  List<RelationshipImpl> relsList=new ArrayList<>(150);
  Iterable<RelationshipRecord> loops=rels.first().get(RelIdArray.DirectionWrapper.BOTH);
  boolean hasLoops=loops != null;
  if (hasLoops) {
    populateLoadedRelationships(loops,relsList,RelIdArray.DirectionWrapper.BOTH,true,newRelationshipMap);
  }
  populateLoadedRelationships(rels.first().get(RelIdArray.DirectionWrapper.OUTGOING),relsList,RelIdArray.DirectionWrapper.OUTGOING,hasLoops,newRelationshipMap);
  populateLoadedRelationships(rels.first().get(RelIdArray.DirectionWrapper.INCOMING),relsList,RelIdArray.DirectionWrapper.INCOMING,hasLoops,newRelationshipMap);
  return Triplet.of(newRelationshipMap,relsList,rels.other());
}
