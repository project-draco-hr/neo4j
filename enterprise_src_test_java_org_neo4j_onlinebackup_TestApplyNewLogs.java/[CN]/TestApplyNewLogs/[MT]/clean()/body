{
  Util.deleteDir(new File(VAR));
  System.out.println("setting up simple database and backup-copy");
  EmbeddedGraphDatabase graphDb=new EmbeddedGraphDatabase(STORE_LOCATION_DIR);
  graphDb.shutdown();
  Util.copyDir(STORE_LOCATION_DIR,BACKUP_LOCATION_DIR);
  graphDb=new EmbeddedGraphDatabase(STORE_LOCATION_DIR);
  IndexService index=new LuceneIndexService(graphDb);
  XaDataSourceManager xaDsMgr=graphDb.getConfig().getTxModule().getXaDataSourceManager();
  for (  XaDataSource xaDs : xaDsMgr.getAllRegisteredDataSources()) {
    xaDs.keepLogicalLogs(true);
  }
  Transaction tx=graphDb.beginTx();
  try {
    Node node1=graphDb.createNode();
    index.index(node1,"backup_test","1");
    tx.success();
  }
  finally {
    tx.finish();
  }
  for (  XaDataSource xaDs : xaDsMgr.getAllRegisteredDataSources()) {
    xaDs.rotateLogicalLog();
  }
  tx=graphDb.beginTx();
  try {
    Node node2=graphDb.createNode();
    index.index(node2,"backup_test","2");
    tx.success();
  }
  finally {
    tx.finish();
  }
  index.shutdown();
  graphDb.shutdown();
  Util.copyLogs(STORE_LOCATION_DIR,BACKUP_LOCATION_DIR);
}
