{
  long timeout=System.currentTimeMillis() + 1000 * 30;
  byte[] bytes=new byte[length];
  int left=length, read;
  while ((read=in.read(bytes,length - left,left)) != -1 && left > 0) {
    if (System.currentTimeMillis() > timeout) {
      throw new IOException("Waited 30 seconds for " + left + " bytes, recieved "+ (length - left));
    }
    left-=read;
    if (left > 0) {
      Thread.sleep(10);
    }
  }
  return bytes;
}
