{
  filter.file(file);
  File tempFile=new File(file.getAbsolutePath() + ".tmp");
  fileSystem.deleteFile(tempFile);
  FileChannel in=fileSystem.open(file,"r");
  FileChannel out=fileSystem.open(tempFile,"rw");
  LogBuffer outBuffer=new DirectMappedLogBuffer(out,new Monitors().newMonitor(ByteCounterMonitor.class));
  ByteBuffer buffer=ByteBuffer.allocate(1024 * 1024);
  transferLogicalLogHeader(in,outBuffer,buffer);
  XaCommandReader commandReader=new PhysicalLogNeoXaCommandReader(buffer);
  XaCommandWriter commandWriter=new PhysicalLogNeoXaCommandWriter();
  try {
    LogEntry entry=null;
    while ((entry=readEntry(buffer,in,commandReader)) != null) {
      if (!filter.accept(entry)) {
        continue;
      }
      writeLogEntry(entry,outBuffer,commandWriter);
    }
  }
  finally {
    safeClose(in);
    outBuffer.force();
    safeClose(out);
    filter.done(file);
  }
  return tempFile;
}
