{
  File file=oneOrTwo(new File(storeDir,"tm_tx_log"));
  File tempFile=new File(file.getAbsolutePath() + ".tmp");
  FileChannel in=new RandomAccessFile(file,"r").getChannel();
  FileChannel out=new RandomAccessFile(tempFile,"rw").getChannel();
  LogBuffer outBuffer=new DirectMappedLogBuffer(out);
  ByteBuffer buffer=ByteBuffer.allocate(1024 * 1024);
  try {
    in.read(buffer);
    buffer.flip();
    while (buffer.hasRemaining()) {
      byte type=buffer.get();
      List<byte[]> xids=null;
      if (type == TxLog.TX_START)       xids=readXids(buffer,1);
 else       if (type == TxLog.BRANCH_ADD)       xids=readXids(buffer,2);
 else       if (type == TxLog.MARK_COMMIT)       xids=readXids(buffer,1);
 else       if (type == TxLog.TX_DONE)       xids=readXids(buffer,1);
 else       throw new IllegalArgumentException("Unknown type " + type);
      if (filter.accept(Pair.of(type,xids))) {
        outBuffer.put(type);
        writeXids(xids,outBuffer);
      }
    }
  }
  finally {
    safeClose(in);
    outBuffer.force();
    safeClose(out);
  }
  file.delete();
  tempFile.renameTo(file);
}
