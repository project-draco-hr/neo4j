{
  GraphDatabaseService slave=null;
  GraphDatabaseService master=null;
  try {
    File masterDir=TargetDirectory.forTest(getClass()).directory("master",true);
    master=new HighlyAvailableGraphDatabaseFactory().newHighlyAvailableDatabaseBuilder(masterDir.getAbsolutePath()).setConfig(ClusterSettings.server_id,"1").setConfig(ClusterSettings.initial_hosts,":5001").newGraphDatabase();
    File slaveDir=TargetDirectory.forTest(getClass()).directory("slave",true);
    slave=new HighlyAvailableGraphDatabaseFactory().newHighlyAvailableDatabaseBuilder(slaveDir.getAbsolutePath()).setConfig(ClusterSettings.server_id,"2").setConfig(ClusterSettings.initial_hosts,":5001").newGraphDatabase();
    slave.shutdown();
    long nodeId=-1;
    Transaction tx=master.beginTx();
    Node node=master.createNode();
    node.setProperty("from","master");
    nodeId=node.getId();
    tx.success();
    tx.finish();
    slave=new HighlyAvailableGraphDatabaseFactory().newHighlyAvailableDatabaseBuilder(slaveDir.getAbsolutePath()).setConfig(ClusterSettings.server_id,"2").setConfig(ClusterSettings.initial_hosts,":5001").setConfig(HaSettings.pull_interval,"0").newGraphDatabase();
    Transaction transaction=slave.beginTx();
    try {
      assertEquals("master",slave.getNodeById(nodeId).getProperty("from"));
    }
  finally {
      transaction.finish();
    }
  }
  finally {
    if (slave != null) {
      slave.shutdown();
    }
    if (master != null) {
      master.shutdown();
    }
  }
}
