{
  NodeRecord firstNode=recordChangeSet.getNodeRecords().getOrLoad(firstNodeId,null).forChangingLinkage();
  if (!firstNode.inUse()) {
    throw new IllegalStateException("First node[" + firstNodeId + "] is deleted and cannot be used to create a relationship");
  }
  NodeRecord secondNode=recordChangeSet.getNodeRecords().getOrLoad(secondNodeId,null).forChangingLinkage();
  if (!secondNode.inUse()) {
    throw new IllegalStateException("Second node[" + secondNodeId + "] is deleted and cannot be used to create a relationship");
  }
  convertNodeToDenseIfNecessary(firstNode,recordChangeSet.getRelRecords(),recordChangeSet.getRelGroupRecords());
  convertNodeToDenseIfNecessary(secondNode,recordChangeSet.getRelRecords(),recordChangeSet.getRelGroupRecords());
  RelationshipRecord record=recordChangeSet.getRelRecords().create(id,null).forChangingLinkage();
  record.setLinks(firstNodeId,secondNodeId,type);
  record.setInUse(true);
  record.setCreated();
  connectRelationship(firstNode,secondNode,record,recordChangeSet.getRelRecords(),recordChangeSet.getRelGroupRecords());
}
