{
  assertIsLegalIndexName(indexName);
  Node result;
  boolean created;
  if (nodeOrNull != null) {
    if (properties != null) {
      throw new InvalidArgumentsException("Cannot specify properties for a new node, " + "when a node to index is specified.");
    }
    Node node=node(nodeOrNull);
    result=graphDb.index().forNodes(indexName).putIfAbsent(node,key,value);
    created=result == null;
    if (created) {
      UniqueNodeFactory factory=new UniqueNodeFactory(indexName,properties);
      UniqueEntity<Node> entity=factory.getOrCreateWithOutcome(key,value);
      created=entity.entity().getId() == node.getId() || entity.wasCreated();
      result=entity.entity();
    }
  }
 else {
    if (properties != null) {
      for (      Map.Entry<String,Object> entry : properties.entrySet()) {
        entry.setValue(propertySetter.convert(entry.getValue()));
      }
    }
    UniqueNodeFactory factory=new UniqueNodeFactory(indexName,properties);
    UniqueEntity<Node> entity=factory.getOrCreateWithOutcome(key,value);
    result=entity.entity();
    created=entity.wasCreated();
  }
  return Pair.of(new IndexedEntityRepresentation(result,key,value,new NodeIndexRepresentation(indexName,Collections.<String,String>emptyMap())),created);
}
