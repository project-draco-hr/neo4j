{
  startDb();
  Label myLabel=label("MyLabel");
  createIndex(myLabel);
  Set<NodePropertyUpdate> expectedUpdates=createSomeBananas(myLabel);
  killDb();
  when(mockedIndexProvider.getInitialState(anyLong(),Matchers.<Dependencies>any())).thenReturn(InternalIndexState.ONLINE);
  GatheringIndexWriter writer=new GatheringIndexWriter();
  when(mockedIndexProvider.getWriter(anyLong(),Matchers.<Dependencies>any())).thenReturn(writer);
  startDb();
  Collection<IndexDefinition> indexes=asCollection(db.schema().getIndexes(myLabel));
  assertThat(indexes.size(),equalTo(1));
  IndexDefinition index=single(indexes);
  assertThat(db.schema().getIndexState(index),equalTo(Schema.IndexState.ONLINE));
  verify(mockedIndexProvider,times(1)).getPopulator(anyLong(),Matchers.<Dependencies>any());
  verify(mockedIndexProvider,times(1)).getWriter(anyLong(),Matchers.<Dependencies>any());
  assertEquals(expectedUpdates,writer.updates);
}
