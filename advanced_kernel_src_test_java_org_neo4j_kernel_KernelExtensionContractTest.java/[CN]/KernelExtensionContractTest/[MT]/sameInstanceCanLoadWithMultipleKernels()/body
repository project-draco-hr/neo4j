{
  EmbeddedGraphDatabase graphdb1=graphdb("graphdb1",false,1);
  try {
    EmbeddedGraphDatabase graphdb2=graphdb("graphdb2",false,2);
    try {
      KernelData extensions1=getExtensions(graphdb1), extensions2=getExtensions(graphdb2);
      X instance=newInstance();
      extensions1.loadExtensions(Collections.<KernelExtension<?>>singleton(instance),StringLogger.SYSTEM);
      extensions2.loadExtensions(Collections.<KernelExtension<?>>singleton(instance),StringLogger.SYSTEM);
      S state1=extensions1.getState(newInstance()), state2=extensions2.getState(newInstance());
      assertTrue("Failed to load extension with first kernel",isLoadedState(state1));
      assertTrue("Failed to load extension with second kernel",isLoadedState(state2));
      assertTrue("Loaded same extension state for both kernels",isOkForDifferentKernels(state1,state2));
      testUnload("first kernel",extensions1,instance,state1);
      testUnload("second kernel",extensions2,instance,state2);
    }
  finally {
      graphdb2.shutdown();
    }
  }
  finally {
    graphdb1.shutdown();
  }
}
