{
  this.graphDb=db;
  TxModule txModule=config.getTxModule();
  boolean isReadOnly=((AbstractGraphDatabase)graphDb).isReadOnly();
  Map<Object,Object> params=new HashMap<Object,Object>(config.getParams());
  params.put("read_only",isReadOnly);
  dataSource=(LuceneDataSource)txModule.registerDataSource(DATA_SOURCE_NAME,LuceneDataSource.class.getName(),LuceneDataSource.DEFAULT_BRANCH_ID,params,true);
  broker=isReadOnly ? new ReadOnlyIndexConnectionBroker<LuceneXaConnection>(txModule.getTxManager()) : new ConnectionBroker(txModule.getTxManager(),dataSource);
}
