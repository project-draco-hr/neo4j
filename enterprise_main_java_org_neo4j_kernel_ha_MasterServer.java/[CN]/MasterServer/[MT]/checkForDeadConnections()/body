{
synchronized (ongoingTransactions) {
    Collection<Channel> channelsToRemove=new ArrayList<Channel>();
    for (    Map.Entry<Channel,Set<SlaveContext>> entry : ongoingTransactions.entrySet()) {
      if (channelIsClosed(entry.getKey())) {
        for (        SlaveContext tx : entry.getValue()) {
          ((MasterImpl)realMaster).rollbackOngoingTransaction(tx);
        }
      }
      channelsToRemove.add(entry.getKey());
    }
    for (    Channel channel : channelsToRemove) {
      ongoingTransactions.remove(channel);
    }
  }
}
