{
  GraphDatabaseAPI db=null;
  ServerInterface server=null;
  try {
    createInitialDataSet(serverPath);
    server=startServer(serverPath);
    OnlineBackup backup=OnlineBackup.from(InetAddress.getLocalHost().getHostAddress());
    backup.full(backupPath.getPath());
    shutdownServer(server);
    server=null;
    addMoreData(serverPath);
    server=startServer(serverPath);
    backup.incremental(backupPath.getPath());
    shutdownServer(server);
    server=null;
    new GraphDatabaseFactory().newEmbeddedDatabase(backupPath.getPath()).shutdown();
    new GraphDatabaseFactory().newEmbeddedDatabase(backupPath.getPath()).shutdown();
    addMoreData(serverPath);
    server=startServer(serverPath);
    backup.incremental(backupPath.getPath());
    shutdownServer(server);
    server=null;
    int logsFound=backupPath.listFiles(new FilenameFilter(){
      @Override public boolean accept(      File dir,      String name){
        return name.startsWith("nioneo_logical.log") && !name.endsWith("active");
      }
    }
).length;
    assertEquals(2,logsFound);
    db=(GraphDatabaseAPI)new GraphDatabaseFactory().newEmbeddedDatabase(backupPath.getPath());
    for (    XaDataSource ds : db.getDependencyResolver().resolveDependency(XaDataSourceManager.class).getAllRegisteredDataSources()) {
      ds.getMasterForCommittedTx(ds.getLastCommittedTxId());
    }
  }
  finally {
    if (db != null) {
      db.shutdown();
    }
    if (server != null) {
      shutdownServer(server);
    }
  }
}
