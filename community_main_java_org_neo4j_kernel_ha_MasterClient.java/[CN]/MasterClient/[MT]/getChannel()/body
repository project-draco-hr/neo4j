{
  Thread thread=Thread.currentThread();
synchronized (channels) {
    Channel channel=channels.get(thread);
    if (channel == null) {
      channel=unusedChannels.poll();
      if (channel == null) {
        ChannelFuture channelFuture=bootstrap.connect(new InetSocketAddress(hostNameOrIp,port));
        channelFuture.awaitUninterruptibly();
        channel=channelFuture.getChannel();
      }
      channels.put(thread,channel);
    }
    return channel;
  }
}
