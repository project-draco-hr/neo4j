{
  try {
    ensureLuceneDataInstantiated();
    long id=entityId.id();
    Document document=findDocument(id);
    boolean add=false;
    if (document == null) {
      document=IndexType.newDocument(entityId);
      document.add(new StoredField(TX_STATE_KEY,TX_STATE_VALUE));
      cachedDocuments.put(id,document);
      add=true;
    }
    if (key == null && value == null) {
      document.add(new StringField(ORPHANS_KEY,ORPHANS_VALUE,Store.NO));
      addOrphan(null);
    }
 else     if (value == null) {
      document.add(new StringField(ORPHANS_KEY,key,Store.NO));
      addOrphan(key);
    }
 else {
      index.type.addToDocument(document,key,value);
    }
    if (add) {
      writer.addDocument(document);
    }
 else {
      writer.updateDocument(index.type.idTerm(id),document);
    }
    invalidateSearcher();
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
