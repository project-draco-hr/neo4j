{
  NodeImpl startNode=null;
  NodeImpl endNode=null;
  boolean startNodeLocked=false;
  boolean endNodeLocked=false;
  boolean thisLocked=false;
  boolean success=false;
  TransactionState tx=null;
  try {
    startNode=nodeManager.getLightNode(getStartNodeId());
    if (startNode != null) {
      nodeManager.acquireLock(startNode,LockType.WRITE);
      startNodeLocked=true;
    }
    endNode=nodeManager.getLightNode(getEndNodeId());
    if (endNode != null) {
      nodeManager.acquireLock(endNode,LockType.WRITE);
      endNodeLocked=true;
    }
    nodeManager.acquireLock(proxy,LockType.WRITE);
    thisLocked=true;
    tx=nodeManager.getTransactionState();
    ArrayMap<Integer,PropertyData> skipMap=tx.getOrCreateCowPropertyRemoveMap(this);
    ArrayMap<Integer,PropertyData> removedProps=nodeManager.deleteRelationship(this,tx);
    if (removedProps.size() > 0) {
      for (      int index : removedProps.keySet()) {
        skipMap.put(index,removedProps.get(index));
      }
    }
    success=true;
    int typeId=getTypeId();
    long id=getId();
    if (startNode != null) {
      tx.getOrCreateCowRelationshipRemoveMap(startNode,typeId).add(id);
    }
    if (endNode != null) {
      tx.getOrCreateCowRelationshipRemoveMap(endNode,typeId).add(id);
    }
    success=true;
  }
  finally {
    boolean releaseFailed=false;
    try {
      if (thisLocked) {
        nodeManager.releaseLock(proxy,LockType.WRITE,tx);
      }
    }
 catch (    Exception e) {
      releaseFailed=true;
      e.printStackTrace();
    }
    try {
      if (startNodeLocked) {
        nodeManager.releaseLock(startNode,LockType.WRITE,tx);
      }
    }
 catch (    Exception e) {
      releaseFailed=true;
      e.printStackTrace();
    }
    try {
      if (endNodeLocked) {
        nodeManager.releaseLock(endNode,LockType.WRITE,tx);
      }
    }
 catch (    Exception e) {
      releaseFailed=true;
      e.printStackTrace();
    }
    if (!success) {
      nodeManager.setRollbackOnly();
    }
    if (releaseFailed) {
      throw new LockException("Unable to release locks [" + startNode + ","+ endNode+ "] in relationship delete->"+ this);
    }
  }
}
