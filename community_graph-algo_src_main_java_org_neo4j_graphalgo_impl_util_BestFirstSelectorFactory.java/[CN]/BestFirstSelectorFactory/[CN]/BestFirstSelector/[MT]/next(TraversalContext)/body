{
  while (true) {
    TraversalBranch next=current.next(expander,metadata);
    if (next == null) {
      break;
    }
    long endNodeId=next.endNode().getId();
    Visit<P> stay=visits.get(endNodeId);
    if (stay == null || !stay.visited) {
      D cost=calculateValue(next);
      P newPriority=addPriority(next,currentAggregatedValue,cost);
      boolean newStay=stay == null;
      if (newStay) {
        stay=new Visit<P>(newPriority);
        visits.put(endNodeId,stay);
      }
      if (newStay || interestPredicate.apply(stay,newPriority)) {
        queue.put(next,newPriority);
        stay.cost=newPriority;
      }
    }
  }
  Entry<TraversalBranch,P> entry=queue.pop();
  if (entry != null) {
    current=entry.getEntity();
    currentAggregatedValue=entry.getPriority();
    visits.get(current.endNode().getId()).visited=true;
    return current;
  }
  return null;
}
