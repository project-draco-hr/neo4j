{
  if (xaResource instanceof XaResource) {
    byte branchId[]=((XaResource)xaResource).getBranchId();
    if (branchId != null) {
      return branchId;
    }
  }
  Iterator<Map.Entry<String,XaDataSource>> itr=dataSources.entrySet().iterator();
  while (itr.hasNext()) {
    Map.Entry<String,XaDataSource> entry=itr.next();
    XaDataSource dataSource=entry.getValue();
    XAResource resource=dataSource.getXaConnection().getXaResource();
    try {
      if (resource.isSameRM(xaResource)) {
        String name=entry.getKey();
        return sourceIdMapping.get(name);
      }
    }
 catch (    XAException e) {
      throw new TransactionFailureException("Unable to check is same resource",e);
    }
  }
  throw new TransactionFailureException("Unable to find mapping for XAResource[" + xaResource + "]");
}
