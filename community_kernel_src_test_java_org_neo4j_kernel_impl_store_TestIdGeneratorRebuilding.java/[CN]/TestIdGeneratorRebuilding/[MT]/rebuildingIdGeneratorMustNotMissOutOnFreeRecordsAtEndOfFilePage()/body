{
  Config config=new Config(MapUtil.stringMap(GraphDatabaseSettings.rebuild_idgenerators_fast.name(),"false"));
  File storeFile=file("nodes");
  fs.create(storeFile);
  IdGeneratorImpl.createGenerator(fs,file("nodes.id"));
  DynamicArrayStore labelStore=mock(DynamicArrayStore.class);
  NodeStore store=new NodeStore(storeFile,config,new DefaultIdGeneratorFactory(),pageCacheRule.getPageCache(fs),fs,StringLogger.DEV_NULL,labelStore,StoreVersionMismatchHandler.FORCE_CURRENT_VERSION,new Monitors());
  store.makeStoreOk();
  int recordsPerPage=store.recordsPerPage();
  NodeRecord record=new NodeRecord(0);
  record.setInUse(true);
  int highestId=recordsPerPage * 3;
  for (int i=0; i < highestId; i++) {
    assertThat(store.nextId(),is((long)i));
    record.setId(i);
    store.updateRecord(record);
  }
  store.setHighestPossibleIdInUse(highestId);
  Long[] idsToFree={recordsPerPage - 2L,recordsPerPage - 1L};
  record.setInUse(false);
  for (  long toDelete : idsToFree) {
    record.setId(toDelete);
    store.updateRecord(record);
  }
  store.rebuildIdGenerator();
  store.closeIdGenerator();
  store.openIdGenerator();
  List<Long> nextIds=new ArrayList<>();
  nextIds.add(store.nextId());
  nextIds.add(store.nextId());
  nextIds.add(store.nextId());
  assertThat(nextIds,contains(recordsPerPage - 2L,recordsPerPage - 1L,recordsPerPage * 3L));
  store.close();
}
