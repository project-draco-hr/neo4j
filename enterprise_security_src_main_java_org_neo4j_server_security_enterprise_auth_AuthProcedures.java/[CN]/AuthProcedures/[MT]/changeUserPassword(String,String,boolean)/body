{
  String ownOrOther=format("password for user `%s`",username);
  try {
    StandardEnterpriseAuthSubject enterpriseSubject=StandardEnterpriseAuthSubject.castOrFail(authSubject);
    if (enterpriseSubject.hasUsername(username)) {
      ownOrOther="password";
      enterpriseSubject.setPassword(newPassword,requirePasswordChange);
      securityLog.info(authSubject,"changed password%s",requirePasswordChange ? ", with password change required" : "");
    }
 else     if (!enterpriseSubject.isAdmin()) {
      throw new AuthorizationViolationException(PERMISSION_DENIED);
    }
 else {
      enterpriseSubject.getUserManager().setUserPassword(username,newPassword,requirePasswordChange);
      terminateTransactionsForValidUser(username);
      terminateConnectionsForValidUser(username);
      securityLog.info(authSubject,"changed password for user `%s`%s",username,requirePasswordChange ? ", with password change required" : "");
    }
  }
 catch (  Exception e) {
    securityLog.error(authSubject,"tried to change %s: %s",ownOrOther,e.getMessage());
    throw e;
  }
}
