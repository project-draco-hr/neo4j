{
  StandardEnterpriseAuthSubject enterpriseSubject=StandardEnterpriseAuthSubject.castOrFail(authSubject);
  if (enterpriseSubject.doesUsernameMatch(username)) {
    enterpriseSubject.setPassword(newPassword,requirePasswordChange);
  }
 else   if (!enterpriseSubject.isAdmin()) {
    securityLog.error("User `%s` tried to change password for user `%s`: %s",enterpriseSubject.name(),username,PERMISSION_DENIED);
    throw new AuthorizationViolationException(PERMISSION_DENIED);
  }
 else {
    enterpriseSubject.getUserManager().setUserPassword(username,newPassword,requirePasswordChange);
    terminateTransactionsForValidUser(username);
    terminateConnectionsForValidUser(username);
  }
}
