{
  if (authSubject.hasUsername(username)) {
    changePassword(newPassword,requirePasswordChange);
  }
 else {
    StandardEnterpriseAuthSubject enterpriseSubject=StandardEnterpriseAuthSubject.castOrFail(authSubject);
    try {
      if (!enterpriseSubject.isAdmin()) {
        throw new AuthorizationViolationException(PERMISSION_DENIED);
      }
 else {
        enterpriseSubject.getUserManager().setUserPassword(username,newPassword,requirePasswordChange);
        terminateTransactionsForValidUser(username);
        terminateConnectionsForValidUser(username);
        securityLog.info(authSubject,"changed password for user `%s`%s",username,requirePasswordChange ? ", with password change required" : "");
      }
    }
 catch (    Exception e) {
      securityLog.error(authSubject,"tried to change password for user `%s`: %s",username,e.getMessage());
      throw e;
    }
  }
}
