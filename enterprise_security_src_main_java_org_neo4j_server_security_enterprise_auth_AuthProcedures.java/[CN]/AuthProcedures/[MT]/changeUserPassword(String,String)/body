{
  ShiroAuthSubject shiroSubject=ShiroAuthSubject.castOrFail(authSubject);
  if (shiroSubject.doesUsernameMatch(username)) {
    shiroSubject.getUserManager().setPassword(shiroSubject,username,newPassword);
  }
 else   if (!shiroSubject.isAdmin()) {
    throw new AuthorizationViolationException(PERMISSION_DENIED);
  }
 else {
    shiroSubject.getUserManager().setUserPassword(username,newPassword);
  }
}
