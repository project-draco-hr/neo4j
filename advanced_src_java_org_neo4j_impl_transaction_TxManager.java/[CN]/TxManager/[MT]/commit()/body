{
  if (!tmOk) {
    throw new SystemException("TM has encountered some problem, " + "please perform neccesary action (tx recovery/restart)");
  }
  Thread thread=Thread.currentThread();
  TransactionImpl tx=txThreadMap.get(thread);
  if (tx == null) {
    throw new IllegalStateException("Not in transaction");
  }
  if (tx.getStatus() != Status.STATUS_ACTIVE && tx.getStatus() != Status.STATUS_MARKED_ROLLBACK) {
    throw new IllegalStateException("Tx status is: " + getTxStatusAsString(tx.getStatus()));
  }
  tx.doBeforeCompletion();
  if (tx.getStatus() == Status.STATUS_ACTIVE) {
    commit(thread,tx);
    Event event=Event.TX_IMMEDIATE_COMMIT;
    eventManager.generateProActiveEvent(event,new EventData(tx.getEventIdentifier()));
  }
 else   if (tx.getStatus() == Status.STATUS_MARKED_ROLLBACK) {
    rollbackCommit(thread,tx);
    Event event=Event.TX_IMMEDIATE_ROLLBACK;
    eventManager.generateProActiveEvent(event,new EventData(tx.getEventIdentifier()));
  }
 else {
    throw new IllegalStateException("Tx status is: " + getTxStatusAsString(tx.getStatus()));
  }
}
