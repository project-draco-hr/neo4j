{
  if (fileChannel == null) {
    return;
  }
  closeStorage();
  try {
    storeFile.close();
  }
 catch (  IOException e) {
    throw new UnderlyingStorageException("Failed to close store file: " + getStorageFileName(),e);
  }
  if (idGenerator == null || !storeOk) {
    closeFileChannel();
    return;
  }
  final long highId=idGenerator.getHighId();
  final int recordSize=getRecordSize();
  idGenerator.close();
  IOException storedIoe=null;
  try {
    windowsSafeIOOperation(new FileOperation(){
      @Override public void perform() throws IOException {
        fileChannel.position(highId * recordSize);
        ByteBuffer buffer=wrap(encode(versionMismatchHandler.trailerToWrite(getTypeAndVersionDescriptor(),readTypeDescriptorAndVersion)));
        fileChannel.write(buffer);
        log.debug("Closing " + storageFileName + ", truncating at "+ fileChannel.position()+ " vs file size "+ fileChannel.size());
        fileChannel.truncate(fileChannel.position());
        fileChannel.force(false);
        closeFileChannel();
      }
    }
);
  }
 catch (  IOException e) {
    storedIoe=e;
  }
  if (storedIoe != null) {
    throw new UnderlyingStorageException("Unable to close store " + getStorageFileName(),storedIoe);
  }
}
