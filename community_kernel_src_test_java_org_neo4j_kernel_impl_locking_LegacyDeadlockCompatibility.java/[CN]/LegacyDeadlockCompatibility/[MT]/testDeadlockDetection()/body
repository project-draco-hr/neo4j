{
  long r1=1L;
  long r2=2L;
  long r3=3L;
  long r4=4L;
  LockWorker t1=new LockWorker("T1",locks);
  LockWorker t2=new LockWorker("T2",locks);
  LockWorker t3=new LockWorker("T3",locks);
  LockWorker t4=new LockWorker("T4",locks);
  try {
    t1.getReadLock(r1,true);
    t1.getReadLock(r4,true);
    t2.getReadLock(r2,true);
    t2.getReadLock(r3,true);
    t3.getReadLock(r3,true);
    t3.getWriteLock(r1,false);
    t2.getWriteLock(r4,false);
    t1.getWriteLock(r2,true);
    assertTrue(t1.isLastGetLockDeadLock());
    t1.releaseReadLock(r4);
    t1.getWriteLock(r2,false);
    t2.releaseReadLock(r2);
    t1.getWriteLock(r4,false);
    t2.getWriteLock(r2,true);
    assertTrue(t2.isLastGetLockDeadLock() || t1.isLastGetLockDeadLock());
    t2.releaseWriteLock(r4);
    t1.releaseWriteLock(r4);
    t2.getReadLock(r4,true);
    t1.releaseWriteLock(r2);
    t1.getReadLock(r2,true);
    t1.releaseReadLock(r1);
    t3.getReadLock(r2,true);
    t3.releaseWriteLock(r1);
    t1.getReadLock(r1,true);
    t1.getWriteLock(r4,false);
    t3.getWriteLock(r1,false);
    t4.getReadLock(r2,true);
    t2.getWriteLock(r2,true);
    assertTrue(t2.isLastGetLockDeadLock());
    t2.releaseReadLock(r4);
    t1.releaseWriteLock(r4);
    t1.releaseReadLock(r1);
    t2.getReadLock(r4,true);
    t3.releaseWriteLock(r1);
    t1.getReadLock(r1,true);
    t1.getWriteLock(r4,false);
    t3.releaseReadLock(r2);
    t3.getWriteLock(r1,false);
    t2.releaseReadLock(r4);
    t1.releaseWriteLock(r4);
    t1.releaseReadLock(r1);
    t3.releaseWriteLock(r1);
    t1.releaseReadLock(r2);
    t4.releaseReadLock(r2);
    t2.releaseReadLock(r3);
    t3.releaseReadLock(r3);
    t1.getReadLock(r1,true);
    t2.getReadLock(r1,true);
    t1.getWriteLock(r1,false);
    t2.getWriteLock(r1,true);
    assertTrue(t2.isLastGetLockDeadLock());
    t2.releaseReadLock(r1);
    t1.releaseReadLock(r1);
    t1.releaseWriteLock(r1);
  }
 catch (  Exception e) {
    LockWorkFailureDump dumper=new LockWorkFailureDump(testDir.directory(getClass().getSimpleName()));
    File file=dumper.dumpState(locks,t1,t2,t3,t4);
    throw new RuntimeException("Failed, forensics information dumped to " + file.getAbsolutePath(),e);
  }
 finally {
    t1.close();
    t2.close();
    t3.close();
    t4.close();
  }
}
