{
  try {
    if (transaction.isOpen()) {
      transaction.close();
    }
  }
 catch (  DeadlockDetectedException e) {
    throw e;
  }
catch (  Exception e) {
    String userMessage=transactionOutcome.successCalled() ? "Transaction was marked as successful, but unable to commit transaction so rolled back." : "Unable to rollback transaction";
    if (e instanceof KernelException && ((KernelException)e).status().code().classification() == Classification.TransientError) {
      throw new TransientTransactionFailureException(userMessage,e);
    }
    throw new TransactionFailureException(userMessage,e);
  }
 finally {
    stmtProvider.unbindTransactionFromCurrentThread();
  }
}
