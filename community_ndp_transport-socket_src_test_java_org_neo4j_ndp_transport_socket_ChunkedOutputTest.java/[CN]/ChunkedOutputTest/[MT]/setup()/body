{
  ChannelHandlerContext ch=mock(ChannelHandlerContext.class);
  when(ch.alloc()).thenReturn(UnpooledByteBufAllocator.DEFAULT);
  when(ch.writeAndFlush(any())).thenAnswer(new Answer<Object>(){
    @Override public Object answer(    InvocationOnMock invocation) throws Throwable {
      ByteBuf byteBuf=(ByteBuf)invocation.getArguments()[0];
      writtenData.limit(writtenData.position() + byteBuf.readableBytes());
      byteBuf.readBytes(writtenData);
      return null;
    }
  }
);
  out.setTargetChannel(ch);
}
