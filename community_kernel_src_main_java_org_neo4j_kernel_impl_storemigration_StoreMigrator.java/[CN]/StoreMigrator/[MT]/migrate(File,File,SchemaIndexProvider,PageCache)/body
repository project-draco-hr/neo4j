{
  progressMonitor.started();
  NeoStoreUtil neoStoreAccess=new NeoStoreUtil(storeDir,fileSystem);
  long lastTxId=neoStoreAccess.getLastCommittedTx();
  long lastTxChecksum=extractTransactionChecksum(neoStoreAccess,storeDir,lastTxId);
  writeLastTxChecksum(migrationDir,lastTxChecksum);
  if (versionToUpgradeFrom(storeDir).equals(Legacy21Store.LEGACY_VERSION)) {
    final LifeSupport life=new LifeSupport();
    life.start();
    try {
      removeDuplicateEntityProperties(storeDir,migrationDir,pageCache,schemaIndexProvider);
      rebuildCountsFromScratch(storeDir,migrationDir,lastTxId,pageCache);
    }
  finally {
      life.shutdown();
    }
  }
 else {
    migrateWithBatchImporter(storeDir,migrationDir,lastTxId,lastTxChecksum,pageCache);
  }
  progressMonitor.finished();
}
