{
  progressMonitor.started();
  File neoStore=new File(storeDir,NeoStore.DEFAULT_NAME);
  long lastTxId=NeoStore.getRecord(pageCache,neoStore,Position.LAST_TRANSACTION_ID);
  long lastTxChecksum=extractTransactionChecksum(neoStore,storeDir,lastTxId);
  LogPosition lastTxLogPosition=extractTransactionLogPosition(neoStore,lastTxId);
  writeLastTxChecksum(migrationDir,lastTxChecksum);
  writeLastTxLogPosition(migrationDir,lastTxLogPosition);
  if (versionToUpgradeFrom(storeDir).equals(Legacy22Store.LEGACY_VERSION)) {
  }
 else   if (versionToUpgradeFrom(storeDir).equals(Legacy21Store.LEGACY_VERSION)) {
    removeDuplicateEntityProperties(storeDir,migrationDir,pageCache,schemaIndexProvider);
    rebuildCountsFromScratch(storeDir,migrationDir,lastTxId,pageCache);
  }
 else {
    migrateWithBatchImporter(storeDir,migrationDir,lastTxId,lastTxChecksum,lastTxLogPosition.getLogVersion(),lastTxLogPosition.getByteOffset(),pageCache);
  }
  progressMonitor.finished();
}
