{
  final LifeSupport life=new LifeSupport();
  life.start();
  try {
    final PageCache pageCache=createPageCache(fileSystem,"build-counts",life);
    final File storeFileBase=new File(migrationDir,NeoStore.DEFAULT_NAME + StoreFactory.COUNTS_STORE);
    CountsTracker.createEmptyCountsStore(pageCache,storeFileBase,buildTypeDescriptorAndVersion(CountsTracker.STORE_DESCRIPTOR));
    final StoreFactory storeFactory=new StoreFactory(fileSystem,storeDir,pageCache,DEV_NULL,new Monitors());
    try (NodeStore nodeStore=storeFactory.newNodeStore();RelationshipStore relationshipStore=storeFactory.newRelationshipStore();CountsTracker tracker=new CountsTracker(fileSystem,pageCache,storeFileBase,BASE_TX_ID)){
      CountsComputer.computeCounts(nodeStore,relationshipStore).accept(new CountsAccessor.Initializer(tracker));
      tracker.rotate(lastTxId);
    }
   }
  finally {
    life.shutdown();
  }
}
