{
  prepareBatchImportMigration(storeDir,migrationDir);
  LegacyStore legacyStore;
switch (versionToUpgradeFrom(storeDir)) {
case Legacy19Store.LEGACY_VERSION:
    legacyStore=new Legacy19Store(fileSystem,new File(storeDir,NeoStore.DEFAULT_NAME));
  break;
case Legacy20Store.LEGACY_VERSION:
legacyStore=new Legacy20Store(fileSystem,new File(storeDir,NeoStore.DEFAULT_NAME));
break;
default :
throw new IllegalStateException("Unknown version to upgrade from: " + versionToUpgradeFrom(storeDir));
}
BatchImporter importer=new ParallelBatchImporter(migrationDir.getAbsolutePath(),fileSystem,new Configuration.OverrideFromConfig(config),logging,migrationBatchImporterMonitor(legacyStore,progressMonitor),parallel(),readAdditionalIds(storeDir,lastTxId,lastTxChecksum),AvailableMemoryCalculator.RUNTIME);
Iterable<InputNode> nodes=legacyNodesAsInput(legacyStore);
Iterable<InputRelationship> relationships=legacyRelationshipsAsInput(legacyStore);
importer.doImport(Inputs.input(nodes,relationships,IdMappers.actual(),IdGenerators.fromInput()));
StoreFile.fileOperation(DELETE,fileSystem,migrationDir,null,Iterables.<StoreFile,StoreFile>iterable(StoreFile.PROPERTY_STORE,StoreFile.PROPERTY_STRING_STORE,StoreFile.PROPERTY_ARRAY_STORE,StoreFile.PROPERTY_KEY_TOKEN_STORE,StoreFile.PROPERTY_KEY_TOKEN_NAMES_STORE),true,false,StoreFileType.values());
if (legacyStore instanceof Legacy19Store) {
migratePropertyKeys((Legacy19Store)legacyStore,pageCache,migrationDir);
}
legacyStore.close();
}
