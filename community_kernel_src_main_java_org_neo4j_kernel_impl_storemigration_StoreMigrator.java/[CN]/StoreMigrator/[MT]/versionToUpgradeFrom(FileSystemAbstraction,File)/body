{
  if (versionToUpgradeFrom == null) {
    versionToUpgradeFrom=upgradableDatabase.checkUpgradeable(storeDir);
    final LogEntryWriterv1 logEntryWriter=new LogEntryWriterv1();
    logEntryWriter.setCommandWriter(new PhysicalLogNeoXaCommandWriter());
    final LogEntryWriterv1 luceneLogEntryWriter=new LogEntryWriterv1();
    luceneLogEntryWriter.setCommandWriter(LegacyLuceneCommandReader.newWriter());
    if (versionToUpgradeFrom.equals(Legacy19Store.LEGACY_VERSION)) {
      final LegacyLogIoUtil logIoUtil=new Legacy19LogIoUtil(new Legacy19CommandReader());
      final LegacyLogIoUtil luceneLogIoUtil=new Legacy19LogIoUtil(LegacyLuceneCommandReader.newReader());
      legacyLogFiles=new LegacyLogFiles(fileSystem,logEntryWriter,luceneLogEntryWriter,logIoUtil,luceneLogIoUtil);
    }
 else {
      final LegacyLogIoUtil logIoUtil=new Legacy20LogIoUtil(new Legacy20CommandReader());
      final LegacyLogIoUtil luceneLogIoUtil=new Legacy20LogIoUtil(LegacyLuceneCommandReader.newReader());
      legacyLogFiles=new LegacyLogFiles(fileSystem,logEntryWriter,luceneLogEntryWriter,logIoUtil,luceneLogIoUtil);
    }
  }
  return versionToUpgradeFrom;
}
