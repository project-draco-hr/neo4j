{
  progressMonitor.started();
  long lastTxId=NeoStore.getTxId(fileSystem,new File(storeDir,NeoStore.DEFAULT_NAME));
  if (versionToUpgradeFrom(fileSystem,storeDir).equals(Legacy21Store.LEGACY_VERSION)) {
    ensureStoreVersions(storeDir);
    final LifeSupport life=new LifeSupport();
    PageCache pageCache=createPageCache(fileSystem,"migration-pagecache",life);
    try {
      removeDuplicateEntityProperties(storeDir,migrationDir,pageCache);
      rebuildCountsFromScratch(storeDir,migrationDir,lastTxId,pageCache);
    }
  finally {
      life.shutdown();
    }
  }
 else {
    migrateWithBatchImporter(storeDir,migrationDir,lastTxId);
  }
  legacyLogs.migrateLogs(storeDir,migrationDir);
  progressMonitor.finished();
}
