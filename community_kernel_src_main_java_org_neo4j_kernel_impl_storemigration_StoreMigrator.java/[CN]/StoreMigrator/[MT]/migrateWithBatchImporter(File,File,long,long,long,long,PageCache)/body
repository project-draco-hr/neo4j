{
  prepareBatchImportMigration(storeDir,migrationDir);
  LegacyStore legacyStore;
switch (versionToUpgradeFrom(storeDir)) {
case Legacy19Store.LEGACY_VERSION:
    legacyStore=new Legacy19Store(fileSystem,new File(storeDir,MetaDataStore.DEFAULT_NAME));
  break;
case Legacy20Store.LEGACY_VERSION:
legacyStore=new Legacy20Store(fileSystem,new File(storeDir,MetaDataStore.DEFAULT_NAME));
break;
default :
throw new IllegalStateException("Unknown version to upgrade from: " + versionToUpgradeFrom(storeDir));
}
Configuration importConfig=new Configuration.Overridden(config);
BatchImporter importer=new ParallelBatchImporter(migrationDir.getAbsoluteFile(),fileSystem,importConfig,logService,withDynamicProcessorAssignment(migrationBatchImporterMonitor(legacyStore),importConfig),readAdditionalIds(storeDir,lastTxId,lastTxChecksum,lastTxLogVersion,lastTxLogByteOffset));
InputIterable<InputNode> nodes=legacyNodesAsInput(legacyStore);
InputIterable<InputRelationship> relationships=legacyRelationshipsAsInput(legacyStore);
importer.doImport(Inputs.input(nodes,relationships,IdMappers.actual(),IdGenerators.fromInput(),true,0));
StoreFile.fileOperation(DELETE,fileSystem,migrationDir,null,Iterables.<StoreFile,StoreFile>iterable(StoreFile.PROPERTY_STORE,StoreFile.PROPERTY_STRING_STORE,StoreFile.PROPERTY_ARRAY_STORE,StoreFile.PROPERTY_KEY_TOKEN_STORE,StoreFile.PROPERTY_KEY_TOKEN_NAMES_STORE),true,false,StoreFileType.values());
if (legacyStore instanceof Legacy19Store) {
migratePropertyKeys((Legacy19Store)legacyStore,pageCache,migrationDir);
}
legacyStore.close();
}
