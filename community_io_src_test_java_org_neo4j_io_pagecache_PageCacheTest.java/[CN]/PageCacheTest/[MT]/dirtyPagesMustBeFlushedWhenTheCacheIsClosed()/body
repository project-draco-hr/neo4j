{
  ByteBuffer buf=ByteBuffer.allocate(recordSize);
  getPageCache(fs,maxPages,pageCachePageSize,PageCacheTracer.NULL);
  long startPageId=0;
  long endPageId=recordCount / recordsPerFilePage;
  try (PagedFile pagedFile=pageCache.map(file("a"),filePageSize);PageCursor cursor=pagedFile.io(startPageId,PF_EXCLUSIVE_LOCK)){
    while (cursor.getCurrentPageId() < endPageId && cursor.next()) {
      do {
        writeRecords(cursor);
      }
 while (cursor.shouldRetry());
    }
  }
  finally {
    pageCache.close();
  }
  StoreChannel channel=fs.open(file("a"),"r");
  ByteBuffer observation=ByteBuffer.allocate(recordSize);
  for (int i=0; i < recordCount; i++) {
    generateRecordForId(i,buf);
    observation.position(0);
    channel.read(observation);
    assertRecord(i,observation,buf);
  }
  channel.close();
}
