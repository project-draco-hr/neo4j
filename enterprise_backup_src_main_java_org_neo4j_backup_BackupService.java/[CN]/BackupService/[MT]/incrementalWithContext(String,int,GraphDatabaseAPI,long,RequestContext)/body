{
  DependencyResolver resolver=targetDb.getDependencyResolver();
  ProgressTxHandler handler=new ProgressTxHandler();
  TransactionCommittingResponseUnpacker unpacker=new TransactionCommittingResponseUnpacker(DependenciesProxy.dependencies(resolver,TransactionCommittingResponseUnpacker.Dependencies.class));
  Monitors monitors=resolver.resolveDependency(Monitors.class);
  LogProvider logProvider=resolver.resolveDependency(LogService.class).getInternalLogProvider();
  BackupClient client=new BackupClient(sourceHostNameOrIp,sourcePort,logProvider,targetDb.storeId(),timeout,unpacker,monitors.newMonitor(ByteCounterMonitor.class,BackupClient.class),monitors.newMonitor(RequestMonitor.class,BackupClient.class));
  boolean consistent=false;
  try {
    client.start();
    unpacker.start();
    try (Response<Void> response=client.incrementalBackup(context)){
      unpacker.unpackResponse(response,handler);
    }
     consistent=true;
  }
 catch (  MismatchingStoreIdException e) {
    throw new RuntimeException(DIFFERENT_STORE,e);
  }
catch (  RuntimeException|IOException e) {
    if (e.getCause() != null && e.getCause() instanceof MissingLogDataException) {
      throw new IncrementalBackupNotPossibleException(TOO_OLD_BACKUP,e.getCause());
    }
    throw new RuntimeException("Failed to perform incremental backup.",e);
  }
catch (  Throwable throwable) {
    throw new RuntimeException("Unexpected error",throwable);
  }
 finally {
    try {
      client.stop();
      unpacker.stop();
    }
 catch (    Throwable throwable) {
      log.warn("Unable to stop backup client",throwable);
    }
  }
  return new BackupOutcome(handler.getLastSeenTransactionId(),consistent);
}
