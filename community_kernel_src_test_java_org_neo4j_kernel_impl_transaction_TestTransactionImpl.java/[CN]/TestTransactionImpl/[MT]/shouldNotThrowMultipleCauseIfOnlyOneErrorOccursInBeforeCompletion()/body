{
  TxManager mockedTxManager=mock(TxManager.class);
  TransactionImpl tx=new TransactionImpl(getNewGlobalId(DEFAULT_SEED,0),mockedTxManager,ForceMode.forced,TransactionStateFactory.noStateFactory(new DevNullLoggingService()),new SystemOutLogging().getMessagesLog(TxManager.class));
  final RuntimeException firstException=new RuntimeException("Ex1");
  Synchronization meanSync1=new Synchronization(){
    @Override public void beforeCompletion(){
      throw firstException;
    }
    @Override public void afterCompletion(    int status){
    }
  }
;
  tx.registerSynchronization(meanSync1);
  tx.doBeforeCompletion();
  assertThat(tx.getRollbackCause(),is((Throwable)firstException));
}
