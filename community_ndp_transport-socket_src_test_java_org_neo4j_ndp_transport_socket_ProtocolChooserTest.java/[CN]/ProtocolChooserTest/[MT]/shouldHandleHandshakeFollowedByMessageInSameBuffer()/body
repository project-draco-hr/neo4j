{
  PrimitiveLongObjectMap<Factory<SocketProtocol>> available=Primitive.longObjectMap();
  Factory factory=mock(Factory.class);
  SocketProtocol protocol=mock(SocketProtocol.class);
  when(factory.newInstance()).thenReturn(protocol);
  available.put(1,factory);
  ProtocolChooser chooser=new ProtocolChooser(available);
  ByteBuf buffer=wrappedBuffer(new byte[]{0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,2,3,4});
  HandshakeOutcome outcome=chooser.handleVersionHandshakeChunk(buffer);
  assertThat(outcome,equalTo(PROTOCOL_CHOSEN));
  assertThat(chooser.chosenProtocol(),equalTo(protocol));
  assertThat(buffer.readableBytes(),equalTo(4));
}
