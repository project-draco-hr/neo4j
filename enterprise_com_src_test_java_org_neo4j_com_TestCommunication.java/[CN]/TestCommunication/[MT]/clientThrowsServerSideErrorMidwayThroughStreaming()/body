{
  final String failureMessage="Just failing";
  MadeUpImplementation serverImplementation=new MadeUpImplementation(storeIdToUse){
    @Override public Response<Void> streamSomeData(    MadeUpWriter writer,    int dataSize){
      writer.write(new FailingByteChannel(dataSize,failureMessage));
      return new Response<Void>(null,storeIdToUse,TransactionStream.EMPTY);
    }
  }
;
  MadeUpServer server=new MadeUpServer(serverImplementation,PORT,INTERNAL_PROTOCOL_VERSION,APPLICATION_PROTOCOL_VERSION);
  MadeUpClient client=new MadeUpClient(PORT,storeIdToUse,INTERNAL_PROTOCOL_VERSION,APPLICATION_PROTOCOL_VERSION);
  try {
    client.streamSomeData(new ToAssertionWriter(),Protocol.DEFAULT_FRAME_LENGTH * 2);
    fail("Should have thrown " + MadeUpException.class.getSimpleName());
  }
 catch (  ComException e) {
    assertCause(e,MadeUpException.class,failureMessage);
  }
  client.shutdown();
  server.shutdown();
}
