{
  final String failureMessage="Just failing";
  MadeUpServerImplementation serverImplementation=new MadeUpServerImplementation(storeIdToUse){
    @Override public Response<Void> fetchDataStream(    MadeUpWriter writer,    int dataSize){
      writer.write(new FailingByteChannel(dataSize,failureMessage));
      return new Response<Void>(null,storeIdToUse,TransactionStream.EMPTY,ResourceReleaser.NO_OP);
    }
  }
;
  MadeUpServer server=builder.server(serverImplementation);
  MadeUpClient client=builder.client();
  try {
    client.fetchDataStream(new ToAssertionWriter(),FRAME_LENGTH * 2);
    fail("Should have thrown " + MadeUpException.class.getSimpleName());
  }
 catch (  MadeUpException e) {
    assertEquals(failureMessage,e.getMessage());
  }
  client.shutdown();
  server.shutdown();
}
