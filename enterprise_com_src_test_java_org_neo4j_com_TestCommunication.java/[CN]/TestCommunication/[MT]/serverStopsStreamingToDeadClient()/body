{
  MadeUpServer server=builder.server();
  MadeUpClient client=builder.client();
  life.add(server);
  life.add(client);
  life.start();
  int failAtSize=FRAME_LENGTH * 2;
  ClientCrashingWriter writer=new ClientCrashingWriter(client,failAtSize);
  try {
    client.fetchDataStream(writer,FRAME_LENGTH * 10);
    fail("Should fail in the middle");
  }
 catch (  ComException e) {
  }
  assertTrue(writer.getSizeRead() >= failAtSize);
  long maxWaitUntil=System.currentTimeMillis() + 2 * 1000;
  while (!server.responseFailureEncountered() && System.currentTimeMillis() < maxWaitUntil) {
    yield();
  }
  assertTrue("Failure writing the response should have been encountered",server.responseFailureEncountered());
  assertFalse("Response shouldn't have been successful",server.responseHasBeenWritten());
}
