{
  MadeUpImplementation serverImplementation=new MadeUpImplementation(storeIdToUse);
  MadeUpServer server=new MadeUpServer(serverImplementation,PORT,INTERNAL_PROTOCOL_VERSION,APPLICATION_PROTOCOL_VERSION);
  MadeUpClient client=new MadeUpClient(PORT,storeIdToUse,INTERNAL_PROTOCOL_VERSION,APPLICATION_PROTOCOL_VERSION);
  int failAtSize=MadeUpServer.FRAME_LENGTH * 2;
  ClientCrashingWriter writer=new ClientCrashingWriter(client,failAtSize);
  try {
    client.streamSomeData(writer,MadeUpServer.FRAME_LENGTH * 5);
    fail("Should fail in the middle");
  }
 catch (  Exception e) {
  }
  assertTrue(writer.getSizeRead() >= failAtSize);
  long maxWaitUntil=System.currentTimeMillis() + 2 * 1000;
  while (!server.responseFailureEncountered() && System.currentTimeMillis() < maxWaitUntil)   Thread.currentThread().yield();
  assertTrue("Failure writing the response should have been encountered",server.responseFailureEncountered());
  assertFalse("Response shouldn't have been successful",server.responseHasBeenWritten());
  server.shutdown();
}
