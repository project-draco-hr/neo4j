{
  R before=check.before(command);
  R after=check.after(command);
  boolean isValid=state.isValid(before);
  if (!isValid) {
    LogRecord<R> seen=state.get(before.getId());
    LogRecord<R> current=new LogRecord<>(before,logVersion);
    handler.handle(seen,current);
  }
  state.put(after,logVersion);
  return isValid;
}
