{
  R before=check.before(command);
  R after=check.after(command);
  if (!state.isValid(before)) {
    LogRecord<R> seen=state.get(before.getId());
    LogRecord<R> current=new LogRecord<>(before,logVersion);
    handler.handle(seen,current);
  }
  state.put(after,logVersion);
}
