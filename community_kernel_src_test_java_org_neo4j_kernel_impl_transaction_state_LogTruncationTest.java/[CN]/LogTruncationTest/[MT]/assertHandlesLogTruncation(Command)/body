{
  inMemoryChannel.reset();
  writer.serialize(new PhysicalTransactionRepresentation(Arrays.asList(cmd)));
  int bytesSuccessfullyWritten=inMemoryChannel.writerPosition();
  try {
    LogEntry logEntry=logEntryReader.readLogEntry(inMemoryChannel);
    StorageCommand command=((LogEntryCommand)logEntry).getXaCommand();
    assertEquals(cmd,command);
  }
 catch (  Exception e) {
    throw new AssertionError("Failed to deserialize " + cmd.toString() + ", because: ",e);
  }
  bytesSuccessfullyWritten--;
  while (bytesSuccessfullyWritten-- > 0) {
    inMemoryChannel.reset();
    writer.serialize(new PhysicalTransactionRepresentation(Arrays.asList(cmd)));
    inMemoryChannel.truncateTo(bytesSuccessfullyWritten);
    LogEntry deserialized=logEntryReader.readLogEntry(inMemoryChannel);
    assertNull("Deserialization did not detect log truncation!" + "Record: " + cmd + ", deserialized: "+ deserialized,deserialized);
  }
}
