{
  StoreUpgrader upgrader=new StoreUpgrader(ALLOW_UPGRADE,fs,StoreUpgrader.NO_MONITOR);
  upgrader.addParticipant(new StoreMigrator(monitor,fs));
  File legacyStoreDir=find19FormatStoreDirectory(storeDir);
  upgrader.migrateIfNeeded(legacyStoreDir);
  assertEquals(100,monitor.eventSize());
  assertTrue(monitor.isStarted());
  assertTrue(monitor.isFinished());
  GraphDatabaseService database=cleanup.add(new GraphDatabaseFactory().newEmbeddedDatabase(storeDir.getAbsolutePath()));
  try {
    verifyDatabaseContents(database);
  }
  finally {
    database.shutdown();
  }
  NeoStore neoStore=cleanup.add(storeFactory.newNeoStore(storeFileName));
  verifyNeoStore(neoStore);
  neoStore.close();
  assertConsistentStore(storeDir);
}
