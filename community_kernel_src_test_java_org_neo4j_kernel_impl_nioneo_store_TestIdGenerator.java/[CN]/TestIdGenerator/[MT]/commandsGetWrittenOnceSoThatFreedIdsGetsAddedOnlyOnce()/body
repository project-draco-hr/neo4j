{
  String storeDir="target/var/free-id-once";
  deleteRecursively(new File(storeDir));
  GraphDatabaseService db=new TestGraphDatabaseFactory().setFileSystem(fs).newImpermanentDatabase(storeDir);
  RelationshipType type=withName("SOME_TYPE");
  Set<Long> createdNodeIds=new HashSet<Long>();
  Set<Long> createdRelationshipIds=new HashSet<Long>();
  Transaction tx=db.beginTx();
  for (int i=0; i < 20; i++) {
    Node otherNode=db.createNode();
    Relationship relationship=db.getReferenceNode().createRelationshipTo(otherNode,type);
    if (i % 5 == 0) {
      otherNode.delete();
      relationship.delete();
    }
 else {
      createdNodeIds.add(otherNode.getId());
      createdRelationshipIds.add(relationship.getId());
    }
  }
  tx.success();
  tx.finish();
  db.shutdown();
  db=new TestGraphDatabaseFactory().setFileSystem(fs).newImpermanentDatabase(storeDir);
  tx=db.beginTx();
  for (int i=0; i < 100; i++) {
    Node otherNode=db.createNode();
    if (!createdNodeIds.add(otherNode.getId())) {
      fail("Managed to create a node with an id that was already in use");
    }
    Relationship relationship=db.getReferenceNode().createRelationshipTo(otherNode,type);
    if (!createdRelationshipIds.add(relationship.getId())) {
      fail("Managed to create a relationship with an id that was already in use");
    }
  }
  tx.success();
  tx.finish();
  ((GraphDatabaseAPI)db).getNodeManager().clearCache();
  tx=db.beginTx();
  for (  Node node : GlobalGraphOperations.at(db).getAllNodes()) {
    lastOrNull(node.getRelationships());
  }
  tx.finish();
  db.shutdown();
}
