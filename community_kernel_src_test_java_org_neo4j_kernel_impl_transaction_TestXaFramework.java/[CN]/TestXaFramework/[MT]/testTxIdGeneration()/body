{
  DummyXaDataSource xaDs1=null;
  DummyXaConnection xaC1=null;
  try {
    Map<Object,Object> config=new HashMap<Object,Object>();
    config.put("store_dir","target/var");
    config.put(LogBufferFactory.class,CommonFactories.defaultLogBufferFactory());
    xaDsMgr.registerDataSource("dummy_datasource1",new DummyXaDataSource(config),UTF8.encode("DDDDDD"));
    xaDs1=(DummyXaDataSource)xaDsMgr.getXaDataSource("dummy_datasource1");
    xaC1=(DummyXaConnection)xaDs1.getXaConnection();
    tm.begin();
    xaC1.enlistWithTx();
    int currentTxId=xaC1.getTransactionId();
    xaC1.doStuff1();
    xaC1.delistFromTx();
    tm.commit();
    tm.begin();
    Node node=getGraphDb().createNode();
    xaC1.enlistWithTx();
    assertEquals(++currentTxId,xaC1.getTransactionId());
    xaC1.doStuff1();
    xaC1.delistFromTx();
    tm.commit();
    tm.begin();
    node=getGraphDb().getNodeById(node.getId());
    xaC1.enlistWithTx();
    assertEquals(++currentTxId,xaC1.getTransactionId());
    xaC1.doStuff2();
    xaC1.delistFromTx();
    node.delete();
    tm.commit();
  }
  finally {
    xaDsMgr.unregisterDataSource("dummy_datasource1");
    if (xaC1 != null) {
      xaC1.destroy();
    }
  }
  File dir=new File(".");
  File files[]=dir.listFiles(new FilenameFilter(){
    public boolean accept(    File dir,    String fileName){
      return fileName.startsWith(resourceFile());
    }
  }
);
  for (int i=0; i < files.length; i++) {
    files[i].delete();
  }
}
