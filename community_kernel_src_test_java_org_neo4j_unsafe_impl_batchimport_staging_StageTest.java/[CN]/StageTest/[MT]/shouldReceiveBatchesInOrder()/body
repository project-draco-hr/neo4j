{
  Configuration config=new Configuration.Default();
  Stage stage=new Stage("Test stage",config);
  int batchSize=10;
  long batches=1000;
  final long items=batches * batchSize;
  stage.add(new ProducerStep<Object>(stage.control(),"Producer",batchSize,100){
    private long i=0;
    private final Object theObject=new Object();
    @Override protected Object nextOrNull(){
      return ++i > items ? null : theObject;
    }
  }
);
  for (int i=0; i < 3; i++) {
    stage.add(new ReceiveOrderAssertingStep(stage.control(),"Step" + i,20,2,i));
  }
  stage.add(new LastReceiveOrderAssertingStep(stage.control(),"Final step",20,2,0));
  StageExecution execution=stage.execute();
  new ExecutionSupervisor(ExecutionMonitors.invisible()).supervise(execution);
  for (  Step<?> step : execution.steps()) {
    assertEquals(batches,step.stats().stat(Keys.done_batches).asLong());
  }
  stage.close();
}
