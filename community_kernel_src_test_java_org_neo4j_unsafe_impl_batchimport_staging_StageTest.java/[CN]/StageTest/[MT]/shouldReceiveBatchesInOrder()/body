{
  Configuration config=new Configuration.Default();
  Stage stage=new Stage("Test stage",config,true);
  int batchSize=10;
  long batches=1000;
  final long items=batches * batchSize;
  stage.add(new ProducerStep<Object>(stage.control(),"Producer",batchSize,100){
    private final Object theObject=new Object();
    private long i;
    @Override protected Object nextBatchOrNull(    int batchSize){
      if (i >= items) {
        return null;
      }
      Object[] batch=new Object[batchSize];
      Arrays.fill(batch,theObject);
      i+=batchSize;
      return batch;
    }
  }
);
  for (int i=0; i < 3; i++) {
    stage.add(new ReceiveOrderAssertingStep(stage.control(),"Step" + i,20,2,i));
  }
  stage.add(new LastReceiveOrderAssertingStep(stage.control(),"Final step",20,2,0));
  StageExecution execution=stage.execute();
  new ExecutionSupervisor(ExecutionMonitors.invisible()).supervise(execution);
  for (  Step<?> step : execution.steps()) {
    assertEquals(batches,step.stats().stat(Keys.done_batches).asLong());
  }
  stage.close();
}
