{
  try {
    transaction.prepare();
    KernelTransactionImplementation transactionImplementation=(KernelTransactionImplementation)transaction;
    if (!transactionImplementation.isReadOnly()) {
      TransactionState transactionState=transactionImplementation.getLegacyTransactionState();
      transactionState.applyChangesToCache(false);
    }
  }
  finally {
    try {
      transaction.rollback();
    }
  finally {
      transactionMonitor.transactionFinished(false);
    }
  }
}
