{
  try {
    Transaction tx=transactionManager.getTransaction();
    List<LockElement> lockElements=lockMap.get(tx);
    if (lockElements != null) {
      lockElements.add(new LockElement(resource,type));
    }
 else {
      if (tx == null) {
        if (type == LockType.WRITE) {
          lockManager.releaseWriteLock(resource);
        }
 else         if (type == LockType.READ) {
          lockManager.releaseReadLock(resource);
        }
        throw new NotInTransactionException();
      }
      tx.registerSynchronization(new TxCommitHook(this,tx));
      lockElements=new ArrayList<LockElement>();
      lockMap.put(tx,lockElements);
      lockElements.add(new LockElement(resource,type));
    }
  }
 catch (  javax.transaction.SystemException e) {
    throw new NotInTransactionException(e);
  }
catch (  Exception e) {
    throw new NotInTransactionException(e);
  }
}
