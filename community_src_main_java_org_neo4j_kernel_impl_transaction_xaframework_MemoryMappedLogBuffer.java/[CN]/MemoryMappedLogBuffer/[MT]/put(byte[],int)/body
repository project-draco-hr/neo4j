{
  int bytesToWrite=bytes.length - offset;
  if (bytesToWrite > MAPPED_SIZE) {
    bytesToWrite=MAPPED_SIZE;
  }
  if (mappedBuffer == null || (MAPPED_SIZE - mappedBuffer.position()) < bytesToWrite) {
    getNewMappedBuffer();
    if (mappedBuffer == null) {
      bytesToWrite=bytes.length - offset;
      ByteBuffer buf=ByteBuffer.wrap(bytes);
      buf.position(offset);
      int count=fileChannel.write(buf,mappedStartPosition);
      if (count != bytesToWrite) {
        throw new UnderlyingStorageException("Failed to write from " + offset + " expected "+ bytesToWrite+ " but wrote "+ count);
      }
      mappedStartPosition+=bytesToWrite;
      return;
    }
  }
  mappedBuffer.put(bytes,offset,bytesToWrite);
  offset+=bytesToWrite;
  if (offset < bytes.length) {
    put(bytes,offset);
  }
}
