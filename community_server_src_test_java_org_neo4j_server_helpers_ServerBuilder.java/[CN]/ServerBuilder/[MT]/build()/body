{
  if (dbDir == null) {
    this.dbDir=createTempDir().getAbsolutePath();
  }
  File configFile=createPropertiesFiles();
  if (serverModules == null) {
    withSpecificServerModulesOnly(RESTApiModule.class,WebAdminModule.class,ManagementApiModule.class,ThirdPartyJAXRSModule.class,DiscoveryModule.class);
  }
  if (startupHealthCheck == null) {
    startupHealthCheck=new StartupHealthCheck(){
      public boolean run(){
        return true;
      }
    }
;
  }
  if (clock != null) {
    LeaseManagerProvider.setClock(clock);
  }
  return new NeoServerWithEmbeddedWebServer(createBootstrapper(),startupHealthCheck,new PropertyFileConfigurator(new Validator(new DatabaseLocationMustBeSpecifiedRule()),configFile),new Jetty6WebServer(),serverModules);
}
