{
  RecordFormats configuredFormat=loadRecordFormat(configuredRecordFormat(config));
  boolean formatConfigured=configuredFormat != null;
  RecordFormats currentFormat=selectForStore(storeDir,fs,pageCache,NullLogProvider.getInstance());
  boolean storeWithFormatExists=currentFormat != null;
  if (formatConfigured && storeWithFormatExists) {
    if (currentFormat.getFormatFamily().equals(configuredFormat.getFormatFamily()) && (currentFormat.generation() == configuredFormat.generation())) {
      info(logProvider,"Configured format matches format in the store. Selected: " + currentFormat);
      return currentFormat;
    }
    throw new IllegalArgumentException(String.format("Configured format '%s' is different from the actual format in the store '%s'",configuredFormat,currentFormat));
  }
  if (!formatConfigured && storeWithFormatExists) {
    info(logProvider,"Format not configured. Selected format from the store: " + currentFormat);
    return currentFormat;
  }
  if (formatConfigured) {
    info(logProvider,"Selected configured format: " + configuredFormat);
    return configuredFormat;
  }
  return DEFAULT_FORMAT;
}
