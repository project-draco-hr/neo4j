{
  try (LockWrapper _=new LockWrapper(updateLock.writeLock())){
    CountsTrackerState state=this.state;
    if (state.hasChanges() || state.lastTxId() != lastCommittedTxId) {
      try (CountsStore.Writer<CountsKey,CopyableDoubleLongRegister> writer=nextWriter(state,lastCommittedTxId)){
        state.accept(writer);
        this.state=new ConcurrentCountsTrackerState(writer.openForReading());
      }
       state.close();
    }
  }
 }
