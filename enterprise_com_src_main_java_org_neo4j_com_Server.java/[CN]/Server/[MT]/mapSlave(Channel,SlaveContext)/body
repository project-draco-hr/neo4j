{
  channelGroup.add(channel);
  Pair<ChannelBuffer,ByteBuffer> buffer=null;
synchronized (connectedSlaveChannels) {
    if (slave != null && slave.machineId() != SlaveContext.EMPTY.machineId()) {
      SlaveContext previous=connectedSlaveChannels.get(channel);
      if (previous != null && !previous.equals(slave)) {
        throw new RuntimeException("Tried to map " + channel + " --> "+ slave+ ", but was already mapped to "+ previous);
      }
      connectedSlaveChannels.put(channel,slave);
    }
    buffer=channelBuffers.get(channel);
    if (buffer == null) {
      buffer=Pair.of(ChannelBuffers.dynamicBuffer(),ByteBuffer.allocateDirect(1 * 1024 * 1024));
      channelBuffers.put(channel,buffer);
    }
    buffer.first().clear();
  }
  return buffer;
}
