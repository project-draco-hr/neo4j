{
  channelGroup.add(channel);
  Pair<ChannelBuffer,ByteBuffer> buffer=null;
synchronized (connectedSlaveChannels) {
    if (type.monitorChannelMapping() && slave != null && slave.machineId() != SlaveContext.EMPTY.machineId()) {
      Pair<SlaveContext,AtomicLong> previous=connectedSlaveChannels.get(channel);
      if (previous != null && !previous.first().equals(slave)) {
        tryToFinishOffChannel(channel,previous.first());
        throw new RuntimeException("Tried to map " + channel + " --> "+ slave+ ", but was already mapped to "+ previous.first());
      }
      if (previous != null) {
        previous.other().set(System.currentTimeMillis());
      }
 else {
        connectedSlaveChannels.put(channel,Pair.of(slave,new AtomicLong(System.currentTimeMillis())));
      }
    }
    buffer=channelBuffers.get(channel);
    if (buffer == null) {
      buffer=Pair.of(ChannelBuffers.dynamicBuffer(),ByteBuffer.allocateDirect(1 * 1024 * 1024));
      channelBuffers.put(channel,buffer);
    }
    buffer.first().clear();
  }
  return buffer;
}
