{
  XaDataSourceManager mockXaManager=mock(XaDataSourceManager.class);
  File txLogDir=TargetDirectory.forTest(fs.get(),getClass()).cleanDirectory("log");
  KernelHealth kernelHealth=new KernelHealth(panicGenerator,logging);
  TxManager txm=new TxManager(txLogDir,mockXaManager,DEV_NULL,fs.get(),null,null,kernelHealth,monitors);
  txm.doRecovery();
  String msg="These kinds of throwables, breaking our transaction managers, are why we can't have nice things.";
  txm.setTmNotOk(new Throwable(msg));
  try {
    txm.begin();
    fail("Should have thrown SystemException.");
  }
 catch (  SystemException topLevelException) {
    assertThat("TM should forward a cause.",topLevelException.getCause(),is(Throwable.class));
    assertThat("Cause should be the original cause",topLevelException.getCause().getMessage(),is(msg));
  }
}
