{
  LogEntry entry=null;
  long startingPosition=localBuffer.position();
  while (collector.hasInFutureQueue() || (entry=LogIoUtils.readEntry(localBuffer,source,commandReader)) != null) {
    long readUpTo=localBuffer.position();
    long bytesRead=readUpTo - startingPosition;
    startingPosition=readUpTo;
    monitor.bytesRead(bytesRead);
    LogEntry foundEntry=collector.collect(entry,target);
    if (foundEntry != null) {
      previousCommitEntry=lastCommitEntry;
      LogIoUtils.writeLogEntry(new LogEntry.Done(collector.getIdentifier()),target,commandWriter);
      lastCommitEntry=(LogEntry.Commit)foundEntry;
      return lastCommitEntry.getTxId();
    }
  }
  return -1;
}
