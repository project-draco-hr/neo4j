{
  Object batch=null;
  long startTime=currentTimeMillis();
  while ((batch=nextBatchOrNull(doneBatches.get(),batchSize)) != null) {
    totalProcessingTime.add(currentTimeMillis() - startTime);
    downstreamIdleTime.addAndGet(downstream.receive(doneBatches.getAndIncrement(),batch));
    assertHealthy();
    startTime=currentTimeMillis();
  }
}
