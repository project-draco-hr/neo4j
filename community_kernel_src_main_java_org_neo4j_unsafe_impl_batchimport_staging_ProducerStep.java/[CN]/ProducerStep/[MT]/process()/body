{
  List<T> batch=new ArrayList<>(batchSize);
  int size=0;
  long startTime=currentTimeMillis();
  T next=null;
  while ((next=nextOrNull()) != null) {
    batch.add(next);
    if (++size == batchSize) {
      totalProcessingTime.add(currentTimeMillis() - startTime);
      sendDownstream(nextTicket(),batch);
      batch=new ArrayList<>(batchSize);
      size=0;
      assertHealthy();
      startTime=currentTimeMillis();
    }
  }
  if (size > 0) {
    totalProcessingTime.add(currentTimeMillis() - startTime);
    sendDownstream(nextTicket(),batch);
  }
}
