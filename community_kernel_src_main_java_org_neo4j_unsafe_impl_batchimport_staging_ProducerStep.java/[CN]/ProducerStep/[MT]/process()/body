{
  Object batch=null;
  while (true) {
    long startTime=nanoTime();
    batch=nextBatchOrNull(doneBatches.get(),batchSize);
    if (batch == null) {
      break;
    }
    totalProcessingTime.add(nanoTime() - startTime);
    downstreamIdleTime.addAndGet(downstream.receive(doneBatches.getAndIncrement(),batch));
    assertHealthy();
  }
}
