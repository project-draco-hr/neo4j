{
  List<T> batch=new ArrayList<>(batchSize);
  int size=0;
  long startTime=currentTimeMillis();
  while (input.hasNext()) {
    batch.add(input.next());
    if (++size == batchSize) {
      totalProcessingTime.addAndGet(currentTimeMillis() - startTime);
      sendDownstream(nextTicket(),batch);
      batch=new ArrayList<>(batchSize);
      size=0;
      assertHealthy();
      startTime=currentTimeMillis();
    }
  }
  if (size > 0) {
    totalProcessingTime.addAndGet(currentTimeMillis() - startTime);
    sendDownstream(nextTicket(),batch);
  }
}
