{
  TransactionCommitProcess transactionCommitProcess=commitProcessFactory.create(appender,storageEngine,config);
  Supplier<KernelAPI> kernelProvider=new Supplier<KernelAPI>(){
    @Override public KernelAPI get(){
      return kernelModule.kernelAPI();
    }
  }
;
  ConstraintIndexCreator constraintIndexCreator=new ConstraintIndexCreator(kernelProvider,indexingService);
  LegacyIndexStore legacyIndexStore=new LegacyIndexStore(config,indexConfigStore,kernelProvider,legacyIndexProviderLookup);
  LegacyPropertyTrackers legacyPropertyTrackers=new LegacyPropertyTrackers(propertyKeyTokenHolder,nodeManager.getNodePropertyTrackers(),nodeManager.getRelationshipPropertyTrackers(),nodeManager);
  StatementOperationParts statementOperations=dependencies.satisfyDependency(buildStatementOperations(storeLayer,legacyPropertyTrackers,constraintIndexCreator,updateableSchemaState,guard,legacyIndexStore));
  Procedures procedures=dependencies.satisfyDependency(new Procedures());
  TransactionHooks hooks=new TransactionHooks();
  KernelTransactions kernelTransactions=life.add(new KernelTransactions(locks,constraintIndexCreator,statementOperations,schemaWriteGuard,transactionHeaderInformationFactory,transactionCommitProcess,indexConfigStore,legacyIndexProviderLookup,hooks,transactionMonitor,life,tracers,storageEngine,procedures,transactionIdStore));
  final Kernel kernel=new Kernel(kernelTransactions,hooks,databaseHealth,transactionMonitor,procedures);
  kernel.registerTransactionHook(transactionEventHandlers);
  BuiltInProcedures.addTo(kernel);
  final NeoStoreFileListing fileListing=new NeoStoreFileListing(storeDir,labelScanStore,indexingService,legacyIndexProviderLookup);
  return new KernelModule(){
    @Override public TransactionCommitProcess transactionCommitProcess(){
      return transactionCommitProcess;
    }
    @Override public KernelAPI kernelAPI(){
      return kernel;
    }
    @Override public KernelTransactions kernelTransactions(){
      return kernelTransactions;
    }
    @Override public NeoStoreFileListing fileListing(){
      return fileListing;
    }
  }
;
}
