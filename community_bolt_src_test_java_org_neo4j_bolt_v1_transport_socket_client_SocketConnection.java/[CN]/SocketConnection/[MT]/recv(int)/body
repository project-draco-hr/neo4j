{
  byte[] bytes=new byte[length];
  int left=length, read;
  try {
    while (left > 0 && (read=in.read(bytes,length - left,left)) != -1) {
      left-=read;
    }
  }
 catch (  SocketTimeoutException e) {
    throw new SocketTimeoutException("Reading data timed out, missing " + left + " bytes. Buffer: "+ HexPrinter.hex(bytes));
  }
  if (left != 0) {
    throw new IOException("Failed to read " + length + " bytes, missing "+ left+ " bytes. Buffer: "+ HexPrinter.hex(bytes));
  }
  return bytes;
}
