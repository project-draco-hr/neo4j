{
  try {
    System.out.println("Found uncompleted global transactions");
    List<NonCompletedTransaction> commitList=new ArrayList<NonCompletedTransaction>();
    List<List<Xid>> rollbackList=new LinkedList<List<Xid>>();
    Map<Resource,XAResource> resourceMap=new HashMap<Resource,XAResource>();
    buildRecoveryInfo(commitList,rollbackList,resourceMap,danglingRecordList);
    Iterator<Resource> resourceItr=resourceMap.keySet().iterator();
    List<Xid> recoveredXidsList=new LinkedList<Xid>();
    while (resourceItr.hasNext()) {
      XAResource xaRes=resourceMap.get(resourceItr.next());
      Xid xids[]=xaRes.recover(XAResource.TMNOFLAGS);
      for (int i=0; i < xids.length; i++) {
        if (XidImpl.isThisTm(xids[i].getGlobalTransactionId())) {
          if (rollbackList.contains(xids[i])) {
            System.out.print("Found pre commit " + xids[i] + " rolling back ... ");
            rollbackList.remove(xids[i]);
            xaRes.rollback(xids[i]);
            System.out.println("done");
          }
 else {
            recoveredXidsList.add(xids[i]);
          }
        }
 else {
          System.out.println("Unkown xid: " + xids[i]);
        }
      }
    }
    Collections.sort(commitList,new Comparator<NonCompletedTransaction>(){
      public int compare(      NonCompletedTransaction r1,      NonCompletedTransaction r2){
        return r1.getSequenceNumber() - r2.getSequenceNumber();
      }
    }
);
    Iterator<NonCompletedTransaction> commitItr=commitList.iterator();
    while (commitItr.hasNext()) {
      Xid xids[]=commitItr.next().getXids();
      for (int i=0; i < xids.length; i++) {
        if (!recoveredXidsList.contains(xids[i])) {
          System.out.println("WARNING, " + xids[i] + " not found in recovered xid list, "+ "assuming already committed");
          recoveredXidsList.remove(xids[i]);
          continue;
        }
        recoveredXidsList.remove(xids[i]);
        Resource resource=new Resource(xids[i].getBranchQualifier());
        if (!resourceMap.containsKey(resource)) {
          throw new RuntimeException("Couldn't find XAResource for " + xids[i]);
        }
        System.out.print("Commiting " + xids[i] + " ... ");
        resourceMap.get(resource).commit(xids[i],false);
        System.out.println("done");
      }
    }
    Iterator<Xid> rollbackItr=recoveredXidsList.iterator();
    while (rollbackItr.hasNext()) {
      Xid xid=rollbackItr.next();
      Resource resource=new Resource(xid.getBranchQualifier());
      if (!resourceMap.containsKey(resource)) {
        throw new RuntimeException("Couldn't find XAResource for " + xid);
      }
      System.out.print("Rollback " + xid + " ... ");
      resourceMap.get(resource).rollback(xid);
      System.out.println("done");
    }
    if (rollbackList.size() > 0) {
      System.out.println("WARNING: TxLog contained unresolved " + "xids that needed rollback. They couldn't be matched to " + "any of the XAResources recover list. "+ "Assuming " + rollbackList.size() + " transactions already rolled back.");
    }
  }
 catch (  XAException e) {
    throw new RuntimeException(e);
  }
}
