{
  if (!tmOk) {
    throw new SystemException("TM has encountered some problem, " + "please perform neccesary action (tx recovery/restart)");
  }
  Thread thread=Thread.currentThread();
  TransactionImpl tx=txThreadMap.get(thread);
  if (tx != null) {
    throw new NotSupportedException("Nested transactions not supported");
  }
  tx=new TransactionImpl(this);
  txThreadMap.put(thread,tx);
  try {
    getTxLog().txStart(tx.getGlobalId());
  }
 catch (  IOException e) {
    e.printStackTrace();
    log.severe("Error writing transaction log");
    tmOk=false;
    throw new SystemException("TM encountered a problem, " + " error writing transaction log," + e);
  }
  eventManager.generateReActiveEvent(Event.TX_BEGIN,new EventData(tx.getEventIdentifier()));
  try {
    tx.registerSynchronization(new TxEventGenerator(eventManager,tx));
  }
 catch (  Exception e) {
    throw new SystemException("" + e);
  }
  eventManager.generateProActiveEvent(Event.TX_IMMEDIATE_BEGIN,new EventData(tx.getEventIdentifier()));
}
