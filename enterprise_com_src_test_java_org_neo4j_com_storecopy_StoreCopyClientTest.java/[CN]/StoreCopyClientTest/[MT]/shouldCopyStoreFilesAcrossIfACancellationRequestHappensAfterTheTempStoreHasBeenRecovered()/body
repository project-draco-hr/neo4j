{
  final File copyDir=new File(testDir.directory(),"copy");
  final File originalDir=new File(testDir.directory(),"original");
  final AtomicBoolean cancelStoreCopy=new AtomicBoolean(false);
  CancellationRequest cancellationRequest=new CancellationRequest(){
    @Override public boolean cancellationRequested(){
      return cancelStoreCopy.get();
    }
  }
;
  StoreCopyClient.Monitor storeCopyMonitor=new StoreCopyClient.Monitor.Adapter(){
    @Override public void finishRecoveringStore(){
      cancelStoreCopy.set(true);
    }
  }
;
  PageCache pageCache=pageCacheRule.getPageCache(fs);
  StoreCopyClient copier=new StoreCopyClient(copyDir,new Config(),loadKernelExtensions(),NullLogProvider.getInstance(),fs,pageCache,storeCopyMonitor);
  final GraphDatabaseAPI original=(GraphDatabaseAPI)startDatabase(originalDir);
  try (Transaction tx=original.beginTx()){
    original.createNode(label("BeforeCopyBegins"));
    tx.success();
  }
   StoreCopyClient.StoreCopyRequester storeCopyRequest=storeCopyRequest(originalDir,original);
  copier.copyStore(storeCopyRequest,cancellationRequest);
  GraphDatabaseService copy=startDatabase(copyDir);
  try (Transaction tx=copy.beginTx()){
    GlobalGraphOperations globalOps=GlobalGraphOperations.at(copy);
    long nodesCount=Iterables.count(globalOps.getAllNodesWithLabel(label("BeforeCopyBegins")));
    assertThat(nodesCount,equalTo(1l));
    assertThat(Iterables.single(globalOps.getAllNodesWithLabel(label("BeforeCopyBegins"))).getId(),equalTo(0l));
    tx.success();
  }
  finally {
    copy.shutdown();
    original.shutdown();
  }
  verify(storeCopyRequest,times(1)).done();
}
