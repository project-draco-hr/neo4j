{
  XidStatus status=xidMap.get(xid);
  if (status == null) {
    throw new XAException("Unknown xid[" + xid + "]");
  }
  TransactionStatus txStatus=status.getTransactionStatus();
  XaTransaction xaTransaction=txStatus.getTransaction();
  if (xaTransaction.isReadOnly()) {
    log.done(xaTransaction.getIdentifier());
    xidMap.remove(xid);
    if (xaTransaction.isRecovered()) {
      recoveredTxCount--;
      checkIfRecoveryComplete();
    }
    return XAResource.XA_RDONLY;
  }
 else {
    xaTransaction.prepare();
    log.prepare(xaTransaction.getIdentifier());
    txStatus.markAsPrepared();
    return XAResource.XA_OK;
  }
}
