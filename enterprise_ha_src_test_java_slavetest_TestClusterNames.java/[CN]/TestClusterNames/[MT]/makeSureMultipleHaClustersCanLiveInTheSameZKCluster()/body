{
  String cluster1Name="cluster_1";
  HAGraphDb db0Cluster1=db(0,cluster1Name,HaConfig.CONFIG_DEFAULT_PORT);
  HAGraphDb db1Cluster1=db(1,cluster1Name,HaConfig.CONFIG_DEFAULT_PORT);
  awaitStarted(db0Cluster1);
  awaitStarted(db1Cluster1);
  String cluster2Name="cluster.2";
  HAGraphDb db0Cluster2=db(0,cluster2Name,HaConfig.CONFIG_DEFAULT_PORT + 1);
  HAGraphDb db1Cluster2=db(1,cluster2Name,HaConfig.CONFIG_DEFAULT_PORT + 1);
  awaitStarted(db0Cluster2);
  awaitStarted(db1Cluster2);
  String cluster1PropertyName="c1";
  setRefNodeName(db1Cluster1,cluster1PropertyName);
  pullUpdates(db0Cluster1,db1Cluster1,db0Cluster2,db1Cluster2);
  assertEquals(cluster1PropertyName,db0Cluster1.getReferenceNode().getProperty("name"));
  assertEquals(cluster1PropertyName,db1Cluster1.getReferenceNode().getProperty("name"));
  assertNull(db0Cluster2.getReferenceNode().getProperty("name",null));
  assertNull(db1Cluster2.getReferenceNode().getProperty("name",null));
  String cluster2PropertyName="c2";
  setRefNodeName(db1Cluster2,cluster2PropertyName);
  pullUpdates(db0Cluster1,db1Cluster1,db0Cluster2,db1Cluster2);
  assertEquals(cluster1PropertyName,db0Cluster1.getReferenceNode().getProperty("name"));
  assertEquals(cluster1PropertyName,db1Cluster1.getReferenceNode().getProperty("name"));
  assertEquals(cluster2PropertyName,db0Cluster2.getReferenceNode().getProperty("name"));
  assertEquals(cluster2PropertyName,db1Cluster2.getReferenceNode().getProperty("name"));
  db0Cluster1.shutdown();
  db1Cluster1.newMaster(new Exception());
  pullUpdates(db1Cluster1);
  db0Cluster1=db(0,cluster1Name,HaConfig.CONFIG_DEFAULT_PORT);
  pullUpdates(db0Cluster1,db1Cluster1);
  db1Cluster2.shutdown();
  pullUpdates(db0Cluster2);
  db1Cluster2=db(1,cluster2Name,HaConfig.CONFIG_DEFAULT_PORT + 1);
  pullUpdates(db0Cluster2,db1Cluster2);
  cluster1PropertyName="new c1";
  setRefNodeName(db1Cluster1,cluster1PropertyName);
  pullUpdates(db0Cluster1,db1Cluster1,db0Cluster2,db1Cluster2);
  assertEquals(cluster1PropertyName,db0Cluster1.getReferenceNode().getProperty("name"));
  assertEquals(cluster1PropertyName,db1Cluster1.getReferenceNode().getProperty("name"));
  assertEquals(cluster2PropertyName,db0Cluster2.getReferenceNode().getProperty("name"));
  assertEquals(cluster2PropertyName,db1Cluster2.getReferenceNode().getProperty("name"));
  cluster2PropertyName="new new c2";
  setRefNodeName(db1Cluster2,cluster2PropertyName);
  pullUpdates(db0Cluster1,db1Cluster1,db0Cluster2,db1Cluster2);
  assertEquals(cluster1PropertyName,db0Cluster1.getReferenceNode().getProperty("name"));
  assertEquals(cluster1PropertyName,db1Cluster1.getReferenceNode().getProperty("name"));
  assertEquals(cluster2PropertyName,db0Cluster2.getReferenceNode().getProperty("name"));
  assertEquals(cluster2PropertyName,db1Cluster2.getReferenceNode().getProperty("name"));
  db0Cluster1.shutdown();
  db1Cluster1.shutdown();
  db0Cluster2.shutdown();
  db1Cluster2.shutdown();
}
