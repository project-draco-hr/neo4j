{
  long nodeId=0;
  TransactionRecordState writeTransaction=newWriteTransaction().first();
  int propertyKey1=1, propertyKey2=2, labelId1=3, labelId2=4;
  Object value1="first", value2=4;
  writeTransaction.nodeCreate(nodeId);
  writeTransaction.nodeAddProperty(nodeId,propertyKey1,value1);
  writeTransaction.addLabelToNode(labelId1,nodeId);
  PhysicalTransactionRepresentation transactionCommands=writeTransaction.doPrepare();
  commitProcess().commit(transactionCommands);
  CapturingIndexingService indexingService=new CapturingIndexingService();
  writeTransaction=newWriteTransaction(indexingService).first();
  writeTransaction.nodeAddProperty(nodeId,propertyKey2,value2);
  writeTransaction.addLabelToNode(labelId2,nodeId);
  transactionCommands=writeTransaction.doPrepare();
  commitProcess(indexingService).commit(transactionCommands);
  assertEquals(asSet(add(nodeId,propertyKey1,value1,new long[]{labelId2}),add(nodeId,propertyKey2,value2,new long[]{labelId2}),add(nodeId,propertyKey2,value2,new long[]{labelId1,labelId2})),indexingService.updates);
}
