{
  PhysicalTransactionRepresentation toCommit=tx.doPrepare();
  RecoveryCreatingCopyingNeoCommandVisitor recoverer=new RecoveryCreatingCopyingNeoCommandVisitor();
  toCommit.execute(recoverer);
  NeoTransactionStoreApplier storeApplier=new NeoTransactionStoreApplier(neoStore,mockIndexing,cacheAccessBackDoor,locks,txId,true);
  NeoTransactionIndexApplier indexApplier=new NeoTransactionIndexApplier(mockIndexing,mock(LabelScanStore.class),neoStore.getNodeStore(),neoStore.getPropertyStore(),cacheAccessBackDoor,propertyLoader);
  TransactionRepresentation recoveredTx=recoverer.getAsRecovered();
  recoveredTx.execute(storeApplier);
  recoveredTx.execute(indexApplier);
  storeApplier.done();
  indexApplier.done();
}
