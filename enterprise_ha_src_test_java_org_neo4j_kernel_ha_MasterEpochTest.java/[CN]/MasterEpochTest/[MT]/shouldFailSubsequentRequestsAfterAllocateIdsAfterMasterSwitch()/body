{
  SPI spi=MasterImplTest.mockedSpi();
  IdAllocation servedIdAllocation=idAllocation(0,999);
  when(spi.allocateIds(any(IdType.class))).thenReturn(servedIdAllocation);
  when(spi.getTransactionChecksum(anyLong())).thenReturn(10L);
  StoreId storeId=newStoreIdForCurrentVersion();
  MasterImpl master=new MasterImpl(spi,mock(ConversationManager.class),mock(MasterImpl.Monitor.class),new Config(stringMap(ClusterSettings.server_id.name(),"1")));
  HandshakeResult handshake=master.handshake(1,storeId).response();
  master.start();
  IdAllocation idAllocation=master.allocateIds(context(handshake.epoch()),IdType.NODE).response();
  assertEquals(servedIdAllocation.getHighestIdInUse(),idAllocation.getHighestIdInUse());
  try {
    master.allocateIds(context(handshake.epoch() + 1),IdType.NODE);
    fail("Should fail with invalid epoch");
  }
 catch (  InvalidEpochException e) {
  }
}
