{
  long txId=3;
  String failureMessage="Forces a failure";
  WritableLogChannel channel=new InMemoryLogChannel();
  LogFile logFile=mock(LogFile.class);
  when(logFile.getWriter()).thenReturn(channel);
  TransactionMetadataCache metadataCache=new TransactionMetadataCache(10,10);
  TransactionIdStore transactionIdStore=mock(TransactionIdStore.class);
  when(transactionIdStore.nextCommittingTransactionId()).thenReturn(txId);
  IdOrderingQueue idOrderingQueue=mock(IdOrderingQueue.class);
  doThrow(new RuntimeException(failureMessage)).when(idOrderingQueue).waitFor(anyLong());
  TransactionAppender appender=new PhysicalTransactionAppender(logFile,LogRotation.NO_ROTATION,metadataCache,transactionIdStore,idOrderingQueue,mock(KernelHealth.class));
  TransactionRepresentation transaction=transactionWithLegacyIndexCommand();
  try {
    appender.append(transaction,logAppendEvent);
    fail("Expected append to fail. Something is wrong with the test itself");
  }
 catch (  Exception e) {
    assertTrue(contains(e,failureMessage,RuntimeException.class));
    verify(transactionIdStore,times(1)).nextCommittingTransactionId();
    verify(transactionIdStore,times(1)).transactionCommitted(eq(txId),anyLong());
    verify(transactionIdStore,times(1)).transactionClosed(txId);
    verifyNoMoreInteractions(transactionIdStore);
  }
}
