{
  long existingLabelsField=node.getLabelField();
  long existingLabelsBits=parseLabelsBody(existingLabelsField);
  Collection<DynamicRecord> changedDynamicRecords=Collections.emptyList();
  if (labelField != 0) {
    nodeStore.ensureHeavy(node,existingLabelsBits);
    changedDynamicRecords=node.getDynamicLabelRecords();
    setNotInUse(changedDynamicRecords);
  }
  if (!new InlineNodeLabels(labelField,node).tryInlineInNodeRecord(labelIds,changedDynamicRecords)) {
    Set<DynamicRecord> allRecords=new HashSet<>(changedDynamicRecords);
    Collection<DynamicRecord> allocatedRecords=nodeStore.allocateRecordsForDynamicLabels(node.getId(),labelIds,changedDynamicRecords.iterator());
    allRecords.addAll(allocatedRecords);
    node.setLabelField(dynamicPointer(allocatedRecords),allocatedRecords);
    changedDynamicRecords=allRecords;
  }
  return changedDynamicRecords;
}
