{
  OnDemandCallScheduler scheduler=new OnDemandCallScheduler();
  Config config=mock(Config.class);
  InstanceId myId=new InstanceId(1);
  when(config.get(HaSettings.pull_interval)).thenReturn(1000l);
  when(config.get(ClusterSettings.server_id)).thenReturn(myId);
  LastUpdateTime lastUpdateTime=mock(LastUpdateTime.class);
  AvailabilityGuard availabilityGuard=mock(AvailabilityGuard.class);
  when(availabilityGuard.isAvailable(anyLong())).thenReturn(true);
  HaXaDataSourceManager dataSourceManager=mock(HaXaDataSourceManager.class);
  Master master=mock(Master.class);
  CapturingHighAvailabilityMemberStateMachine memberStateMachine=new CapturingHighAvailabilityMemberStateMachine(myId);
  UpdatePuller puller=new UpdatePuller(memberStateMachine,dataSourceManager,master,mock(RequestContextFactory.class),mock(AbstractTransactionManager.class),availabilityGuard,lastUpdateTime,config,scheduler,mock(StringLogger.class));
  puller.init();
  puller.start();
  scheduler.runJob();
  verify(lastUpdateTime,times(1)).setLastUpdateTime(anyLong());
  verify(availabilityGuard,times(1)).isAvailable(anyLong());
  verify(dataSourceManager,times(1)).applyTransactions(Matchers.<Response>any());
  verify(master,times(1)).pullUpdates(Matchers.<RequestContext>any());
  memberStateMachine.switchInstanceToMaster();
  scheduler.runJob();
  memberStateMachine.switchInstanceToSlave();
  scheduler.runJob();
  verify(lastUpdateTime,times(2)).setLastUpdateTime(anyLong());
  verify(availabilityGuard,times(2)).isAvailable(anyLong());
  verify(dataSourceManager,times(2)).applyTransactions(Matchers.<Response>any());
  verify(master,times(2)).pullUpdates(Matchers.<RequestContext>any());
}
