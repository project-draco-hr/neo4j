{
  RelationshipRecord relRecord=getRelationshipRecord(relId);
  if (relRecord == null) {
    relRecord=getRelationshipStore().getRecord(relId);
  }
  if (!relRecord.inUse()) {
    throw new IllegalStateException("Property change on relationship[" + relId + "] illegal since it has been deleted.");
  }
  PropertyRecord propertyRecord=getPropertyRecord(propertyId);
  if (propertyRecord == null) {
    propertyRecord=getPropertyStore().getRecord(propertyId);
    addPropertyRecord(propertyRecord);
  }
  if (!propertyRecord.inUse()) {
    throw new IllegalStateException("Unable to change property[" + propertyId + "] since it is deleted.");
  }
  propertyRecord.setRelId(relId);
  if (propertyRecord.isLight()) {
    getPropertyStore().makeHeavy(propertyRecord);
  }
  propertyRecord.setChanged();
  if (propertyRecord.getType() == PropertyType.STRING) {
    for (    DynamicRecord record : propertyRecord.getValueRecords()) {
      if (record.inUse()) {
        record.setInUse(false,PropertyType.STRING.intValue());
      }
    }
  }
 else   if (propertyRecord.getType() == PropertyType.ARRAY) {
    for (    DynamicRecord record : propertyRecord.getValueRecords()) {
      if (record.inUse()) {
        record.setInUse(false,PropertyType.ARRAY.intValue());
      }
    }
  }
  getPropertyStore().encodeValue(propertyRecord,value);
  addPropertyRecord(propertyRecord);
  return propertyRecord.newPropertyData(value);
}
