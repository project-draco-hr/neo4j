{
  final NodeStore nodeStore=getNodeStore();
  for (  NodeCommand nodeCommand : nodeCommands.values()) {
    long nodeId=nodeCommand.getKey();
    long[] labelsBefore=nodeStore.getLabelsForNode(nodeCommand.getBefore());
    long[] labelsAfter=nodeStore.getLabelsForNode(nodeCommand.getAfter());
    for (    long labelAfter : labelsAfter) {
      if (binarySearch(labelsBefore,labelAfter) < 0) {
        ArrayMap<Integer,PropertyData> properties=nodeLoadProperties(nodeId,false);
        for (        PropertyData property : properties.values()) {
          updates.add(NodePropertyUpdate.add(nodeId,property.getIndex(),property.getValue(),new long[]{labelAfter}));
        }
      }
    }
    for (    long labelBefore : labelsBefore) {
      if (binarySearch(labelsAfter,labelBefore) < 0) {
        ArrayMap<Integer,PropertyData> properties=nodeLoadProperties(nodeId,false);
        for (        PropertyData property : properties.values())         updates.add(NodePropertyUpdate.remove(nodeId,property.getIndex(),property.getValue(),new long[]{labelBefore}));
      }
    }
  }
}
