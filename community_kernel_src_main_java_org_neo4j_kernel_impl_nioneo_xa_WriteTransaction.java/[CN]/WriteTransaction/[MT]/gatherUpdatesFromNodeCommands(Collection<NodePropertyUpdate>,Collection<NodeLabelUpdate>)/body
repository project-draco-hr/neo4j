{
  final NodeStore nodeStore=getNodeStore();
  for (  NodeCommand nodeCommand : nodeCommands.values()) {
    long nodeId=nodeCommand.getKey();
    long[] labelsBefore=parseLabelsField(nodeCommand.getBefore()).get(nodeStore);
    long[] labelsAfter=parseLabelsField(nodeCommand.getAfter()).get(nodeStore);
    labelUpdates.add(NodeLabelUpdate.labelChanges(nodeId,labelsBefore,labelsAfter));
    if (nodeCommand.getMode() != Mode.UPDATE) {
      continue;
    }
    LabelChangeSummary summary=new LabelChangeSummary(labelsBefore,labelsAfter);
    Iterator<DefinedProperty> properties=nodeFullyLoadProperties(nodeId);
    while (properties.hasNext()) {
      DefinedProperty property=properties.next();
      if (summary.hasAddedLabels()) {
        propertyUpdates.add(add(nodeId,property.propertyKeyId(),property.value(),summary.getAddedLabels()));
      }
      if (summary.hasRemovedLabels()) {
        propertyUpdates.add(remove(nodeId,property.propertyKeyId(),property.value(),summary.getRemovedLabels()));
      }
    }
  }
}
