{
  if (dbDir == null) {
    throw new IllegalStateException("database directory must be configured.");
  }
  File configFile=createPropertiesFiles();
  if (serverModules == null) {
    withSpecificServerModules(RESTApiModule.class,WebAdminModule.class,ManagementApiModule.class,ThirdPartyJAXRSModule.class,DiscoveryModule.class);
  }
  return new NeoServerWithEmbeddedWebServer(new NeoServerBootstrapper(),addressResolver,startupHealthCheck,new PropertyFileConfigurator(new Validator(new DatabaseLocationMustBeSpecifiedRule()),configFile),new Jetty6WebServer(),serverModules);
}
