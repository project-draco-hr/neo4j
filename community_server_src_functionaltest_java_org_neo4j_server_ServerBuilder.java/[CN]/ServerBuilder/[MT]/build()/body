{
  if (dbDir == null) {
    this.dbDir=createTempDir().getAbsolutePath();
  }
  File configFile=createPropertiesFiles();
  if (serverModules == null) {
    withSpecificServerModulesOnly(RESTApiModule.class,WebAdminModule.class,ManagementApiModule.class,ThirdPartyJAXRSModule.class,DiscoveryModule.class);
  }
  if (startupHealthCheck == null) {
    startupHealthCheck=mock(StartupHealthCheck.class);
    when(startupHealthCheck.run()).thenReturn(true);
  }
  if (clock != null) {
    LeaseManagerProvider.setClock(clock);
  }
  return new NeoServerWithEmbeddedWebServer(new NeoServerBootstrapper(),addressResolver,startupHealthCheck,new PropertyFileConfigurator(new Validator(new DatabaseLocationMustBeSpecifiedRule()),configFile),new Jetty6WebServer(),serverModules);
}
