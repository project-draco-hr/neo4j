{
  File storeDirectory=createNeoStoreWithOlderVersion(Legacy20Store.LEGACY_VERSION);
  Logging logging=new DevNullLoggingService();
  StoreMigrator migrator=new StoreMigrator(new SilentMigrationProgressMonitor(),fs.get(),logging);
  File migrationDir=new File(storeDirectory,StoreUpgrader.MIGRATION_DIRECTORY);
  fs.get().mkdirs(migrationDir);
  assertTrue(migrator.needsMigration(storeDirectory));
  migrator.migrate(storeDirectory,migrationDir,schemaIndexProvider);
  migrator.close();
  migrator=new StoreMigrator(new SilentMigrationProgressMonitor(),fs.get(),logging);
  migrator.moveMigratedFiles(migrationDir,storeDirectory);
  LifeSupport life=new LifeSupport();
  PageCache pageCache=StandalonePageCacheFactory.createPageCache(fs.get(),getClass().getSimpleName(),life);
  life.start();
  try {
    StoreFactory storeFactory=new StoreFactory(fs.get(),storeDirectory,pageCache,logging.getMessagesLog(getClass()),new Monitors());
    storeFactory.newNeoStore(false,false).close();
  }
  finally {
    life.shutdown();
  }
}
