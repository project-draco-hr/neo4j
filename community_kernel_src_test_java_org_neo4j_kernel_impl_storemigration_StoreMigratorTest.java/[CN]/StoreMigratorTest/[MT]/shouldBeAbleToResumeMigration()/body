{
  File storeDirectory=createNeoStoreWithOlderVersion(Legacy21Store.LEGACY_VERSION);
  Logging logging=new DevNullLoggingService();
  PageCache pageCache=pageCacheRule.getPageCache(fs);
  StoreMigrator migrator=new StoreMigrator(new SilentMigrationProgressMonitor(),fs,logging);
  File migrationDir=new File(storeDirectory,StoreUpgrader.MIGRATION_DIRECTORY);
  fs.mkdirs(migrationDir);
  assertTrue(migrator.needsMigration(storeDirectory));
  migrator.migrate(storeDirectory,migrationDir,schemaIndexProvider,pageCache);
  migrator.close();
  migrator=new StoreMigrator(new SilentMigrationProgressMonitor(),fs,logging);
  migrator.moveMigratedFiles(migrationDir,storeDirectory);
  StoreFactory storeFactory=new StoreFactory(fs,storeDirectory,pageCache,logging.getMessagesLog(getClass()),new Monitors());
  storeFactory.newNeoStore(false).close();
}
