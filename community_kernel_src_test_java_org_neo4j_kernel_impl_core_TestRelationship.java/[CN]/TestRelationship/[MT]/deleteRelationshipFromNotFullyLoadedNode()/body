{
  int grabSize=10;
  GraphDatabaseService db=new ImpermanentGraphDatabase("target/test-data/test-db",stringMap("relationship_grab_size","" + grabSize));
  Transaction tx=db.beginTx();
  Node node1=db.createNode();
  Node node2=db.createNode();
  Node node3=db.createNode();
  RelationshipType type1=DynamicRelationshipType.withName("type1");
  RelationshipType type2=DynamicRelationshipType.withName("type2");
  node1.createRelationshipTo(node3,type1);
  Collection<Relationship> type2Relationships=new HashSet<Relationship>();
  for (int i=0; i < grabSize; i++) {
    type2Relationships.add(node1.createRelationshipTo(node2,type2));
  }
  tx.success();
  tx.finish();
  ((AbstractGraphDatabase)db).getConfig().getGraphDbModule().getNodeManager().clearCache();
  tx=db.beginTx();
  node1=db.getNodeById(node1.getId());
  node2=db.getNodeById(node2.getId());
  node3=db.getNodeById(node3.getId());
  node1.getRelationships().iterator().next();
  node3.getRelationships().iterator().next().delete();
  assertFalse(node3.getRelationships().iterator().hasNext());
  assertEquals(type2Relationships,addToCollection(node1.getRelationships(),new HashSet<Relationship>()));
  tx.success();
  tx.finish();
  assertEquals(type2Relationships,addToCollection(node1.getRelationships(),new HashSet<Relationship>()));
  db.shutdown();
}
