{
  final LockAcquisition lockAcquisition=new LockAcquisition();
  Future<Void> future=threadA.execute(new WorkerCommand<Void,Void>(){
    @Override public Void doWork(    Void state) throws Exception {
      try (Locks.Client client=newLockClient(lockAcquisition)){
        try {
          if (firstShared) {
            client.acquireShared(RESOURCE_TYPE,RESOURCE_ID);
          }
 else {
            client.acquireExclusive(RESOURCE_TYPE,RESOURCE_ID);
          }
          fail("Transaction termination expected");
        }
 catch (        Exception e) {
          assertThat(e,instanceOf(LockClientStoppedException.class));
        }
      }
       lockAcquisition.setClient(null);
      firstLockFailed.countDown();
      await(startSecondLock);
      try (Locks.Client client=newLockClient(lockAcquisition)){
        if (secondShared) {
          client.acquireShared(RESOURCE_TYPE,RESOURCE_ID);
        }
 else {
          client.acquireExclusive(RESOURCE_TYPE,RESOURCE_ID);
        }
      }
       return null;
    }
  }
);
  lockAcquisition.setFuture(future,threadA.get());
  return lockAcquisition;
}
