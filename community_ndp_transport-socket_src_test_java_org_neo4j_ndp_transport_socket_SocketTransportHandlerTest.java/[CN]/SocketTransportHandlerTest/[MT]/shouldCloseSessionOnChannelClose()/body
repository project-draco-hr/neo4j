{
  Session session=mock(Session.class);
  Channel ch=mock(Channel.class);
  ChannelHandlerContext ctx=mock(ChannelHandlerContext.class);
  when(ctx.channel()).thenReturn(ch);
  when(ch.alloc()).thenReturn(UnpooledByteBufAllocator.DEFAULT);
  when(ctx.alloc()).thenReturn(UnpooledByteBufAllocator.DEFAULT);
  SocketTransportHandler handler=new SocketTransportHandler(protocolChooser(session));
  handler.channelRead(ctx,handshake());
  handler.channelInactive(ctx);
  verify(session).close();
}
