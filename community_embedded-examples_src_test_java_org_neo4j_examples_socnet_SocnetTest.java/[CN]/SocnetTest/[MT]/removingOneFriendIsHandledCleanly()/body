{
  Person person1;
  Person person2;
  int noOfFriends;
  Transaction transaction=graphDb.beginTx();
  try {
    person1=personRepository.getPersonByName("person#1");
    person2=personRepository.getPersonByName("person#2");
    person1.addFriend(person2);
    noOfFriends=person1.getNrOfFriends();
    transaction.success();
  }
  finally {
    transaction.finish();
  }
  transaction=graphDb.beginTx();
  try {
    person1.removeFriend(person2);
    transaction.success();
  }
  finally {
    transaction.finish();
  }
  transaction=graphDb.beginTx();
  try {
    int noOfFriendsAfterChange=person1.getNrOfFriends();
    assertThat(noOfFriends,equalTo(noOfFriendsAfterChange + 1));
  }
  finally {
    transaction.finish();
  }
}
