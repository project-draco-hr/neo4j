{
  boolean success=false;
  try {
    populator.create();
    indexAllNodes();
    if (cancelled)     return;
    Runnable duringFlip=new Runnable(){
      @Override public void run(){
        populateFromQueueIfAvailable(Long.MAX_VALUE);
        populator.close(true);
      }
    }
;
    FailedIndexProxy failureTarget=new FailedIndexProxy(descriptor,populator);
    flipper.flip(duringFlip,failureTarget);
    success=true;
  }
 catch (  FlippableIndexProxy.FlipFailedKernelException e) {
    log.error("Failed to create index.",e);
    flipper.setFlipTarget(singleProxy(new FailedIndexProxy(descriptor,populator,e)));
    flipper.flip();
  }
catch (  RuntimeException e) {
    log.error("Failed to create index.",e);
    flipper.setFlipTarget(singleProxy(new FailedIndexProxy(descriptor,populator,e)));
    flipper.flip();
  }
 finally {
    try {
      if (!success)       populator.close(false);
    }
  finally {
      doneSignal.countDown();
    }
  }
}
