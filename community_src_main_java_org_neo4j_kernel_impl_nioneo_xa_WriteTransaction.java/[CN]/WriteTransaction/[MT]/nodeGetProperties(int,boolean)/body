{
  NodeRecord nodeRecord=getNodeRecord(nodeId);
  if (nodeRecord != null) {
    if (!nodeRecord.inUse() && !light) {
      throw new IllegalStateException("Node[" + nodeId + "] has been deleted in this tx");
    }
  }
 else {
    nodeRecord=getNodeStore().getRecord(nodeId);
  }
  if (!nodeRecord.inUse()) {
    throw new InvalidRecordException("Node[" + nodeId + "] not in use");
  }
  int nextProp=nodeRecord.getNextProp();
  ArrayMap<Integer,PropertyData> propertyMap=new ArrayMap<Integer,PropertyData>(9,false,true);
  while (nextProp != Record.NO_NEXT_PROPERTY.intValue()) {
    PropertyRecord propRecord=getPropertyRecord(nextProp);
    if (propRecord == null) {
      propRecord=getPropertyStore().getLightRecord(nextProp);
    }
    if (!propRecord.isCreated()) {
      propertyMap.put(propRecord.getKeyIndexId(),new PropertyData(propRecord.getId(),propertyGetValueOrNull(propRecord)));
    }
    nextProp=propRecord.getNextProp();
  }
  return propertyMap;
}
