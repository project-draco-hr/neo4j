{
  if (committed) {
    throw new XAException("Cannot prepare committed transaction[" + getIdentifier() + "]");
  }
  if (prepared) {
    throw new XAException("Cannot prepare prepared transaction[" + getIdentifier() + "]");
  }
  prepared=true;
  for (  RelationshipTypeRecord record : relTypeRecords.values()) {
    Command.RelationshipTypeCommand command=new Command.RelationshipTypeCommand(neoStore.getRelationshipTypeStore(),record);
    relTypeCommands.add(command);
    addCommand(command);
  }
  for (  NodeRecord record : nodeRecords.values()) {
    if (!record.inUse() && record.getNextRel() != Record.NO_NEXT_RELATIONSHIP.intValue()) {
      throw new InvalidRecordException("Node record " + record + " still has relationships");
    }
    Command.NodeCommand command=new Command.NodeCommand(neoStore.getNodeStore(),record);
    nodeCommands.add(command);
    if (!record.inUse()) {
      removeNodeFromCache(record.getId());
    }
    addCommand(command);
  }
  for (  RelationshipRecord record : relRecords.values()) {
    Command.RelationshipCommand command=new Command.RelationshipCommand(neoStore.getRelationshipStore(),record);
    relCommands.add(command);
    if (!record.inUse()) {
      removeRelationshipFromCache(record.getId());
    }
    addCommand(command);
  }
  for (  PropertyIndexRecord record : propIndexRecords.values()) {
    Command.PropertyIndexCommand command=new Command.PropertyIndexCommand(neoStore.getPropertyStore().getIndexStore(),record);
    propIndexCommands.add(command);
    addCommand(command);
  }
  for (  PropertyRecord record : propertyRecords.values()) {
    Command.PropertyCommand command=new Command.PropertyCommand(neoStore.getPropertyStore(),record);
    propCommands.add(command);
    addCommand(command);
  }
}
