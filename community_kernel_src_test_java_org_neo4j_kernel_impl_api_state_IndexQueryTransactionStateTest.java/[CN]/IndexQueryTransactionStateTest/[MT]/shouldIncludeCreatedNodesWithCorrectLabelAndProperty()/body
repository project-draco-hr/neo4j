{
  when(store.nodesGetFromIndexLookup(state,indexDescriptor,value)).then(answerAsPrimitiveLongIteratorFrom(asList(2l,3l)));
  when(store.nodeGetProperty(Matchers.any(StoreStatement.class),anyLong(),eq(propertyKeyId))).thenReturn(noNodeProperty(1,propertyKeyId));
  when(store.nodeGetAllProperties(same(statement),anyLong())).thenReturn(IteratorUtil.<DefinedProperty>emptyIterator());
  when(store.nodeHasLabel(statement,1l,labelId)).thenReturn(false);
  state.txState().nodeDoReplaceProperty(1l,noNodeProperty(1l,propertyKeyId),stringProperty(propertyKeyId,value));
  txContext.nodeAddLabel(state,1l,labelId);
  PrimitiveLongIterator result=txContext.nodesGetFromIndexLookup(state,indexDescriptor,value);
  assertThat(asSet(result),equalTo(asSet(1l,2l,3l)));
}
