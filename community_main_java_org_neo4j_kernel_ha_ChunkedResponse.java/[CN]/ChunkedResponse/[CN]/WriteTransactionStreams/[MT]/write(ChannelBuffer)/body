{
  for (int space=CHUNK_SIZE - buffer.writerIndex(); current != null && space > 0; space=CHUNK_SIZE - buffer.writerIndex()) {
    char[] resource=current.first().toCharArray();
    if (space > 1 + resource.length + 1) {
      writeName(resource,buffer);
    }
 else {
      return;
    }
    Collection<Pair<Long,ReadableByteChannel>> channels=current.other().getChannels();
    buffer.writeByte(channels.size());
    (state=new WriteStream(this,channels)).write(buffer);
    if (streams.hasNext()) {
      current=streams.next();
    }
 else {
      current=null;
    }
  }
}
