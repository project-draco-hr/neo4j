{
  ByteArrayOutputStream output=new ByteArrayOutputStream();
  ExecutionResultSerializer serializer=new ExecutionResultSerializer(output,null,StringLogger.DEV_NULL);
  Map<String,Object> data=map("column1","value1","column2","value2");
  ExecutionResult executionResult=mock(ExecutionResult.class);
  when(executionResult.columns()).thenReturn(new ArrayList<>(data.keySet()));
  @SuppressWarnings("unchecked") ResourceIterator<Map<String,Object>> iterator=mock(ResourceIterator.class);
  when(iterator.hasNext()).thenReturn(true).thenThrow(new RuntimeException("Stuff went wrong!"));
  when(iterator.next()).thenReturn(data);
  when(executionResult.iterator()).thenReturn(iterator);
  try {
    serializer.statementResult(executionResult,false);
    fail("should have thrown exception");
  }
 catch (  RuntimeException e) {
    serializer.errors(asList(new Neo4jError(StatusCode.INTERNAL_STATEMENT_EXECUTION_ERROR,e)));
  }
  serializer.finish();
  String result=output.toString("UTF-8");
  assertEquals("{\"results\":[{\"columns\":[\"column1\",\"column2\"],\"data\":[{\"row\":[\"value1\",\"value2\"]}]}]," + "\"errors\":[{\"code\":\"Neo.DatabaseError.Statement.ExecutionFailure\",\"message\":\"Stuff went wrong!\"," + "\"stackTrace\":***}]}",replaceStackTrace(result,"***"));
}
