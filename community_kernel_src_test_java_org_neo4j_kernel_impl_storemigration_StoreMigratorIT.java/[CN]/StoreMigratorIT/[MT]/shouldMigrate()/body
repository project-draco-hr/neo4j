{
  upgrader(new StoreMigrator(monitor,fs,idGeneratorFactory)).migrateIfNeeded(findOldFormatStoreDirectory(storeDir));
  assertEquals(100,monitor.events.size());
  assertTrue(monitor.started);
  assertTrue(monitor.finished);
  GraphDatabaseService database=cleanup.add(new GraphDatabaseFactory().newEmbeddedDatabase(storeDir.getAbsolutePath()));
  DatabaseContentVerifier verifier=new DatabaseContentVerifier(database);
  verifier.verifyNodes();
  verifier.verifyRelationships();
  verifier.verifyNodeIdsReused();
  verifier.verifyRelationshipIdsReused();
  verifier.verifyLegacyIndex();
  database.shutdown();
  NeoStore neoStore=cleanup.add(storeFactory.newNeoStore(storeFileName));
  verifyNeoStore(neoStore);
  neoStore.close();
}
