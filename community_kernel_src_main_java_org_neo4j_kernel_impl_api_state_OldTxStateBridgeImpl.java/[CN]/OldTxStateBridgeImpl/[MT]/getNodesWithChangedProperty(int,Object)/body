{
  DiffSets<Long> diff=new DiffSets<>();
  for (  WritableTransactionState.CowNodeElement changedNode : state.getChangedNodes()) {
    DefinedProperty removed=propertyChange(changedNode.getPropertyRemoveMap(false),propertyKey);
    if (removed != null && removed.value().equals(value)) {
      diff.remove(changedNode.getId());
    }
    if (!changedNode.isDeleted()) {
      DefinedProperty added=propertyChange(changedNode.getPropertyAddMap(false),propertyKey);
      if (added != null) {
        if (added.valueEquals(value)) {
          diff.add(changedNode.getId());
        }
 else {
          diff.remove(changedNode.getId());
        }
      }
    }
  }
  return diff;
}
