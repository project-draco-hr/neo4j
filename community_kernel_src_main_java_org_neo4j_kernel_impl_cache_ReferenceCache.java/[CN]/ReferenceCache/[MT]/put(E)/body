{
  Long key=value.getId();
  ReferenceWithKey<Long,E> ref=referenceFactory.newReference(key,value,(ReferenceQueue)refQueue);
  do {
    ReferenceWithKey<Long,E> previous=cache.putIfAbsent(key,ref);
    if (previous != null) {
      E prevValue=previous.get();
      if (prevValue == null) {
        pollClearedValues();
        continue;
      }
      return prevValue;
    }
 else {
      return value;
    }
  }
 while (true);
}
