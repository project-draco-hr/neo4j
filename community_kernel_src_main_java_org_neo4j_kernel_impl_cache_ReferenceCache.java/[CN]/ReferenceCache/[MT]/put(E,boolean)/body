{
  Long key=value.getId();
  ReferenceWithKey<Long,E> ref=referenceFactory.<Long,E>newReference(key,value,(ReferenceQueue)refQueue);
  try {
    do {
      ReferenceWithKey<Long,E> previous=force ? cache.put(key,ref) : cache.putIfAbsent(key,ref);
      if (previous != null) {
        E prevValue=previous.get();
        if (prevValue == null) {
          pollClearedValues();
          continue;
        }
        return prevValue;
      }
 else {
        return value;
      }
    }
 while (true);
  }
  finally {
    recordPutAndPollIfNeeded(1);
  }
}
