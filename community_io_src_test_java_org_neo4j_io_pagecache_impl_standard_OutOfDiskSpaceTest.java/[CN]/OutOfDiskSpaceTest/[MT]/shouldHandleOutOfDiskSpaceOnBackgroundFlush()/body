{
  LimitedFilesystemAbstraction fs=new LimitedFilesystemAbstraction(new DefaultFileSystemAbstraction());
  RecordingPageCacheMonitor monitor=new RecordingPageCacheMonitor();
  StandardPageCache cache=new StandardPageCache(fs,2,512,monitor);
  PagedFile file=cache.map(new File(testDir.directory(),"storefile"),512);
  PageCursor cursor=cache.newCursor();
  Thread sweeperThread=new Thread(cache);
  sweeperThread.start();
  CountDownLatch evictionThreadLatch=monitor.trap(any(RecordingPageCacheMonitor.Evict.class));
  file.pin(cursor,PageLock.EXCLUSIVE,1);
  file.unpin(cursor);
  file.pin(cursor,PageLock.EXCLUSIVE,2);
  file.unpin(cursor);
  fs.runOutOfDiskSpace();
  evictionThreadLatch.countDown();
  try {
    file.flush();
    fail("Should've thrown out of disk.");
  }
 catch (  IOException e) {
  }
  sweeperThread.join();
}
