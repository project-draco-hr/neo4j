{
  LimitedFilesystemAbstraction fs=new LimitedFilesystemAbstraction(new DefaultFileSystemAbstraction());
  RecordingPageCacheMonitor monitor=new RecordingPageCacheMonitor();
  StandardPageCache cache=new StandardPageCache(fs,2,512,monitor);
  PagedFile file=cache.map(new File(testDir.directory(),"storefile"),512);
  Thread sweeperThread=new Thread(cache);
  sweeperThread.start();
  CountDownLatch evictionThreadLatch=monitor.trap(any(RecordingPageCacheMonitor.Evict.class));
  try (PageCursor cursor=file.io(1,PF_EXCLUSIVE_LOCK)){
    cursor.next();
    cursor.next();
  }
   fs.runOutOfDiskSpace();
  evictionThreadLatch.countDown();
  try {
    file.flush();
    fail("Should've thrown out of disk.");
  }
 catch (  IOException e) {
  }
  sweeperThread.join();
}
