{
  StageControl control=mock(StageControl.class);
  MyProcessorStep step=new MyProcessorStep(control,0);
  step.start(ORDER_PROCESS);
  while (step.numberOfProcessors() < 5) {
    step.incrementNumberOfProcessors();
  }
  int batches=10;
  for (int i=0; i < batches; i++) {
    step.receive(i,i);
  }
  step.endOfUpstream();
  while (!step.isCompleted()) {
    verifyNoMoreInteractions(control);
  }
  assertEquals(batches,step.nextExpected.get());
  step.close();
}
