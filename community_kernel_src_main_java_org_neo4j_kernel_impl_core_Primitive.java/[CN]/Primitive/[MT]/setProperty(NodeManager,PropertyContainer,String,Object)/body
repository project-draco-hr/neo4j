{
  if (key == null || value == null) {
    throw new IllegalArgumentException("Null parameter, " + "key=" + key + ", "+ "value="+ value);
  }
  TransactionState tx=nodeManager.getTransactionState();
  tx.acquireWriteLock(proxy);
  boolean success=false;
  try {
    ensureFullProperties(nodeManager);
    ArrayMap<Integer,PropertyData> addMap=tx.getOrCreateCowPropertyAddMap(this);
    ArrayMap<Integer,PropertyData> skipMap=tx.getCowPropertyRemoveMap(this);
    PropertyKeyToken index=null;
    PropertyData property=null;
    boolean foundInSkipMap=false;
    for (    PropertyKeyToken cachedIndex : nodeManager.getPropertyKeyTokens(key)) {
      if (skipMap != null && skipMap.remove(cachedIndex.getKeyId()) != null) {
        foundInSkipMap=true;
      }
      index=cachedIndex;
      property=addMap.get(cachedIndex.getKeyId());
      if (property != null) {
        break;
      }
      property=getPropertyForIndex(cachedIndex.getKeyId());
      if (property != null) {
        break;
      }
    }
    if (index == null) {
      int keyId=nodeManager.getOrCreatePropertyKeyId(key);
      index=nodeManager.getPropertyKeyTokenOrNull(keyId);
    }
    if (property != null && !foundInSkipMap) {
      property=changeProperty(nodeManager,property,value,tx);
    }
 else {
      property=addProperty(nodeManager,index,value);
    }
    addMap.put(index.getKeyId(),property);
    success=true;
  }
  finally {
    if (!success) {
      nodeManager.setRollbackOnly();
    }
  }
}
