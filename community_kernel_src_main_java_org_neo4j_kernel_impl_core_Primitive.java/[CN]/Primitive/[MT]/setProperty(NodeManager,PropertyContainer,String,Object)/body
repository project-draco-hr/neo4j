{
  if (key == null || value == null) {
    throw new IllegalArgumentException("Null parameter, " + "key=" + key + ", "+ "value="+ value);
  }
  nodeManager.acquireLock(proxy,LockType.WRITE);
  boolean success=false;
  try {
    ensureFullProperties(nodeManager);
    ArrayMap<Integer,PropertyData> addMap=nodeManager.getOrCreateCowPropertyAddMap(this);
    ArrayMap<Integer,PropertyData> skipMap=nodeManager.getCowPropertyRemoveMap(this);
    PropertyIndex index=null;
    PropertyData property=null;
    boolean foundInSkipMap=false;
    for (    PropertyIndex cachedIndex : nodeManager.index(key)) {
      if (skipMap != null) {
        if (skipMap.remove(cachedIndex.getKeyId()) != null) {
          foundInSkipMap=true;
        }
      }
      index=cachedIndex;
      property=addMap.get(cachedIndex.getKeyId());
      if (property != null) {
        break;
      }
      property=getPropertyForIndex(cachedIndex.getKeyId());
      if (property != null) {
        break;
      }
    }
    if (property == null && !nodeManager.hasAllPropertyIndexes()) {
      for (      int keyId : addMap.keySet()) {
        if (!nodeManager.hasIndexFor(keyId)) {
          PropertyIndex indexToCheck=nodeManager.getIndexFor(keyId);
          if (indexToCheck.getKey().equals(key)) {
            if (skipMap != null) {
              skipMap.remove(indexToCheck.getKeyId());
            }
            index=indexToCheck;
            property=addMap.get(indexToCheck.getKeyId());
            if (property != null) {
              break;
            }
          }
        }
      }
      if (property == null) {
        for (        PropertyData aProperty : allProperties()) {
          int keyId=aProperty.getIndex();
          if (!nodeManager.hasIndexFor(keyId)) {
            PropertyIndex indexToCheck=nodeManager.getIndexFor(keyId);
            if (indexToCheck.getKey().equals(key)) {
              if (skipMap != null) {
                skipMap.remove(indexToCheck.getKeyId());
              }
              index=indexToCheck;
              property=getPropertyForIndex(indexToCheck.getKeyId());
              if (property != null) {
                break;
              }
            }
          }
        }
      }
    }
    if (index == null) {
      index=nodeManager.createPropertyIndex(key);
    }
    if (property != null && !foundInSkipMap) {
      property=changeProperty(nodeManager,property,value);
    }
 else {
      property=addProperty(nodeManager,index,value);
    }
    if (addMap == null)     System.out.println("addMap null");
    if (index == null)     System.out.println("index null");
    addMap.put(index.getKeyId(),property);
    success=true;
  }
  finally {
    nodeManager.releaseLock(proxy,LockType.WRITE);
    if (!success) {
      nodeManager.setRollbackOnly();
    }
  }
}
