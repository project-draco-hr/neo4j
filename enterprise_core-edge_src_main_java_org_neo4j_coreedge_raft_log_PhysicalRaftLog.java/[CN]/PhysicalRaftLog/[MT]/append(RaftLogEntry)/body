{
  if (entry.term() >= term) {
    term=entry.term();
  }
 else {
    throw new IllegalStateException(format("Non-monotonic term %d for in entry %s in term %d",entry.term(),entry.toString(),term));
  }
  long newAppendIndex=appendIndex.incrementAndGet();
  LogPositionMarker entryStartPosition=writer.getCurrentPosition(positionMarker);
  RaftLogAppendRecord.write(writer,marshal,newAppendIndex,term,entry.content());
  writer.prepareForFlush().flush();
  entryCache.put(newAppendIndex,entry);
  metadataCache.cacheMetadata(newAppendIndex,entry.term(),entryStartPosition.newPosition());
  if (logRotation.rotateLogIfNeeded(LogAppendEvent.NULL)) {
    RaftLogContinuationRecord.write(writer,newAppendIndex);
  }
  return newAppendIndex;
}
