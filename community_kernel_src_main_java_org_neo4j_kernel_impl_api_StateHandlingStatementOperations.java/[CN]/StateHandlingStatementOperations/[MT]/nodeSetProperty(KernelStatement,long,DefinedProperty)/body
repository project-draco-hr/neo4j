{
  try (NodeCursor node=nodeCursor(state,nodeId)){
    if (!node.next()) {
      throw new EntityNotFoundException(EntityType.NODE,nodeId);
    }
    Property existingProperty;
    try (PropertyCursor properties=node.properties()){
      if (!properties.seek(property.propertyKeyId())) {
        legacyPropertyTrackers.nodeAddStoreProperty(nodeId,property);
        existingProperty=Property.noProperty(property.propertyKeyId(),EntityType.NODE,nodeId);
      }
 else {
        existingProperty=Property.property(properties.propertyKeyId(),properties.value());
        legacyPropertyTrackers.nodeChangeStoreProperty(nodeId,(DefinedProperty)existingProperty,property);
      }
    }
     state.txState().nodeDoReplaceProperty(nodeId,existingProperty,property);
    indexesUpdateProperty(state,node,property.propertyKeyId(),existingProperty instanceof DefinedProperty ? (DefinedProperty)existingProperty : null,property);
    return existingProperty;
  }
 }
