{
  File indexDirectory=new File("target/whatever");
  final LuceneDocumentStructure documentLogic=new LuceneDocumentStructure();
  DeferredConstraintVerificationUniqueLuceneIndexPopulator populator=new DeferredConstraintVerificationUniqueLuceneIndexPopulator(documentLogic,standard(),new IndexWriterStatus(),directoryFactory,indexDirectory,failureStorage,indexId);
  populator.create();
  IndexUpdater updater=populator.newPopulatingUpdater();
  updater.process(NodePropertyUpdate.add(1,1,"value1",new long[]{}));
  updater.process(NodePropertyUpdate.change(1,1,"value1",new long[]{},"value1",new long[]{}));
  updater.close();
  populator.add(2,"value2");
  populator.add(3,"value3");
  populator.verifyDeferredConstraints();
  populator.close(true);
  assertEquals(asList(1l),getAllNodes(directoryFactory,indexDirectory,"value1"));
  assertEquals(asList(2l),getAllNodes(directoryFactory,indexDirectory,"value2"));
  assertEquals(asList(3l),getAllNodes(directoryFactory,indexDirectory,"value3"));
}
