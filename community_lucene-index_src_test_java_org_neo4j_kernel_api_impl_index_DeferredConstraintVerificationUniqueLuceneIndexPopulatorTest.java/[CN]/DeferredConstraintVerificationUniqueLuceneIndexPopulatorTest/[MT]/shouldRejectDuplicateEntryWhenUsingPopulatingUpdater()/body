{
  DeferredConstraintVerificationUniqueLuceneIndexPopulator populator=newPopulator();
  populator.add(1,"value1");
  populator.add(2,"value2");
  when(propertyAccessor.getProperty(1,PROPERTY_KEY_ID)).thenReturn(stringProperty(PROPERTY_KEY_ID,"value1"));
  when(propertyAccessor.getProperty(3,PROPERTY_KEY_ID)).thenReturn(stringProperty(PROPERTY_KEY_ID,"value1"));
  try {
    IndexUpdater updater=populator.newPopulatingUpdater(propertyAccessor);
    updater.process(NodePropertyUpdate.add(3,PROPERTY_KEY_ID,"value1",new long[]{}));
    updater.close();
    fail("should have thrown exception");
  }
 catch (  PreexistingIndexEntryConflictException conflict) {
    assertEquals(1,conflict.getExistingNodeId());
    assertEquals("value1",conflict.getPropertyValue());
    assertEquals(3,conflict.getAddedNodeId());
  }
}
