{
  int charsToWrite=chars.length - offset;
  if (charsToWrite * 2 > MAPPED_SIZE) {
    charsToWrite=MAPPED_SIZE / 2;
  }
  if (mappedBuffer == null || (MAPPED_SIZE - mappedBuffer.position()) < (charsToWrite * 2)) {
    getNewMappedBuffer();
    if (mappedBuffer == null) {
      int bytesToWrite=(chars.length - offset) * 2;
      ByteBuffer buf=ByteBuffer.allocate(bytesToWrite);
      buf.asCharBuffer().put(chars,offset,chars.length - offset);
      buf.limit(chars.length * 2);
      int count=fileChannel.write(buf,mappedStartPosition);
      if (count != bytesToWrite) {
        throw new UnderlyingStorageException("Failed to write from " + offset + " expected "+ bytesToWrite+ " but wrote "+ count);
      }
      mappedStartPosition+=bytesToWrite;
      return;
    }
  }
  int oldPos=mappedBuffer.position();
  mappedBuffer.asCharBuffer().put(chars,offset,charsToWrite);
  mappedBuffer.position(oldPos + (charsToWrite * 2));
  offset+=charsToWrite;
  if (offset < chars.length) {
    put(chars,offset);
  }
}
