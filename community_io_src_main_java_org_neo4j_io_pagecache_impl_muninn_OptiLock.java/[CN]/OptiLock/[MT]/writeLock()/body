{
  long s, n;
  for (; ; ) {
    s=getState();
    if ((s & EXCL_MASK) == EXCL_MASK) {
      blockOnExclusiveLock();
      continue;
    }
    if ((s & CNT_MASK) == CNT_MASK) {
      throwWriteLockOverflow(s);
    }
    n=s + CNT_UNIT;
    if (compareAndSetState(s,n)) {
      return;
    }
  }
}
