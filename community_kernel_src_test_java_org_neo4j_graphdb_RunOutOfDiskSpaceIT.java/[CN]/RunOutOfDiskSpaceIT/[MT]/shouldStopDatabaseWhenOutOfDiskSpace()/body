{
  TransactionFailureException errorCaught=null;
  LimitedFileSystemGraphDatabase db=cleanup.add(new LimitedFileSystemGraphDatabase());
  db.runOutOfDiskSpaceNao();
  Transaction tx=db.beginTx();
  db.createNode();
  tx.success();
  try {
    tx.finish();
    fail("Expected tx finish to throw TransactionFailureException when filesystem is full.");
  }
 catch (  TransactionFailureException e) {
  }
  try {
    db.beginTx();
    fail("Expected tx begin to throw TransactionFailureException when tx manager breaks.");
  }
 catch (  TransactionFailureException e) {
    errorCaught=e;
  }
  assertThat(errorCaught.getCause(),is(instanceOf(org.neo4j.kernel.api.exceptions.TransactionFailureException.class)));
  db.somehowGainMoreDiskSpace();
}
