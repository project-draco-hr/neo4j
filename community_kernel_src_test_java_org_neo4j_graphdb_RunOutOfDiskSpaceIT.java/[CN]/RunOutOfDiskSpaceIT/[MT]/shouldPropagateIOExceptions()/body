{
  TransactionFailureException exceptionThrown=null;
  String storeDir=testDirectory.absolutePath();
  LimitedFileSystemGraphDatabase db=new LimitedFileSystemGraphDatabase(storeDir);
  try (Transaction tx=db.beginTx()){
    db.createNode();
    tx.success();
  }
   long logVersion=db.getDependencyResolver().resolveDependency(NeoStore.class).getCurrentLogVersion();
  db.runOutOfDiskSpaceNao();
  Transaction tx=db.beginTx();
  db.createNode();
  tx.success();
  try {
    tx.close();
    fail("Expected tx finish to throw TransactionFailureException when filesystem is full.");
  }
 catch (  TransactionFailureException e) {
    exceptionThrown=e;
  }
  assertTrue(Exceptions.contains(exceptionThrown,IOException.class));
  db.somehowGainMoreDiskSpace();
  db.shutdown();
  assertEquals(logVersion,new NeoStoreUtil(new File(storeDir),db.getFileSystem()).getLogVersion());
}
