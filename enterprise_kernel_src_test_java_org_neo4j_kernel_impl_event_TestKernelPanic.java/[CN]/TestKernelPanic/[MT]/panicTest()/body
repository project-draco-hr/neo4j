{
  String path="target/var/testdb";
  AbstractNeo4jTestCase.deleteFileOrDirectory(new File(path));
  EmbeddedGraphDatabase graphDb=new EmbeddedGraphDatabase(path);
  XaDataSourceManager xaDs=graphDb.getConfig().getTxModule().getXaDataSourceManager();
  IllBehavingXaDataSource noob=new IllBehavingXaDataSource();
  xaDs.registerDataSource("noob",noob,UTF8.encode("554342"));
  Panic panic=new Panic();
  graphDb.registerKernelEventHandler(panic);
  org.neo4j.graphdb.Transaction gdbTx=graphDb.beginTx();
  TransactionManager txMgr=graphDb.getConfig().getTxModule().getTxManager();
  Transaction tx=txMgr.getTransaction();
  graphDb.createNode();
  tx.enlistResource(noob.getXaConnection().getXaResource());
  try {
    gdbTx.success();
    gdbTx.finish();
    fail("Should fail");
  }
 catch (  Throwable t) {
    for (int i=0; i < 10 && panic.panic == false; i++) {
      Thread.sleep(1000);
    }
  }
 finally {
    graphDb.unregisterKernelEventHandler(panic);
  }
  assertTrue(panic.panic);
  graphDb.shutdown();
}
