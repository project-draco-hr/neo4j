{
  assertTmOk();
  TransactionImpl tx=txThreadMap.get();
  if (tx != null) {
    throw logAndReturn("TM error tx begin",new NotSupportedException("Nested transactions not supported"));
  }
  tx=new TransactionImpl(this,forceMode,stateFactory,log);
  txThreadMap.set(tx);
  int concurrentTxCount=txThreadMap.size();
  if (concurrentTxCount > peakConcurrentTransactions) {
    peakConcurrentTransactions=concurrentTxCount;
  }
  startedTxCount.incrementAndGet();
  tx.setTransactionContext(kernel.newTransaction());
}
