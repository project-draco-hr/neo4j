{
  assertTmOk();
  TransactionImpl tx=txThreadMap.get();
  if (tx != null) {
    throw logAndReturn("TM error tx begin",new NotSupportedException("Nested transactions not supported. Thread: " + Thread.currentThread()));
  }
  tx=new TransactionImpl(xidGlobalIdFactory.newInstance(),this,forceMode,stateFactory,log);
  txThreadMap.set(tx);
  int concurrentTxCount=txThreadMap.size();
  if (concurrentTxCount > peakConcurrentTransactions) {
    peakConcurrentTransactions=concurrentTxCount;
  }
  startedTxCount.incrementAndGet();
  monitor.txStarted(new XidImpl(tx.getGlobalId(),new byte[0]));
}
