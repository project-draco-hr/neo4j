{
  assertTmOk();
  if (txThreadMap.get() != null) {
    throw new IllegalStateException("Transaction already associated");
  }
  if (tx != null) {
    TransactionImpl txImpl=(TransactionImpl)tx;
    if (txImpl.getStatus() != Status.STATUS_NO_TRANSACTION) {
      if (txImpl.isActive()) {
        throw new IllegalStateException(txImpl + " already active");
      }
      txImpl.markAsActive();
      txThreadMap.set(txImpl);
    }
  }
}
