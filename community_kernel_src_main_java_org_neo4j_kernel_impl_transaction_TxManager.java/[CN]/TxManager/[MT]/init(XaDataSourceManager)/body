{
  this.xaDsManager=xaDsManagerToUse;
  txThreadMap=new ArrayMap<Thread,TransactionImpl>(5,true,true);
  logSwitcherFileName=txLogDir + separator + "active_tx_log";
  txLog1FileName="tm_tx_log.1";
  txLog2FileName="tm_tx_log.2";
  try {
    if (fileSystem.fileExists(logSwitcherFileName)) {
      FileChannel fc=fileSystem.open(logSwitcherFileName,"rw");
      byte fileName[]=new byte[256];
      ByteBuffer buf=ByteBuffer.wrap(fileName);
      fc.read(buf);
      fc.close();
      String currentTxLog=txLogDir + separator + UTF8.decode(fileName).trim();
      if (!fileSystem.fileExists(currentTxLog)) {
        throw logAndReturn("TM startup failure",new TransactionFailureException("Unable to start TM, " + "active tx log file[" + currentTxLog + "] not found."));
      }
      txLog=new TxLog(currentTxLog,fileSystem);
      msgLog.logMessage("TM opening log: " + currentTxLog,true);
    }
 else {
      if (fileSystem.fileExists(txLogDir + separator + txLog1FileName) || fileSystem.fileExists(txLogDir + separator + txLog2FileName)) {
        throw logAndReturn("TM startup failure",new TransactionFailureException("Unable to start TM, " + "no active tx log file found but found either " + txLog1FileName + " or "+ txLog2FileName+ " file, please set one of them as active or "+ "remove them."));
      }
      ByteBuffer buf=ByteBuffer.wrap(txLog1FileName.getBytes("UTF-8"));
      FileChannel fc=fileSystem.open(logSwitcherFileName,"rw");
      fc.write(buf);
      txLog=new TxLog(txLogDir + separator + txLog1FileName,fileSystem);
      msgLog.logMessage("TM new log: " + txLog1FileName,true);
      fc.force(true);
      fc.close();
    }
    Iterator<List<TxLog.Record>> danglingRecordList=txLog.getDanglingRecords();
    boolean danglingRecordFound=danglingRecordList.hasNext();
    if (danglingRecordFound) {
      log.info("Unresolved transactions found, " + "recovery started ...");
    }
    recover(danglingRecordList);
    if (danglingRecordFound) {
      log.info("Recovery completed, all transactions have been " + "resolved to a consistent state.");
      msgLog.logMessage("Recovery completed, all transactions have been " + "resolved to a consistent state.");
    }
    getTxLog().truncate();
    tmOk=true;
  }
 catch (  IOException e) {
    log.log(Level.SEVERE,"Unable to start TM",e);
    throw logAndReturn("TM startup failure",new TransactionFailureException("Unable to start TM",e));
  }
}
