{
  ZooKeeperMachine master=getMasterBasedOn(getAllMachines(wait,mode).values());
  masterElectionHappened(cachedMaster,master);
  if (cachedMaster.getMachineId() != master.getMachineId()) {
    invalidateMaster();
    if (!allowChange) {
      return "";
    }
    cachedMaster=master;
  }
  return cachedMaster.getServerAsString();
}
