{
  final OutputStream logOutputStream;
  try {
    logOutputStream=createOrOpenAsOuputStream(fileSystem,new File(serverFolder,"neo4j.log"),true);
  }
 catch (  IOException e) {
    throw new RuntimeException("Unable to create log file",e);
  }
  config.put(ServerSettings.third_party_packages.name(),toStringForThirdPartyPackageProperty(extensions.toList()));
  final FormattedLogProvider userLogProvider=FormattedLogProvider.toOutputStream(logOutputStream);
  GraphDatabaseFacadeFactory.Dependencies dependencies=GraphDatabaseDependencies.newDependencies().userLogProvider(userLogProvider);
  AbstractNeoServer neoServer=createNeoServer(config,dependencies,userLogProvider);
  InProcessServerControls controls=new InProcessServerControls(serverFolder,neoServer,logOutputStream);
  controls.start();
  try {
    fixtures.applyTo(controls);
  }
 catch (  RuntimeException e) {
    controls.close();
    throw e;
  }
  return controls;
}
