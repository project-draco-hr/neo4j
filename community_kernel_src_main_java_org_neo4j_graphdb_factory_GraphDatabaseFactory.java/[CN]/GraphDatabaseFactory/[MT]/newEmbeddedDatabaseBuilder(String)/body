{
  final GraphDatabaseFactoryState state=getStateCopy();
  return new GraphDatabaseBuilder(new GraphDatabaseBuilder.DatabaseCreator(){
    @Override public GraphDatabaseService newDatabase(    Map<String,String> config){
      config.put("ephemeral","false");
      if (TRUE.equalsIgnoreCase(config.get(read_only.name()))) {
        return new EmbeddedReadOnlyGraphDatabase(path,config,state.getKernelExtension(),state.getCacheProviders(),state.getTransactionInterceptorProviders());
      }
 else {
        return new EmbeddedGraphDatabase(path,config,state.getKernelExtension(),state.getCacheProviders(),state.getTransactionInterceptorProviders());
      }
    }
  }
);
}
