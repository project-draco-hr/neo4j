{
  File directory=TargetDirectory.forTest(getClass()).cleanDirectory("shouldNotPrepareAfterKernelPanicHasHappened");
  Logging mockLogging=mock(Logging.class);
  when(mockLogging.getMessagesLog(Matchers.<Class>any())).thenReturn(mock(StringLogger.class));
  KernelHealth health=new KernelHealth(mock(KernelPanicEventGenerator.class),mockLogging);
  long maxSize=1000;
  File logFile=new File(directory,"log");
  RandomAccessFile forCheckingSize=null;
  XaLogicalLog log=null;
  try {
    forCheckingSize=new RandomAccessFile(logFile,"rw");
    log=new XaLogicalLog(logFile,mock(XaResourceManager.class),XaCommandReaderFactory.DEFAULT,new XaCommandWriterFactory(){
      @Override public XaCommandWriter newInstance(){
        return new FixedSizeXaCommandWriter();
      }
    }
,new VersionRespectingXaTransactionFactory(),new DefaultFileSystemAbstraction(),new Monitors(),new DevNullLoggingService(),NO_PRUNING,mock(TransactionStateFactory.class),health,maxSize,ALLOW_ALL,Functions.<List<LogEntry>>identity(),Functions.<List<LogEntry>>identity());
    log.open();
    int identifier=log.start(new XidImpl(XidImpl.getNewGlobalId(DEFAULT_SEED,1),NeoStoreXaDataSource.BRANCH_ID),-1,-1,-1);
    log.writeStartEntry(identifier);
    long sizeBeforePanic=forCheckingSize.getChannel().size();
    health.panic(new MockException());
    try {
      log.commitOnePhase(identifier,2,ForceMode.forced);
      fail();
    }
 catch (    XAException e) {
      assertEquals(MockException.class,e.getCause().getClass());
    }
    assertEquals(sizeBeforePanic,forCheckingSize.getChannel().size());
  }
  finally {
    if (log != null) {
      log.close();
    }
    if (forCheckingSize != null) {
      forCheckingSize.close();
    }
  }
}
