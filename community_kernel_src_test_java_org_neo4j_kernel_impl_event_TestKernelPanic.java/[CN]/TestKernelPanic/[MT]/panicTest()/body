{
  final AtomicReference<BufferingLogger> logger=new AtomicReference<BufferingLogger>();
  @SuppressWarnings("deprecation") GraphDatabaseService graphDb=new ImpermanentGraphDatabase(){
    @Override protected Logging createLogging(){
      logger.set(new BufferingLogger());
      return new SingleLoggingService(logger.get());
    }
  }
;
  XaDataSourceManager xaDs=((GraphDatabaseAPI)graphDb).getXaDataSourceManager();
  IllBehavingXaDataSource noob=new IllBehavingXaDataSource(UTF8.encode("554342"),"noob");
  xaDs.registerDataSource(noob);
  Panic panic=new Panic();
  graphDb.registerKernelEventHandler(panic);
  org.neo4j.graphdb.Transaction gdbTx=graphDb.beginTx();
  TransactionManager txMgr=((GraphDatabaseAPI)graphDb).getTxManager();
  Transaction tx=txMgr.getTransaction();
  graphDb.createNode();
  noob.getXaConnection().enlistResource(tx);
  try {
    gdbTx.success();
    gdbTx.finish();
    fail("Should fail");
  }
 catch (  Throwable t) {
    for (int i=0; i < 10 && !panic.panic; i++) {
      Thread.sleep(1000);
    }
  }
 finally {
    graphDb.unregisterKernelEventHandler(panic);
  }
  assertTrue(panic.panic);
  assertTrue("Log didn't contain expected string",logger.get().toString().contains("at org.neo4j.kernel.impl.event.TestKernelPanic.panicTest"));
  graphDb.shutdown();
}
