{
  int nodeId=1;
  WriteTransaction writeTransaction=newWriteTransaction(NO_INDEXING);
  PropertyIndex propertyIndex1=new PropertyIndex("key",1), propertyIndex2=new PropertyIndex("key2",2);
  Object value1="first", value2=4;
  writeTransaction.nodeCreate(nodeId);
  PropertyData property1=writeTransaction.nodeAddProperty(nodeId,propertyIndex1,value1);
  PropertyData property2=writeTransaction.nodeAddProperty(nodeId,propertyIndex2,value2);
  writeTransaction.doPrepare();
  writeTransaction.doCommit();
  CapturingIndexingService indexingService=new CapturingIndexingService();
  writeTransaction=newWriteTransaction(indexingService);
  writeTransaction.nodeRemoveProperty(nodeId,property1);
  writeTransaction.nodeRemoveProperty(nodeId,property2);
  writeTransaction.doPrepare();
  writeTransaction.doCommit();
  assertEquals(asSet(remove(nodeId,propertyIndex1.getKeyId(),value1,none),remove(nodeId,propertyIndex2.getKeyId(),value2,none)),indexingService.updates);
}
