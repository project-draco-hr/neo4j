{
  try {
    Outcome outcome=currentRole.handler.handle(incomingMessage,state,log);
    boolean newLeaderWasElected=leaderChanged(outcome,state.leader());
    boolean newCommittedEntry=outcome.getCommitIndex() > state.commitIndex();
    state.update(outcome);
    sendMessages(outcome);
    handleTimers(outcome);
    handleLogShipping(outcome);
    membershipManager.processLog(outcome.getCommitIndex(),outcome.getLogCommands());
    driveMembership(outcome);
    volatileLeader.set(outcome.getLeader());
    if (newCommittedEntry) {
      raftStateMachine.notifyCommitted(state.commitIndex());
    }
    if (newLeaderWasElected) {
      notifyLeaderChanges(outcome);
    }
    checkForSnapshotNeed(outcome);
  }
 catch (  Throwable e) {
    panicAndStop(incomingMessage,e);
  }
}
