{
  ensureOk();
  updateTerm(entry);
  state.appendIndex++;
  try {
    state.segments.last().write(state.appendIndex,entry);
  }
 catch (  Throwable e) {
    needsRecovery=true;
    throw e;
  }
  if (state.segments.last().position() >= rotateAtSize) {
    rotateSegment(state.appendIndex,state.appendIndex,state.currentTerm);
  }
  if (entryCache != null) {
    entryCache.put(state.appendIndex,entry);
  }
  return state.appendIndex;
}
