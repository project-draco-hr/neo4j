{
  config=new Config(stringMap(GraphDatabaseSettings.record_format.name(),formatName));
  pageCache=pageCacheRule.getPageCache(fs);
  schemaIndexProvider=new LuceneSchemaIndexProvider(fs,DirectoryFactory.PERSISTENT,storeDir.directory());
  labelScanStoreProvider=new LabelScanStoreProvider(new InMemoryLabelScanStore(),1);
  format=RecordFormatSelector.select(config,NullLogService.getInstance());
  storeFactory=new StoreFactory(storeDir.directory(),config,new DefaultIdGeneratorFactory(fs),pageCache,fs,format,NullLogProvider.getInstance());
  upgradableDatabase=new UpgradableDatabase(fs,new StoreVersionCheck(pageCache),new LegacyStoreVersionCheck(fs),format);
}
