{
  File legacyStoreDir=find20FormatStoreDirectory(storeDir.directory());
  StoreMigrator storeMigrator=new StoreMigrator(fs,pageCache,config,NullLogService.getInstance(),schemaIndexProvider);
  SchemaIndexMigrator indexMigrator=new SchemaIndexMigrator(fs,schemaIndexProvider,labelScanStoreProvider);
  upgrader(indexMigrator,storeMigrator).migrateIfNeeded(legacyStoreDir);
  ClusterManager.ManagedCluster cluster=buildClusterWithMasterDirIn(fs,legacyStoreDir,life,config.getParams());
  cluster.await(allSeesAllAsAvailable());
  cluster.sync();
  HighlyAvailableGraphDatabase slave1=cluster.getAnySlave();
  verifySlaveContents(slave1);
  verifySlaveContents(cluster.getAnySlave(slave1));
  verifyDatabaseContents(cluster.getMaster());
}
