{
  File legacyStoreDir=find20FormatStoreDirectory(storeDir.directory());
  StoreMigrator storeMigrator=new StoreMigrator(monitor,fs,pageCache,config,NullLogService.getInstance());
  SchemaIndexMigrator indexMigrator=new SchemaIndexMigrator(fs);
  upgrader(indexMigrator,storeMigrator).migrateIfNeeded(legacyStoreDir,upgradableDatabase,schemaIndexProvider,labelScanStoreProvider);
  ClusterManager.ManagedCluster cluster=buildClusterWithMasterDirIn(fs,legacyStoreDir,life);
  cluster.await(allSeesAllAsAvailable());
  cluster.sync();
  HighlyAvailableGraphDatabase slave1=cluster.getAnySlave();
  verifySlaveContents(slave1);
  verifySlaveContents(cluster.getAnySlave(slave1));
  verifyDatabaseContents(cluster.getMaster());
}
