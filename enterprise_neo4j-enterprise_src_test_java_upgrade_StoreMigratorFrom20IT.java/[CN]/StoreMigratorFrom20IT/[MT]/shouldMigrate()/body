{
  StoreMigrator storeMigrator=new StoreMigrator(fs,pageCache,config,NullLogService.getInstance(),schemaIndexProvider);
  SchemaIndexMigrator indexMigrator=new SchemaIndexMigrator(fs,schemaIndexProvider,labelScanStoreProvider);
  upgrader(indexMigrator,storeMigrator).migrateIfNeeded(find20FormatStoreDirectory(storeDir.directory()));
  assertEquals(2,monitor.progresses().size());
  assertTrue(monitor.isStarted());
  assertTrue(monitor.isFinished());
  GraphDatabaseService database=new EnterpriseGraphDatabaseFactory().newEmbeddedDatabaseBuilder(storeDir.absolutePath()).setConfig(GraphDatabaseSettings.record_format,formatName).newGraphDatabase();
  try {
    verifyDatabaseContents(database);
  }
  finally {
    database.shutdown();
  }
  try (NeoStores neoStores=storeFactory.openAllNeoStores(true)){
    verifyNeoStore(neoStores);
  }
   assertConsistentStore(storeDir.directory(),config);
}
