{
  Transaction tx=graphDb.beginTx();
  try {
    Node newPersonNode=graphDb.createNode();
    Relationship rel=personRefNode.createRelationshipTo(newPersonNode,A_PERSON);
    Node alreadyExist=index.getSingleNode(Person.NAME,name);
    if (alreadyExist != null) {
      rel.delete();
      newPersonNode.delete();
      tx.success();
      return new Person(alreadyExist);
    }
    newPersonNode.setProperty(Person.NAME,name);
    index.index(newPersonNode,Person.NAME,name);
    tx.success();
    return new Person(newPersonNode);
  }
  finally {
    tx.finish();
  }
}
