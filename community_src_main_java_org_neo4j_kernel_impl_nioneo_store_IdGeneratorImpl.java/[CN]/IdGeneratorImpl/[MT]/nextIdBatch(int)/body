{
  assertStillOpen();
  int count=0;
  long[] defragIds=new long[size];
  while (count < size) {
    long id=nextIdFromDefragList();
    if (id == -1) {
      break;
    }
    defragIds[count++]=id;
  }
  long[] tmpArray=defragIds;
  defragIds=new long[count];
  System.arraycopy(tmpArray,0,defragIds,0,count);
  int sizeLeftForRange=size - count;
  long start=nextFreeId.get();
  long newHighId=start + sizeLeftForRange;
  assertIdWithinCapacity(newHighId);
  nextFreeId.set(newHighId);
  return new IdRange(defragIds,start,sizeLeftForRange);
}
