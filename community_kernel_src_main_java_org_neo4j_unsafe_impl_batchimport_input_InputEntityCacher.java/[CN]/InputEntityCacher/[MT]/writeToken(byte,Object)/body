{
  if (key instanceof String) {
    Short id=tokens[type].get(key);
    if (id == null) {
      if (nextKeyId[type] == -1) {
        throw new IllegalArgumentException("Too many tokens");
      }
      tokens[type].put((String)key,id=nextKeyId[type]++);
      header.put(type);
      ValueType.stringType().write(key,header);
    }
    channel.putShort(id);
  }
 else   if (key instanceof Integer) {
    channel.putShort((short)-1);
    channel.putShort(safeCastLongToShort((Integer)key));
  }
 else {
    throw new IllegalArgumentException("Invalid key " + key + ", "+ key.getClass());
  }
}
