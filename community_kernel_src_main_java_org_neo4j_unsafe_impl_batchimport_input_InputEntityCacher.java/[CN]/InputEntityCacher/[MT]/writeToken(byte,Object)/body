{
  if (key instanceof String) {
    Integer id=tokens[type].get(key);
    if (id == null) {
      if (nextKeyId[type] == maxKeyId[type]) {
        throw new UnsupportedOperationException("Too many tokens. Creation of more then " + maxKeyId[type] + " tokens is not supported.");
      }
      tokens[type].put((String)key,id=nextKeyId[type]++);
      header.put(type);
      ValueType.stringType().write(key,header);
    }
    channel.putInt(id);
  }
 else   if (key instanceof Integer) {
    channel.putInt((short)-1);
    channel.putInt((Integer)key);
  }
 else {
    throw new IllegalArgumentException("Invalid key " + key + ", "+ key.getClass());
  }
}
