{
  List<Block> blocks=parseBlocks(input);
  StringBuilder output=new StringBuilder(4096);
  GraphDatabaseService database=new TestGraphDatabaseFactory().newImpermanentDatabase();
  Transaction transaction=database.beginTx();
  try {
    ExecutionEngine engine=new ExecutionEngine(database);
    State state=new State(engine,database);
    removeReferenceNode(database);
    boolean hasConsole=false;
    for (    Block block : blocks) {
      if (block.type == BlockType.CONSOLE) {
        hasConsole=true;
      }
      output.append(block.process(state)).append(EOL).append(EOL);
    }
    if (!hasConsole) {
      output.append(BlockType.CONSOLE.process(null,state));
    }
    return output.toString();
  }
  finally {
    transaction.finish();
  }
}
