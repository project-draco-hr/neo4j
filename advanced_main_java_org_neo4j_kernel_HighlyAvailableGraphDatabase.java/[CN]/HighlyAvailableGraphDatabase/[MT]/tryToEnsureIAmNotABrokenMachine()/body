{
  try {
    if (broker.thisIsMaster()) {
      return;
    }
    XaDataSource nioneoDataSource=this.localGraph.getConfig().getTxModule().getXaDataSourceManager().getXaDataSource(Config.DEFAULT_DATA_SOURCE_NAME);
    long lastCommittedTx=nioneoDataSource.getLastCommittedTxId();
    long lastCommonTxId=Math.min(lastCommittedTx,broker.getMasterMachine().getLastCommittedTxId());
    int masterForMyLastCommittedTx=nioneoDataSource.getMasterForCommittedTx(lastCommonTxId);
    Master master=broker.getMaster();
    int masterForMastersLastCommittedTx=master.getMasterIdForCommittedTx(lastCommonTxId);
    if (masterForMastersLastCommittedTx == masterForMyLastCommittedTx) {
      broker.setLastCommittedTxId(lastCommittedTx);
      return;
    }
 else {
      msgLog.logMessage("Broken store, my last committed tx,machineId[" + lastCommittedTx + ","+ masterForMyLastCommittedTx+ "] but master says machine id for that txId is "+ masterForMastersLastCommittedTx);
      throw new RuntimeException("I am broken");
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
    shutdown();
    throw new RuntimeException(e);
  }
}
