{
  if (firstRelId > MAX_RELATIONSHIP_ID) {
    throw new IllegalArgumentException("Illegal relationship id, max is " + MAX_RELATIONSHIP_ID);
  }
  ByteArray array=this.array.at(nodeId);
  long existingId=all48Bits(array,nodeId,SPARSE_ID_OFFSET);
  if (isDense(array,nodeId)) {
    if (existingId == EMPTY) {
      existingId=relGroupCache.allocate(type,direction,firstRelId,incrementCount);
      setRelationshipId(array,nodeId,existingId);
      return EMPTY;
    }
    return relGroupCache.putRelationship(existingId,type,direction,firstRelId,incrementCount);
  }
  setRelationshipId(array,nodeId,firstRelId);
  return existingId;
}
