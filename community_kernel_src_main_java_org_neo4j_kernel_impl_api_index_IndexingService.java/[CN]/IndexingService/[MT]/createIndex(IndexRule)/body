{
  IndexMap indexMap=indexMapReference.getIndexMapCopy();
  long ruleId=rule.getId();
  IndexProxy index=indexMap.getIndexProxy(ruleId);
  if (index != null && state == State.NOT_STARTED) {
    indexMap.putIndexProxy(ruleId,index);
    indexMapReference.setIndexMap(indexMap);
    return;
  }
  final IndexDescriptor descriptor=createDescriptor(rule);
  SchemaIndexProvider.Descriptor providerDescriptor=rule.getProviderDescriptor();
  boolean constraint=rule.isConstraintIndex();
  if (state == State.RUNNING) {
    try {
      index=createAndStartPopulatingIndexProxy(ruleId,descriptor,providerDescriptor,constraint);
    }
 catch (    IOException e) {
      throw new RuntimeException(e);
    }
  }
 else {
    index=createAndStartRecoveringIndexProxy(descriptor,providerDescriptor);
  }
  indexMap.putIndexProxy(rule.getId(),index);
  indexMapReference.setIndexMap(indexMap);
}
