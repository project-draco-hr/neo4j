{
  IndexMap indexMap=indexMapRef.indexMapSnapshot();
  long ruleId=rule.getId();
  IndexProxy index=indexMap.getIndexProxy(ruleId);
  if (index != null && state == State.NOT_STARTED) {
    indexMap.putIndexProxy(ruleId,index);
    indexMapRef.setIndexMap(indexMap);
    return;
  }
  final IndexDescriptor descriptor=new IndexDescriptor(rule.getLabel(),rule.getPropertyKey());
  SchemaIndexProvider.Descriptor providerDescriptor=rule.getProviderDescriptor();
  boolean constraint=rule.isConstraintIndex();
  if (state == State.RUNNING) {
    try {
      index=proxySetup.createPopulatingIndexProxy(ruleId,descriptor,providerDescriptor,constraint,monitor);
      index.start();
    }
 catch (    IOException e) {
      throw new RuntimeException(e);
    }
  }
 else {
    index=proxySetup.createRecoveringIndexProxy(descriptor,providerDescriptor,constraint);
  }
  indexMap.putIndexProxy(rule.getId(),index);
  indexMapRef.setIndexMap(indexMap);
}
