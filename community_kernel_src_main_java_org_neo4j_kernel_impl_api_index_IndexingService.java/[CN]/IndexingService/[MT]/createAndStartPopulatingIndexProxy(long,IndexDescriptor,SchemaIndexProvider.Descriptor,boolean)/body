{
  final FlippableIndexProxy flipper=new FlippableIndexProxy();
  final String indexUserDescription=indexUserDescription(descriptor,providerDescriptor);
  IndexPopulator populator=getPopulatorFromProvider(providerDescriptor,ruleId,descriptor,new IndexConfiguration(constraint));
  FailedIndexProxyFactory failureDelegateFactory=new FailedPopulatingIndexProxyFactory(descriptor,providerDescriptor,populator,indexUserDescription,IndexCountsRemover.Factory.create(storeView,descriptor));
  PopulatingIndexProxy populatingIndex=new PopulatingIndexProxy(scheduler,descriptor,providerDescriptor,failureDelegateFactory,populator,flipper,storeView,new SizeVisitor(),new SampleVisitor(maxUniqueElementsPerSampling),updateableSchemaState,logging,indexUserDescription);
  flipper.flipTo(populatingIndex);
  flipper.setFlipTarget(new IndexProxyFactory(){
    @Override public IndexProxy create(){
      try {
        OnlineIndexProxy onlineProxy=new OnlineIndexProxy(descriptor,providerDescriptor,getOnlineAccessorFromProvider(providerDescriptor,ruleId,new IndexConfiguration(constraint)),storeView);
        if (constraint) {
          return new TentativeConstraintIndexProxy(flipper,onlineProxy);
        }
        return onlineProxy;
      }
 catch (      IOException e) {
        return createAndStartFailedIndexProxy(ruleId,descriptor,providerDescriptor,constraint,failure(e));
      }
    }
  }
);
  IndexProxy result=contractCheckedProxy(flipper,false);
  result.start();
  return result;
}
