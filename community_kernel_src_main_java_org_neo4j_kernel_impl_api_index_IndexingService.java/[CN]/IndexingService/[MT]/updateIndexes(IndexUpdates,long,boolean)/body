{
  if (state == State.RUNNING) {
    IndexUpdateMode mode=forceIdempotency ? IndexUpdateMode.RECOVERY : IndexUpdateMode.ONLINE;
    try (IndexUpdaterMap updaterMap=indexMapRef.createIndexUpdaterMap(mode)){
      applyUpdates(updates,updaterMap);
    }
   }
 else {
    if (state == State.NOT_STARTED) {
      recoveredNodeIds.addAll(updates.changedNodeIds());
    }
 else {
      throw new IllegalStateException("Cannot queue index updates while index service is " + state);
    }
  }
}
