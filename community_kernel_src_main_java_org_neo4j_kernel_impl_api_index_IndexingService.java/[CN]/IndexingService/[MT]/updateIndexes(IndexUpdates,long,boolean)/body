{
  if (state == State.RUNNING) {
    IndexUpdateMode mode=forceIdempotency ? IndexUpdateMode.RECOVERY : IndexUpdateMode.ONLINE;
    try (IndexUpdaterMap updaterMap=indexMapReference.createIndexUpdaterMap(mode,transactionId)){
      applyUpdates(updates,updaterMap);
    }
   }
 else {
    if (state == State.NOT_STARTED) {
      currentRecoveredTransactions().add(new RecoveredTx(transactionId,updates.changedNodeIds()));
    }
 else {
      throw new IllegalStateException("Cannot queue index updates while index service is " + state);
    }
  }
}
