{
  IndexMap indexMap=indexMapReference.getIndexMapCopy();
  for (  IndexRule indexRule : loop(indexRules)) {
    IndexProxy indexProxy;
    long indexId=indexRule.getId();
    IndexDescriptor descriptor=createDescriptor(indexRule);
    SchemaIndexProvider.Descriptor providerDescriptor=indexRule.getProviderDescriptor();
    SchemaIndexProvider provider=providerMap.apply(providerDescriptor);
    InternalIndexState initialState=provider.getInitialState(indexId);
    logger.info(format("IndexingService.initIndexes: index on %s is %s",descriptor.userDescription(tokenNameLookup),initialState));
    boolean constraint=indexRule.isConstraintIndex();
switch (initialState) {
case ONLINE:
      indexProxy=createAndStartOnlineIndexProxy(indexId,descriptor,providerDescriptor,constraint);
    break;
case POPULATING:
  indexProxy=createAndStartRecoveringIndexProxy(descriptor,providerDescriptor);
break;
case FAILED:
IndexPopulationFailure failure=failure(provider.getPopulationFailure(indexId));
indexProxy=createAndStartFailedIndexProxy(indexId,descriptor,providerDescriptor,constraint,failure);
break;
default :
throw new IllegalArgumentException("" + initialState);
}
indexMap.putIndexProxy(indexId,indexProxy);
}
indexMapReference.setIndexMap(indexMap);
}
