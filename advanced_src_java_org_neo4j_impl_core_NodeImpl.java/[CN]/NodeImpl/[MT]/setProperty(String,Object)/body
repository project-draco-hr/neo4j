{
  if (key == null || value == null) {
    throw new IllegalValueException("Null parameter, " + "key=" + key + ", "+ "value="+ value);
  }
  nodeManager.acquireLock(this,LockType.WRITE);
  try {
    ensureFullProperties();
    PropertyIndex index=null;
    Property property=null;
    for (    PropertyIndex cachedIndex : nodeManager.index(key)) {
      property=propertyMap.get(cachedIndex.getKeyId());
      index=cachedIndex;
      if (property != null) {
        break;
      }
    }
    if (property == null && !nodeManager.hasAllPropertyIndexes()) {
      for (      int keyId : propertyMap.keySet()) {
        if (!nodeManager.hasIndexFor(keyId)) {
          PropertyIndex indexToCheck=nodeManager.getIndexFor(keyId);
          if (indexToCheck.getKey().equals(key)) {
            index=indexToCheck;
            property=propertyMap.get(indexToCheck.getKeyId());
            break;
          }
        }
      }
    }
    if (index == null) {
      index=nodeManager.createPropertyIndex(key);
    }
    Event event=Event.NODE_ADD_PROPERTY;
    NodeOpData data;
    if (property != null) {
      int propertyId=property.getId();
      data=new NodeOpData(this,id,propertyId,index,value);
      event=Event.NODE_CHANGE_PROPERTY;
    }
 else {
      data=new NodeOpData(this,id,-1,index,value);
    }
    EventData eventData=new EventData(data);
    if (!nodeManager.generateProActiveEvent(event,eventData)) {
      nodeManager.setRollbackOnly();
      throw new IllegalValueException("Generate pro-active event failed, " + " unable to add property[" + key + ","+ value+ "] on "+ this);
    }
    if (event == Event.NODE_ADD_PROPERTY) {
      doAddProperty(index,new Property(data.getPropertyId(),value));
    }
 else {
      doChangeProperty(index,new Property(data.getPropertyId(),value));
    }
    nodeManager.generateReActiveEvent(event,eventData);
  }
  finally {
    nodeManager.releaseLock(this,LockType.WRITE);
  }
}
