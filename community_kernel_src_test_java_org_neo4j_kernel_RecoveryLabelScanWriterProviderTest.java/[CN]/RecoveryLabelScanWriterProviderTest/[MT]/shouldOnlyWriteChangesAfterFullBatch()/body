{
  LabelScanStore store=mock(LabelScanStore.class);
  LabelScanWriter storeWriter=mock(LabelScanWriter.class);
  when(store.newWriter()).thenReturn(storeWriter);
  int batchSize=5;
  List<NodeLabelUpdate> expectedUpdates=new ArrayList<>();
  try (RecoveryLabelScanWriterProvider provider=new RecoveryLabelScanWriterProvider(store,batchSize)){
    for (int b=0; b < 3; b++) {
      for (int i=0; i < batchSize - 1; i++) {
        simulateTransaction(provider,b * 100 + batchSize - i,expectedUpdates);
        verifyNoMoreInteractions(storeWriter);
      }
      simulateTransaction(provider,b * 100 + batchSize * 2,expectedUpdates);
      for (      NodeLabelUpdate update : expectedUpdates) {
        verify(storeWriter).write(update);
      }
      verify(storeWriter).close();
      verifyNoMoreInteractions(storeWriter);
      reset(storeWriter);
      expectedUpdates.clear();
    }
  }
 }
