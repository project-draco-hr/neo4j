{
  String path=new File(PATH,"2").getAbsolutePath();
  BatchInserter inserter=new BatchInserterImpl(path);
  BatchInserterIndexProvider provider=new LuceneBatchInserterIndexProvider(inserter);
  String name="users";
  BatchInserterIndex index=provider.nodeIndex(name,stringMap("type","fulltext"));
  long id1=inserter.createNode(null);
  index.add(id1,map("name","Mattias Persson","email","something@somewhere","something","bad"));
  long id2=inserter.createNode(null);
  index.add(id2,map("name","Lars PerssoN"));
  index.flush();
  assertContains(index.get("name","Mattias Persson"),id1);
  assertContains(index.query("name","mattias"),id1);
  assertContains(index.query("name","bla"));
  assertContains(index.query("name","persson"),id1,id2);
  assertContains(index.query("email","*@*"),id1);
  assertContains(index.get("something","bad"),id1);
  long id3=inserter.createNode(null);
  index.add(id3,map("name",new String[]{"What Ever","Anything"}));
  index.flush();
  assertContains(index.get("name","What Ever"),id3);
  assertContains(index.get("name","Anything"),id3);
  provider.shutdown();
  inserter.shutdown();
  GraphDatabaseService db=new EmbeddedGraphDatabase(path);
  Index<Node> dbIndex=db.index().forNodes(name);
  Node node1=db.getNodeById(id1);
  Node node2=db.getNodeById(id2);
  assertContains(dbIndex.query("name","persson"),node1,node2);
  db.shutdown();
}
