{
  long blockId=record.getId();
  if (isInRecoveryMode()) {
    registerIdFromUpdateRecord(blockId);
  }
  PersistenceWindow window=acquireWindow(blockId,OperationType.WRITE);
  try {
    Buffer buffer=window.getOffsettedBuffer(blockId);
    if (record.inUse()) {
      long nextProp=record.getNextBlock();
      int nextModifier=nextProp == Record.NO_NEXT_BLOCK.intValue() ? 0 : (int)((nextProp & 0xF00000000L) >> 8);
      short inUseUnsignedByte=((Record.IN_USE.byteValue()));
      int nrOfBytesInt=record.getLength();
      nrOfBytesInt|=nextModifier;
      buffer.put((byte)inUseUnsignedByte).putInt(nrOfBytesInt).putInt((int)nextProp);
      if (!record.isLight()) {
        if (!record.isCharData()) {
          buffer.put(record.getData());
        }
 else {
          buffer.put(record.getDataAsChar());
        }
      }
    }
 else {
      buffer.put(Record.NOT_IN_USE.byteValue());
      if (!isInRecoveryMode()) {
        freeBlockId(blockId);
      }
    }
  }
  finally {
    releaseWindow(window);
  }
}
