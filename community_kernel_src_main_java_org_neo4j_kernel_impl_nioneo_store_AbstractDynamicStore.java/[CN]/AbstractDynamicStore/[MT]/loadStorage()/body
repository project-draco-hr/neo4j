{
  try {
    String expectedTypeDescriptorAndVersion=getTypeDescriptor() + " " + ALL_STORES_VERSION;
    int expectedVersionLength=UTF8.encode(expectedTypeDescriptorAndVersion).length;
    long fileSize=getFileChannel().size();
    areTypeDescriptorAndVersionPresentAtTheEndOfTheFileAndDoTheyMatchTheCurrentVersion(expectedTypeDescriptorAndVersion,fileSize);
    ByteBuffer buffer=ByteBuffer.allocate(4);
    getFileChannel().position(0);
    getFileChannel().read(buffer);
    buffer.flip();
    blockSize=buffer.getInt();
    if (blockSize <= 0) {
      throw new InvalidRecordException("Illegal block size: " + blockSize + " in "+ getStorageFileName());
    }
    if ((fileSize - expectedVersionLength) % blockSize != 0 && !isReadOnly()) {
      setStoreNotOk();
    }
    if (getStoreOk() && !isReadOnly()) {
      getFileChannel().truncate(fileSize - expectedVersionLength);
    }
  }
 catch (  IOException e) {
    throw new UnderlyingStorageException("Unable to load storage " + getStorageFileName(),e);
  }
  try {
    if (!isReadOnly() || isBackupSlave()) {
      openIdGenerator();
    }
 else {
      openReadOnlyIdGenerator(getBlockSize());
    }
  }
 catch (  InvalidIdGeneratorException e) {
    setStoreNotOk();
  }
 finally {
    if (!getStoreOk()) {
      if (getConfig() != null) {
        String storeDir=(String)getConfig().get("store_dir");
        StringLogger msgLog=StringLogger.getLogger(storeDir);
        msgLog.logMessage(getStorageFileName() + " non clean shutdown detected",true);
      }
    }
  }
  setWindowPool(new PersistenceWindowPool(getStorageFileName(),getBlockSize(),getFileChannel(),calculateMappedMemory(getConfig(),storageFileName),getIfMemoryMapped(),isReadOnly() && !isBackupSlave()));
}
