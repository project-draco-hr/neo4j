{
  try {
    long fileSize=getFileChannel().size();
    String expectedVersion=getTypeAndVersionDescriptor();
    byte version[]=new byte[expectedVersion.getBytes().length];
    ByteBuffer buffer=ByteBuffer.wrap(version);
    getFileChannel().position(fileSize - version.length);
    getFileChannel().read(buffer);
    buffer=ByteBuffer.allocate(4);
    getFileChannel().position(0);
    getFileChannel().read(buffer);
    buffer.flip();
    blockSize=buffer.getInt();
    if (blockSize <= 0) {
      throw new InvalidRecordException("Illegal block size: " + blockSize + " in "+ getStorageFileName());
    }
    if (!expectedVersion.equals(new String(version))) {
      if (!versionFound(new String(version)) && !isReadOnly()) {
        setStoreNotOk();
      }
    }
    if ((fileSize - version.length) % blockSize != 0 && !isReadOnly()) {
      setStoreNotOk();
    }
    if (getStoreOk() && !isReadOnly()) {
      getFileChannel().truncate(fileSize - version.length);
    }
  }
 catch (  IOException e) {
    throw new UnderlyingStorageException("Unable to load storage " + getStorageFileName(),e);
  }
  try {
    if (!isReadOnly() || isBackupSlave()) {
      openIdGenerator();
    }
 else {
      openReadOnlyIdGenerator(getBlockSize());
    }
  }
 catch (  InvalidIdGeneratorException e) {
    setStoreNotOk();
  }
 finally {
    if (!getStoreOk()) {
      if (getConfig() != null) {
        String storeDir=(String)getConfig().get("store_dir");
        StringLogger msgLog=StringLogger.getLogger(storeDir);
        msgLog.logMessage(getStorageFileName() + " non clean shutdown detected",true);
      }
    }
  }
  setWindowPool(new PersistenceWindowPool(getStorageFileName(),getBlockSize(),getFileChannel(),getMappedMem(),getIfMemoryMapped(),isReadOnly() && !isBackupSlave()));
}
