{
  try {
    StoreChannel fileChannel=getFileChannel();
    int recordSize=getRecordSize();
    long fileSize=fileChannel.size();
    long highId=fileSize / recordSize;
    ByteBuffer byteBuffer=ByteBuffer.allocate(bytesRequiredToDetermineInUse());
    for (long i=highId; i >= 0; i--) {
      fileChannel.position(i * recordSize);
      if (fileChannel.read(byteBuffer) > 0) {
        byteBuffer.flip();
        boolean isInUse=isRecordInUse(byteBuffer);
        byteBuffer.clear();
        if (isInUse) {
          return i + 1;
        }
      }
    }
    return getNumberOfReservedLowIds();
  }
 catch (  IOException e) {
    throw new UnderlyingStorageException("Unable to rebuild id generator " + getStorageFileName(),e);
  }
}
