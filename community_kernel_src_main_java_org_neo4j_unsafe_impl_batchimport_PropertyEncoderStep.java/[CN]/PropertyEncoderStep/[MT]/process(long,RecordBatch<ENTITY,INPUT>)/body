{
  BatchingPropertyRecordAccess propertyRecords=new BatchingPropertyRecordAccess();
  Iterator<ENTITY> records=batch.getEntityRecords().iterator();
  Iterator<INPUT> inputs=batch.getInputEntities().iterator();
  while (inputs.hasNext()) {
    INPUT input=inputs.next();
    ENTITY record=records.next();
    long nextProp;
    if (input.hasFirstPropertyId()) {
      nextProp=input.firstPropertyId();
    }
 else {
      nextProp=propertyCreator.createPropertyChain(record,propertyKeyHolder.propertyKeysAndValues(input.properties(),propertyCreator),propertyRecords);
    }
    record.setNextProp(nextProp);
  }
  batch.setPropertyRecords(propertyRecords.records());
  return batch;
}
