{
  long existingLabelsField=node.getLabelField();
  byte header=getHeader(existingLabelsField);
  long existingLabelsBits=parseLabelsBody(existingLabelsField);
  Collection<DynamicRecord> changedDynamicRecords=Collections.emptyList();
  if (highHeaderBitSet(header)) {
    nodeStore.ensureHeavy(node,existingLabelsBits);
    changedDynamicRecords=node.getDynamicLabelRecords();
    for (    DynamicRecord record : changedDynamicRecords)     record.setInUse(false);
  }
  if (!tryInlineInNodeRecord(labelIds,changedDynamicRecords)) {
    Set<DynamicRecord> allRecords=new HashSet<DynamicRecord>(changedDynamicRecords);
    Collection<DynamicRecord> allocatedRecords=nodeStore.allocateRecordsForDynamicLabels(labelIds,changedDynamicRecords.iterator());
    allRecords.addAll(allocatedRecords);
    node.setLabelField(dynamicPointer(allocatedRecords),allocatedRecords);
    changedDynamicRecords=allRecords;
  }
  return changedDynamicRecords;
}
