{
  try {
    final int eventIdentifier=txManager.getEventIdentifier();
    Response<Long> response=broker.getMaster().first().commitSingleResourceTransaction(onlyForThisDataSource(responseReceiver.getSlaveContext(eventIdentifier),dataSource),dataSource.getName(),new TxExtractor(){
      @Override public void extract(      LogBuffer buffer){
        try {
          dataSource.getPreparedTransaction(identifier,buffer);
        }
 catch (        IOException e) {
          throw new RuntimeException(e);
        }
      }
      @Override public ReadableByteChannel extract(){
        try {
          return dataSource.getPreparedTransaction(identifier);
        }
 catch (        IOException e) {
          throw new RuntimeException(e);
        }
      }
    }
);
    return responseReceiver.receive(response);
  }
 catch (  ZooKeeperException e) {
    clusterReceiver.newMaster(e);
    throw e;
  }
catch (  ComException e) {
    clusterReceiver.newMaster(e);
    throw e;
  }
}
