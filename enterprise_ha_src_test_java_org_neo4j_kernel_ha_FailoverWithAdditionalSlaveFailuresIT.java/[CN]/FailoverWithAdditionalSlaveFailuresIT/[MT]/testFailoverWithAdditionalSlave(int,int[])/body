{
  ClusterManager manager=new ClusterManager.Builder().withRootDirectory(dir.cleanDirectory("testcluster")).withCluster(ClusterManager.clusterOfSize(clusterSize)).build();
  try {
    manager.start();
    ClusterManager.ManagedCluster cluster=manager.getCluster();
    cluster.await(allSeesAllAsAvailable());
    cluster.await(masterAvailable());
    Collection<HighlyAvailableGraphDatabase> failed=new ArrayList<>();
    Collection<RepairKit> repairKits=new ArrayList<>();
    for (    int slaveIndex : slaveIndexes) {
      HighlyAvailableGraphDatabase nthSlave=getNthSlave(cluster,slaveIndex);
      failed.add(nthSlave);
      RepairKit repairKit=cluster.fail(nthSlave);
      repairKits.add(repairKit);
    }
    HighlyAvailableGraphDatabase oldMaster=cluster.getMaster();
    failed.add(oldMaster);
    repairKits.add(cluster.fail(oldMaster));
    cluster.await(masterAvailable(toArray(failed)));
    for (    RepairKit repairKit : repairKits) {
      repairKit.repair();
    }
    Thread.sleep(3000);
  }
  finally {
    manager.safeShutdown();
  }
}
