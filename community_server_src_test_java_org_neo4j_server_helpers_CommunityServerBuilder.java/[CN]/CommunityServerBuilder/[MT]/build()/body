{
  if (dbDir == null && persistent) {
    throw new IllegalStateException("Must specify path");
  }
  final File configFile=buildBefore();
  BufferingConsoleLogger console=new BufferingConsoleLogger();
  Validator validator=new Validator(new DatabaseLocationMustBeSpecifiedRule());
  Configurator configurator=new PropertyFileConfigurator(validator,configFile,console);
  Monitors monitors=new Monitors();
  Logging logging=loggingFactory().create(configurator,monitors);
  console.replayInto(logging.getConsoleLog(getClass()));
  return build(configFile,configurator,GraphDatabaseDependencies.newDependencies().logging(logging).monitors(monitors));
}
