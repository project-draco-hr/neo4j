{
  TransactionCommitProcess commitProcess=mock(TransactionCommitProcess.class);
  when(commitProcess.commit(any(),any(),any())).thenThrow(new TransactionFailureException("testing")).thenReturn(123L);
  RecoverTransactionLogState recoverTransactionLogState=mock(RecoverTransactionLogState.class);
  when(recoverTransactionLogState.findLastAppliedIndex()).thenReturn(99L);
  ReplicatedTransactionStateMachine<RaftTestMember> stateMachine=stateMachine(commitProcess,new GlobalSessionTrackerState<>(),recoverTransactionLogState);
  ReplicatedTransaction<RaftTestMember> rtx=replicatedTx();
  try {
    stateMachine.applyCommand(rtx,100);
    fail("test design throws exception here");
  }
 catch (  TransactionFailureException thrownByTestDesign) {
  }
  reset(commitProcess);
  stateMachine.setLastCommittedIndex(99);
  stateMachine.applyCommand(rtx,100);
  verify(commitProcess,times(1)).commit(any(),any(),any());
}
