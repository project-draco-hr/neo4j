{
  TransactionCommitProcess commitProcess=mock(TransactionCommitProcess.class);
  GlobalSessionTrackerState<RaftTestMember> sessionTracker=mock(GlobalSessionTrackerState.class);
  when(sessionTracker.validateOperation(any(),any())).thenReturn(true);
  Stubber stubber=doThrow(new RuntimeException());
  stubber.when(sessionTracker).update(any(),any(),anyLong());
  stubber.doNothing().when(sessionTracker).update(any(),any(),anyLong());
  ReplicatedTransactionStateMachine<RaftTestMember> stateMachine=stateMachine(commitProcess,sessionTracker,mock(RecoverTransactionLogState.class));
  ReplicatedTransaction<RaftTestMember> rtx=replicatedTx();
  try {
    stateMachine.applyCommand(rtx,99);
    fail("test setup should have resulted in an exception by now");
  }
 catch (  RuntimeException totallyExpectedByTestSetup) {
  }
  reset(commitProcess);
  stateMachine.setLastCommittedIndex(99);
  stateMachine.applyCommand(rtx,99);
  verifyZeroInteractions(commitProcess);
  verify(sessionTracker,times(2)).update(any(),any(),eq(99L));
}
