{
  entity.setProperty("key","value");
  final AtomicBoolean gotTheLock=new AtomicBoolean();
  Thread thread=new Thread(){
    @Override public void run(){
      try (Transaction tx=getGraphDb().beginTx()){
        tx.acquireWriteLock(entity);
        gotTheLock.set(true);
        tx.success();
      }
 catch (      Exception e) {
        e.printStackTrace();
        throw launderedException(e);
      }
    }
  }
;
  thread.start();
  long endTime=System.currentTimeMillis() + 5000;
  while (thread.getState() != State.TERMINATED) {
    if (thread.getState() == Thread.State.WAITING || thread.getState() == State.TIMED_WAITING) {
      break;
    }
    Thread.sleep(1);
    if (System.currentTimeMillis() > endTime)     break;
  }
  boolean gotLock=gotTheLock.get();
  tx.success();
  tx.begin();
  assertFalse(gotLock);
  thread.join();
}
