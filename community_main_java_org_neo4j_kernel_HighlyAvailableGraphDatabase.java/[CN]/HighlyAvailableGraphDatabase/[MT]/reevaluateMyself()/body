{
  shutdownIfNecessary();
  if (brokerSaysIAmMaster()) {
    this.localGraph=new EmbeddedGraphDbImpl(storeDir,config,this,LockManagerFactory.DEFAULT,IdGeneratorFactory.DEFAULT,DefaultRelationshipTypeCreator.INSTANCE,TopLevelTransactionFactory.DEFAULT,TxIdFactory.DEFAULT);
  }
 else {
    ResponseReceiver receiver=new ResponseReceiver();
    this.localGraph=new EmbeddedGraphDbImpl(storeDir,config,this,new SlaveLockManager.SlaveLockManagerFactory(broker,receiver),new SlaveIdGenerator.SlaveIdGeneratorFactory(broker,receiver),new SlaveRelationshipTypeCreator(broker,receiver),new SlaveTopLevelTransactionFactory(broker,receiver),new SlaveTxIdFactory(broker,receiver));
  }
}
