{
  EphemeralFileSystemAbstraction fsa=new EphemeralFileSystemAbstraction();
  fsa.mkdir(testDir.directory());
  final int numberOfEntriesBeforeRotation=100;
  DurableStateStorage<AtomicInteger> storage=new DurableStateStorage<>(fsa,testDir.directory(),"state",new AtomicIntegerMarshal(),numberOfEntriesBeforeRotation,health(),NullLogProvider.getInstance());
  for (int i=0; i < numberOfEntriesBeforeRotation; i++) {
    storage.persistStoreData(new AtomicInteger(i));
  }
  storage.persistStoreData(new AtomicInteger(9999));
  assertEquals(4,fsa.getFileSize(stateFileB()));
  assertEquals(numberOfEntriesBeforeRotation * 4,fsa.getFileSize(stateFileA()));
}
