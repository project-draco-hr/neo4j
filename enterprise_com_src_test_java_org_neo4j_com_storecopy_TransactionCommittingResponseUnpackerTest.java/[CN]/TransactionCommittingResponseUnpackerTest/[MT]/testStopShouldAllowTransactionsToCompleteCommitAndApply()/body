{
  DependencyResolver dependencyResolver=mock(DependencyResolver.class);
  TransactionIdStore txIdStore=mock(TransactionIdStore.class);
  when(dependencyResolver.resolveDependency(TransactionIdStore.class)).thenReturn(txIdStore);
  TransactionAppender appender=mockedTransactionAppender();
  LogicalTransactionStore logicalTransactionStore=mock(LogicalTransactionStore.class);
  when(logicalTransactionStore.getAppender()).thenReturn(appender);
  when(dependencyResolver.resolveDependency(LogicalTransactionStore.class)).thenReturn(logicalTransactionStore);
  BatchingTransactionRepresentationStoreApplier storeApplier=mock(BatchingTransactionRepresentationStoreApplier.class);
  LogFile logFile=mock(LogFile.class);
  when(dependencyResolver.resolveDependency(LogFile.class)).thenReturn(logFile);
  KernelHealth kernelHealth=mock(KernelHealth.class);
  when(kernelHealth.isHealthy()).thenReturn(true);
  when(dependencyResolver.resolveDependency(KernelHealth.class)).thenReturn(kernelHealth);
  LogRotation logRotation=mock(LogRotation.class);
  when(dependencyResolver.resolveDependency(LogRotation.class)).thenReturn(logRotation);
  addMockedNeoStore(dependencyResolver);
  when(dependencyResolver.resolveDependency(IndexingService.class)).thenReturn(mock(IndexingService.class));
  when(dependencyResolver.resolveDependency(Logging.class)).thenReturn(logging);
  IndexUpdatesValidator validator=setUpIndexUpdatesValidatorMocking(dependencyResolver);
  StoppingTxHandler stoppingTxHandler=new StoppingTxHandler();
  int maxBatchSize=10;
  TransactionCommittingResponseUnpacker unpacker=new TransactionCommittingResponseUnpacker(dependencyResolver,maxBatchSize,customValidator(validator),customApplier(storeApplier));
  stoppingTxHandler.setUnpacker(unpacker);
  unpacker.start();
  long committingTransactionId=BASE_TX_ID + 1;
  unpacker.unpackResponse(new DummyTransactionResponse(committingTransactionId,1,appender,maxBatchSize),stoppingTxHandler);
  verify(txIdStore,times(1)).transactionClosed(committingTransactionId);
  verify(appender,times(1)).append(any(TransactionRepresentation.class),anyLong());
  verify(appender,times(1)).force();
  verify(logRotation,times(1)).rotateLogIfNeeded(logAppendEvent);
  try {
    unpacker.unpackResponse(mock(Response.class),stoppingTxHandler);
    fail("A stopped transaction unpacker should not allow transactions to be applied");
  }
 catch (  IllegalStateException e) {
  }
  verifyNoMoreInteractions(txIdStore);
  verifyNoMoreInteractions(appender);
}
