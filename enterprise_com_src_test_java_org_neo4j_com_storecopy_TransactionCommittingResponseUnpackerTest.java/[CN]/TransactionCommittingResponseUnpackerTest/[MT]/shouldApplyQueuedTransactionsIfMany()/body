{
  final BatchingTransactionRepresentationStoreApplier applier=mock(BatchingTransactionRepresentationStoreApplier.class);
  final TransactionAppender appender=mockedTransactionAppender();
  final IndexUpdatesValidator indexUpdatesValidator=mockedIndexUpdatesValidator();
  final LogFile logFile=mock(LogFile.class);
  final LogRotation logRotation=mock(LogRotation.class);
  final KernelHealth kernelHealth=newKernelHealth();
  Dependencies deps=new MockedDependencies().logFile(logFile).logRotation(logRotation).indexUpdatesValidator(indexUpdatesValidator).transactionRepresentationStoreApplier(applier).transactionAppender(appender).kernelHealth(kernelHealth);
  int maxBatchSize=3;
  TransactionCommittingResponseUnpacker unpacker=new TransactionCommittingResponseUnpacker(deps,maxBatchSize);
  unpacker.start();
  int txCount=maxBatchSize * 2 - 1;
  unpacker.unpackResponse(new DummyTransactionResponse(2,txCount,appender,maxBatchSize),NO_OP_TX_HANDLER);
  verify(appender,times(txCount)).append(any(TransactionRepresentation.class),anyLong());
  verify(appender,times(2)).force();
  verify(logRotation,times(2)).rotateLogIfNeeded(logAppendEvent);
}
