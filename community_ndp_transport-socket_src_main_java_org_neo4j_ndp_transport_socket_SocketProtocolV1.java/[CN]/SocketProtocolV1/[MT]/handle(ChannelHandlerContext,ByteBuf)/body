{
  onBatchOfMessagesStarted();
  try {
    while (data.readableBytes() > 0) {
switch (state) {
case AWAITING_CHUNK:
{
          if (data.readableBytes() >= 2) {
            chunkSize=data.readUnsignedShort();
            handleHeader(channelContext);
          }
 else {
            chunkSize=data.readByte() << 8;
            state=State.IN_HEADER;
          }
          break;
        }
case IN_HEADER:
{
        chunkSize=(chunkSize | data.readByte()) & 0xFFFF;
        handleHeader(channelContext);
        break;
      }
case IN_CHUNK:
{
      if (chunkSize < data.readableBytes()) {
        input.addChunk(data.readSlice(chunkSize));
        state=State.AWAITING_CHUNK;
      }
 else       if (chunkSize == data.readableBytes()) {
        input.addChunk(data);
        state=State.AWAITING_CHUNK;
      }
 else {
        chunkSize-=data.readableBytes();
        input.addChunk(data);
      }
      break;
    }
case CLOSED:
{
    return;
  }
}
}
}
  finally {
data.release();
onBatchOfMessagesDone();
}
}
