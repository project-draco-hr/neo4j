{
  try (ValidatedIndexUpdates indexUpdates=validateIndexUpdates(transaction)){
    long transactionId=commitTransaction(transaction,commitEvent);
    commitEvent.setTransactionId(transactionId);
    try (StoreApplyEvent storeApplyEvent=commitEvent.beginStoreApply()){
      storeApplier.apply(transaction,indexUpdates,locks,transactionId,mode);
    }
 catch (    Throwable e) {
      throw exception(CouldNotCommit,e,"Could not apply the transaction to the store after written to log");
    }
 finally {
      transactionIdStore.transactionClosed(transactionId);
    }
    return transactionId;
  }
 }
