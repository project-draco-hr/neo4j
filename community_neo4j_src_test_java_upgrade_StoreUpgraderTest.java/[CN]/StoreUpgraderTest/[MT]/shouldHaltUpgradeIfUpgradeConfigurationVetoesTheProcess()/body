{
  PageCache pageCache=pageCacheRule.getPageCache(fileSystem);
  UpgradeConfiguration vetoingUpgradeConfiguration=new UpgradeConfiguration(){
    @Override public void checkConfigurationAllowsAutomaticUpgrade(){
      throw new UpgradeNotAllowedByConfigurationException("vetoed");
    }
  }
;
  UpgradableDatabase upgradableDatabase=new UpgradableDatabase(new StoreVersionCheck(pageCache),new LegacyStoreVersionCheck(fileSystem));
  try {
    newUpgrader(vetoingUpgradeConfiguration,pageCache).migrateIfNeeded(dbDirectory,upgradableDatabase,schemaIndexProvider);
    fail("Should throw exception");
  }
 catch (  UpgradeNotAllowedByConfigurationException e) {
  }
}
