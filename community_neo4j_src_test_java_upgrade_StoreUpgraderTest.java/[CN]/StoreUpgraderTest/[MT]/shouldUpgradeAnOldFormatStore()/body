{
  PageCache pageCache=pageCacheRule.getPageCache(fileSystem);
  UpgradableDatabase upgradableDatabase=new UpgradableDatabase(new StoreVersionCheck(pageCache),new LegacyStoreVersionCheck(fileSystem));
  assertTrue(allLegacyStoreFilesHaveVersion(fileSystem,dbDirectory,version));
  newUpgrader(ALLOW_UPGRADE,pageCache).migrateIfNeeded(dbDirectory,upgradableDatabase,schemaIndexProvider);
  assertTrue(checkNeoStoreHasLatestVersion(check,dbDirectory));
  assertTrue(allStoreFilesHaveNoTrailer(fileSystem,dbDirectory));
  assertFalse(containsAnyStoreFiles(fileSystem,isolatedMigrationDirectoryOf(dbDirectory)));
  assertConsistentStore(dbDirectory);
}
