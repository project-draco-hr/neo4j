{
  PageCache pageCache=pageCacheRule.getPageCache(fileSystem);
  UpgradableDatabase upgradableDatabase=new UpgradableDatabase(fileSystem,new StoreVersionCheck(pageCache),new LegacyStoreVersionCheck(fileSystem),InternalRecordFormatSelector.select());
  assertEquals(!LowLimitV2_3.STORE_VERSION.equals(version),allLegacyStoreFilesHaveVersion(fileSystem,dbDirectory,version));
  newUpgrader(upgradableDatabase,pageCache).migrateIfNeeded(dbDirectory);
  assertTrue(checkNeoStoreHasCurrentFormatVersion(check,dbDirectory));
  assertTrue(allStoreFilesHaveNoTrailer(fileSystem,dbDirectory));
  assertFalse(containsAnyStoreFiles(fileSystem,isolatedMigrationDirectoryOf(dbDirectory)));
  assertConsistentStore(dbDirectory);
}
