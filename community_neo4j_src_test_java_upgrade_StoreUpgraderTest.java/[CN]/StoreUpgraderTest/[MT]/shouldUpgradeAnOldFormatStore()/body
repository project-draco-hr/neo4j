{
  PageCache pageCache=pageCacheRule.getPageCache(fileSystem);
  UpgradableDatabase upgradableDatabase=new UpgradableDatabase(fileSystem,new StoreVersionCheck(pageCache),new LegacyStoreVersionCheck(fileSystem),getRecordFormats());
  assertEquals(!StandardV2_3.STORE_VERSION.equals(version),allLegacyStoreFilesHaveVersion(fileSystem,dbDirectory,version));
  newUpgrader(upgradableDatabase,pageCache).migrateIfNeeded(dbDirectory);
  assertCorrectStoreVersion(getRecordFormats().storeVersion(),check,dbDirectory);
  assertTrue(allStoreFilesHaveNoTrailer(fileSystem,dbDirectory));
  assertFalse(containsAnyStoreFiles(fileSystem,isolatedMigrationDirectoryOf(dbDirectory)));
  startStopDatabase();
  assertConsistentStore(dbDirectory);
}
