{
  PageCache pageCache=pageCacheRule.getPageCache(fileSystem);
  UpgradableDatabase upgradableDatabase=new UpgradableDatabase(fileSystem,new StoreVersionCheck(pageCache),new LegacyStoreVersionCheck(fileSystem));
  assertEquals(!Legacy23Store.LEGACY_VERSION.equals(version),allLegacyStoreFilesHaveVersion(fileSystem,dbDirectory,version));
  newUpgrader(ALLOW_UPGRADE,pageCache).migrateIfNeeded(dbDirectory,upgradableDatabase,schemaIndexProvider);
  assertTrue(checkNeoStoreHasLatestVersion(check,dbDirectory));
  assertTrue(allStoreFilesHaveNoTrailer(fileSystem,dbDirectory));
  assertFalse(containsAnyStoreFiles(fileSystem,isolatedMigrationDirectoryOf(dbDirectory)));
  assertConsistentStore(dbDirectory);
}
