{
  PageCache pageCache=pageCacheRule.getPageCache(fileSystem);
  UpgradableDatabase upgradableDatabase=new UpgradableDatabase(fileSystem,new StoreVersionCheck(pageCache),new LegacyStoreVersionCheck(fileSystem));
  String versionToMigrateFrom=upgradableDatabase.checkUpgradeable(dbDirectory);
{
    StoreUpgrader upgrader=newUpgrader(ALLOW_UPGRADE,pageCache);
    String failureMessage="Just failing";
    upgrader.addParticipant(participantThatWillFailWhenMoving(failureMessage));
    try {
      upgrader.migrateIfNeeded(dbDirectory,upgradableDatabase,schemaIndexProvider,labelScanStoreProvider);
      fail("should have thrown");
    }
 catch (    UnableToUpgradeException e) {
      assertTrue(e.getCause() instanceof IOException);
      assertEquals(failureMessage,e.getCause().getMessage());
    }
  }
{
    Monitor monitor=Mockito.mock(Monitor.class);
    StoreUpgrader upgrader=newUpgrader(monitor,pageCache);
    StoreMigrationParticipant observingParticipant=Mockito.mock(StoreMigrationParticipant.class);
    upgrader.addParticipant(observingParticipant);
    upgrader.migrateIfNeeded(dbDirectory,upgradableDatabase,schemaIndexProvider,labelScanStoreProvider);
    verify(observingParticipant,Mockito.times(0)).migrate(any(File.class),any(File.class),any(SchemaIndexProvider.class),any(LabelScanStoreProvider.class),eq(versionToMigrateFrom));
    verify(observingParticipant,Mockito.times(1)).moveMigratedFiles(any(File.class),any(File.class),eq(versionToMigrateFrom));
    verify(observingParticipant,Mockito.times(1)).cleanup(any(File.class));
    verify(monitor).migrationCompleted();
  }
}
