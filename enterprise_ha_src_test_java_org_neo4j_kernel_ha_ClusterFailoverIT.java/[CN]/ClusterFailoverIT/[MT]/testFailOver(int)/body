{
  ClusterManager clusterManager=new ClusterManager.Builder().withRootDirectory(dir.cleanDirectory("failover")).withCluster(ClusterManager.clusterOfSize(clusterSize)).build();
  clusterManager.start();
  ClusterManager.ManagedCluster cluster=clusterManager.getCluster();
  cluster.await(ClusterManager.allSeesAllAsAvailable());
  HighlyAvailableGraphDatabase oldMaster=cluster.getMaster();
  long start=System.nanoTime();
  ClusterManager.RepairKit repairKit=cluster.fail(oldMaster);
  logger.getLogger().warning("Shut down master");
  cluster.await(ClusterManager.masterAvailable(oldMaster));
  long end=System.nanoTime();
  logger.getLogger().warning("Failover took:" + (end - start) / 1000000 + "ms");
  repairKit.repair();
  Thread.sleep(3000);
  clusterManager.safeShutdown();
}
