{
  KernelTransaction kernelTransaction=mock(KernelTransaction.class);
  when(kernelTransaction.isOpen()).thenReturn(true);
  doThrow(new TransactionFailureException(Status.Transaction.ConstraintsChanged,"Proving that TopLevelTransaction does the right thing")).when(kernelTransaction).close();
  ThreadToStatementContextBridge bridge=new ThreadToStatementContextBridge();
  TopLevelTransaction transaction=new TopLevelTransaction(kernelTransaction,bridge);
  transaction.success();
  try {
    transaction.close();
    fail("Should have failed");
  }
 catch (  TransientTransactionFailureException e) {
  }
}
