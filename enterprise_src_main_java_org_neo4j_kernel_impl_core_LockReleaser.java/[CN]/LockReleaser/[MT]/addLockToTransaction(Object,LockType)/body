{
  Transaction tx=getTransaction();
  List<LockElement> lockElements=lockMap.get(tx);
  if (lockElements != null) {
    lockElements.add(new LockElement(resource,type));
  }
 else {
    if (tx == null) {
      if (type == LockType.WRITE) {
        lockManager.releaseWriteLock(resource);
      }
 else       if (type == LockType.READ) {
        lockManager.releaseReadLock(resource);
      }
      return;
    }
    lockElements=new ArrayList<LockElement>();
    lockMap.put(tx,lockElements);
    lockElements.add(new LockElement(resource,type));
    try {
      tx.registerSynchronization(new ReadOnlyTxReleaser(tx));
    }
 catch (    Exception e) {
      throw new TransactionFailureException("Failed to register lock release synchronization hook",e);
    }
  }
}
