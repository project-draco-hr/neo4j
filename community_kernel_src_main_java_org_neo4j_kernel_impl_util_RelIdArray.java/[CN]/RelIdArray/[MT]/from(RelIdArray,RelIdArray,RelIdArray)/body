{
  if (remove == null) {
    if (src == null) {
      return add.downgradeIfPossible();
    }
    if (add != null) {
      RelIdArray newArray=src.newSimilarInstance();
      newArray.addAll(src);
      newArray=newArray.addAll(add);
      return newArray;
    }
    return src;
  }
 else {
    if (src == null && add == null) {
      return null;
    }
    RelIdArray newArray=null;
    Set<Long> removedSet=remove.asSet();
    if (src != null) {
      newArray=src.newSimilarInstance();
      newArray.addAll(src);
      evictExcluded(newArray,removedSet);
    }
 else {
      newArray=add.newSimilarInstance();
    }
    if (add != null) {
      newArray=newArray.upgradeIfNeeded(add);
      for (RelIdIterator fromIterator=add.iterator(DirectionWrapper.BOTH); fromIterator.hasNext(); ) {
        long value=fromIterator.next();
        if (!removedSet.contains(value)) {
          newArray.add(value,fromIterator.currentDirection);
        }
      }
    }
    return newArray.shrink();
  }
}
