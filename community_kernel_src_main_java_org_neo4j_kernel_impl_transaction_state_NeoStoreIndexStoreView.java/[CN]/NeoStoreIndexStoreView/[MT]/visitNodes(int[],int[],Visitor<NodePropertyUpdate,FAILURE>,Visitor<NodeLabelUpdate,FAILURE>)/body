{
  final long allNodes=counts.nodeCount(ANY_LABEL,Registers.newDoubleLongRegister()).readSecond();
  return new NodeStoreScan<Update,FAILURE>(nodeStore,locks,allNodes){
    @Override protected Update read(    NodeRecord node){
      long[] labels=parseLabelsField(node).get(this.nodeStore);
      Update update=new Update(node.getId(),labels);
      if (!containsAnyLabel(labelIds,labels)) {
        return update;
      }
      properties:       for (      PropertyBlock property : properties(node)) {
        int propertyKeyId=property.getKeyIndexId();
        for (        int sought : propertyKeyIds) {
          if (propertyKeyId == sought) {
            update.add(NodePropertyUpdate.add(node.getId(),propertyKeyId,valueOf(property),labels));
            continue properties;
          }
        }
      }
      return update;
    }
    @Override protected void process(    Update update) throws FAILURE {
      labelUpdateVisitor.visit(update.labels);
      for (      NodePropertyUpdate propertyUpdate : update) {
        propertyUpdateVisitor.visit(propertyUpdate);
      }
    }
  }
;
}
