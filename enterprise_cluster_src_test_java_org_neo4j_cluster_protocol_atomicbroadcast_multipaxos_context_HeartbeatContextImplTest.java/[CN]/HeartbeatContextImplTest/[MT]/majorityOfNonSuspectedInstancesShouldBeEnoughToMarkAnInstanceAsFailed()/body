{
  InstanceId me=new InstanceId(1);
  InstanceId member2=new InstanceId(2);
  InstanceId member3=new InstanceId(3);
  InstanceId member4=new InstanceId(4);
  InstanceId member5=new InstanceId(5);
  Timeouts timeouts=mock(Timeouts.class);
  CommonContextState commonState=mock(CommonContextState.class);
  ClusterConfiguration configuration=mock(ClusterConfiguration.class);
  when(commonState.configuration()).thenReturn(configuration);
  when(configuration.getMembers()).thenReturn(members(5));
  when(configuration.getMemberIds()).thenReturn(ids(5));
  DelayedDirectExecutor executor=new DelayedDirectExecutor(NullLogProvider.getInstance());
  HeartbeatContext context=new HeartbeatContextImpl(me,commonState,NullLogProvider.getInstance(),timeouts,executor);
  final List<InstanceId> failed=new ArrayList<>(4);
  HeartbeatListener listener=new HeartbeatListener(){
    @Override public void failed(    InstanceId server){
      failed.add(server);
    }
    @Override public void alive(    InstanceId server){
      failed.remove(server);
    }
  }
;
  context.addHeartbeatListener(listener);
  context.suspect(member2);
  context.suspect(member3);
  executor.drain();
  assertEquals(0,failed.size());
  Set<InstanceId> suspicionsFrom5=new HashSet<>();
  suspicionsFrom5.add(member2);
  suspicionsFrom5.add(member3);
  context.suspicions(member5,suspicionsFrom5);
  executor.drain();
  assertEquals(2,failed.size());
  assertTrue(failed.contains(member2));
  assertTrue(failed.contains(member3));
  context.alive(member2);
  executor.drain();
  assertEquals(1,failed.size());
  assertTrue(failed.contains(member3));
}
