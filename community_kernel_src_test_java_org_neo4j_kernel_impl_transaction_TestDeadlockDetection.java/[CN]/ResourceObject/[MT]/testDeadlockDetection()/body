{
  Object r1=new ResourceObject("R1");
  Object r2=new ResourceObject("R2");
  Object r3=new ResourceObject("R3");
  Object r4=new ResourceObject("R4");
  LockManager lm=new LockManager(new PlaceboTm());
  HelperThread t1=new HelperThread("T1",lm);
  HelperThread t2=new HelperThread("T2",lm);
  HelperThread t3=new HelperThread("T3",lm);
  HelperThread t4=new HelperThread("T4",lm);
  try {
    t1.start();
    t2.start();
    t3.start();
    t4.start();
    t1.getReadLock(r1);
    t1.waitForCompletionOfTask();
    t1.getReadLock(r4);
    t1.waitForCompletionOfTask();
    t2.getReadLock(r2);
    t2.waitForCompletionOfTask();
    t2.getReadLock(r3);
    t2.waitForCompletionOfTask();
    t3.getReadLock(r3);
    t3.waitForCompletionOfTask();
    t3.getWriteLock(r1);
    t3.waitForWaitingState();
    t2.getWriteLock(r4);
    t2.waitForWaitingState();
    t1.getWriteLock(r2);
    t1.waitForCompletionOfTask();
    assertTrue(t1.isLastGetLockDeadLock());
    t1.releaseReadLock(r4);
    t2.waitForCompletionOfTask();
    t1.getWriteLock(r2);
    t2.releaseReadLock(r2);
    t1.waitForCompletionOfTask();
    t1.getWriteLock(r4);
    t1.waitForWaitingState();
    t2.getWriteLock(r2);
    t2.waitForCompletionOfTask();
    assertTrue(t2.isLastGetLockDeadLock());
    t2.releaseWriteLock(r4);
    t1.waitForCompletionOfTask();
    t1.releaseWriteLock(r4);
    t2.getReadLock(r4);
    t2.waitForCompletionOfTask();
    t1.releaseWriteLock(r2);
    t1.waitForCompletionOfTask();
    t1.getReadLock(r2);
    t1.waitForCompletionOfTask();
    t1.releaseReadLock(r1);
    t3.waitForCompletionOfTask();
    t3.getReadLock(r2);
    t3.waitForCompletionOfTask();
    t3.releaseWriteLock(r1);
    t1.getReadLock(r1);
    t1.waitForCompletionOfTask();
    t1.getWriteLock(r4);
    t3.getWriteLock(r1);
    t4.getReadLock(r2);
    t4.waitForCompletionOfTask();
    t2.getWriteLock(r2);
    t2.waitForCompletionOfTask();
    assertTrue(t2.isLastGetLockDeadLock());
    t2.releaseReadLock(r4);
    t1.waitForCompletionOfTask();
    t1.releaseWriteLock(r4);
    t1.waitForCompletionOfTask();
    t1.releaseReadLock(r1);
    t1.waitForCompletionOfTask();
    t2.getReadLock(r4);
    t3.waitForCompletionOfTask();
    t3.releaseWriteLock(r1);
    t1.getReadLock(r1);
    t1.waitForCompletionOfTask();
    t1.getWriteLock(r4);
    t3.releaseReadLock(r2);
    t3.waitForCompletionOfTask();
    t3.getWriteLock(r1);
    t2.releaseReadLock(r4);
    t1.waitForCompletionOfTask();
    t1.releaseWriteLock(r4);
    t1.waitForCompletionOfTask();
    t1.releaseReadLock(r1);
    t3.waitForCompletionOfTask();
    t3.releaseWriteLock(r1);
    t3.waitForCompletionOfTask();
    t1.releaseReadLock(r2);
    t4.releaseReadLock(r2);
    t2.releaseReadLock(r3);
    t3.releaseReadLock(r3);
    t1.waitForCompletionOfTask();
    t2.waitForCompletionOfTask();
    t3.waitForCompletionOfTask();
    t4.waitForCompletionOfTask();
    t1.getReadLock(r1);
    t1.waitForCompletionOfTask();
    t2.getReadLock(r1);
    t2.waitForCompletionOfTask();
    t1.getWriteLock(r1);
    t1.waitForWaitingState();
    t2.getWriteLock(r1);
    t2.waitForCompletionOfTask();
    assertTrue(t2.isLastGetLockDeadLock());
    t2.releaseReadLock(r1);
    t1.waitForCompletionOfTask();
    t1.releaseReadLock(r1);
    t1.waitForCompletionOfTask();
    t1.releaseWriteLock(r1);
    t1.waitForCompletionOfTask();
  }
  finally {
    t1.quit();
    t2.quit();
    t3.quit();
    t4.quit();
  }
}
