{
  TransactionManager txManager=db.getDependencyResolver().resolveDependency(TransactionManager.class);
  DataWriteOperations s1=dataWriteOperationsInNewTransaction();
  createNodeWithLabelAndProperty(s1,labelId,propertyKeyId,"Bob");
  Transaction suspendedTx=txManager.suspend();
  SchemaWriteOperations schemaStatement=schemaWriteOperationsInNewTransaction();
  schemaStatement.uniquenessConstraintCreate(labelId,propertyKeyId);
  commit();
  DataWriteOperations s3=dataWriteOperationsInNewTransaction();
  createNodeWithLabelAndProperty(s3,labelId,propertyKeyId,"Bob");
  commit();
  txManager.resume(suspendedTx);
  try {
    txManager.commit();
    fail("Expected this commit to fail :(");
  }
 catch (  HeuristicRollbackException e) {
    XAException cause=(XAException)e.getCause();
    assertThat(cause.errorCode,equalTo(XAException.XA_RBINTEGRITY));
  }
}
