{
  when(loader.loadById(nodeId)).thenReturn(new CachedNodeEntity(nodeId));
  Set<Long> labels=new HashSet<Long>(asList(1L,2L,3L));
  @SuppressWarnings("unchecked") DiffSets<Long> diff=mock(DiffSets.class);
  when(diff.getAdded()).thenReturn(labels);
  when(state.getNodeStateLabelDiffSets(nodeId)).thenReturn(diff);
  nodeState.getLabelDiffSets().addAll(labels.iterator());
  when(state.getNodeStates()).thenReturn(asList(nodeState));
  cache.getLabels(nodeId);
  cache.apply(state);
  assertEquals(labels,cache.getLabels(nodeId));
}
