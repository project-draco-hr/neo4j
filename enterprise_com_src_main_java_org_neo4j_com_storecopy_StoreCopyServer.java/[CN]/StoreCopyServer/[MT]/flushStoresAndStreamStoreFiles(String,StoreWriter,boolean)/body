{
  try {
    monitor.startTryCheckPoint();
    long lastAppliedTransaction=checkPointer.tryCheckPoint(new SimpleTriggerInfo(triggerName));
    monitor.finishTryCheckPoint();
    ByteBuffer temporaryBuffer=ByteBuffer.allocateDirect((int)ByteUnit.mebiBytes(1));
    monitor.startStreamingStoreFiles();
    try (ResourceIterator<StoreFileMetadata> files=dataSource.listStoreFiles(includeLogs)){
      while (files.hasNext()) {
        StoreFileMetadata meta=files.next();
        File file=meta.file();
        int recordSize=meta.recordSize();
        final Optional<PagedFile> optionalPagedFile=pageCache.getExistingMapping(file);
        try (ReadableByteChannel fileChannel=optionalPagedFile.isPresent() ? optionalPagedFile.get().openReadableByteChannel() : fileSystem.open(file,"r")){
          monitor.startStreamingStoreFile(file);
          writer.write(relativePath(storeDirectory,file),fileChannel,temporaryBuffer,file.length() > 0,recordSize);
          monitor.finishStreamingStoreFile(file);
        }
  finally {
          if (optionalPagedFile.isPresent()) {
            optionalPagedFile.get().close();
          }
        }
      }
    }
  finally {
      monitor.finishStreamingStoreFiles();
    }
    return anonymous(lastAppliedTransaction);
  }
 catch (  IOException e) {
    throw new ServerFailureException(e);
  }
}
