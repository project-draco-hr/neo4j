{
  while (true) {
    long firstNotAllocated=pendingIdAllocationRequests.firstUnallocated(idType);
    ReplicatedIdAllocationRequest idAllocationRequest=new ReplicatedIdAllocationRequest(me,idType,firstNotAllocated,allocationChunk);
    try (PendingIdAllocationRequest pendingIdAllocationRequest=pendingIdAllocationRequests.register(idAllocationRequest)){
      try {
        replicator.replicate(idAllocationRequest);
      }
 catch (      Replicator.ReplicationFailedException e) {
        log.error(format("Failed to acquire id range for idType %s",idType),e);
        throw new IdGenerationException(e);
      }
      try {
        if (pendingIdAllocationRequest.waitUntilAcquired(retryTimeoutMillis,TimeUnit.MILLISECONDS)) {
          IdRange idRange=new IdRange(EMPTY_LONG_ARRAY,firstNotAllocated,allocationChunk);
          return new IdAllocation(idRange,-1,0);
        }
      }
 catch (      InterruptedException|TimeoutException e) {
        log.error(format("Failed to acquire id range for idType %s",idType),e);
        throw new IdGenerationException(e);
      }
    }
   }
}
