{
  if (master.other().getMachineId() == machineId) {
    return;
  }
 else   if (master.first() == null) {
    RuntimeException cause=new RuntimeException("Unable to get master from ZK");
    shutdown(cause,false);
    throw cause;
  }
  XaDataSource nioneoDataSource=getConfig().getTxModule().getXaDataSourceManager().getXaDataSource(Config.DEFAULT_DATA_SOURCE_NAME);
  long myLastCommittedTx=nioneoDataSource.getLastCommittedTxId();
  long highestCommonTxId=Math.min(myLastCommittedTx,master.other().getLastCommittedTxId());
  int masterForMyHighestCommonTxId=-1;
  try {
    masterForMyHighestCommonTxId=nioneoDataSource.getMasterForCommittedTx(highestCommonTxId);
  }
 catch (  IOException e) {
    msgLog.logMessage("Couldn't get master ID for txId " + highestCommonTxId + ". It may be that a log file is missing due to the db being copied from master?",e);
    return;
  }
  int masterForMastersHighestCommonTxId=master.first().getMasterIdForCommittedTx(highestCommonTxId).response();
  if (masterForMyHighestCommonTxId == masterForMastersHighestCommonTxId) {
    msgLog.logMessage("Master id for last committed tx ok with highestCommonTxId=" + highestCommonTxId + " with masterId="+ masterForMyHighestCommonTxId,true);
    return;
  }
 else {
    String msg="Broken store, I (machineId:" + machineId + ") think machineId for txId ("+ highestCommonTxId+ ") is "+ masterForMyHighestCommonTxId+ ", but master (machineId:"+ master.other().getMachineId()+ ") says that it's "+ masterForMastersHighestCommonTxId;
    msgLog.logMessage(msg,true);
    RuntimeException exception=new BranchedDataException(msg);
    shutdown(exception,false);
    throw exception;
  }
}
