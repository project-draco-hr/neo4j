{
  if (master.other().getMachineId() == machineId) {
    return;
  }
 else   if (master.first() == null) {
    RuntimeException cause=new RuntimeException("Unable to get master from ZK");
    shutdown(cause,false);
    throw cause;
  }
  XaDataSource nioneoDataSource=getConfig().getTxModule().getXaDataSourceManager().getXaDataSource(Config.DEFAULT_DATA_SOURCE_NAME);
  long myLastCommittedTx=nioneoDataSource.getLastCommittedTxId();
  Pair<Integer,Long> masterForMyHighestCommonTxId;
  try {
    masterForMyHighestCommonTxId=nioneoDataSource.getMasterForCommittedTx(myLastCommittedTx);
  }
 catch (  IOException e) {
    msgLog.logMessage("Couldn't get master ID for txId " + myLastCommittedTx + ". It may be that a log file is missing due to the db being copied from master?",e);
    masterForMyHighestCommonTxId=Pair.of(-1,0L);
    return;
  }
  Pair<Integer,Long> masterForMastersHighestCommonTxId=master.first().getMasterIdForCommittedTx(myLastCommittedTx).response();
  if (masterForMyHighestCommonTxId.first() == XaLogicalLog.MASTER_ID_REPRESENTING_NO_MASTER || masterForMyHighestCommonTxId.equals(masterForMastersHighestCommonTxId)) {
    msgLog.logMessage("Master id for last committed tx ok with highestCommonTxId=" + myLastCommittedTx + " with masterId="+ masterForMyHighestCommonTxId,true);
    return;
  }
 else {
    String msg="Branched data, I (machineId:" + machineId + ") think machineId for txId ("+ myLastCommittedTx+ ") is "+ masterForMyHighestCommonTxId+ ", but master (machineId:"+ master.other().getMachineId()+ ") says that it's "+ masterForMastersHighestCommonTxId;
    msgLog.logMessage(msg,true);
    RuntimeException exception=new BranchedDataException(msg);
    shutdown(exception,false);
    throw exception;
  }
}
