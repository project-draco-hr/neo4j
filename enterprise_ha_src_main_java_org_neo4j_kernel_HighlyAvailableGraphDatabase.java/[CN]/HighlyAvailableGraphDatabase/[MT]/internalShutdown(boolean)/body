{
  msgLog.logMessage("Internal shutdown of HA db[" + machineId + "] reference="+ this+ ", masterServer="+ masterServer,new Exception("Internal shutdown"),true);
  if (this.updatePuller != null) {
    msgLog.logMessage("Internal shutdown updatePuller",true);
    this.updatePuller.shutdown();
    msgLog.logMessage("Internal shutdown updatePuller DONE",true);
    this.updatePuller=null;
  }
  if (this.masterServer != null) {
    msgLog.logMessage("Internal shutdown masterServer",true);
    this.masterServer.shutdown();
    msgLog.logMessage("Internal shutdown masterServer DONE",true);
    this.masterServer=null;
  }
  if (this.localGraph != null) {
    if (rotateLogs) {
      for (      XaDataSource dataSource : getConfig().getTxModule().getXaDataSourceManager().getAllRegisteredDataSources()) {
        try {
          dataSource.rotateLogicalLog();
        }
 catch (        IOException e) {
          msgLog.logMessage("Couldn't rotate logical log for " + dataSource.getName(),e);
        }
      }
    }
    msgLog.logMessage("Internal shutdown localGraph",true);
    this.localGraph.shutdown();
    msgLog.logMessage("Internal shutdown localGraph DONE",true);
    this.localGraph=null;
  }
  msgLog.flush();
  StringLogger.close(storeDir);
}
