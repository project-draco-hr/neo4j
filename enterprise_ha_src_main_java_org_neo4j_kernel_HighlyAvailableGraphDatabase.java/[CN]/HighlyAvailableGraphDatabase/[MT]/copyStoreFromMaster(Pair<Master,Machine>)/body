{
  getMessageLog().logMessage("Copying store from master");
  String temp=getClearedTempDir().getAbsolutePath();
  Response<Void> response=master.first().copyStore(emptyContext(),new ToFileStoreWriter(temp));
  long highestLogVersion=highestLogVersion();
  if (highestLogVersion > -1) {
    NeoStore.setVersion(temp,highestLogVersion + 1);
  }
  GraphDatabaseAPI copiedDb=(GraphDatabaseAPI)new GraphDatabaseFactory().newEmbeddedDatabaseBuilder(temp).setConfig(GraphDatabaseSettings.keep_logical_logs,GraphDatabaseSetting.TRUE).newGraphDatabase();
  try {
    MasterUtil.applyReceivedTransactions(response,copiedDb,MasterUtil.txHandlerForFullCopy());
  }
  finally {
    copiedDb.shutdown();
    response.close();
  }
  getMessageLog().logMessage("Done copying store from master");
}
