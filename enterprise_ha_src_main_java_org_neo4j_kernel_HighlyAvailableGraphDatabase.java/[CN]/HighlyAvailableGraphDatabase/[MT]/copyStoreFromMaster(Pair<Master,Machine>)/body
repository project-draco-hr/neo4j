{
  getMessageLog().logMessage("Copying store from master");
  String temp=getClearedTempDir().getAbsolutePath();
  Response<Void> response=master.first().copyStore(emptyContext(),new ToFileStoreWriter(temp));
  long highestLogVersion=highestLogVersion(temp);
  if (highestLogVersion > -1) {
    NeoStore.setVersion(temp,highestLogVersion + 1);
  }
  GraphDatabaseAPI copiedDb=(GraphDatabaseAPI)new GraphDatabaseFactory().newEmbeddedDatabaseBuilder(temp).setConfig(GraphDatabaseSettings.keep_logical_logs,GraphDatabaseSetting.TRUE).setConfig(GraphDatabaseSettings.allow_store_upgrade,configuration.get(GraphDatabaseSettings.allow_store_upgrade).toString()).newGraphDatabase();
  try {
    ServerUtil.applyReceivedTransactions(response,copiedDb,ServerUtil.txHandlerForFullCopy());
  }
  finally {
    copiedDb.shutdown();
    response.close();
  }
  getMessageLog().logMessage("Done copying store from master");
}
