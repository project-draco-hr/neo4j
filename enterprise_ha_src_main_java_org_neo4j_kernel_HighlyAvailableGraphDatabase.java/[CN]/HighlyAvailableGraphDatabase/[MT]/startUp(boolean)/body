{
  StoreId storeId=null;
  if (!new File(storeDir,"neostore").exists()) {
    long endTime=System.currentTimeMillis() + 10000;
    Exception exception=null;
    while (System.currentTimeMillis() < endTime) {
      Pair<Master,Machine> master=broker.getMasterReally();
      if (master != null && master.first() != null) {
        try {
          copyStoreFromMaster(master);
          msgLog.logMessage("copied store from master");
          exception=null;
          break;
        }
 catch (        Exception e) {
          exception=e;
          broker.getMasterReally();
          msgLog.logMessage("Problems copying store from master",e);
        }
      }
 else       if (allowInit) {
        exception=null;
        StoreId myStoreId=new StoreId();
        storeId=broker.createCluster(myStoreId);
        if (storeId.equals(myStoreId)) {
          break;
        }
      }
      sleepWithoutInterruption(300,"Startup interrupted");
    }
    if (exception != null) {
      throw new RuntimeException("Tried to join the cluster, but was unable to",exception);
    }
  }
  newMaster(null,storeId,new Exception());
  localGraph();
}
