{
  if (config == null) {
    throw new IllegalArgumentException("null config, proper configuration required");
  }
  this.startupTime=System.currentTimeMillis();
  this.storeDir=storeDir;
  this.config=config;
  config.put(Config.KEEP_LOGICAL_LOGS,"true");
  this.brokerFactory=brokerFactory != null ? brokerFactory : defaultBrokerFactory(this,config);
  this.machineId=getMachineIdFromConfig(config);
  this.broker=this.brokerFactory.create(this,config);
  this.msgLog=StringLogger.getLogger(storeDir);
  boolean allowInitFromConfig=getAllowInitFromConfig(config);
  startUp(allowInitFromConfig);
}
