{
  File workingDirectory=new File("target/" + StoreUpgraderTestIT.class.getSimpleName() + "shouldAbortOnCorruptStore");
  prepareSampleLegacyDatabase(fileSystem,workingDirectory);
  assertTrue(allStoreFilesHaveVersion(fileSystem,workingDirectory,"v0.9.9"));
  truncateFile(fileSystem,new File(workingDirectory,"neostore.propertystore.db.index.keys"),"StringPropertyStore v0.9.9");
  Map<String,String> params=new HashMap<String,String>();
  params.put(Config.ALLOW_STORE_UPGRADE,"true");
  try {
    GraphDatabaseService database=new GraphDatabaseFactory().newEmbeddedDatabaseBuilder(workingDirectory.getPath()).setConfig(params).newGraphDatabase();
    fail("Should have been unable to start upgrade on old version");
  }
 catch (  RuntimeException e) {
    assertTrue(UnableToUpgradeException.class.isAssignableFrom(e.getCause().getCause().getCause().getClass()));
  }
}
