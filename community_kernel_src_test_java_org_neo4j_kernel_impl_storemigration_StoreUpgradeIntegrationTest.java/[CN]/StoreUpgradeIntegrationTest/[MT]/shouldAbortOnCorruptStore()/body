{
  prepareSampleLegacyDatabase(fileSystem,workingDirectory);
  assertTrue(allStoreFilesHaveVersion(fileSystem,workingDirectory,LEGACY_VERSION));
  truncateFile(fileSystem,new File(workingDirectory,"neostore.propertystore.db.index.keys"),"StringPropertyStore " + LEGACY_VERSION);
  Map<String,String> params=new HashMap<>();
  params.put(GraphDatabaseSettings.allow_store_upgrade.name(),"true");
  try {
    GraphDatabaseService database=new GraphDatabaseFactory().newEmbeddedDatabaseBuilder(workingDirectory.getPath()).setConfig(params).newGraphDatabase();
    fail("Should have been unable to start upgrade on old version");
  }
 catch (  RuntimeException e) {
    assertThat(Exceptions.rootCause(e),Matchers.instanceOf(UnableToUpgradeException.class));
  }
}
