{
  final TopLevelTransaction tx=mock(TopLevelTransaction.class);
  when(db.beginTx()).thenReturn(tx);
  when(runner.run(any(SessionState.class),anyString(),Matchers.anyMap())).thenThrow(new NoTransactionEffectException());
  machine.init("FunClient/1.2",Collections.<String,Object>emptyMap(),null,Session.Callback.NO_OP);
  machine.run("ROLLBACK",Collections.EMPTY_MAP,null,Session.Callback.NO_OP);
  assertThat(machine.state(),equalTo(SessionStateMachine.State.ERROR));
}
