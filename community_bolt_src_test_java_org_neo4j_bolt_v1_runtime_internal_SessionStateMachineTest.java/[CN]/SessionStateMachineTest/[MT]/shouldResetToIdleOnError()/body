{
  when(spi.run(any(SessionStateMachine.class),anyString(),anyMapOf(String.class,Object.class))).thenThrow(new RollbackInducingKernelException());
  machine.init("FunClient/1.2",emptyMap(),BASE_TX_ID,null,Session.Callback.NO_OP);
  machine.run("RETURN 1",emptyMap(),null,Session.Callback.NO_OP);
  TestCallback<Void> callback=new TestCallback<>();
  machine.reset(null,callback);
  assertThat(machine.state(),equalTo(IDLE));
  assertThat(callback.completedCount,equalTo(1));
}
