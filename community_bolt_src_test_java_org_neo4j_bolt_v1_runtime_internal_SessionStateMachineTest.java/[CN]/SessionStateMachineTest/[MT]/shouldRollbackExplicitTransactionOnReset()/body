{
  when(spi.run(any(SessionStateMachine.class),anyString(),anyMapOf(String.class,Object.class))).thenThrow(new RollbackInducingKernelException());
  machine.init("FunClient/1.2",emptyMap(),-1,null,noOp());
  machine.beginImplicitTransaction();
  machine.run("Hello, world!",emptyMap(),null,noOp());
  assertThat(machine.state(),equalTo(ERROR));
  verify(ktx).failure();
  machine.reset(null,noOp());
  verify(ktx).close();
  assertThat(machine.state(),equalTo(IDLE));
}
