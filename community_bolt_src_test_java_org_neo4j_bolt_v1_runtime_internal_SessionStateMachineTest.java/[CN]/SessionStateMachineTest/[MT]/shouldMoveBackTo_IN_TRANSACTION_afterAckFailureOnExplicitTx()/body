{
  when(spi.run(any(SessionStateMachine.class),anyString(),anyMapOf(String.class,Object.class))).thenThrow(new RollbackInducingKernelException());
  machine.init("FunClient/1.2",emptyMap(),BASE_TX_ID,null,noOp());
  machine.beginTransaction();
  machine.run("statement that fails",emptyMap(),null,noOp());
  machine.ackFailure(null,noOp());
  assertThat(machine.state(),equalTo(SessionStateMachine.State.IN_TRANSACTION));
}
