{
  long transactionId;
  long ticket;
  boolean hasLegacyIndexChanges;
synchronized (logFile) {
    logFile.checkRotation();
    long lastCommittedTxId=transactionIdStore.getLastCommittedTransactionId();
    long candidateTransactionId=transaction.getCommitEntry().getTxId();
    if (lastCommittedTxId + 1 == candidateTransactionId) {
      transactionId=txIdGenerator.generate(transaction.getTransactionRepresentation());
      hasLegacyIndexChanges=append(transaction.getTransactionRepresentation(),transactionId);
      ticket=getCurrentTicket();
    }
 else     if (lastCommittedTxId + 1 < candidateTransactionId) {
      throw new IOException("Tried to apply transaction with txId=" + candidateTransactionId + " but last committed txId="+ lastCommittedTxId);
    }
 else {
      return false;
    }
  }
  force(ticket);
  afterForce(transactionId,hasLegacyIndexChanges);
  return true;
}
