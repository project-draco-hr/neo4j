{
  long transactionId=-1;
  int phase=0;
  logAppendEvent.setLogRotated(logRotation.rotateLogIfNeeded(logAppendEvent));
  try {
    Commitment commit;
synchronized (logFile) {
      try (SerializeTransactionEvent serialiseEvent=logAppendEvent.beginSerializeTransaction()){
        transactionId=transactionIdStore.nextCommittingTransactionId();
        commit=append0(transaction,transactionId);
        phase=1;
      }
     }
    forceAfterAppend(logAppendEvent);
    commit.complete();
    phase=2;
    return transactionId;
  }
  finally {
    if (phase == 1) {
      transactionIdStore.transactionClosed(transactionId);
    }
  }
}
