{
  indexCommandDetector.reset();
  try {
    LogPosition logPosition;
synchronized (channel) {
      logPosition=channel.getCurrentPosition(positionMarker).newPosition();
      transactionLogWriter.append(transaction,transactionId);
    }
    long transactionChecksum=checksum(transaction.additionalHeader(),transaction.getMasterId(),transaction.getAuthorId());
    transactionMetadataCache.cacheTransactionMetadata(transactionId,logPosition,transaction.getMasterId(),transaction.getAuthorId(),transactionChecksum);
    emptyBufferIntoChannel();
    boolean containsLegacyIndexCommands=indexCommandDetector.hasWrittenAnyLegacyIndexCommand();
    if (containsLegacyIndexCommands) {
      legacyIndexTransactionOrdering.offer(transactionId);
    }
    return new TransactionCommitment(containsLegacyIndexCommands,transactionId,transactionChecksum);
  }
 catch (  final Throwable panic) {
    kernelHealth.panic(panic);
    throw panic;
  }
}
