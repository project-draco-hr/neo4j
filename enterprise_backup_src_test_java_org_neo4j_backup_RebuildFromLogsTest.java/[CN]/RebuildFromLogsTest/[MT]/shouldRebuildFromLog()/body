{
  File prototypePath=new File(dir.graphDbDir(),"prototype");
  GraphDatabaseService prototype=db(prototypePath);
  try {
    for (    Transaction transaction : work) {
      transaction.applyTo(prototype);
    }
  }
  finally {
    prototype.shutdown();
  }
  File rebuildPath=new File(dir.graphDbDir(),"rebuild");
  GraphDatabaseAPI rebuilt=db(rebuildPath);
  try {
    new RebuildFromLogs(rebuilt).applyTransactionsFrom(prototypePath,BASE_TX_ID);
  }
  finally {
    rebuilt.shutdown();
  }
  assertEquals(DbRepresentation.of(prototypePath),DbRepresentation.of(rebuildPath));
}
