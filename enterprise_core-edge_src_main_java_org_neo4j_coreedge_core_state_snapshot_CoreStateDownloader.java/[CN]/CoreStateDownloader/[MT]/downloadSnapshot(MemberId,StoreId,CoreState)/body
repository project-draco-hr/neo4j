{
  try {
    localDatabase.stop();
    log.info("Downloading snapshot from core server at %s",source);
    CompletableFuture<CoreSnapshot> snapshotFuture=coreClient.requestCoreSnapshot(source);
    CoreSnapshot coreSnapshot;
    try {
      coreSnapshot=snapshotFuture.get(1,MINUTES);
    }
 catch (    TimeoutException e) {
      throw new StoreCopyFailedException(e);
    }
    localDatabase.bringUpToDateOrReplaceStoreFrom(source,storeId,storeFetcher);
    log.info("Replaced store with one downloaded from %s",source);
    coreState.installSnapshot(coreSnapshot);
    log.info("Core snapshot installed: " + coreSnapshot);
    log.info("Restarting local database",source);
    localDatabase.start();
    log.info("Restarted local database",source);
  }
 catch (  Throwable e) {
    localDatabase.panic(e);
    throw new StoreCopyFailedException(e);
  }
}
