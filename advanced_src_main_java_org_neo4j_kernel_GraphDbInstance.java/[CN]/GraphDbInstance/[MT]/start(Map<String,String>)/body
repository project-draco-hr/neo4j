{
  if (started) {
    throw new IllegalStateException("Neo4j instance already started");
  }
  Map<Object,Object> params=getDefaultParams();
  for (  Map.Entry<String,String> entry : stringParams.entrySet()) {
    params.put(entry.getKey(),entry.getValue());
  }
  config=new Config(storeDir,params);
  storeDir=FileUtils.fixSeparatorsInPath(storeDir);
  String separator=System.getProperty("file.separator");
  String store=storeDir + separator + "neostore";
  params.put("store_dir",storeDir);
  params.put("neo_store",store);
  params.put("create",String.valueOf(create));
  String logicalLog=storeDir + separator + "nioneo_logical.log";
  params.put("logical_log",logicalLog);
  byte resourceId[]="414141".getBytes();
  params.put(LockManager.class,config.getLockManager());
  params.put(LockReleaser.class,config.getLockReleaser());
  config.getTxModule().registerDataSource(DEFAULT_DATA_SOURCE_NAME,NIO_NEO_DB_CLASS,resourceId,params);
  XaDataSource lucene=null;
  if (!config.isReadOnly()) {
    try {
      Class clazz=Class.forName(LUCENE_DS_CLASS);
      cleanWriteLocksInLuceneDirectory(storeDir + "/lucene");
      lucene=registerLuceneDataSource(clazz.getName(),config.getTxModule(),storeDir + "/lucene",config.getLockManager());
    }
 catch (    ClassNotFoundException e) {
    }
  }
  persistenceSource=new NioNeoDbPersistenceSource();
  config.setNeoPersistenceSource(DEFAULT_DATA_SOURCE_NAME,create);
  config.getIdGeneratorModule().setPersistenceSourceInstance(persistenceSource);
  config.getEventModule().init();
  config.getTxModule().init();
  config.getPersistenceModule().init();
  persistenceSource.init();
  config.getIdGeneratorModule().init();
  config.getNeoModule().init();
  config.getEventModule().start();
  config.getTxModule().start();
  config.getPersistenceModule().start(config.getTxModule().getTxManager(),persistenceSource);
  persistenceSource.start(config.getTxModule().getXaDataSourceManager());
  config.getIdGeneratorModule().start();
  config.getNeoModule().start(config.getLockReleaser(),config.getPersistenceModule().getPersistenceManager(),params);
  if (lucene != null) {
    config.getTxModule().getXaDataSourceManager().unregisterDataSource("lucene");
    lucene=null;
  }
  started=true;
}
