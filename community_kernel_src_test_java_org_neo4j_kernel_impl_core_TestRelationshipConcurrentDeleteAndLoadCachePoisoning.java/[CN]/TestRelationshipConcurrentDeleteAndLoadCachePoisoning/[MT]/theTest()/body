{
  final GraphDatabaseAPI db=database.getGraphDatabaseAPI();
  Transaction tx=db.beginTx();
  final Node first=db.createNode();
  final Relationship theOneAfterTheGap=first.createRelationshipTo(db.createNode(),DynamicRelationshipType.withName("AC"));
  for (int i=0; i < RelationshipGrabSize; i++) {
    first.createRelationshipTo(db.createNode(),DynamicRelationshipType.withName("AC"));
  }
  tx.success();
  tx.finish();
  db.getDependencyResolver().resolveDependency(Caches.class).clear();
  Runnable writer=new Runnable(){
    @Override public void run(){
      Transaction tx=db.beginTx();
      theOneAfterTheGap.delete();
      tx.success();
      tx.finish();
    }
  }
;
  Runnable reader=new Runnable(){
    @Override public void run(){
      waitForPrepare();
      Transaction transaction=db.beginTx();
      first.getRelationships().iterator().next();
      transaction.finish();
      readDone();
    }
  }
;
  Thread writerThread=new Thread(writer);
  Thread readerThread=new Thread(reader);
  readerThread.start();
  writerThread.start();
  dumpAndFailIfNotDeadWithin(readerThread,1,MINUTES);
  dumpAndFailIfNotDeadWithin(writerThread,1,MINUTES);
  Transaction transaction=db.beginTx();
  int count=count(first.getRelationships());
  assertEquals("Should have read relationships created minus one",RelationshipGrabSize,count);
  transaction.finish();
}
