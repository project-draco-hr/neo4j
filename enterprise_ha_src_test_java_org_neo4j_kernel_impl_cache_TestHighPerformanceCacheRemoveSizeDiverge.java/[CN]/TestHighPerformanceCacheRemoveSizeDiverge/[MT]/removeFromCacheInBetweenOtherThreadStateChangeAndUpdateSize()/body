{
  final Node node=createNodeWithSomeRelationships();
  graphdb.getDependencyResolver().resolveDependency(Caches.class).clear();
  enableBreakpoints();
  Transaction transaction=graphdb.beginTx();
  try {
    graphdb.getNodeById(node.getId());
  }
  finally {
    transaction.finish();
  }
  final Cache<?> nodeCache=graphdb.getDependencyResolver().resolveDependency(Caches.class).node();
  assertTrue("We didn't get a hold of the right cache object",nodeCache.getName().toLowerCase().contains("node"));
  Thread t1=new Thread("T1: Relationship loader"){
    @Override public void run(){
      Transaction transaction=graphdb.beginTx();
      try {
        count(node.getRelationships());
      }
  finally {
        transaction.finish();
      }
    }
  }
;
  t1.start();
  Thread.sleep(2000);
  Thread t2=new Thread("T2: Cache remover"){
    @Override public void run(){
      nodeCache.remove(node.getId());
    }
  }
;
  t2.start();
  t2.join();
  resumeUpdateSize();
  t1.join();
  assertEquals("Invalid cache size for " + nodeCache,0,nodeCache.size());
}
