{
  try (SchemaIndex uniqueIndex=LuceneSchemaIndexBuilder.create().uniqueIndex().withIndexRootFolder(testDir.directory("partitionIndex" + affectedNodes)).withIndexIdentifier("uniqueIndex" + affectedNodes).build()){
    uniqueIndex.open();
    assertEquals(0,uniqueIndex.allDocumentsReader().maxCount());
    assertFalse(uniqueIndex.exists());
    try (LuceneIndexAccessor indexAccessor=new LuceneIndexAccessor(uniqueIndex)){
      generateUpdates(indexAccessor,affectedNodes);
      indexAccessor.force();
      assertTrue(uniqueIndex.isOnline());
      try (IndexReader indexReader=indexAccessor.newReader()){
        long[] nodes=PrimitiveLongCollections.asArray(indexReader.scan());
        assertEquals(affectedNodes,nodes.length);
        IndexSampler indexSampler=indexReader.createSampler();
        IndexSample sample=indexSampler.sampleIndex();
        assertEquals(affectedNodes,sample.indexSize());
        assertEquals(affectedNodes,sample.uniqueValues());
        assertEquals(affectedNodes,sample.sampleSize());
      }
     }
   }
 }
