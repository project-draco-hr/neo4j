{
  if (meta == null || meta.getEntity() == null) {
    throw new IllegalArgumentException("meta =" + meta + ", "+ "meta.getEntity = "+ meta.getEntity());
  }
  ResourceConnection con=null;
  ConnectionBundle bundle=null;
  PersistenceSource source=null;
  source=PersistenceSourceDispatcher.getDispatcher().getPersistenceSource(meta.getEntity());
  Transaction tx=this.getCurrentTransaction();
  if (txConnectionMap.containsKey(tx)) {
    bundle=txConnectionMap.get(tx);
  }
 else {
    try {
      bundle=new ConnectionBundle();
      tx.registerSynchronization(txCommitHook);
      txConnectionMap.put(tx,bundle);
    }
 catch (    Exception e) {
      throw new ResourceAcquisitionFailedException("Unable to register commit hook with current tx",e);
    }
  }
  if (bundle.hasConnectionForPersistenceSource(source)) {
    con=bundle.getConnectionForPersistenceSource(source);
  }
 else {
    try {
      con=source.createResourceConnection();
      if (!tx.enlistResource(con.getXAResource())) {
        throw new ResourceAcquisitionFailedException("Unable to enlist '" + con.getXAResource() + "' in "+ "transaction");
      }
      bundle.setConnectionForPersistenceSource(source,con);
    }
 catch (    ConnectionCreationFailedException ccfe) {
      String msg="Failed to create connection using " + source;
      throw new ResourceAcquisitionFailedException(msg,ccfe);
    }
catch (    javax.transaction.RollbackException re) {
      String msg="The transaction is marked for rollback only.";
      throw new ResourceAcquisitionFailedException(msg,re);
    }
catch (    javax.transaction.SystemException se) {
      String msg="TM encountered an unexpected error condition.";
      throw new ResourceAcquisitionFailedException(msg,se);
    }
  }
  return con;
}
