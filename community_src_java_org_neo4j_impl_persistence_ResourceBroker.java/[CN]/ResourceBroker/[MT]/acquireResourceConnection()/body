{
  ResourceConnection con=null;
  PersistenceSource source=null;
  source=dispatcher.getPersistenceSource();
  Thread currentThread=Thread.currentThread();
  con=txConnectionMap.get(currentThread);
  if (con == null) {
    try {
      Transaction tx=this.getCurrentTransaction();
      con=source.createResourceConnection();
      if (!tx.enlistResource(con.getXAResource())) {
        throw new ResourceAcquisitionFailedException("Unable to enlist '" + con.getXAResource() + "' in "+ "transaction");
      }
      tx.registerSynchronization(txCommitHook);
      txConnectionMap.put(currentThread,con);
    }
 catch (    ConnectionCreationFailedException ccfe) {
      String msg="Failed to create connection using " + source;
      throw new ResourceAcquisitionFailedException(msg,ccfe);
    }
catch (    javax.transaction.RollbackException re) {
      String msg="The transaction is marked for rollback only.";
      throw new ResourceAcquisitionFailedException(msg,re);
    }
catch (    javax.transaction.SystemException se) {
      String msg="TM encountered an unexpected error condition.";
      throw new ResourceAcquisitionFailedException(msg,se);
    }
  }
  return con;
}
