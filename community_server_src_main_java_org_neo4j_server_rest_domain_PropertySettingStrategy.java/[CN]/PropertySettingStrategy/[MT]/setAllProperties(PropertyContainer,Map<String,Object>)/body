{
  Map<String,Object> propsToSet=properties == null ? new HashMap<String,Object>() : properties;
  try (Transaction tx=db.beginTx()){
    setProperties(entity,properties);
    ensureHasOnlyTheseProperties(entity,propsToSet.keySet());
    tx.success();
  }
 }
