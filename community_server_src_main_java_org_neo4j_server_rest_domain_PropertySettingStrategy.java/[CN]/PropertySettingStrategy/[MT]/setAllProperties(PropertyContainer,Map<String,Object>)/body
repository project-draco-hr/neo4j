{
  Map<String,Object> propsToSet=properties == null ? new HashMap<String,Object>() : properties;
  Transaction tx=db.beginTx();
  try {
    setProperties(entity,properties);
    ensureHasOnlyTheseProperties(entity,propsToSet.keySet());
    tx.success();
  }
  finally {
    tx.finish();
  }
}
