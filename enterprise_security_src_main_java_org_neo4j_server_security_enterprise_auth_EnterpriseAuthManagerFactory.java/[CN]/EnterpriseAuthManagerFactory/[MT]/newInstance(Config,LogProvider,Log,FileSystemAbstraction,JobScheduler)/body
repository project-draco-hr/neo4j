{
  List<String> configuredRealms=config.get(SecuritySettings.active_realms);
  List<Realm> realms=new ArrayList<>(configuredRealms.size() + 1);
  SecurityLog securityLog=getSecurityLog(allegedSecurityLog);
  SecureHasher secureHasher=new SecureHasher();
  InternalFlatFileRealm internalRealm=createInternalRealm(config,logProvider,fileSystem,jobScheduler);
  if (config.get(SecuritySettings.native_authentication_enabled) || config.get(SecuritySettings.native_authorization_enabled)) {
    realms.add(internalRealm);
  }
  if ((config.get(SecuritySettings.ldap_authentication_enabled) || config.get(SecuritySettings.ldap_authorization_enabled)) && configuredRealms.contains(SecuritySettings.LDAP_REALM_NAME)) {
    realms.add(new LdapRealm(config,securityLog));
  }
  realms.addAll(createPluginRealms(config,logProvider,secureHasher));
  List<Realm> orderedActiveRealms=selectOrderedActiveRealms(configuredRealms,realms);
  if (orderedActiveRealms.isEmpty()) {
    String message="Illegal configuration: No valid security realm is active.";
    securityLog.error(message);
    throw new IllegalArgumentException(message);
  }
  return new MultiRealmAuthManager(internalRealm,orderedActiveRealms,createCacheManager(config),securityLog,config.get(EnterpriseEditionSettings.security_log_successful_authentication));
}
