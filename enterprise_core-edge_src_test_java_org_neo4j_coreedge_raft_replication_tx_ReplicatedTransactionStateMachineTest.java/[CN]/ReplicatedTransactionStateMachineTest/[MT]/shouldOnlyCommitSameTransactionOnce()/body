{
  LocalOperationId localOperationId=new LocalOperationId(0,0);
  int lockSessionId=23;
  ReplicatedTransaction tx=ReplicatedTransactionFactory.createImmutableReplicatedTransaction(physicalTx(lockSessionId),globalSession,localOperationId);
  RecoverTransactionLogState recoverTransactionLogState=mock(RecoverTransactionLogState.class);
  when(recoverTransactionLogState.findLastAppliedIndex()).thenReturn(-1L);
  TransactionCommitProcess localCommitProcess=mock(TransactionCommitProcess.class);
  ReplicatedTransactionStateMachine<CoreMember> listener=new ReplicatedTransactionStateMachine<>(localCommitProcess,globalSession,lockState(lockSessionId),new CommittingTransactionsRegistry(),new InMemoryStateStorage<>(new GlobalSessionTrackerState<>()),NullLogProvider.getInstance(),recoverTransactionLogState);
  listener.applyCommand(tx,0);
  listener.applyCommand(tx,0);
  verify(localCommitProcess).commit(any(TransactionToApply.class),any(CommitEvent.class),eq(TransactionApplicationMode.EXTERNAL));
}
