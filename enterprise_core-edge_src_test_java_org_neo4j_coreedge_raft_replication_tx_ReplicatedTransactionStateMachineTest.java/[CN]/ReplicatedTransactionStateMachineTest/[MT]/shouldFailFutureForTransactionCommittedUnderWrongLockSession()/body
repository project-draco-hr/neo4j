{
  LocalOperationId localOperationId=new LocalOperationId(0,0);
  int txLockSessionId=23;
  int currentLockSessionId=24;
  ReplicatedTransaction tx=ReplicatedTransactionFactory.createImmutableReplicatedTransaction(physicalTx(txLockSessionId),globalSession,localOperationId);
  TransactionCommitProcess localCommitProcess=mock(TransactionCommitProcess.class);
  RecoverTransactionLogState recoverTransactionLogState=mock(RecoverTransactionLogState.class);
  when(recoverTransactionLogState.findLastCommittedIndex()).thenReturn(-1L);
  CommittingTransactions committingTransactions=new CommittingTransactionsRegistry();
  final ReplicatedTransactionStateMachine listener=new ReplicatedTransactionStateMachine<>(localCommitProcess,globalSession,lockState(currentLockSessionId),committingTransactions,new InMemoryStateStorage<>(new GlobalSessionTrackerState<>()),NullLogProvider.getInstance(),recoverTransactionLogState);
  CommittingTransaction future=committingTransactions.register(localOperationId);
  listener.applyCommand(tx,0);
  try {
    future.waitUntilCommitted(1,TimeUnit.SECONDS);
    fail("Should have thrown exception");
  }
 catch (  TransactionFailureException e) {
    assertEquals(Status.Transaction.LockSessionInvalid,e.status());
  }
}
