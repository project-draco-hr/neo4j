{
  if (nextTxId != (xaTf.getLastCommittedTx() + 1)) {
    throw new IllegalStateException("Tried to apply tx " + nextTxId + " but expected transaction "+ (xaTf.getCurrentVersion() + 1));
  }
  log.fine("Logical log version: " + logVersion + ", committing tx="+ nextTxId+ ")");
  long logEntriesFound=0;
  scanIsComplete=false;
  LogApplier logApplier=new LogApplier(byteChannel);
  int xidIdent=getNextIdentifier();
  while (logApplier.readAndApplyAndWriteEntry(xidIdent)) {
    logEntriesFound++;
  }
  byteChannel.close();
  LogEntry.Start entry=logApplier.startEntry;
  if (entry == null) {
    throw new IOException("Unable to find start entry");
  }
  LogEntry.OnePhaseCommit commit=new LogEntry.OnePhaseCommit(xidIdent,nextTxId);
  LogIoUtils.writeLogEntry(commit,writeBuffer);
  Xid xid=entry.getXid();
  try {
    XaTransaction xaTx=xaRm.getXaTransaction(xid);
    xaTx.setCommitTxId(nextTxId);
    xaRm.commit(xid,true);
    LogEntry doneEntry=new LogEntry.Done(entry.getIdentifier());
    LogIoUtils.writeLogEntry(doneEntry,writeBuffer);
  }
 catch (  XAException e) {
    e.printStackTrace();
    throw new IOException(e.getMessage());
  }
  scanIsComplete=true;
  log.info("Tx[" + nextTxId + "] "+ " applied successfully.");
  msgLog.logMessage("Applied external tx and generated tx id=" + nextTxId);
}
