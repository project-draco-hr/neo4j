{
  GraphDatabaseService graphdb=database.getGraphDatabaseService();
  Transaction tx=graphdb.beginTx();
  final Node root=graphdb.getReferenceNode();
  try {
    root.setProperty("counter",Long.valueOf(0L));
    tx.success();
  }
  finally {
    tx.finish();
  }
  graphdb.registerTransactionEventHandler(new TransactionEventHandler<Void>(){
    @SuppressWarnings("boxing") @Override public Void beforeCommit(    TransactionData data) throws Exception {
      if (count(data.createdRelationships()) == 0)       return null;
      root.setProperty("counter",((Long)root.removeProperty("counter")) + 1);
      return null;
    }
    @Override public void afterCommit(    TransactionData data,    Void state){
    }
    @Override public void afterRollback(    TransactionData data,    Void state){
    }
  }
);
  tx=graphdb.beginTx();
  try {
    root.setProperty("state","not broken yet");
    root.createRelationshipTo(graphdb.createNode(),DynamicRelationshipType.withName("TEST"));
    root.removeProperty("state");
    tx.success();
  }
  finally {
    tx.finish();
  }
  assertThat(root,inTx(graphdb,hasProperty("counter").withValue(1L)));
}
