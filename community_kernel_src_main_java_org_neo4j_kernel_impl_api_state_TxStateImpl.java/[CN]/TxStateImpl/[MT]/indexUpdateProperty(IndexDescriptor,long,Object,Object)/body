{
{
    DiffSets<Long> before=getIndexUpdates(descriptor,true,valueBefore);
    if (before != null) {
      before.remove(nodeId);
{
        if (before.getRemoved().contains(nodeId)) {
          getOrCreateNodeState(nodeId).addIndexDiff(before);
        }
 else {
          getOrCreateNodeState(nodeId).removeIndexDiff(before);
        }
      }
    }
  }
{
    DiffSets<Long> after=getIndexUpdates(descriptor,true,valueAfter);
    if (after != null) {
      after.add(nodeId);
{
        if (after.getAdded().contains(nodeId)) {
          getOrCreateNodeState(nodeId).addIndexDiff(after);
        }
 else {
          getOrCreateNodeState(nodeId).removeIndexDiff(after);
        }
      }
    }
  }
}
