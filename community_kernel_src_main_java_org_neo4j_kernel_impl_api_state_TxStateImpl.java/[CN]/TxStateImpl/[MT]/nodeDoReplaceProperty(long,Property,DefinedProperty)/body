{
  if (replacedProperty.isDefined()) {
    getOrCreateNodeState(nodeId).changeProperty(newProperty);
    nodePropertyChanges().changeProperty(nodeId,replacedProperty.propertyKeyId(),((DefinedProperty)replacedProperty).value(),newProperty.value());
  }
 else {
    getOrCreateNodeState(nodeId).addProperty(newProperty);
    nodePropertyChanges().addProperty(nodeId,newProperty.propertyKeyId(),newProperty.value());
  }
  hasChanges=true;
}
