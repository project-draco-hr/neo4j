{
  long id=legacyState.relationshipCreate(relationshipTypeId,startNodeId,endNodeId);
  if (startNodeId == endNodeId) {
    getOrCreateNodeState(startNodeId).addRelationship(id,relationshipTypeId,Direction.BOTH);
  }
 else {
    getOrCreateNodeState(startNodeId).addRelationship(id,relationshipTypeId,Direction.OUTGOING);
    getOrCreateNodeState(endNodeId).addRelationship(id,relationshipTypeId,Direction.INCOMING);
  }
  getOrCreateRelationshipState(id).setMetaData(startNodeId,endNodeId,relationshipTypeId);
  hasChanges=true;
  return id;
}
