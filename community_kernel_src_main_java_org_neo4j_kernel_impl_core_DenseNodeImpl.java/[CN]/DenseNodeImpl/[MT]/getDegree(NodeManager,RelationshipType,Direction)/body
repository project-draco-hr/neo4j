{
  int count=0;
  TransactionState state=nm.getTransactionState();
  DirectionWrapper dir=RelIdArray.wrap(direction);
  boolean hasStateChanges=state.hasChanges();
  if (!hasStateChanges || !state.getCreatedNodes().contains(getId())) {
    count=nm.getRelationshipCount(this,type,dir);
  }
  if (hasStateChanges) {
    count+=degreeFromTxState(nm,dir,nm.getRelationshipTypeIdFor(type));
  }
  return count;
}
