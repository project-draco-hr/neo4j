{
  MigrationTestUtils.prepareSampleLegacyDatabase(fs,directory.directory());
  LegacyStore legacyStore=new LegacyStore(fs,new File(directory.directory(),NeoStore.DEFAULT_NAME),StringLogger.DEV_NULL);
  Config config=MigrationTestUtils.defaultConfig();
  File outputDir=new File("target/outputDatabase");
  FileUtils.deleteRecursively(outputDir);
  assertTrue(outputDir.mkdirs());
  String storeFileName="target/outputDatabase/neostore";
  StoreFactory factory=new StoreFactory(config,new DefaultIdGeneratorFactory(),new DefaultWindowPoolFactory(),fs,StringLogger.DEV_NULL,new DefaultTxHook());
  NeoStore neoStore=factory.createNeoStore(new File(storeFileName));
  ListAccumulatorMigrationProgressMonitor monitor=new ListAccumulatorMigrationProgressMonitor();
  new StoreMigrator(monitor).migrate(legacyStore,neoStore);
  verifyNeoStore(neoStore);
  neoStore.close();
  assertEquals(100,monitor.events.size());
  assertTrue(monitor.started);
  assertTrue(monitor.finished);
  GraphDatabaseService database=new GraphDatabaseFactory().newEmbeddedDatabase(outputDir.getPath());
  DatabaseContentVerifier verifier=new DatabaseContentVerifier(database);
  verifier.verifyNodes();
  verifier.verifyRelationships();
  verifier.verifyNodeIdsReused();
  verifier.verifyRelationshipIdsReused();
  verifier.verifyLegacyIndex();
  database.shutdown();
}
