{
  if (startNode == null || endNode == null || type == null) {
    throw new IllegalArgumentException("Null parameter, startNode=" + startNode + ", endNode="+ endNode+ ", type="+ type);
  }
  if (!RelationshipTypeHolder.getHolder().isValidRelationshipType(type)) {
    setRollbackOnly();
    throw new IllegalArgumentException("Relationship type: " + type + " not valid");
  }
  NodeImpl firstNode=(NodeImpl)getNodeForProxy((int)startNode.getId());
  NodeImpl secondNode=(NodeImpl)getNodeForProxy((int)endNode.getId());
  int id=IdGenerator.getGenerator().nextId(Relationship.class);
  RelationshipImpl rel=new RelationshipImpl(id,(int)startNode.getId(),(int)endNode.getId(),type,true);
  RelationshipCommands relationshipCommand=null;
  boolean firstNodeTaken=false;
  boolean secondNodeTaken=false;
  acquireLock(rel,LockType.WRITE);
  try {
    acquireLock(firstNode,LockType.WRITE);
    firstNodeTaken=true;
    if (firstNode.isDeleted()) {
      setRollbackOnly();
      throw new CreateException("" + startNode + " has been deleted in other transaction");
    }
    acquireLock(secondNode,LockType.WRITE);
    secondNodeTaken=true;
    if (secondNode.isDeleted()) {
      setRollbackOnly();
      throw new CreateException("" + endNode + " has been deleted in other transaction");
    }
    relationshipCommand=new RelationshipCommands();
    relationshipCommand.setRelationship(rel);
    relationshipCommand.initCreate();
    EventManager em=EventManager.getManager();
    EventData eventData=new EventData(relationshipCommand);
    if (!em.generateProActiveEvent(Event.RELATIONSHIP_CREATE,eventData)) {
      setRollbackOnly();
      throw new CreateException("Unable to create relationship, " + "pro-active event failed.");
    }
    relationshipCommand.execute();
    em.generateReActiveEvent(Event.RELATIONSHIP_CREATE,eventData);
    return new RelationshipProxy(id);
  }
 catch (  ExecuteFailedException e) {
    setRollbackOnly();
    if (relationshipCommand != null) {
      relationshipCommand.undo();
    }
    throw new CreateException("Failed executing command",e);
  }
 finally {
    boolean releaseFailed=false;
    if (firstNodeTaken) {
      try {
        releaseLock(firstNode,LockType.WRITE);
      }
 catch (      Exception e) {
        releaseFailed=true;
        e.printStackTrace();
        log.severe("Failed to release lock");
      }
    }
    if (secondNodeTaken) {
      try {
        releaseLock(secondNode,LockType.WRITE);
      }
 catch (      Exception e) {
        releaseFailed=true;
        e.printStackTrace();
        log.severe("Failed to release lock");
      }
    }
    releaseLock(rel,LockType.WRITE);
    if (releaseFailed) {
      throw new RuntimeException("Unable to release locks [" + startNode + ","+ endNode+ "] in relationship create->"+ rel);
    }
  }
}
