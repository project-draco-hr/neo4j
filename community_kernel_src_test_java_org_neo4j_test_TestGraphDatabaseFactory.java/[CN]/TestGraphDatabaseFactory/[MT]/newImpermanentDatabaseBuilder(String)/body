{
  final TestGraphDatabaseFactoryState state=getStateCopy();
  return new TestGraphDatabaseBuilder(new GraphDatabaseBuilder.DatabaseCreator(){
    @Override @SuppressWarnings("deprecation") public GraphDatabaseService newDatabase(    Map<String,String> config){
      return new ImpermanentGraphDatabase(storeDir,config,state.getKernelExtension(),state.getCacheProviders(),state.getTransactionInterceptorProviders()){
        @Override protected FileSystemAbstraction createFileSystemAbstraction(){
          FileSystemAbstraction fs=state.getFileSystem();
          if (fs != null) {
            return fs;
          }
 else {
            return super.createFileSystemAbstraction();
          }
        }
        @Override protected Logging createLogging(){
          if (overrideLoggingAndUseThis != null) {
            return overrideLoggingAndUseThis;
          }
          if (state.isSystemOutLogging()) {
            return new SingleLoggingService(StringLogger.SYSTEM);
          }
 else {
            return super.createLogging();
          }
        }
      }
;
    }
  }
);
}
