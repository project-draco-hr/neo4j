{
  User existingUser=getUser(username);
  passwordPolicy.validatePassword(password);
  if (existingUser.credentials().matchesPassword(password)) {
    throw new InvalidArgumentsException("Old password and new password cannot be the same.");
  }
  try {
    User updatedUser=existingUser.augment().withCredentials(Credential.forPassword(password)).withRequiredPasswordChange(requirePasswordChange).build();
synchronized (this) {
      userRepository.update(existingUser,updatedUser);
    }
  }
 catch (  ConcurrentModificationException e) {
    setUserPassword(username,password,requirePasswordChange);
  }
  clearCacheForUser(username);
}
