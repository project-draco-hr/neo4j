{
  checkValidityOfUsernameAndRoleName(username,roleName);
synchronized (this) {
    assertAndGetUser(username);
    RoleRecord role=assertAndGetRole(roleName);
    RoleRecord newRole=role.augment().withUser(username).build();
    try {
      roleRepository.update(role,newRole);
    }
 catch (    ConcurrentModificationException e) {
      addUserToRole(username,roleName);
    }
  }
  clearCachedAuthorizationInfoForUser(username);
}
