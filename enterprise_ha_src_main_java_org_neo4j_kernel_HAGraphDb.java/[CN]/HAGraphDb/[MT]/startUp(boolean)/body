{
  StoreId storeId=null;
  if (!new File(getStoreDir(),NeoStore.DEFAULT_NAME).exists()) {
    long endTime=System.currentTimeMillis() + 60000;
    Exception exception=null;
    while (System.currentTimeMillis() < endTime) {
      Pair<Master,Machine> master=broker.getMasterReally(true);
      if (master != null && master.first() != null) {
        try {
          copyStoreFromMaster(master);
          getMessageLog().logMessage("copied store from master");
          exception=null;
          break;
        }
 catch (        Exception e) {
          exception=e;
          master=broker.getMasterReally(true);
          getMessageLog().logMessage("Problems copying store from master",e);
        }
      }
 else       if (allowInit) {
        exception=null;
        StoreId myStoreId=new StoreId();
        storeId=broker.createCluster(myStoreId);
        if (storeId.equals(myStoreId)) {
          break;
        }
      }
      sleepWithoutInterruption(300,"Startup interrupted");
    }
    if (exception != null) {
      throw new RuntimeException("Tried to join the cluster, but was unable to",exception);
    }
  }
  newMaster(storeId,new Exception("Starting up for the first time"));
  localGraph();
}
