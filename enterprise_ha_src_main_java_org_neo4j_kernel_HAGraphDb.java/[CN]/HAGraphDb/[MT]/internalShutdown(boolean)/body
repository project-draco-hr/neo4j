{
  getMessageLog().logMessage("Internal shutdown of HA db[" + machineId + "] reference="+ this+ ", masterServer="+ masterServer,new Exception("Internal shutdown"),true);
  if (this.updatePuller != null) {
    getMessageLog().logMessage("Internal shutdown updatePuller",true);
    this.updatePuller.shutdown();
    getMessageLog().logMessage("Internal shutdown updatePuller DONE",true);
    this.updatePuller=null;
  }
  if (this.masterServer != null) {
    getMessageLog().logMessage("Internal shutdown masterServer",true);
    this.masterServer.shutdown();
    getMessageLog().logMessage("Internal shutdown masterServer DONE",true);
    this.masterServer=null;
  }
  if (this.localGraph != null) {
    if (rotateLogs) {
      for (      XaDataSource dataSource : getConfig().getTxModule().getXaDataSourceManager().getAllRegisteredDataSources()) {
        try {
          dataSource.rotateLogicalLog();
        }
 catch (        IOException e) {
          getMessageLog().logMessage("Couldn't rotate logical log for " + dataSource.getName(),e);
        }
      }
    }
    getMessageLog().logMessage("Internal shutdown localGraph",true);
    this.localGraph.shutdown();
    getMessageLog().logMessage("Internal shutdown localGraph DONE",true);
    this.localGraph=null;
  }
  getMessageLog().flush();
}
