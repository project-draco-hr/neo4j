{
  if (master.other().getMachineId() == machineId) {
    getMessageLog().logMessage("I am master so cannot consistency check data with master");
    return;
  }
 else   if (master.first() == null) {
    RuntimeException cause=new RuntimeException("Unable to get master from ZK");
    shutdown(cause,false);
    throw cause;
  }
  XaDataSource nioneoDataSource=newDb.getConfig().getTxModule().getXaDataSourceManager().getXaDataSource(Config.DEFAULT_DATA_SOURCE_NAME);
  long myLastCommittedTx=nioneoDataSource.getLastCommittedTxId();
  Pair<Integer,Long> myMaster;
  try {
    myMaster=nioneoDataSource.getMasterForCommittedTx(myLastCommittedTx);
  }
 catch (  NoSuchLogVersionException e) {
    getMessageLog().logMessage("Logical log file for txId " + myLastCommittedTx + " not found, perhaps due to the db being copied from master. Ignoring.");
    return;
  }
catch (  IOException e) {
    getMessageLog().logMessage("Failed to get master ID for txId " + myLastCommittedTx + ".",e);
    return;
  }
catch (  Exception e) {
    getMessageLog().logMessage("Exception while getting master ID for txId " + myLastCommittedTx + ".",e);
    throw new BranchedDataException("Maybe not branched data, but it could solve it",e);
  }
  long endTime=System.currentTimeMillis() + readTimeout * 1000;
  Pair<Integer,Long> mastersMaster=null;
  RuntimeException failure=null;
  while (mastersMaster == null && System.currentTimeMillis() < endTime) {
    try {
      mastersMaster=master.first().getMasterIdForCommittedTx(myLastCommittedTx,getStoreId(newDb)).response();
    }
 catch (    ComException e) {
      failure=e;
      sleepWithoutInterruption(500,"Failed waiting for next attempt to contact master");
    }
  }
  if (mastersMaster == null)   throw failure;
  if (myMaster.first() != XaLogicalLog.MASTER_ID_REPRESENTING_NO_MASTER && !myMaster.equals(mastersMaster)) {
    String msg="Branched data, I (machineId:" + machineId + ") think machineId for txId ("+ myLastCommittedTx+ ") is "+ myMaster+ ", but master (machineId:"+ master.other().getMachineId()+ ") says that it's "+ mastersMaster;
    getMessageLog().logMessage(msg,true);
    RuntimeException exception=new BranchedDataException(msg);
    safelyShutdownDb(newDb);
    shutdown(exception,false);
    throw exception;
  }
  getMessageLog().logMessage("Master id for last committed tx ok with highestTxId=" + myLastCommittedTx + " with masterId="+ myMaster,true);
}
