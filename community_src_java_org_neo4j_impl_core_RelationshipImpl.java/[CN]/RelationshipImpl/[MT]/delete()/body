{
  NodeImpl startNode=null;
  NodeImpl endNode=null;
  boolean startNodeLocked=false;
  boolean endNodeLocked=false;
  nodeManager.acquireLock(this,LockType.WRITE);
  try {
    startNode=nodeManager.getLightNode(startNodeId);
    if (startNode != null) {
      nodeManager.acquireLock(startNode,LockType.WRITE);
      startNodeLocked=true;
    }
    endNode=nodeManager.getLightNode(endNodeId);
    if (endNode != null) {
      nodeManager.acquireLock(endNode,LockType.WRITE);
      endNodeLocked=true;
    }
    int typeId=nodeManager.getRelationshipTypeIdFor(type);
    EventData eventData=new EventData(new RelationshipOpData(this,id,typeId,startNodeId,endNodeId));
    if (!nodeManager.generateProActiveEvent(Event.RELATIONSHIP_DELETE,eventData)) {
      nodeManager.setRollbackOnly();
      throw new DeleteException("Generate pro-active event failed.");
    }
    if (startNode != null) {
      startNode.removeRelationship(type,id);
    }
    if (endNode != null) {
      endNode.removeRelationship(type,id);
    }
    nodeManager.removeRelationshipFromCache(id);
    nodeManager.generateReActiveEvent(Event.RELATIONSHIP_DELETE,eventData);
  }
  finally {
    boolean releaseFailed=false;
    try {
      if (startNodeLocked) {
        nodeManager.releaseLock(startNode,LockType.WRITE);
      }
    }
 catch (    Exception e) {
      releaseFailed=true;
      e.printStackTrace();
    }
    try {
      if (endNodeLocked) {
        nodeManager.releaseLock(endNode,LockType.WRITE);
      }
    }
 catch (    Exception e) {
      releaseFailed=true;
      e.printStackTrace();
    }
    nodeManager.releaseLock(this,LockType.WRITE);
    if (releaseFailed) {
      throw new RuntimeException("Unable to release locks [" + startNode + ","+ endNode+ "] in relationship delete->"+ this);
    }
  }
}
