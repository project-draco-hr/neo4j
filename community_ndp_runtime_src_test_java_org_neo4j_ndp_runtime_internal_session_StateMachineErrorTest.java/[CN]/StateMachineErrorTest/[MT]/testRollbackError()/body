{
  SessionStateMachine machine=new SessionStateMachine(db,txBridge,runner,NullLogService.getInstance());
  machine.beginTransaction();
  doThrow(new TransactionFailureException("This just isn't going well for us.")).when(tx).close();
  machine.rollbackTransaction();
  assertThat(machine.state(),equalTo(ERROR));
}
