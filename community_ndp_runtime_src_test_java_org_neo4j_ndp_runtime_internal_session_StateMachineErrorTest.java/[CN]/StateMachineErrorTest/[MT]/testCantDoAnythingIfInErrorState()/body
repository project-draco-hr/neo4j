{
  RecordingCallback messages=new RecordingCallback();
  SessionStateMachine machine=new SessionStateMachine(db,txBridge,runner,NullLog.getInstance());
  machine.commitTransaction();
  assertThat(machine.state(),equalTo(ERROR));
  machine.beginTransaction();
  assertThat(machine.state(),equalTo(ERROR));
  machine.beginImplicitTransaction();
  assertThat(machine.state(),equalTo(ERROR));
  machine.commitTransaction();
  assertThat(machine.state(),equalTo(ERROR));
  machine.rollbackTransaction();
  assertThat(machine.state(),equalTo(ERROR));
  machine.run("src/test",EMPTY_MAP,null,messages);
  assertThat(machine.state(),equalTo(ERROR));
  assertThat(messages.next(),ignored());
  machine.pullAll(null,messages);
  assertThat(machine.state(),equalTo(ERROR));
  assertThat(messages.next(),ignored());
  verifyNoMoreInteractions(db,runner);
}
