{
  Throwable txEx=null;
  for (int i=0; i < retries; i++) {
    try (Transaction tx=gds.beginTx()){
      T result=txFunction.apply(tx);
      tx.success();
      return result;
    }
 catch (    Throwable ex) {
      monitor.failure(ex);
      txEx=ex;
      if (!retryPredicate.accept(ex)) {
        break;
      }
    }
    if (i < retries - 1) {
      try {
        Thread.sleep(backoff);
      }
 catch (      InterruptedException e) {
        throw new TransactionFailureException("Interrupted",e);
      }
      monitor.retrying();
    }
  }
  if (txEx instanceof TransactionFailureException) {
    throw ((TransactionFailureException)txEx);
  }
 else   if (txEx instanceof Error) {
    throw ((Error)txEx);
  }
 else   if (txEx instanceof RuntimeException) {
    throw ((RuntimeException)txEx);
  }
 else {
    throw new TransactionFailureException("Failed",txEx);
  }
}
