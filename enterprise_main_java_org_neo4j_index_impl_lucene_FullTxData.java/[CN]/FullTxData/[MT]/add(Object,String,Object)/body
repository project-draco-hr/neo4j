{
  try {
    ensureLuceneDataInstantiated();
    long id=entityId instanceof Long ? (Long)entityId : ((RelationshipId)entityId).id;
    Document document=LuceneDataSource.findDocument(index.type,searcher(),id);
    if (document != null) {
      index.type.addToDocument(document,key,value);
      writer.updateDocument(index.type.idTerm(id),document);
    }
 else {
      document=index.identifier.entityType.newDocument(entityId);
      index.type.addToDocument(document,key,value);
      writer.addDocument(document);
    }
    invalidateSearcher();
    return this;
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
