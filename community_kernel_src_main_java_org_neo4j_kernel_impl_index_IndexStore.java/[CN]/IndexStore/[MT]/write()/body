{
  File tmpFile=new File(this.file.getParentFile(),this.file.getName() + ".tmp");
  write(tmpFile);
  fileSystem.deleteFile(oldFile.getAbsolutePath());
  try {
    if (fileSystem.fileExists(file.getAbsolutePath()) && !fileSystem.renameFile(file.getAbsolutePath(),oldFile.getAbsolutePath())) {
      throw new RuntimeException("Couldn't rename " + file + " -> "+ oldFile);
    }
  }
 catch (  IOException e) {
    throw new RuntimeException("Couldn't rename " + file + " -> "+ oldFile);
  }
  try {
    if (!fileSystem.renameFile(tmpFile.getAbsolutePath(),this.file.getAbsolutePath())) {
      throw new RuntimeException("Couldn't rename " + tmpFile + " -> "+ file);
    }
  }
 catch (  IOException e) {
    throw new RuntimeException("Couldn't rename " + tmpFile + " -> "+ file);
  }
  fileSystem.deleteFile(oldFile.getAbsolutePath());
}
