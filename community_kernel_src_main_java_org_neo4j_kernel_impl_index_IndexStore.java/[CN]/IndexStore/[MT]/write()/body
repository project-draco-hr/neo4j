{
  File tmpFile=new File(this.file.getParentFile(),this.file.getName() + ".tmp");
  write(tmpFile);
  fileSystem.deleteFile(oldFile);
  try {
    if (fileSystem.fileExists(file) && !fileSystem.renameFile(file,oldFile)) {
      throw new RuntimeException("Couldn't rename " + file + " -> "+ oldFile);
    }
  }
 catch (  IOException e) {
    throw new RuntimeException("Couldn't rename " + file + " -> "+ oldFile);
  }
  try {
    if (!fileSystem.renameFile(tmpFile,this.file)) {
      throw new RuntimeException("Couldn't rename " + tmpFile + " -> "+ file);
    }
  }
 catch (  IOException e) {
    throw new RuntimeException("Couldn't rename " + tmpFile + " -> "+ file);
  }
  fileSystem.deleteFile(oldFile);
}
