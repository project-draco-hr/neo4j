{
  NodeRelationshipCache cache=mock(NodeRelationshipCache.class);
  try (CalculateDenseNodesStep step=new CalculateDenseNodesStep(mock(StageControl.class),DEFAULT,cache,mock(Collector.class))){
    step.processors(4);
    step.start(0);
    Batch<InputRelationship,RelationshipRecord> batch=batch(relationship(1,5),relationship(3,10),relationship(2,2),relationship(4,1));
    step.receive(0,batch);
    step.endOfUpstream();
    while (!step.isCompleted())     ;
    verify(cache,times(2)).incrementCount(eq(1L));
    verify(cache,times(1)).incrementCount(eq(2L));
    verify(cache,times(1)).incrementCount(eq(3L));
    verify(cache,times(1)).incrementCount(eq(4L));
    verify(cache,times(1)).incrementCount(eq(5L));
    verify(cache,times(1)).incrementCount(eq(10L));
  }
 }
