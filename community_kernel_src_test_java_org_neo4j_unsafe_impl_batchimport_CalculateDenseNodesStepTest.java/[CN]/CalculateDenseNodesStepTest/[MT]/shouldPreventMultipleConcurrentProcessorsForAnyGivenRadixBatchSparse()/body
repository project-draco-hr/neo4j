{
  StageControl control=new StageControl(){
    @Override public void panic(    Throwable cause){
      cause.printStackTrace();
    }
  }
;
  Configuration config=Configuration.DEFAULT;
  NodeRelationshipCache cache=new NodeRelationshipCache(NumberArrayFactory.HEAP,-1);
  Step<long[]> step=new CalculateDenseNodesStep(control,config,cache);
  step.start(0);
  step.processors(100);
  long[] ids=batchOfIdsWithRadix(3);
  int numberOfBatches=100;
  for (int i=0; i < numberOfBatches; i++) {
    step.receive(i,ids);
  }
  step.endOfUpstream();
  waitUntilCompleted(step);
  for (  long id : ids) {
    assertEquals(numberOfBatches,cache.getCount(id,null));
  }
}
