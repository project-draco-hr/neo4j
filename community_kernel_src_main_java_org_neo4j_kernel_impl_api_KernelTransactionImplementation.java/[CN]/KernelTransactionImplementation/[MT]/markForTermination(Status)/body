{
  if (!canBeTerminated()) {
    return;
  }
  int initialReuseCount=reuseCount;
  terminationReleaseLock.lock();
  try {
    boolean stillSameTransaction=initialReuseCount == reuseCount;
    if (stillSameTransaction && canBeTerminated()) {
      failure=true;
      terminationReason=reason;
      if (locks != null) {
        locks.stop();
      }
      transactionMonitor.transactionTerminated(hasTxStateWithChanges());
    }
  }
  finally {
    terminationReleaseLock.unlock();
  }
}
