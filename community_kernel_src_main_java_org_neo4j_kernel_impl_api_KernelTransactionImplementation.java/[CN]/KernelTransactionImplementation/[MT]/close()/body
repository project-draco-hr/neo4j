{
  assertTransactionOpen();
  assertTransactionNotClosing();
  closeCurrentStatementIfAny();
  closing=true;
  try {
    if (failure || !success) {
      rollback();
      if (success) {
        throw new TransactionFailureException(Status.Transaction.MarkedAsFailed,"Transaction rolled back even if marked as successful");
      }
    }
 else {
      commit();
    }
  }
  finally {
    closed=true;
    closing=false;
    transactionEvent.setSuccess(success);
    transactionEvent.setFailure(failure);
    transactionEvent.setTransactionType(transactionType.name());
    transactionEvent.setReadOnly(txState == null || !txState.hasChanges());
    transactionEvent.close();
    transactionEvent=null;
  }
}
