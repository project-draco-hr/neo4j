{
  if (txState != null) {
    NeoStoreTransactionContext context=new NeoStoreTransactionContext(neoStores,loaders,locks);
    TransactionRecordState recordState=new TransactionRecordState(neoStores,integrityValidator,context);
    recordState.initialize(lastTransactionIdWhenStarted);
    TxStateVisitor txStateVisitor=new TransactionToRecordStateVisitor(recordState,schemaStateChangeCallback,schemaStorage,constraintSemantics,schemaIndexProviderMap);
    CountsRecordState countsRecordState=new CountsRecordState();
    txStateVisitor=constraintSemantics.decorateTxStateVisitor(storeLayer,txState,txStateVisitor);
    txStateVisitor=new TransactionCountingStateVisitor(txStateVisitor,storeLayer,txState,countsRecordState);
    try (TxStateVisitor visitor=txStateVisitor){
      txState.accept(txStateVisitor);
    }
     recordState.extractCommands(commands);
    countsRecordState.extractCommands(commands);
  }
}
