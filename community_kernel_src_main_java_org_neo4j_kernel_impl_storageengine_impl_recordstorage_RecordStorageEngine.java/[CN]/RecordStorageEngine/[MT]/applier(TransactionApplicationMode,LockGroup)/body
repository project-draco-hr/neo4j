{
  CommandHandler storeApplier=new NeoStoreTransactionApplier(neoStores,cacheAccess,lockService,locks);
  if (mode.needsHighIdTracking()) {
    storeApplier=new HighIdTransactionApplier(storeApplier,neoStores);
  }
  if (mode.needsCacheInvalidationOnUpdates()) {
    storeApplier=new CacheInvalidationTransactionApplier(storeApplier,neoStores,cacheAccess);
  }
  CommandHandler indexApplier=new IndexTransactionApplier(indexingService,labelScanStoreSync);
  CommandHandler legacyIndexApplier=new LegacyIndexApplier(indexConfigStore,legacyIndexApplierLookup,legacyIndexTransactionOrdering,mode);
  CommandHandler countsStoreApplier=new CountsStoreApplier(neoStores.getCounts(),mode);
  return new CommandApplierFacade(storeApplier,indexApplier,legacyIndexApplier,countsStoreApplier);
}
