{
  Collection<Command> commands=new ArrayList<>();
  NeoStoreTransactionContext context=new NeoStoreTransactionContext(neoStores,locks);
  TransactionRecordState recordState=new TransactionRecordState(neoStores,integrityValidator,context);
  recordState.initialize(lastTransactionIdWhenStarted);
  TxStateVisitor recordStateVisitor=new TransactionToRecordStateVisitor(recordState,schemaStateChangeCallback,schemaStorage,constraintSemantics,providerMap,legacyIndexTransactionState,procedureCache);
  CountsRecordState countsRecordState=new CountsRecordState();
  recordStateVisitor=new TransactionCountingStateVisitor(recordStateVisitor,storeLayer,txState,countsRecordState);
  txState.accept(recordStateVisitor);
  recordStateVisitor.done();
  recordState.extractCommands(commands);
  legacyIndexTransactionState.extractCommands(commands);
  countsRecordState.extractCommands(commands);
  return commands;
}
