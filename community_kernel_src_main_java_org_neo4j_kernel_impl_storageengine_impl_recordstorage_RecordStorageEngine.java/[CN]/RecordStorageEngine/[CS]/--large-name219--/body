{
  this.propertyKeyTokenHolder=propertyKeyTokenHolder;
  this.relationshipTypeTokenHolder=relationshipTypeTokens;
  this.labelTokenHolder=labelTokens;
  this.schemaStateChangeCallback=schemaStateChangeCallback;
  this.constraintSemantics=constraintSemantics;
  this.kernelHealth=kernelHealth;
  this.legacyIndexProviderLookup=legacyIndexProviderLookup;
  this.indexConfigStore=indexConfigStore;
  final StoreFactory storeFactory=new StoreFactory(storeDir,config,idGeneratorFactory,pageCache,fs,logProvider);
  neoStores=storeFactory.openAllNeoStores(true);
  try {
    schemaCache=new SchemaCache(constraintSemantics,Collections.<SchemaRule>emptyList());
    schemaStorage=new SchemaStorage(neoStores.getSchemaStore());
    providerMap=new DefaultSchemaIndexProviderMap(indexProvider);
    indexingService=IndexingService.create(new IndexSamplingConfig(config),scheduler,providerMap,new NeoStoreIndexStoreView(lockService,neoStores),tokenNameLookup,toList(new SchemaStorage(neoStores.getSchemaStore()).allIndexRules()),logProvider,indexingServiceMonitor,schemaStateChangeCallback);
    integrityValidator=new IntegrityValidator(neoStores,indexingService);
    indexUpdatesValidator=new OnlineIndexUpdatesValidator(neoStores,kernelHealth,new PropertyLoader(neoStores),indexingService,IndexUpdateMode.ONLINE);
    cacheAccess=new BridgingCacheAccess(schemaCache,schemaStateChangeCallback,propertyKeyTokenHolder,relationshipTypeTokens,labelTokens);
    DiskLayer diskLayer=new DiskLayer(propertyKeyTokenHolder,labelTokens,relationshipTypeTokens,schemaStorage,neoStores,indexingService,storeStatementFactory(neoStores,config,lockService));
    procedureCache=new ProcedureCache();
    storeLayer=new CacheLayer(diskLayer,schemaCache,procedureCache);
    this.labelScanStore=labelScanStoreProvider.getLabelScanStore();
    legacyIndexApplierLookup=new LegacyIndexApplierLookup.Direct(legacyIndexProviderLookup);
    RelationshipGroupStore relationshipGroupStore=neoStores.getRelationshipGroupStore();
    RelationshipGroupGetter relGroupGetter=new RelationshipGroupGetter(relationshipGroupStore);
    PropertyTraverser propertyTraverser=new PropertyTraverser();
    propertyCreator=new PropertyCreator(neoStores.getPropertyStore(),propertyTraverser);
    propertyDeleter=new PropertyDeleter(neoStores.getPropertyStore(),propertyTraverser);
    relationshipCreator=new RelationshipCreator(relGroupGetter,relationshipGroupStore.getDenseNodeThreshold());
    relationshipDeleter=new RelationshipDeleter(relGroupGetter,propertyDeleter);
    final RecoveryLabelScanWriterProvider labelScanWriters=new RecoveryLabelScanWriterProvider(labelScanStore,1000);
    final RecoveryLegacyIndexApplierLookup recoveryLegacyIndexApplierLookup=new RecoveryLegacyIndexApplierLookup(legacyIndexApplierLookup,1000);
    final RecoveryIndexingUpdatesValidator indexUpdatesValidator=new RecoveryIndexingUpdatesValidator(indexingService);
    applierForRecovery=new TransactionRepresentationStoreApplier(labelScanWriters,lockService,indexConfigStore,IdOrderingQueue.BYPASS,legacyIndexApplierLookup,neoStores,cacheAccess,indexingService,kernelHealth);
  }
 catch (  Throwable failure) {
    neoStores.close();
    throw failure;
  }
}
