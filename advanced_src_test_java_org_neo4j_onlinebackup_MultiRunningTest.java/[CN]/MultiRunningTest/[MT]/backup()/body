{
  System.out.println("starting tests");
  EmbeddedNeo neo=Util.startNeoInstance(STORE_LOCATION_DIR);
  ((NeoStoreXaDataSource)neo.getConfig().getPersistenceModule().getPersistenceSource().getXaDataSource()).keepLogicalLogs(true);
  IndexService indexService=new LuceneIndexService(neo);
  XaDataSourceManager xaDsm=neo.getConfig().getTxModule().getXaDataSourceManager();
  XaDataSource ds=xaDsm.getXaDataSource("lucene");
  ((LuceneDataSource)ds).keepLogicalLogs(true);
  System.out.println("backing up original db without any changes");
  tryBackup(neo,BACKUP_LOCATION_DIR,1);
  Transaction tx=neo.beginTx();
  try {
    indexService.index(addNode(neo),"number",2);
    tx.success();
  }
  finally {
    tx.finish();
  }
  System.out.println("one node added");
  tryBackup(neo,BACKUP_LOCATION_DIR,2);
  tx=neo.beginTx();
  try {
    indexService.index(addNode(neo),"number",3);
    tx.success();
  }
  finally {
    tx.finish();
  }
  System.out.println("one node added");
  tx=neo.beginTx();
  try {
    indexService.index(addNode(neo),"number",4);
    System.out.println("one node added, not commited");
    tryBackup(neo,BACKUP_LOCATION_DIR,3);
    tx.success();
  }
  finally {
    tx.finish();
  }
  System.out.println("previous add commited");
  tryBackup(neo,BACKUP_LOCATION_DIR,4);
  Util.stopNeo(neo,indexService);
}
