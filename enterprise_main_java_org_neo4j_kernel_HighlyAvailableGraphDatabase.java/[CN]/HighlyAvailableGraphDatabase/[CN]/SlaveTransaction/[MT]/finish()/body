{
  boolean successfulFinish=false;
  try {
    int localTxId=((TxManager)getTransactionManager()).getEventIdentifier();
    if (isMarkedAsSuccessful()) {
      broker.getMaster().commitTransaction(broker.getSlaveContext(),localTxId,transactionAsStream());
    }
 else {
      broker.getMaster().rollbackTransaction(broker.getSlaveContext(),localTxId);
    }
    successfulFinish=true;
  }
  finally {
    try {
      if (!successfulFinish) {
        failure();
      }
    }
  finally {
      super.finish();
    }
  }
}
