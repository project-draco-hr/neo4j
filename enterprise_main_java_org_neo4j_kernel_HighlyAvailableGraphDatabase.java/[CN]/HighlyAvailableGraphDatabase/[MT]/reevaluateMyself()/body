{
  shutdownIfNecessary();
  if (brokerSaysIAmMaster()) {
    this.localGraph=new EmbeddedGraphDbImpl(storeDir,config,this,LockManagerFactory.DEFAULT,IdGeneratorFactory.DEFAULT,DefaultRelationshipTypeCreator.INSTANCE,TopLevelTransactionFactory.DEFAULT,TxIdGeneratorFactory.DEFAULT);
  }
 else {
    ResponseReceiver receiver=new ResponseReceiver();
    this.localGraph=new EmbeddedGraphDbImpl(storeDir,config,this,new SlaveLockManagerFactory(broker,receiver),new SlaveIdGeneratorFactory(broker,receiver),new SlaveRelationshipTypeCreator(broker,receiver),new SlaveTopLevelTransactionFactory(broker,receiver),new SlaveTxIdGeneratorFactory(broker,receiver));
  }
}
