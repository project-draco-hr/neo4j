{
  long[] defragIds={42,27172828,314159};
  IdAllocation firstResult=new IdAllocation(new IdRange(defragIds,0,0),0,defragIds.length);
  Response<IdAllocation> toReturn=mock(Response.class);
  when(toReturn.response()).thenReturn(firstResult);
  when(master.allocateIds(Matchers.<IdType>any())).thenReturn(toReturn);
  IdGenerator gen=switchToSlave();
  for (int i=0; i < defragIds.length; i++) {
    assertEquals(defragIds[i],gen.nextId());
  }
}
