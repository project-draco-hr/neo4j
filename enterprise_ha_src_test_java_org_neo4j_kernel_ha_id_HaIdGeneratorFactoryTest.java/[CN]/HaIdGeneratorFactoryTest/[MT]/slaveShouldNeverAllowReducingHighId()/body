{
  final int highIdFromAllocation=123;
  IdAllocation firstResult=new IdAllocation(new IdRange(new long[]{},42,highIdFromAllocation),highIdFromAllocation,0);
  Response<IdAllocation> response=response(firstResult);
  when(master.allocateIds(any(RequestContext.class),any(IdType.class))).thenReturn(response);
  IdGenerator gen=switchToSlave();
  final int highIdFromUpdatedRecord=highIdFromAllocation + 1;
  gen.setHighId(highIdFromUpdatedRecord);
  gen.nextId();
  assertEquals(highIdFromUpdatedRecord,gen.getHighId());
}
