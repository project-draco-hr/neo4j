{
  assertValidToken(token);
  User user=users.get(name);
  if (user != null) {
    String oldToken=user.token();
    user=user.augment().withToken(token).build();
    try {
      users.save(user);
    }
 catch (    IllegalUsernameException e) {
      throw new ThisShouldNotHappenError("Jake","Username has already been accepted, we are modifying the token only.");
    }
    usersByToken.put(token,user);
    if (oldToken != User.NO_TOKEN) {
      usersByToken.remove(oldToken);
    }
  }
}
