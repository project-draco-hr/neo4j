{
  EphemeralFileSystemAbstraction fsa=new EphemeralFileSystemAbstraction();
  fsa.mkdir(testDir.directory());
  final int numberOfEntriesBeforeRotation=100;
  StatePersister<AtomicInteger> statePersister=new StatePersister<>(stateFileA(),stateFileB(),fsa,numberOfEntriesBeforeRotation,new AtomicIntegerMarshal(),stateFileA(),mock(Supplier.class));
  for (int i=0; i < numberOfEntriesBeforeRotation * 2; i++) {
    statePersister.persistStoreData(new AtomicInteger(i));
  }
  statePersister.persistStoreData(new AtomicInteger(9999));
  assertEquals(4,fsa.getFileSize(stateFileA()));
  assertEquals(numberOfEntriesBeforeRotation * 4,fsa.getFileSize(stateFileB()));
}
