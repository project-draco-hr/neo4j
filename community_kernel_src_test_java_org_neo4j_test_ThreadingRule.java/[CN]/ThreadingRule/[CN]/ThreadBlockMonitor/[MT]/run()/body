{
  StackTraceElement[] lastTrace=null;
  Thread.State lastState=null;
  do {
    Thread.State state=thread.getState();
switch (state) {
case BLOCKED:
case WAITING:
case TIMED_WAITING:
      StackTraceElement[] trace=thread.getStackTrace();
    if (trace[0].isNativeMethod() && Thread.class.getName().equals(trace[0].getClassName()) && "sleep".equals(trace[0].getMethodName())) {
      break;
    }
  if (lastState == state && Arrays.equals(trace,lastTrace)) {
    action.run();
    return;
  }
lastTrace=trace;
break;
default :
lastTrace=null;
}
lastState=state;
try {
Thread.sleep(500);
}
 catch (InterruptedException e) {
return;
}
}
 while (!cancellation.cancellationRequested());
}
