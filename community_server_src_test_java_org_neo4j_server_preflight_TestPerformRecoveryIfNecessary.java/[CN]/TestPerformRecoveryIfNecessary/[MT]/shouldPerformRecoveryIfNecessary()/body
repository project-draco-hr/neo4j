{
  AssertableLogProvider logProvider=new AssertableLogProvider();
  DefaultFileSystemAbstraction fs=new DefaultFileSystemAbstraction();
  PageCache pageCache=pageCacheRule.getPageCache(fs);
  StoreRecoverer recoverer=new StoreRecoverer(fs,pageCache);
  Config config=buildProperties();
  new TestGraphDatabaseFactory().newEmbeddedDatabase(storeDirectory).shutdown();
  createSomeDataAndCrash(storeDirectory,fs);
  assertThat("Store should need recovery",recoverer.recoveryNeededAt(storeDirectory),is(true));
  PerformRecoveryIfNecessary task=new PerformRecoveryIfNecessary(config,new HashMap<String,String>(),logProvider);
  assertThat("Recovery task should run successfully.",task.run(),is(true));
  assertThat("Database should exist.",storeDirectory.exists(),is(true));
  logProvider.assertAtLeastOnce(inLog(PerformRecoveryIfNecessary.class).warn("Detected incorrectly shut down database, performing recovery.."));
  assertThat("Store should be recovered",recoverer.recoveryNeededAt(storeDirectory),is(false));
}
