{
  if (xaRes == null) {
    throw new IllegalArgumentException("Null xa resource");
  }
  if (status == Status.STATUS_ACTIVE || status == Status.STATUS_PREPARING) {
    try {
      if (resourceList.size() == 0) {
        byte branchId[]=txManager.getBranchId(xaRes);
        Xid xid=new XidImpl(globalId,branchId);
        resourceList.add(new ResourceElement(xid,xaRes));
        xaRes.start(xid,XAResource.TMNOFLAGS);
        return true;
      }
      Xid sameRmXid=null;
      Iterator<ResourceElement> itr=resourceList.iterator();
      while (itr.hasNext()) {
        ResourceElement re=itr.next();
        if (sameRmXid == null && re.getResource().isSameRM(xaRes)) {
          sameRmXid=re.getXid();
        }
        if (xaRes == re.getResource()) {
          if (re.getStatus() == RS_SUSPENDED) {
            xaRes.start(re.getXid(),XAResource.TMRESUME);
          }
 else {
            xaRes.start(re.getXid(),XAResource.TMJOIN);
          }
          re.setStatus(RS_ENLISTED);
          return true;
        }
      }
      if (sameRmXid != null) {
        resourceList.add(new ResourceElement(sameRmXid,xaRes));
        xaRes.start(sameRmXid,XAResource.TMJOIN);
      }
 else {
        byte branchId[]=txManager.getBranchId(xaRes);
        Xid xid=new XidImpl(globalId,branchId);
        resourceList.add(new ResourceElement(xid,xaRes));
        xaRes.start(xid,XAResource.TMNOFLAGS);
      }
      return true;
    }
 catch (    XAException e) {
      log.log(Level.SEVERE,"Unable to enlist resource[" + xaRes + "]",e);
      status=Status.STATUS_MARKED_ROLLBACK;
      return false;
    }
  }
 else   if (status == Status.STATUS_ROLLING_BACK || status == Status.STATUS_ROLLEDBACK || status == Status.STATUS_MARKED_ROLLBACK) {
    throw new RollbackException("Tx status is: " + txManager.getTxStatusAsString(status));
  }
  throw new IllegalStateException("Tx status is: " + txManager.getTxStatusAsString(status));
}
