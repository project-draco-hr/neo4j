{
  if (xaRes == null) {
    throw new IllegalArgumentException("Null xa resource");
  }
  if (flag != XAResource.TMSUCCESS && flag != XAResource.TMSUSPEND && flag != XAResource.TMFAIL) {
    throw new IllegalArgumentException("Illegal flag: " + flag);
  }
  ResourceElement re=null;
  Iterator<ResourceElement> itr=resourceList.iterator();
  while (itr.hasNext()) {
    ResourceElement reMatch=itr.next();
    if (reMatch.getResource() == xaRes) {
      re=reMatch;
      break;
    }
  }
  if (re == null) {
    return false;
  }
  if (status == Status.STATUS_ACTIVE || status == Status.STATUS_MARKED_ROLLBACK) {
    try {
      xaRes.end(re.getXid(),flag);
      if (flag == XAResource.TMSUSPEND || flag == XAResource.TMFAIL) {
        re.setStatus(RS_SUSPENDED);
      }
 else {
        re.setStatus(RS_DELISTED);
      }
      return true;
    }
 catch (    XAException e) {
      log.log(Level.SEVERE,"Unable to delist resource[" + xaRes + "]",e);
      status=Status.STATUS_MARKED_ROLLBACK;
      return false;
    }
  }
  throw new IllegalStateException("Tx status is: " + txManager.getTxStatusAsString(status));
}
