{
  if (closed)   throw new IllegalStateException("Index has been shut down");
  Pair<IndexWriter,AtomicBoolean> writer=indexWriters.get(identifier);
  if (writer != null) {
    return writer.first();
  }
  try {
    Directory dir=getDirectory(baseStorePath,identifier);
    directoryExists(dir);
    IndexType type=getType(identifier);
    IndexWriterConfig writerConfig=new IndexWriterConfig(LUCENE_VERSION,type.analyzer);
    writerConfig.setIndexDeletionPolicy(new MultipleBackupDeletionPolicy());
    Similarity similarity=type.getSimilarity();
    if (similarity != null) {
      writerConfig.setSimilarity(similarity);
    }
    IndexWriter indexWriter=new IndexWriter(dir,writerConfig);
    writer=Pair.of(indexWriter,new AtomicBoolean());
    indexWriters.put(identifier,writer);
    return writer.first();
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
