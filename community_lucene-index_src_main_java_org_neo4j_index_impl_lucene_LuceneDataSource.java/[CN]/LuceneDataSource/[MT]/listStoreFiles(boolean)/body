{
  final Collection<File> files=new ArrayList<>();
  final Collection<SnapshotDeletionPolicy> snapshots=new ArrayList<>();
  makeSureAllIndexesAreInstantiated();
  for (  IndexReference writer : getAllIndexes()) {
    SnapshotDeletionPolicy deletionPolicy=(SnapshotDeletionPolicy)writer.getWriter().getConfig().getIndexDeletionPolicy();
    File indexDirectory=getFileDirectory(baseStorePath,writer.getIdentifier());
    try {
      IndexCommit commit=deletionPolicy.snapshot(SNAPSHOT_ID);
      for (      String fileName : commit.getFileNames()) {
        files.add(new File(indexDirectory,fileName));
      }
      snapshots.add(deletionPolicy);
    }
 catch (    IllegalStateException e) {
    }
  }
  return new PrefetchingResourceIterator<File>(){
    private final Iterator<File> filesIterator=files.iterator();
    @Override protected File fetchNextOrNull(){
      return filesIterator.hasNext() ? filesIterator.next() : null;
    }
    @Override public void close(){
      for (      SnapshotDeletionPolicy deletionPolicy : snapshots) {
        try {
          deletionPolicy.release(SNAPSHOT_ID);
        }
 catch (        IOException e) {
          e.printStackTrace();
        }
      }
    }
  }
;
}
