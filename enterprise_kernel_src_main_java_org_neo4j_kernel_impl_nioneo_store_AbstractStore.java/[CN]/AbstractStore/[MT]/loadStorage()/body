{
  try {
    long fileSize=getFileChannel().size();
    String expectedVersion=getTypeAndVersionDescriptor();
    byte version[]=new byte[UTF8.encode(expectedVersion).length];
    ByteBuffer buffer=ByteBuffer.wrap(version);
    if (fileSize >= version.length) {
      getFileChannel().position(fileSize - version.length);
    }
 else     if (!isReadOnly()) {
      setStoreNotOk();
    }
    getFileChannel().read(buffer);
    if (!expectedVersion.equals(UTF8.decode(version)) && !isReadOnly()) {
      if (!versionFound(UTF8.decode(version))) {
        setStoreNotOk();
      }
    }
    if (getRecordSize() != 0 && (fileSize - version.length) % getRecordSize() != 0 && !isReadOnly()) {
      setStoreNotOk();
    }
    if (getStoreOk() && !isReadOnly()) {
      getFileChannel().truncate(fileSize - version.length);
    }
  }
 catch (  IOException e) {
    throw new UnderlyingStorageException("Unable to load store " + getStorageFileName(),e);
  }
  try {
    if (!isReadOnly() || isBackupSlave()) {
      openIdGenerator();
    }
 else {
      openReadOnlyIdGenerator(getRecordSize());
    }
  }
 catch (  InvalidIdGeneratorException e) {
    setStoreNotOk();
  }
 finally {
    if (!getStoreOk()) {
      if (getConfig() != null) {
        String storeDir=(String)getConfig().get("store_dir");
        StringLogger msgLog=StringLogger.getLogger(storeDir);
        msgLog.logMessage(getStorageFileName() + " non clean shutdown detected",true);
      }
    }
  }
  setWindowPool(new PersistenceWindowPool(getStorageFileName(),getRecordSize(),getFileChannel(),getMappedMem(),getIfMemoryMapped(),isReadOnly() && !isBackupSlave()));
}
