{
  LockableWindow window=null;
  if (brickMiss >= REFRESH_BRICK_COUNT) {
    refreshBricks();
  }
  while (window == null) {
    if (brickSize > 0) {
      int brickIndex=positionToBrickIndex(position);
      if (brickIndex >= brickArray.length) {
        expandBricks(brickIndex + 1);
      }
      BrickElement brick=brickArray[brickIndex];
      window=brick.getWindow();
      if (window != null && !window.markAsInUse()) {
        window=null;
      }
      brick.setHit();
    }
    if (window == null) {
      miss++;
      brickMiss++;
      PersistenceRow dpw=activeRowWindows.get(position);
      if (dpw != null && dpw.markAsInUse()) {
        window=dpw;
        break;
      }
      dpw=new PersistenceRow(position,blockSize,fileChannel);
      PersistenceRow existing=activeRowWindows.putIfAbsent(position,dpw);
      if (existing == null) {
        window=dpw;
      }
 else {
        dpw.close();
      }
    }
 else {
      hit++;
    }
  }
  window.lock(operationType);
  return window;
}
