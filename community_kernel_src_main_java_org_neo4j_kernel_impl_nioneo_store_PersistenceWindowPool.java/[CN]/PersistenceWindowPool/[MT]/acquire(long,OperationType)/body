{
  LockableWindow window=null;
  if (brickMiss >= REFRESH_BRICK_COUNT) {
    refreshBricks();
  }
  boolean readFullRow=false;
  while (window == null) {
    if (brickSize > 0) {
      int brickIndex=positionToBrickIndex(position);
      if (brickIndex < brickArray.length) {
        BrickElement brick=brickArray[brickIndex];
        window=brick.getWindow();
        if (window != null && !window.markAsInUse())         window=null;
        brick.setHit();
      }
 else {
        expandBricks(brickIndex + 1);
        window=brickArray[brickIndex].getWindow();
      }
    }
    if (window == null) {
      miss++;
      brickMiss++;
      if (operationType == OperationType.READ)       readFullRow=true;
      PersistenceRow dpw=activeRowWindows.get((int)position);
      if (dpw != null && dpw.markAsInUse()) {
        window=dpw;
        break;
      }
      dpw=new PersistenceRow(position,blockSize,fileChannel);
      PersistenceRow existing=activeRowWindows.putIfAbsent((int)position,dpw);
      if (existing == null && dpw.markAsInUse()) {
        window=dpw;
      }
 else {
        dpw.close();
        readFullRow=false;
      }
    }
 else {
      hit++;
    }
  }
  window.lock();
  if (readFullRow) {
    PersistenceRow dpw=(PersistenceRow)window;
    boolean success=false;
    try {
      dpw.readFullWindow();
      success=true;
    }
  finally {
      if (!success) {
        activeRowWindows.remove((int)dpw.position());
        window.unLock();
      }
    }
  }
  window.setOperationType(operationType);
  return window;
}
