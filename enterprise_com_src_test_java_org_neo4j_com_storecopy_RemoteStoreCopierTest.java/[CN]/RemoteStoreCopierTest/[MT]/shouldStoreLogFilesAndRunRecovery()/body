{
  final String copyDir=new File(testDir.directory(),"copy").getAbsolutePath();
  final String originalDir=new File(testDir.directory(),"original").getAbsolutePath();
  Config config=new Config(stringMap(store_dir.name(),copyDir));
  ConsoleLogger consoleLog=new ConsoleLogger(StringLogger.SYSTEM);
  Logging logging=new DevNullLoggingService();
  Monitors monitors=new Monitors();
  monitors.addMonitorListener(StoreCopyMonitor.NONE);
  RemoteStoreCopier copier=new RemoteStoreCopier(config,loadKernelExtensions(),consoleLog,logging,fs,monitors);
  final GraphDatabaseAPI original=(GraphDatabaseAPI)new GraphDatabaseFactory().newEmbeddedDatabase(originalDir);
  RemoteStoreCopier.StoreCopyRequester requester=spy(new RemoteStoreCopier.StoreCopyRequester(){
    public Response<Object> response;
    @Override public Response<?> copyStore(    StoreWriter writer){
      try (Transaction tx=original.beginTx()){
        original.createNode(label("BeforeCopyBegins"));
        tx.success();
      }
       XaDataSourceManager dsManager=original.getDependencyResolver().resolveDependency(XaDataSourceManager.class);
      RequestContext ctx=ServerUtil.rotateLogsAndStreamStoreFiles(originalDir,dsManager,original.getDependencyResolver().resolveDependency(KernelPanicEventGenerator.class),StringLogger.SYSTEM,false,writer,fs,original.getDependencyResolver().resolveDependency(Monitors.class).newMonitor(StoreCopyMonitor.class));
      try (Transaction tx=original.beginTx()){
        original.createNode(label("AfterCopy"));
        tx.success();
      }
       response=spy(ServerUtil.packResponse(original.storeId(),dsManager,ctx,null,ServerUtil.ALL));
      return response;
    }
    @Override public void done(){
      assertNotNull(response);
      verify(response,times(1)).close();
    }
  }
);
  copier.copyStore(requester,CancellationRequest.NONE);
  GraphDatabaseService copy=new GraphDatabaseFactory().newEmbeddedDatabase(copyDir);
  try (Transaction tx=copy.beginTx()){
    GlobalGraphOperations globalOps=GlobalGraphOperations.at(copy);
    assertThat(Iterables.single(globalOps.getAllNodesWithLabel(label("BeforeCopyBegins"))).getId(),equalTo(0l));
    assertThat(Iterables.single(globalOps.getAllNodesWithLabel(label("AfterCopy"))).getId(),equalTo(1l));
    tx.success();
  }
  finally {
    copy.shutdown();
    original.shutdown();
  }
  verify(requester,times(1)).done();
}
