{
  final long lockTimeout=1;
  initializeDbs(1,stringMap(HaSettings.lock_read_timeout.name(),String.valueOf(lockTimeout)));
  final Long nodeId=executeJobOnMaster(new CommonJobs.CreateNodeJob(true));
  final Fetcher<DoubleLatch> latchFetcher=getDoubleLatch();
  pullUpdates();
  Thread lockHolder=new Thread(new Runnable(){
    @Override public void run(){
      DoubleLatch latch=latchFetcher.fetch();
      try {
        latch.awaitFirst();
        Thread.sleep((lockTimeout + MasterImpl.UNFINISHED_TRANSACTION_CLEANUP_DELAY) * 1000);
        latch.countDownSecond();
      }
 catch (      Exception e) {
        throw new RuntimeException(e);
      }
    }
  }
);
  lockHolder.start();
  try {
    executeJob(new CommonJobs.HoldLongLock(nodeId,latchFetcher),0);
    fail("Should have cleaned up transaction and thrown exception.");
  }
 catch (  TransactionFailureException e) {
  }
}
