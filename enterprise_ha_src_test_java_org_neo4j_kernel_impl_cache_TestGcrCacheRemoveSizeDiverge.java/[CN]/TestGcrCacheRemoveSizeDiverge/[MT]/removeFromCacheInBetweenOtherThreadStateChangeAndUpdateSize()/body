{
  final Node node=createNodeWithSomeRelationships();
  graphdb.getDependencyResolver().resolveDependency(NodeManager.class).clearCache();
  enableBreakpoints();
  graphdb.getNodeById(node.getId());
  final Cache<?> nodeCache=graphdb.getDependencyResolver().resolveDependency(NodeManager.class).caches().iterator().next();
  assertTrue("We didn't get a hold of the right cache object",nodeCache.toString().toLowerCase().contains("node"));
  Thread t1=new Thread("T1: Relationship loader"){
    @Override public void run(){
      count(node.getRelationships());
    }
  }
;
  t1.start();
  Thread.sleep(2000);
  Thread t2=new Thread("T2: Cache remover"){
    @Override public void run(){
      nodeCache.remove(node.getId());
    }
  }
;
  t2.start();
  t2.join();
  resumeUpdateSize();
  t1.join();
  assertEquals("Invalid cache size for " + nodeCache,0,nodeCache.size());
}
