{
  int insertionsCount=0;
  for (  NodePropertyUpdate update : updates) {
    if (update.getUpdateMode() == UpdateMode.ADDED || update.getUpdateMode() == UpdateMode.CHANGED) {
      insertionsCount++;
    }
  }
  writer.reserveInsertions(insertionsCount);
  final int insertions=insertionsCount;
  return new Reservation(){
    boolean released;
    @Override public void release(){
      if (released) {
        throw new IllegalStateException("Reservation was already released. " + "Previously reserved " + insertions + " insertions");
      }
      writer.removeReservedInsertions(insertions);
      released=true;
    }
  }
;
}
