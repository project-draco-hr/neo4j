{
  LabelScanStorageStrategy.StorageService storage=mock(LabelScanStorageStrategy.StorageService.class);
  IndexSearcher searcher=mock(IndexSearcher.class);
  when(storage.acquireSearcher()).thenReturn(searcher);
  when(searcher.search(new TermQuery(format.rangeTerm(0)),1)).thenReturn(docs());
  when(searcher.search(new TermQuery(format.rangeTerm(1)),1)).thenReturn(null);
  LuceneLabelScanWriter writer=new LuceneLabelScanWriter(storage,format,mock(Lock.class));
  writer.write(labelChanges(0,labels(),labels(6,7)));
  writer.write(labelChanges(1,labels(),labels(6,8)));
  writer.write(labelChanges(1 << format.bitmapFormat().shift,labels(),labels(7)));
  writer.close();
  verify(storage).acquireSearcher();
  verify(storage).releaseSearcher(searcher);
  verify(storage).updateDocument(eq(format.rangeTerm(0)),match(document(format.rangeField(0),format.labelField(6,0x3),format.labelField(7,0x1),format.labelField(8,0x2),format.labelSearchField(8))));
  verify(storage).updateDocument(eq(format.rangeTerm(1)),match(document(format.rangeField(1),format.labelField(7,0x1),format.labelSearchField(7))));
  verify(storage).refreshSearcher();
  verifyNoMoreInteractions(storage);
}
