{
  when(mockedIndexProvider.getPopulator(anyLong())).thenReturn(mock(IndexPopulator.class));
  startDb();
  Label myLabel=label("MyLabel");
  Transaction tx=db.beginTx();
  db.schema().indexCreator(myLabel).on("number_of_bananas_owned").create();
  tx.success();
  tx.finish();
  stopDb();
  when(mockedIndexProvider.getInitialState(anyLong())).thenReturn(InternalIndexState.ONLINE);
  startDb();
  Collection<IndexDefinition> indexes=asCollection(db.schema().getIndexes(myLabel));
  assertThat(indexes.size(),equalTo(1));
  IndexDefinition index=single(indexes);
  assertThat(db.schema().getIndexState(index),equalTo(Schema.IndexState.ONLINE));
  verify(mockedIndexProvider,times(1)).getPopulator(anyLong());
  verify(mockedIndexProvider,times(2)).getWriter(anyLong());
}
