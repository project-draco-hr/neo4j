{
  try (BatchFriendlyNeoStore neoStore=new BatchFriendlyNeoStore(fileSystem,storeDir,config,writeMonitor,logging,monitors)){
    executeStage(new NodeStage(idMapper.wrapNodes(nodes.iterator()),neoStore));
    NodeRelationshipLink nodeRelationshipLink=new NodeRelationshipLinkImpl(LongArrayFactory.AUTO,neoStore.getNodeStore().getHighId(),config.denseNodeThreshold());
    executeStage(new CalculateDenseNodesStage(relationships.iterator(),neoStore,nodeRelationshipLink));
    executeStage(new RelationshipStage(relationships.iterator(),neoStore,nodeRelationshipLink));
    neoStore.switchNodeAndRelationshipStoresToUpdateMode();
    executeStage(new NodeFirstRelationshipStage(neoStore,nodeRelationshipLink));
    nodeRelationshipLink.clearRelationships();
    executeStage(new RelationshipLinkbackStage(neoStore,nodeRelationshipLink));
    executionMonitor.done();
    logger.log("Import completed [TODO import stats]");
  }
 catch (  Throwable t) {
    logger.error("Error during import",t);
    throw Exceptions.launderedException(IOException.class,t);
  }
}
