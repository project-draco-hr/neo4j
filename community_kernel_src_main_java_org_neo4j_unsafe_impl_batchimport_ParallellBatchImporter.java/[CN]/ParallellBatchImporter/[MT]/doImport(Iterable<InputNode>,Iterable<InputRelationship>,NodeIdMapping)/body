{
  long startTime=currentTimeMillis();
  try (BatchingNeoStore neoStore=new BatchingNeoStore(fileSystem,storeDir,config,writeMonitor,logging,writerFactory)){
    NodeIdMapper nodeIdMapper=nodeIdMapping.mapper(neoStore.getNodeStore());
    NodeStage nodeStage=new NodeStage(nodeIdMapper.wrapNodes(nodes.iterator()),neoStore);
    NodeRelationshipLink nodeRelationshipLink=new NodeRelationshipLinkImpl(LongArrayFactory.AUTO,config.denseNodeThreshold());
    CalculateDenseNodesStage calculateDenseNodesStage=new CalculateDenseNodesStage(relationships.iterator(),neoStore,nodeRelationshipLink);
    executeStages(nodeStage,calculateDenseNodesStage);
    executeStages(new RelationshipStage(relationships,neoStore,nodeRelationshipLink));
    neoStore.switchNodeAndRelationshipStoresToReverseUpdatingMode();
    executeStages(new NodeFirstRelationshipStage(neoStore,nodeRelationshipLink));
    nodeRelationshipLink.clearRelationships();
    executeStages(new RelationshipLinkbackStage(neoStore,nodeRelationshipLink));
    executionMonitor.done(currentTimeMillis() - startTime);
    logger.log("Import completed [TODO import stats]");
  }
 catch (  Throwable t) {
    logger.error("Error during import",t);
    throw Exceptions.launderedException(IOException.class,t);
  }
 finally {
    writerFactory.shutdownAndAwaitEverythingWritten();
  }
}
