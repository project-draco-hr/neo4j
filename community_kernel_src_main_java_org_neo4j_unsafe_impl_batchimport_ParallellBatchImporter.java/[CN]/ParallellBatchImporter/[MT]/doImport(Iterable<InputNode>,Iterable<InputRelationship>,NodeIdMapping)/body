{
  try (BatchFriendlyNeoStore neoStore=new BatchFriendlyNeoStore(fileSystem,storeDir,config,logging,monitors)){
    NodeIdMapper nodeIdMapper=nodeIdMapping.mapper(neoStore.getNodeStore());
    executeStage(new NodeStage(nodeIdMapper.wrapNodes(nodes.iterator()),neoStore));
    NodeRelationshipLink nodeRelationshipLink=new NodeRelationshipLinkImpl(LongArrayFactory.AUTO,neoStore.getNodeStore().getHighId(),config.denseNodeThreshold());
    executeStage(new CalculateDenseNodesStage(relationships.iterator(),neoStore,nodeRelationshipLink));
    executeStage(new RelationshipStage(relationships,neoStore,nodeRelationshipLink));
    neoStore.switchNodeAndRelationshipStoresToReverseUpdatingMode();
    executeStage(new NodeFirstRelationshipStage(neoStore,nodeRelationshipLink));
    nodeRelationshipLink.clearRelationships();
    executeStage(new RelationshipLinkbackStage(neoStore,nodeRelationshipLink));
    executionMonitor.done();
    logger.log("Import completed [TODO import stats]");
  }
 catch (  Throwable t) {
    logger.error("Error during import",t);
    throw Exceptions.launderedException(IOException.class,t);
  }
}
