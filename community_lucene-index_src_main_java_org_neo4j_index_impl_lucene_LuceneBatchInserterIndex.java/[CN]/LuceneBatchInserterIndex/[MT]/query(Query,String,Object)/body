{
  IndexSearcher searcher=searcherManager.acquire();
  try {
    Hits hits=new Hits(searcher,query,null);
    HitsIterator result=new HitsIterator(hits);
    if (key == null || this.cache == null || !this.cache.containsKey(key)) {
      return new DocToIdIterator(result,Collections.<Long>emptyList(),null);
    }
 else {
      return new DocToIdIterator(result,Collections.<Long>emptyList(),null){
        private final Collection<Long> ids=new ArrayList<Long>();
        @Override protected Long fetchNextOrNull(){
          Long result=super.fetchNextOrNull();
          if (result != null) {
            ids.add(result);
          }
          return result;
        }
        @Override protected void endReached(){
          super.endReached();
          addToCache(ids,key,value);
        }
      }
;
    }
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
 finally {
    try {
      searcherManager.release(searcher);
    }
 catch (    IOException ignore) {
    }
  }
}
