{
  try {
    Hits hits=new Hits(searcher(),query,null);
    HitsIterator result=new HitsIterator(hits);
    LegacyIndexHits primitiveHits=null;
    if (key == null || this.cache == null || !this.cache.containsKey(key)) {
      primitiveHits=new DocToIdIterator(result,Collections.<Long>emptyList(),null);
    }
 else {
      primitiveHits=new DocToIdIterator(result,Collections.<Long>emptyList(),null){
        private final Collection<Long> ids=new ArrayList<>();
        @Override protected boolean fetchNext(){
          if (super.fetchNext()) {
            ids.add(next);
            return true;
          }
          addToCache(ids,key,value);
          return false;
        }
      }
;
    }
    return wrapIndexHits(primitiveHits);
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
