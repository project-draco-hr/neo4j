{
  try {
    Document document=identifier.entityType.newDocument(entityId);
    for (    Map.Entry<String,Object> entry : properties.entrySet()) {
      String key=entry.getKey();
      Object value=entry.getValue();
      boolean isValueContext=value instanceof ValueContext;
      value=isValueContext ? ((ValueContext)value).getCorrectValue() : value;
      for (      Object oneValue : IoPrimitiveUtils.asArray(value)) {
        oneValue=isValueContext ? oneValue : oneValue.toString();
        type.addToDocument(document,key,oneValue);
        if (createdNow) {
          addToCache(entityId,key,oneValue);
        }
      }
    }
    writer.addDocument(document);
    if (++updateCount == commitBatchSize) {
      writer.commit();
      updateCount=0;
    }
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
