{
  if (configuration.get(generate_graph)) {
    DataGenerator.run(configuration);
  }
  new GraphDatabaseFactory().newEmbeddedDatabase(configuration.get(DataGenerator.store_dir)).shutdown();
  ProgressMonitorFactory progress;
  if (configuration.get(DataGenerator.report_progress)) {
    progress=ProgressMonitorFactory.textual(System.out);
  }
 else {
    progress=ProgressMonitorFactory.NONE;
  }
  if (configuration.get(wait_before_check)) {
    System.out.println("Press return to start the checker...");
    System.in.read();
  }
  Config tuningConfiguration=buildTuningConfiguration(configuration);
  jobScheduler=new Neo4jJobScheduler();
  fileSystem=new DefaultFileSystemAbstraction();
  PageSwapperFactory swapperFactory=new SingleFilePageSwapperFactory(fileSystem);
  Monitors monitors=new Monitors();
  pageCache=new LifecycledPageCache(swapperFactory,jobScheduler,tuningConfiguration,monitors.newMonitor(PageCacheMonitor.class));
  jobScheduler.init();
  pageCache.start();
  DirectStoreAccess directStoreAccess=createScannableStores(configuration.get(DataGenerator.store_dir),tuningConfiguration);
  JsonReportWriter reportWriter=new JsonReportWriter(configuration,tuningConfiguration);
  TimingProgress progressMonitor=new TimingProgress(new TimeLogger(reportWriter),progress);
  try {
    configuration.get(checker_version).run(progressMonitor,directStoreAccess,tuningConfiguration);
  }
  finally {
    directStoreAccess.close();
    pageCache.stop();
    jobScheduler.shutdown();
  }
}
