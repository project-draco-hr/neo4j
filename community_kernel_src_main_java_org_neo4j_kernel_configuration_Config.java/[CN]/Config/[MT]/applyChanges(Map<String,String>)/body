{
  newConfiguration=migrator.apply(newConfiguration,log);
  validator.validate(newConfiguration);
  if (listeners.isEmpty()) {
    params.clear();
    params.putAll(newConfiguration);
  }
 else {
    List<ConfigurationChange> configurationChanges=new ArrayList<>();
    for (    Map.Entry<String,String> stringStringEntry : newConfiguration.entrySet()) {
      String oldValue=params.get(stringStringEntry.getKey());
      String newValue=stringStringEntry.getValue();
      if (!(oldValue == null && newValue == null) && (oldValue == null || newValue == null || !oldValue.equals(newValue))) {
        configurationChanges.add(new ConfigurationChange(stringStringEntry.getKey(),oldValue,newValue));
      }
    }
    if (configurationChanges.isEmpty()) {
      return this;
    }
    params.clear();
    for (    Map.Entry<String,String> entry : newConfiguration.entrySet()) {
      String value=entry.getValue();
      if (value != null) {
        params.put(entry.getKey(),value);
      }
    }
    for (    ConfigurationChangeListener listener : listeners) {
      listener.notifyConfigurationChanges(configurationChanges);
    }
  }
  return this;
}
