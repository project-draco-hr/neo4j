{
  if (dbDir == null) {
    this.dbDir=createTempDir().getAbsolutePath();
  }
  File configFile=buildBefore();
  BufferingConsoleLogger console=new BufferingConsoleLogger();
  Validator validator=new Validator(new DatabaseLocationMustBeSpecifiedRule());
  Configurator configurator=new PropertyFileConfigurator(validator,configFile,console);
  Logging logging=loggingFactory.create(configurator);
  console.replayInto(logging.getConsoleLog(getClass()));
  return new EnterpriseNeoServer(configurator,logging){
    @Override protected PreFlightTasks createPreflightTasks(){
      return preflightTasks;
    }
    @Override protected Database createDatabase(){
      return persistent ? super.createDatabase() : new EphemeralDatabase(configurator);
    }
    @Override protected DatabaseActions createDatabaseActions(){
      return createDatabaseActionsObject(database,configurator);
    }
  }
;
}
