{
  if (dbDir == null) {
    this.dbDir=createTempDir().getAbsolutePath();
  }
  final File configFile=createPropertiesFiles();
  if (preflightTasks == null) {
    preflightTasks=new PreFlightTasks(){
      @Override public boolean run(){
        return true;
      }
    }
;
  }
  return new EnterpriseNeoServer(new PropertyFileConfigurator(new Validator(new DatabaseLocationMustBeSpecifiedRule()),configFile)){
    @Override protected PreFlightTasks createPreflightTasks(){
      return preflightTasks;
    }
    @Override protected Database createDatabase(){
      return persistent ? super.createDatabase() : new EphemeralDatabase(configurator.configuration());
    }
    @Override protected DatabaseActions createDatabaseActions(){
      Clock clockToUse=(clock != null) ? clock : new RealClock();
      return new DatabaseActions(database,new LeaseManager(clockToUse),ForceMode.forced,configurator.configuration().getBoolean(Configurator.SCRIPT_SANDBOXING_ENABLED_KEY,Configurator.DEFAULT_SCRIPT_SANDBOXING_ENABLED));
    }
    @Override public void stop(){
      configFile.delete();
    }
  }
;
}
