{
  if (dbDir == null) {
    this.dbDir=createTempDir().getAbsolutePath();
  }
  File configFile=createPropertiesFiles();
  if (clock != null) {
    LeaseManagerProvider.setClock(clock);
  }
  return new EnterpriseNeoServer(new PropertyFileConfigurator(new Validator(new DatabaseLocationMustBeSpecifiedRule()),configFile)){
    @Override protected PreFlightTasks createPreflightTasks(){
      return preflightTasks;
    }
    @Override protected Database createDatabase(){
      return persistent ? super.createDatabase() : new EphemeralDatabase(configurator.configuration());
    }
  }
;
}
