{
  if (nextElement != null) {
    return true;
  }
  do {
    if (currentTypeIterator.hasNext(nodeManager)) {
      long nextId=currentTypeIterator.next(nodeManager);
      try {
        nextElement=new RelationshipProxy(nextId,nodeManager);
        return true;
      }
 catch (      NotFoundException e) {
      }
    }
    while (!currentTypeIterator.hasNext(nodeManager)) {
      if (typeIterator.hasNext()) {
        currentTypeIterator=typeIterator.next();
      }
 else       if (fromNode.getMoreRelationships(nodeManager)) {
        Map<String,RelTypeElementIterator> newRels=new HashMap<String,RelTypeElementIterator>();
        for (        RelTypeElementIterator itr : rels) {
          RelTypeElementIterator newItr=itr;
          RelIdArray newSrc=fromNode.getRelationshipIds(itr.getType());
          if (newSrc != null) {
            if (itr.isSrcEmpty()) {
              newItr=itr.setSrc(newSrc);
            }
 else             if (newSrc.couldBeNeedingUpdate()) {
              itr.updateSrc(newSrc);
            }
            newItr.notifyAboutMoreRelationships();
          }
          newRels.put(newItr.getType(),newItr);
        }
        if (types.length == 0) {
          for (          RelIdArray ids : fromNode.getRelationshipIds()) {
            String type=ids.getType();
            RelTypeElementIterator itr=newRels.get(type);
            if (itr == null || itr.isSrcEmpty()) {
              itr=itr == null ? new FastRelTypeElement(type,fromNode,ids,direction) : itr.setSrc(ids);
              newRels.put(type,itr);
            }
          }
        }
        rels.clear();
        rels.addAll(newRels.values());
        typeIterator=rels.iterator();
        currentTypeIterator=typeIterator.hasNext() ? typeIterator.next() : RelTypeElementIterator.EMPTY;
      }
 else {
        break;
      }
    }
  }
 while (currentTypeIterator.hasNext(nodeManager));
  return false;
}
