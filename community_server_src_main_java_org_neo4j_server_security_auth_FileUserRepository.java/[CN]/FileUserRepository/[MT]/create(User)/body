{
  if (!isValidName(user.name())) {
    throw new IllegalUsernameException("'" + user.name() + "' is not a valid user name.");
  }
  if (!isValidToken(user.token())) {
    throw new IllegalTokenException("Invalid token");
  }
synchronized (this) {
    for (    User other : users) {
      if (other.name().equals(user.name())) {
        throw new IllegalUsernameException("The specified user already exists");
      }
      if (other.token().equals(user.token())) {
        throw new IllegalTokenException("The specified token is already in use");
      }
    }
    users.add(user);
    commitToDisk();
    usersByName.put(user.name(),user);
    usersByToken.put(user.token(),user);
  }
}
