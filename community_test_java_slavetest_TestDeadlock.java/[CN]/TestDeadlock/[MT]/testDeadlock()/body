{
  initializeDbs(2);
  GraphDatabaseService haDb1=haDbs.get(0);
  GraphDatabaseService haDb2=haDbs.get(1);
  GraphDatabaseService mDb=master.getGraphDb();
  Transaction tx=mDb.beginTx();
  Node node1, node2;
  try {
    node1=mDb.createNode();
    node2=mDb.createNode();
    tx.success();
  }
  finally {
    tx.finish();
  }
  ((HighlyAvailableGraphDatabase)haDb1).pullUpdates();
  ((HighlyAvailableGraphDatabase)haDb2).pullUpdates();
  CountDownLatch barrier1=new CountDownLatch(1);
  CountDownLatch barrier2=new CountDownLatch(1);
  Worker1 w1=new Worker1(haDb1,barrier1,barrier2,node1.getId(),node2.getId());
  w1.start();
  Worker2 w2=new Worker2(haDb1,barrier1,barrier2,node1.getId(),node2.getId());
  w2.start();
  while (w1.isAlive() || w2.isAlive()) {
    Thread.sleep(500);
  }
  boolean case1=w2.successfull && !w2.deadlocked && !w1.successfull&& w1.deadlocked;
  boolean case2=!w2.successfull && w2.deadlocked && w1.successfull&& !w1.deadlocked;
  assertTrue(case1 != case2);
  assertTrue(case1 || case2);
  ((HighlyAvailableGraphDatabase)haDb1).pullUpdates();
  ((HighlyAvailableGraphDatabase)haDb2).pullUpdates();
}
