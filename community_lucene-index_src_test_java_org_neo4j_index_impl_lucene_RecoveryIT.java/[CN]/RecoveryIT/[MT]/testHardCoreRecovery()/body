{
  String path="target/hcdb";
  FileUtils.deleteRecursively(new File(path));
  Process process=Runtime.getRuntime().exec(new String[]{"java","-cp",System.getProperty("java.class.path"),Inserter.class.getName(),path});
  awaitFile(new File(path,"started"));
  Thread.sleep(5000);
  process.destroy();
  process.waitFor();
  final GraphDatabaseService db=new TestGraphDatabaseFactory().newEmbeddedDatabase(path);
  Transaction transaction=db.beginTx();
  try {
    assertTrue(db.index().existsForNodes("myIndex"));
    Index<Node> index=db.index().forNodes("myIndex");
    for (    Node node : GlobalGraphOperations.at(db).getAllNodes()) {
      for (      String key : node.getPropertyKeys()) {
        String value=(String)node.getProperty(key);
        boolean found=false;
        for (        Node indexedNode : index.get(key,value)) {
          if (indexedNode.equals(node)) {
            found=true;
            break;
          }
        }
        if (!found) {
          throw new IllegalStateException(node + " has property '" + key+ "'='"+ value+ "', but not in index");
        }
      }
    }
  }
  finally {
    transaction.finish();
  }
  Thread t=new Thread(){
    @Override public void run(){
      try (Transaction tx=db.beginTx()){
        Index<Node> index=db.index().forNodes("myIndex");
        index.add(db.createNode(),"one","two");
        tx.success();
      }
     }
  }
;
  t.start();
  t.join();
  db.shutdown();
}
