{
  if (commandIndex <= lastCommittedIndex) {
    return Optional.empty();
  }
  Integer tokenId=tokenRegistry.getId(tokenRequest.tokenName());
  if (tokenId == null) {
    try {
      Collection<StorageCommand> commands=ReplicatedTokenRequestSerializer.extractCommands(tokenRequest.commandBytes());
      tokenId=applyToStore(commands,commandIndex);
    }
 catch (    NoSuchEntryException e) {
      throw new IllegalStateException("Commands did not contain token command");
    }
    tokenRegistry.addToken(tokenFactory.newToken(tokenRequest.tokenName(),tokenId));
  }
  return Optional.of(Result.of(tokenId));
}
