{
  final IOException exception=new IOException("simulated IO Exception on create");
  FileSystemAbstraction craschingFileSystem=new DelegatingFileSystemAbstraction(fs){
    @Override public void renameFile(    File oldLocation,    File newLocation,    CopyOption... copyOptions) throws IOException {
      if (roleFile.getName().equals(newLocation.getName())) {
        throw exception;
      }
      super.renameFile(oldLocation,newLocation,copyOptions);
    }
  }
;
  roleRepository=new FileRoleRepository(craschingFileSystem,roleFile,logProvider);
  roleRepository.start();
  RoleRecord role=new RoleRecord("admin","jake");
  try {
    roleRepository.create(role);
    fail("Expected an IOException");
  }
 catch (  IOException e) {
    assertSame(exception,e);
  }
  assertFalse(craschingFileSystem.fileExists(roleFile));
  assertThat(craschingFileSystem.listFiles(roleFile.getParentFile()).length,equalTo(0));
}
