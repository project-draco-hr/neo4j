{
  XidStatus status=xidMap.get(xid);
  if (status == null) {
    throw new XAException("Unknown xid[" + xid + "]");
  }
  TransactionStatus txStatus=status.getTransactionStatus();
  XaTransaction xaTransaction=txStatus.getTransaction();
  if (onePhase) {
    if (!xaTransaction.isReadOnly()) {
      if (!xaTransaction.isRecovered()) {
        xaTransaction.prepare();
        long txId=txIdGenerator.generate(dataSource,xaTransaction.getIdentifier());
        int masterId=txIdGenerator.getCurrentMasterId();
        xaTransaction.setCommitTxId(txId);
        log.commitOnePhase(xaTransaction.getIdentifier(),xaTransaction.getCommitTxId(),masterId);
      }
    }
    txStatus.markAsPrepared();
  }
  if (!txStatus.prepared() || txStatus.rollback()) {
    throw new XAException("Transaction not prepared or " + "(marked as) rolledbacked");
  }
  if (!xaTransaction.isReadOnly()) {
    if (!xaTransaction.isRecovered()) {
      if (!onePhase) {
        long txId=txIdGenerator.generate(dataSource,xaTransaction.getIdentifier());
        int masterId=txIdGenerator.getCurrentMasterId();
        xaTransaction.setCommitTxId(txId);
        log.commitTwoPhase(xaTransaction.getIdentifier(),xaTransaction.getCommitTxId(),masterId);
      }
    }
    txStatus.markCommitStarted();
    if (xaTransaction.isRecovered() && xaTransaction.getCommitTxId() == -1) {
      boolean previousRecoveredValue=dataSource.setRecovered(true);
      try {
        xaTransaction.setCommitTxId(dataSource.getLastCommittedTxId() + 1);
      }
  finally {
        dataSource.setRecovered(previousRecoveredValue);
      }
    }
    xaTransaction.commit();
  }
  if (!xaTransaction.isRecovered()) {
    log.done(xaTransaction.getIdentifier());
  }
 else   if (!log.scanIsComplete() || recoveredTxCount > 0) {
    recoveredDoneRecords.add(Triplet.of(xaTransaction.getIdentifier(),onePhase,xaTransaction.getCommitTxId()));
  }
  xidMap.remove(xid);
  if (xaTransaction.isRecovered()) {
    recoveredTxCount--;
    checkIfRecoveryComplete();
  }
  return xaTransaction;
}
