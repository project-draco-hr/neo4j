{
  XaTransaction xaTransaction;
  TransactionStatus txStatus;
  boolean isReadOnly;
  XidStatus status=xidMap.get(xid);
  if (status == null) {
    throw new XAException("Unknown xid[" + xid + "]");
  }
  txStatus=status.getTransactionStatus();
  xaTransaction=txStatus.getTransaction();
  isReadOnly=xaTransaction.isReadOnly();
  if (onePhase && (!isReadOnly && !xaTransaction.isRecovered())) {
    prepareKernelTx(xaTransaction);
    isReadOnly=xaTransaction.isReadOnly();
  }
synchronized (this) {
    if (isReadOnly) {
      commitReadTx(xid,onePhase,xaTransaction,txStatus);
    }
 else {
      commitWriteTx(xid,onePhase,xaTransaction,txStatus,txIdGenerator);
    }
  }
  commitKernelTx(xaTransaction);
  if (!xaTransaction.isRecovered() && !isReadOnly) {
    try {
      txIdGenerator.committed(dataSource,xaTransaction.getIdentifier(),xaTransaction.getCommitTxId(),null);
    }
 catch (    Exception e) {
      throw new CommitNotificationFailedException(e);
    }
  }
  return xaTransaction;
}
