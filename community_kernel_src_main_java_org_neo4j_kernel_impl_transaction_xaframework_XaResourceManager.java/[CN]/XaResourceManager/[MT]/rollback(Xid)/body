{
  XidStatus status=xidMap.get(xid);
  if (status == null) {
    throw new XAException("Unknown xid[" + xid + "]");
  }
  TransactionStatus txStatus=status.getTransactionStatus();
  XaTransaction xaTransaction=txStatus.getTransaction();
  checkStartWritten(txStatus,xaTransaction);
  if (txStatus.commitStarted()) {
    throw new XAException("Transaction already started commit");
  }
  txStatus.markAsRollback();
  xaTransaction.rollback();
  rollbackKernelTx(xaTransaction);
  log.done(xaTransaction.getIdentifier());
  xidMap.remove(xid);
  if (xaTransaction.isRecovered()) {
    oneMoreTransactionRecovered();
  }
  return txStatus.getTransaction();
}
