{
  BoltStateMachine machine=newMachine(READY);
  machine.run("BEGIN",EMPTY_PARAMS,new NullResponseHandler());
  machine.discardAll(new NullResponseHandler());
  TransactionStateMachine txMachine=(TransactionStateMachine)machine.ctx.statementProcessor;
  doThrow(new TransactionFailureException("No Mr. Bond, I expect you to die.")).when(txMachine.ctx.currentTransaction).close();
  machine.run("ROLLBACK",EMPTY_PARAMS,new NullResponseHandler());
  machine.discardAll(new NullResponseHandler());
  assertThat(machine,inState(FAILED));
}
