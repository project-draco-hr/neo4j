{
  if (!SCHEME.equals(authToken.get(SCHEME_KEY))) {
    throw new AuthenticationException(Status.Security.Unauthorized,"Authentication token must contain: '" + SCHEME_KEY + " : "+ SCHEME+ "'");
  }
  String user=safeCast(PRINCIPAL,authToken);
  String password=safeCast(CREDENTIALS,authToken);
  if (authToken.containsKey(NEW_CREDENTIALS)) {
    return update(user,password,safeCast(NEW_CREDENTIALS,authToken));
  }
 else {
    return authenticate(user,password);
  }
}
