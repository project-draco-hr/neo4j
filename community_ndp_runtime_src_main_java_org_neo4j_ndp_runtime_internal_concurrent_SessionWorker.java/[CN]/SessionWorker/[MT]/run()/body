{
  keepRunning=true;
  ArrayList<Consumer<Session>> batch=new ArrayList<>(workQueueSize);
  try {
    while (keepRunning) {
      Consumer<Session> work=workQueue.poll(10,TimeUnit.SECONDS);
      if (work != null) {
        execute(work);
        for (int items=workQueue.drainTo(batch); keepRunning && items > 0; items=workQueue.drainTo(batch)) {
          executeBatch(batch);
        }
      }
    }
  }
 catch (  Throwable e) {
    log.error("Worker for session '" + session.key() + "' crashed: "+ e.getMessage(),e);
    userLog.error("Fatal, worker for session '" + session.key() + "' crashed. Please"+ " contact your support representative if you are unable to resolve this error. Error "+ "message was: "+ e.getMessage());
    session.close();
  }
}
