{
  commit();
  List<TransactionEventHandler<Object>> handlers=new ArrayList<TransactionEventHandler<Object>>();
  handlers.add(new FailingEventHandler<Object>(new DummyTransactionEventHandler<Object>(null),false));
  handlers.add(new FailingEventHandler<Object>(new DummyTransactionEventHandler<Object>(null),false));
  handlers.add(new FailingEventHandler<Object>(new DummyTransactionEventHandler<Object>(null),true));
  handlers.add(new FailingEventHandler<Object>(new DummyTransactionEventHandler<Object>(null),false));
  for (  TransactionEventHandler<Object> handler : handlers) {
    getGraphDb().registerTransactionEventHandler(handler);
  }
  try {
    newTransaction();
    try {
      commit();
      fail("Should fail commit");
    }
 catch (    TransactionFailureException e) {
    }
    verifyHandlerCalls(handlers,false);
    getGraphDb().unregisterTransactionEventHandler(handlers.remove(2));
    for (    TransactionEventHandler<Object> handler : handlers) {
      ((DummyTransactionEventHandler<Object>)((FailingEventHandler<Object>)handler).source).reset();
    }
    newTransaction();
    commit();
    verifyHandlerCalls(handlers,true);
  }
  finally {
    for (    TransactionEventHandler<Object> handler : handlers) {
      getGraphDb().unregisterTransactionEventHandler(handler);
    }
  }
}
