{
  List<RelationshipRecord> relationshipRecords=new ArrayList<>(batch.size());
  for (  InputRelationship batchRelationship : batch) {
    long relationshipId=batchRelationship.id();
    relationshipStore.setHighestPossibleIdInUse(relationshipId);
    long startNodeId=idMapper.get(batchRelationship.startNode());
    long endNodeId=idMapper.get(batchRelationship.endNode());
    int typeId=batchRelationship.hasTypeId() ? batchRelationship.typeId() : relationshipTypeRepository.getOrCreateId(batchRelationship.type());
    RelationshipRecord relationshipRecord=new RelationshipRecord(relationshipId,startNodeId,endNodeId,typeId);
    relationshipRecord.setInUse(true);
    long firstNextRel=nodeRelationshipLink.getAndPutRelationship(startNodeId,typeId,batchRelationship.startDirection(),relationshipId,true);
    relationshipRecord.setFirstNextRel(firstNextRel);
    if (batchRelationship.isLoop()) {
      relationshipRecord.setSecondNextRel(firstNextRel);
    }
 else {
      relationshipRecord.setSecondNextRel(nodeRelationshipLink.getAndPutRelationship(endNodeId,typeId,INCOMING,relationshipId,true));
    }
    relationshipRecord.setFirstInFirstChain(false);
    relationshipRecord.setFirstInSecondChain(false);
    relationshipRecord.setFirstPrevRel(Record.NO_NEXT_RELATIONSHIP.intValue());
    relationshipRecord.setSecondPrevRel(Record.NO_NEXT_RELATIONSHIP.intValue());
    relationshipRecords.add(relationshipRecord);
  }
  return new RecordBatch<>(relationshipRecords,batch);
}
