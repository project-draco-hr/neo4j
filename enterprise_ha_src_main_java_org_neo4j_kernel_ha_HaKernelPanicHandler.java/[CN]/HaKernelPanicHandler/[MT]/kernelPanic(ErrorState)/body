{
  if (error == ErrorState.TX_MANAGER_NOT_OK) {
    try {
      int myEpoch=epoch.get();
synchronized (dataSourceManager) {
        if (myEpoch != epoch.get()) {
          return;
        }
        logger.info("Recovering from HA kernel panic");
        epoch.incrementAndGet();
        availabilityGuard.deny(this);
        try {
          txManager.stop();
          dataSourceManager.stop();
          dataSourceManager.start();
          txManager.start();
          txManager.doRecovery();
          masterDelegateInvocationHandler.harden();
        }
  finally {
          availabilityGuard.grant(this);
          logger.info("Done recovering from HA kernel panic");
        }
      }
    }
 catch (    Throwable t) {
      String msg="Error while handling HA kernel panic";
      logger.warn(msg,t);
      throw new RuntimeException(msg,t);
    }
  }
 else   if (error == ErrorState.STORAGE_MEDIA_FULL) {
    availabilityGuard.shutdown();
  }
}
