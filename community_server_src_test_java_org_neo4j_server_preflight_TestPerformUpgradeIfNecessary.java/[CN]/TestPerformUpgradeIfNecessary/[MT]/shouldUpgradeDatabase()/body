{
  Config serverConfig=buildProperties(true);
  prepareSampleLegacyDatabase(STORE_DIRECTORY);
  Monitor monitor=mock(Monitor.class);
  TestLogging logging=new TestLogging();
  PerformUpgradeIfNecessary upgrader=new PerformUpgradeIfNecessary(serverConfig,loadNeo4jProperties(),logging,monitor);
  boolean success=upgrader.run();
  if (!success) {
    TestLogPrinter testLogPrinter=new TestLogPrinter();
    logging.visitConsoleLog(upgrader.getClass(),testLogPrinter);
    logging.visitMessagesLog(upgrader.getClass(),testLogPrinter);
    fail();
  }
  InOrder order=inOrder(monitor);
  order.verify(monitor,times(1)).migrationNeeded();
  order.verify(monitor,times(1)).migrationCompleted();
  order.verifyNoMoreInteractions();
  logging.getMessagesLog(ParallelBatchImporter.class).assertAtLeastOnce(info("Import completed"));
}
