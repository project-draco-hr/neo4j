{
  Config serverConfig=buildProperties(true);
  prepareSampleLegacyDatabase(storeDir);
  Monitor monitor=mock(Monitor.class);
  ByteArrayOutputStream outputStream=new ByteArrayOutputStream();
  AssertableLogProvider assertableLogProvider=new AssertableLogProvider();
  LogProvider logProvider=new DuplicatingLogProvider(FormattedLogProvider.toOutputStream(outputStream),assertableLogProvider);
  PerformUpgradeIfNecessary upgrader=new PerformUpgradeIfNecessary(serverConfig,loadNeo4jProperties(),logProvider,monitor);
  boolean success=upgrader.run();
  if (!success) {
    System.out.write(outputStream.toByteArray());
    fail();
  }
  InOrder order=inOrder(monitor);
  order.verify(monitor,times(1)).migrationNeeded();
  order.verify(monitor,times(1)).migrationCompleted();
  order.verifyNoMoreInteractions();
  assertableLogProvider.assertContainsMessageContaining("Migration completed");
}
