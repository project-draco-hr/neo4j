{
  AbstractGraphDatabase db=database.graph;
  Transaction tx=db.beginTx();
  try {
    List<Object> operations=input.readList(body);
    List<BatchOperationRepresentation> results=new ArrayList<BatchOperationRepresentation>(operations.size());
    InternalJettyServletRequest request=new InternalJettyServletRequest();
    InternalJettyServletResponse response=new InternalJettyServletResponse();
    String servletBaseUrl=uriInfo.getBaseUri().toString();
    String servletPath=uriInfo.getBaseUri().getPath();
    servletBaseUrl=servletBaseUrl.substring(0,servletBaseUrl.length() - 1);
    String opBody, opMethod, opPath;
    Integer opId;
    Map<String,Object> op;
    for (    Object rawOperation : operations) {
      op=(Map<String,Object>)rawOperation;
      opMethod=(String)op.get(METHOD_KEY);
      opPath=(String)op.get(TO_KEY);
      opBody=op.containsKey(BODY_KEY) ? JsonHelper.createJsonFrom(op.get(BODY_KEY)) : "";
      opId=op.containsKey(ID_KEY) ? (Integer)op.get(ID_KEY) : null;
      if (!opPath.startsWith("/")) {
        opPath="/" + opPath;
      }
      request.setup(opMethod,new HttpURI(servletBaseUrl + opPath),opBody,new Cookie[]{});
      response.setup();
      System.out.println("_____" + stripDoubleSlashes(servletPath + opPath));
      webServer.invokeDirectly(stripDoubleSlashes(servletPath + opPath),request,response);
      System.out.println(response.getStatus());
      if (is2XXStatusCode(response.getStatus())) {
        results.add(new BatchOperationRepresentation(opId,opPath,response.getOutputStream().toString(),response.getHeaders()));
      }
 else {
        tx.failure();
        return output.badRequest(new RuntimeException(response.getReason()));
      }
    }
    tx.success();
    return output.ok(BatchOperationRepresentation.list(results));
  }
 catch (  Exception e) {
    tx.failure();
    return output.badRequest(e);
  }
 finally {
    tx.finish();
  }
}
