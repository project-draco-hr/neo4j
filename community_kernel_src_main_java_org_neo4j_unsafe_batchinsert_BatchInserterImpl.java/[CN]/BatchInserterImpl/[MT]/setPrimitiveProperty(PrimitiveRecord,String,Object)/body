{
  boolean result=false;
  long nextProp=primitive.getNextProp();
  int index=getOrCreatePropertyKeyId(name);
  PropertyBlock block=new PropertyBlock();
  getPropertyStore().encodeValue(block,index,value);
  int size=block.getSize();
  PropertyRecord current, thatFits=null, thatHas=null;
  while (!(nextProp == Record.NO_NEXT_PROPERTY.intValue() || (thatHas != null && thatFits != null))) {
    current=getPropertyStore().getRecord(nextProp);
    if (thatHas == null && current.getPropertyBlock(index) != null) {
      thatHas=current;
      PropertyBlock removed=thatHas.removePropertyBlock(index);
      getPropertyStore().ensureHeavy(removed);
      for (      DynamicRecord dynRec : removed.getValueRecords()) {
        thatHas.addDeletedRecord(dynRec);
      }
      getPropertyStore().updateRecord(thatHas);
    }
    if (thatFits == null && (PropertyType.getPayloadSize() - current.size() >= size)) {
      thatFits=current;
    }
    nextProp=current.getNextProp();
  }
  if (thatFits == null) {
    thatFits=new PropertyRecord(getPropertyStore().nextId());
    thatFits.setInUse(true);
    result=true;
    if (primitive.getNextProp() != Record.NO_NEXT_PROPERTY.intValue()) {
      PropertyRecord first=getPropertyStore().getRecord(primitive.getNextProp());
      thatFits.setNextProp(first.getId());
      first.setPrevProp(thatFits.getId());
      getPropertyStore().updateRecord(first);
    }
    primitive.setNextProp(thatFits.getId());
  }
  thatFits.addPropertyBlock(block);
  getPropertyStore().updateRecord(thatFits);
  return result;
}
