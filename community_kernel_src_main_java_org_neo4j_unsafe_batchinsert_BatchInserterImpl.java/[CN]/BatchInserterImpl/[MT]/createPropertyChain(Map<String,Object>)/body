{
  if (properties == null || properties.isEmpty()) {
    return Record.NO_NEXT_PROPERTY.intValue();
  }
  PropertyStore propStore=getPropertyStore();
  List<PropertyRecord> propRecords=new ArrayList<>();
  PropertyRecord currentRecord=new PropertyRecord(propStore.nextId());
  currentRecord.setInUse(true);
  currentRecord.setCreated();
  propRecords.add(currentRecord);
  for (  Entry<String,Object> entry : properties.entrySet()) {
    int keyId=propertyKeyTokens.idOf(entry.getKey());
    if (keyId == -1) {
      keyId=createNewPropertyKeyId(entry.getKey());
    }
    PropertyBlock block=new PropertyBlock();
    propStore.encodeValue(block,keyId,entry.getValue());
    if (currentRecord.size() + block.getSize() > PropertyType.getPayloadSize()) {
      PropertyRecord prevRecord=currentRecord;
      long propertyId=propStore.nextId();
      currentRecord=new PropertyRecord(propertyId);
      currentRecord.setInUse(true);
      currentRecord.setCreated();
      prevRecord.setNextProp(propertyId);
      currentRecord.setPrevProp(prevRecord.getId());
      propRecords.add(currentRecord);
    }
    currentRecord.addPropertyBlock(block);
  }
  for (int i=propRecords.size() - 1; i >= 0; i--) {
    propStore.updateRecord(propRecords.get(i));
  }
  return propRecords.get(0).getId();
}
