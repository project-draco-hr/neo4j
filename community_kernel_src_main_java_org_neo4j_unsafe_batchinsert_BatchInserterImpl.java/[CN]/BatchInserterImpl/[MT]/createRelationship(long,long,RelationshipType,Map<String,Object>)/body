{
  NodeRecord firstNode=getNodeRecord(node1);
  NodeRecord secondNode=getNodeRecord(node2);
  int typeId=relationshipTypeTokens.idOf(type.name());
  if (typeId == -1) {
    typeId=createNewRelationshipType(type.name());
  }
  long id=getRelationshipStore().nextId();
  RelationshipRecord record=new RelationshipRecord(id,node1,node2,typeId);
  record.setInUse(true);
  record.setCreated();
  record.setFirstPrevRel(Record.NO_PREV_RELATIONSHIP.intValue());
  record.setSecondPrevRel(Record.NO_PREV_RELATIONSHIP.intValue());
  record.setFirstInFirstChain(false);
  record.setFirstInSecondChain(false);
  connectRelationship(firstNode,secondNode,record);
  getNodeStore().updateRecord(firstNode);
  getNodeStore().updateRecord(secondNode);
  record.setNextProp(createPropertyChain(properties));
  getRelationshipStore().updateRecord(record);
  return id;
}
