{
  rejectAutoUpgrade(stringParams);
  Map<String,String> params=getDefaultParams();
  params.putAll(stringParams);
  config=StoreFactory.configForStoreDir(new Config(params,GraphDatabaseSettings.class),new File(storeDir));
  Monitors monitors=new Monitors();
  life=new LifeSupport();
  this.fileSystem=fileSystem;
  this.storeDir=new File(FileUtils.fixSeparatorsInPath(storeDir));
  Neo4jJobScheduler jobScheduler=life.add(new Neo4jJobScheduler());
  PageSwapperFactory swapperFactory=new SingleFilePageSwapperFactory(fileSystem);
  LifecycledPageCache pageCache=life.add(new LifecycledPageCache(swapperFactory,jobScheduler,config,monitors.newMonitor(PageCacheMonitor.class)));
  msgLog=StringLogger.loggerDirectory(fileSystem,this.storeDir);
  logging=new SingleLoggingService(msgLog);
  storeLocker=new StoreLocker(fileSystem);
  storeLocker.checkLock(this.storeDir);
  boolean dump=config.get(GraphDatabaseSettings.dump_configuration);
  this.idGeneratorFactory=new DefaultIdGeneratorFactory();
  StoreFactory sf=new StoreFactory(config,idGeneratorFactory,pageCache,fileSystem,msgLog,monitors);
  if (dump) {
    dumpConfiguration(params);
  }
  msgLog.logMessage(Thread.currentThread() + " Starting BatchInserter(" + this+ ")");
  neoStore=sf.newNeoStore(true);
  if (!neoStore.isStoreOk()) {
    throw new IllegalStateException(storeDir + " store is not cleanly shutdown.");
  }
  neoStore.makeStoreOk();
  Token[] indexes=getPropertyKeyTokenStore().getTokens(10000);
  propertyKeyTokens=new BatchTokenHolder(indexes);
  labelTokens=new BatchTokenHolder(neoStore.getLabelTokenStore().getTokens(Integer.MAX_VALUE));
  Token[] types=getRelationshipTypeStore().getTokens(Integer.MAX_VALUE);
  relationshipTypeTokens=new BatchTokenHolder(types);
  indexStore=life.add(new IndexConfigStore(this.storeDir,fileSystem));
  schemaCache=new SchemaCache(neoStore.getSchemaStore());
  KernelExtensions extensions=life.add(new KernelExtensions(kernelExtensions,config,new DependencyResolverImpl(),UnsatisfiedDependencyStrategies.ignore()));
  life.start();
  SchemaIndexProvider provider=extensions.resolveDependency(SchemaIndexProvider.class,SchemaIndexProvider.HIGHEST_PRIORITIZED_OR_NONE);
  schemaIndexProviders=new DefaultSchemaIndexProviderMap(provider);
  labelScanStore=life.add(extensions.resolveDependency(LabelScanStoreProvider.class,LabelScanStoreProvider.HIGHEST_PRIORITIZED).getLabelScanStore());
  actions=new BatchSchemaActions();
  recordAccess=new DirectRecordAccessSet(neoStore);
  relationshipCreator=new RelationshipCreator(RelationshipLocker.NO_LOCKING,new RelationshipGroupGetter(neoStore.getRelationshipGroupStore()),neoStore.getDenseNodeThreshold());
  propertyTraverser=new PropertyTraverser();
  propertyCreator=new PropertyCreator(getPropertyStore(),propertyTraverser);
  propertyDeletor=new PropertyDeleter(getPropertyStore(),propertyTraverser);
}
