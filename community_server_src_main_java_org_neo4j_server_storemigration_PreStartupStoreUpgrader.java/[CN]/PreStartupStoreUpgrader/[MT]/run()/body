{
  try {
    Configurator configurator=getConfigurator();
    HashMap<Object,Object> config=new HashMap<Object,Object>(configurator.getDatabaseTuningProperties());
    String dbLocation=new File(configurator.configuration().getString(Configurator.DATABASE_LOCATION_PROPERTY_KEY)).getAbsolutePath();
    if (new CurrentDatabase().storeFilesAtCurrentVersion(new File(dbLocation))) {
      return 0;
    }
    String separator=System.getProperty("file.separator");
    String store=dbLocation + separator + NeoStore.DEFAULT_NAME;
    config.put("store_dir",dbLocation);
    config.put("neo_store",store);
    config.put(IdGeneratorFactory.class,CommonFactories.defaultIdGeneratorFactory());
    config.put(FileSystemAbstraction.class,CommonFactories.defaultFileSystemAbstraction());
    if (!new UpgradableDatabase().storeFilesUpgradeable(new File(store))) {
      logger.info("Store files missing, or not in suitable state for upgrade. " + "Leaving this problem for main server process to resolve.");
      return 0;
    }
    StoreUpgrader storeUpgrader=new StoreUpgrader(config,new ConfigMapUpgradeConfiguration(config),new UpgradableDatabase(),new StoreMigrator(new VisibleMigrationProgressMonitor(out)),new DatabaseFiles());
    try {
      storeUpgrader.attemptUpgrade(store);
    }
 catch (    UpgradeNotAllowedByConfigurationException e) {
      logger.info(e.getMessage());
      out.println(e.getMessage());
      return 1;
    }
catch (    StoreUpgrader.UnableToUpgradeException e) {
      logger.error(e);
      return 1;
    }
    return 0;
  }
 catch (  Exception e) {
    logger.error(e);
    return 1;
  }
}
