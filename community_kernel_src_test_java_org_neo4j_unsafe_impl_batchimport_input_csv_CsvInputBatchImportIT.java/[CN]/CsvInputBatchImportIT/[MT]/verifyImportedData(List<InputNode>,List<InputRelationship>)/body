{
  Map<String,InputNode> expectedNodes=new HashMap<>();
  Set<String> expectedNodeNames=new HashSet<>();
  Map<String,Map<String,Map<String,AtomicInteger>>> expectedRelationships=new HashMap<>();
  buildUpExpectedData(nodeData,relationshipData,expectedNodes,expectedNodeNames,expectedRelationships);
  GraphDatabaseService db=new GraphDatabaseFactory().newEmbeddedDatabase(directory.absolutePath());
  try (Transaction tx=db.beginTx()){
    for (    Node node : GlobalGraphOperations.at(db).getAllNodes()) {
      String name=(String)node.getProperty("name");
      assertTrue(expectedNodeNames.remove(name));
    }
    assertEquals(0,expectedNodeNames.size());
    for (    Relationship relationship : GlobalGraphOperations.at(db).getAllRelationships()) {
      String startNodeName=(String)relationship.getStartNode().getProperty("name");
      Map<String,Map<String,AtomicInteger>> inner=expectedRelationships.get(startNodeName);
      String endNodeName=(String)relationship.getEndNode().getProperty("name");
      Map<String,AtomicInteger> innerInner=inner.get(endNodeName);
      String type=relationship.getType().name();
      AtomicInteger count=innerInner.get(type);
      int countAfterwards=count.decrementAndGet();
      assertThat(countAfterwards,greaterThanOrEqualTo(0));
      if (countAfterwards == 0) {
        innerInner.remove(type);
        if (innerInner.isEmpty()) {
          inner.remove(endNodeName);
          if (inner.isEmpty()) {
            expectedRelationships.remove(startNodeName);
          }
        }
      }
    }
    assertEquals(0,expectedRelationships.size());
    tx.success();
  }
  finally {
    db.shutdown();
  }
}
