{
  propertyRecords.close();
  long highestId=0;
  RECORD[] records=batch.records;
  if (records.length == 0) {
    return;
  }
  int propertyBlockCursor=0, skipped=0;
  for (int i=0; i < records.length; i++) {
    RECORD record=records[i];
    int propertyBlockCount=batch.propertyBlocksLengths[i];
    if (record != null) {
      INPUT input=batch.input[i];
      if (input.hasFirstPropertyId()) {
        record.setNextProp(input.firstPropertyId());
      }
 else {
        if (propertyBlockCount > 0) {
          reassignDynamicRecordIds(batch.propertyBlocks,propertyBlockCursor,propertyBlockCount);
          long firstProp=propertyCreator.createPropertyChain(record,blockIterator.dressArray(batch.propertyBlocks,propertyBlockCursor,propertyBlockCount),propertyRecords);
          record.setNextProp(firstProp);
        }
      }
      highestId=max(highestId,record.getId());
      entityStore.prepareForCommit(record);
      entityStore.updateRecord(record);
    }
 else {
      skipped++;
    }
    propertyBlockCursor+=propertyBlockCount;
  }
  entityStore.setHighestPossibleIdInUse(highestId);
  for (  PropertyRecord propertyRecord : propertyRecords.records()) {
    propertyStore.updateRecord(propertyRecord);
  }
  monitor.entitiesWritten(records[0].getClass(),records.length - skipped);
  monitor.propertiesWritten(propertyBlockCursor);
  sender.send(EMPTY);
}
