{
  if (bufferPos >= bufferEnd) {
    if (seekStartPos == 0 && bufferEnd == charBuffer.capacity()) {
      throw new IllegalStateException("Tried to read in a value larger than buffer size " + buffer.length);
    }
    charBuffer.position(seekStartPos);
    charBuffer.limit(bufferPos);
    charBuffer.compact();
    charBuffer.limit(charBuffer.capacity());
    int remaining=charBuffer.remaining();
    int read=reader.read(buffer,charBuffer.position(),remaining);
    if (read <= 0) {
      buffer[charBuffer.position() + max(read,0)]=EOF_CHAR;
    }
    bufferPos=charBuffer.position();
    seekStartPos=0;
    bufferEnd=bufferPos + max(read,0);
  }
}
