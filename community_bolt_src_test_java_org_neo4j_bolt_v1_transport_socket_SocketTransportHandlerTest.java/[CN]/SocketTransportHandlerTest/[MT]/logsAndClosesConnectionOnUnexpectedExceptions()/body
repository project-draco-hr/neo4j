{
  BoltStateMachine machine=mock(BoltStateMachine.class);
  Channel ch=mock(Channel.class);
  ChannelHandlerContext ctx=mock(ChannelHandlerContext.class);
  when(ctx.channel()).thenReturn(ch);
  when(ch.alloc()).thenReturn(UnpooledByteBufAllocator.DEFAULT);
  when(ctx.alloc()).thenReturn(UnpooledByteBufAllocator.DEFAULT);
  AssertableLogProvider logging=new AssertableLogProvider();
  SocketTransportHandler handler=new SocketTransportHandler(protocolChooser(machine),logging);
  handler.channelRead(ctx,handshake());
  Throwable cause=new Throwable("Oh no!");
  handler.exceptionCaught(ctx,cause);
  verify(machine).close();
  logging.assertExactly(inLog(SocketTransportHandler.class).error(equalTo("Fatal error occurred when handling a client connection: Oh no!"),is(cause)));
}
