{
  long now=System.currentTimeMillis();
  long timeout=now + unit.toMillis(duration);
  do {
    IndexState state=getIndexState(index);
switch (state) {
case ONLINE:
      return;
case FAILED:
    throw new IllegalStateException("Index did not come online but entered the FAILED state instead");
default :
  Thread.yield();
break;
}
}
 while (System.currentTimeMillis() < timeout);
throw new IllegalStateException("Expected index to come online within a reasonable time.");
}
