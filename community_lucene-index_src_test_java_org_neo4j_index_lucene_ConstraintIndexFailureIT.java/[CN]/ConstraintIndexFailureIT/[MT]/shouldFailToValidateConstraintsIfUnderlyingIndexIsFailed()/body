{
  dbWithConstraint();
  storeIndexFailure("Injected failure");
  GraphDatabaseService db=startDatabase();
  try {
    Transaction tx=db.beginTx();
    try {
      db.createNode(label("Label1")).setProperty("key1","value1");
      fail("expected exception");
    }
 catch (    ConstraintViolationException e) {
      assertThat(e.getCause(),instanceOf(UnableToValidateConstraintKernelException.class));
      assertThat(e.getCause().getCause().getMessage(),equalTo("The index is in a failed state: 'Injected failure'."));
    }
 finally {
      tx.finish();
    }
  }
  finally {
    db.shutdown();
  }
}
