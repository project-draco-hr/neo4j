{
  org.neo4j.kernel.impl.util.Dependencies dependencies=platformModule.dependencies;
  Config config=platformModule.config;
  LogService logging=platformModule.logging;
  FileSystemAbstraction fileSystem=platformModule.fileSystem;
  File storeDir=platformModule.storeDir;
  LifeSupport life=platformModule.life;
  GraphDatabaseFacade graphDatabaseFacade=platformModule.graphDatabaseFacade;
  LogProvider logProvider=logging.getInternalLogProvider();
  CoreDiscoveryService discoveryService=discoveryServiceFactory.coreDiscoveryService(config);
  life.add(dependencies.satisfyDependency(discoveryService));
  final CoreReplicatedContentMarshal marshall=new CoreReplicatedContentMarshal();
  final SenderService senderService=new SenderService(new ExpiryScheduler(platformModule.jobScheduler),new Expiration(SYSTEM_CLOCK),new RaftChannelInitializer(marshall),logProvider);
  life.add(senderService);
  final CoreMember myself=new CoreMember(config.get(CoreEdgeClusterSettings.transaction_advertised_address),config.get(CoreEdgeClusterSettings.raft_advertised_address));
  final MessageLogger<AdvertisedSocketAddress> messageLogger=new BetterMessageLogger<>(myself.getRaftAddress(),raftMessagesLog(storeDir));
  LoggingOutbound<AdvertisedSocketAddress> loggingOutbound=new LoggingOutbound<>(senderService,myself.getRaftAddress(),messageLogger);
  ListenSocketAddress raftListenAddress=config.get(CoreEdgeClusterSettings.raft_listen_address);
  RaftServer<CoreMember> raftServer=new RaftServer<>(marshall,raftListenAddress,logProvider);
  final DelayedRenewableTimeoutService raftTimeoutService=new DelayedRenewableTimeoutService();
  File raftLogsDirectory=createRaftLogsDirectory(platformModule.storeDir,fileSystem);
  NaiveDurableRaftLog raftLog=new NaiveDurableRaftLog(fileSystem,raftLogsDirectory,new RaftContentSerializer(),platformModule.monitors);
  DurableTermStore termStore=new DurableTermStore(fileSystem,raftLogsDirectory);
  DurableVoteStore voteStore=new DurableVoteStore(fileSystem,raftLogsDirectory);
  life.add(raftLog);
  life.add(termStore);
  life.add(voteStore);
  raft=createRaft(life,loggingOutbound,discoveryService,config,messageLogger,raftLog,termStore,voteStore,myself,logProvider,raftServer,raftTimeoutService);
  RaftReplicator<CoreMember> replicator=new RaftReplicator<>(raft,myself,new RaftOutbound(loggingOutbound));
  LocalSessionPool localSessionPool=new LocalSessionPool(myself);
  GlobalSessionTracker sessionTracker=new GlobalSessionTracker();
  commitProcessFactory=createCommitProcessFactory(replicator,localSessionPool,sessionTracker,dependencies);
  ReplicatedIdAllocationStateMachine idAllocationStateMachine=new ReplicatedIdAllocationStateMachine(myself);
  replicator.subscribe(idAllocationStateMachine);
  ReplicatedIdRangeAcquirer idRangeAcquirer=new ReplicatedIdRangeAcquirer(replicator,idAllocationStateMachine,1024,1000,myself,logProvider);
  raftLog.registerListener(replicator);
  long electionTimeout=config.get(CoreEdgeClusterSettings.leader_election_timeout);
  MembershipWaiter<CoreMember> membershipWaiter=new MembershipWaiter<>(myself,platformModule.jobScheduler,electionTimeout);
  CoreServiceRegistry coreServices=new CoreServiceRegistry(SYSTEM_CLOCK);
  raft.registerLeadershipChangeListener(new CoreServiceManager(replicator,coreServices,myself,logProvider));
  ReplicatedIdGeneratorFactory replicatedIdGeneratorFactory=createIdGeneratorFactory(fileSystem,idRangeAcquirer,logProvider);
  this.idGeneratorFactory=dependencies.satisfyDependency(replicatedIdGeneratorFactory);
  this.relationshipTypeTokenHolder=life.add(dependencies.satisfyDependency(new ReplicatedRelationshipTypeTokenHolder(replicator,this.idGeneratorFactory,dependencies)));
  this.propertyKeyTokenHolder=life.add(dependencies.satisfyDependency(new ReplicatedPropertyKeyTokenHolder(replicator,this.idGeneratorFactory,dependencies)));
  this.labelTokenHolder=life.add(dependencies.satisfyDependency(new ReplicatedLabelTokenHolder(replicator,this.idGeneratorFactory,dependencies)));
  dependencies.satisfyDependency(createKernelData(fileSystem,platformModule.pageCache,storeDir,config,graphDatabaseFacade,life));
  headerInformationFactory=createHeaderInformationFactory();
  schemaWriteGuard=createSchemaWriteGuard();
  transactionStartTimeout=config.get(GraphDatabaseSettings.transaction_start_timeout);
  upgradeConfiguration=new ConfigMapUpgradeConfiguration(config);
  constraintSemantics=new EnterpriseConstraintSemantics();
  registerRecovery(config.get(GraphDatabaseFacadeFactory.Configuration.editionName),life,dependencies);
  publishEditionInfo(dependencies.resolveDependency(UsageData.class));
  ExpiryScheduler expiryScheduler=new ExpiryScheduler(platformModule.jobScheduler);
  Expiration expiration=new Expiration(SYSTEM_CLOCK);
  CoreToCoreClient.ChannelInitializer channelInitializer=new CoreToCoreClient.ChannelInitializer(logProvider);
  CoreToCoreClient coreToCoreClient=life.add(new CoreToCoreClient(logProvider,expiryScheduler,expiration,channelInitializer));
  channelInitializer.setOwner(coreToCoreClient);
  lockManager=dependencies.satisfyDependency(createLockManager(config,logging));
  LocalDatabase localDatabase=new LocalDatabase(platformModule.storeDir,new CopiedStoreRecovery(config,platformModule.kernelExtensions.listFactories(),platformModule.pageCache),new StoreFiles(new DefaultFileSystemAbstraction()),dependencies.provideDependency(NeoStoreDataSource.class),platformModule.dependencies.provideDependency(TransactionIdStore.class));
  CatchupServer catchupServer=new CatchupServer(logProvider,new StoreIdSupplier(platformModule),platformModule.dependencies.provideDependency(TransactionIdStore.class),platformModule.dependencies.provideDependency(LogicalTransactionStore.class),new DataSourceSupplier(platformModule),new CheckpointerSupplier(platformModule.dependencies),config.get(CoreEdgeClusterSettings.transaction_listen_address));
  life.add(new CoreServerStartupProcess(localDatabase,platformModule.dataSourceManager,replicatedIdGeneratorFactory,raft,raftLog,raftServer,catchupServer,raftTimeoutService,membershipWaiter,config.get(CoreEdgeClusterSettings.join_catch_up_timeout)));
}
