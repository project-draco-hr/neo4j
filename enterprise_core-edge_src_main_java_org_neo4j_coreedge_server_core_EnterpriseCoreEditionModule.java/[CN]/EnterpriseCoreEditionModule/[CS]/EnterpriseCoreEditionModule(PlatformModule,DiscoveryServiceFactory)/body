{
  org.neo4j.kernel.impl.util.Dependencies dependencies=platformModule.dependencies;
  Config config=platformModule.config;
  LogService logging=platformModule.logging;
  FileSystemAbstraction fileSystem=platformModule.fileSystem;
  File storeDir=platformModule.storeDir;
  LifeSupport life=platformModule.life;
  GraphDatabaseFacade graphDatabaseFacade=platformModule.graphDatabaseFacade;
  LogProvider logProvider=logging.getInternalLogProvider();
  CoreDiscoveryService discoveryService=discoveryServiceFactory.coreDiscoveryService(config);
  life.add(dependencies.satisfyDependency(discoveryService));
  final CoreReplicatedContentMarshal marshal=new CoreReplicatedContentMarshal();
  final SenderService senderService=new SenderService(new ExpiryScheduler(platformModule.jobScheduler),new Expiration(SYSTEM_CLOCK),new RaftChannelInitializer(marshal),logProvider);
  life.add(senderService);
  final CoreMember myself=new CoreMember(config.get(CoreEdgeClusterSettings.transaction_advertised_address),config.get(CoreEdgeClusterSettings.raft_advertised_address));
  final MessageLogger<AdvertisedSocketAddress> messageLogger=new BetterMessageLogger<>(myself.getRaftAddress(),raftMessagesLog(storeDir));
  LoggingOutbound<AdvertisedSocketAddress> loggingOutbound=new LoggingOutbound<>(senderService,myself.getRaftAddress(),messageLogger);
  ListenSocketAddress raftListenAddress=config.get(CoreEdgeClusterSettings.raft_listen_address);
  RaftServer<CoreMember> raftServer=new RaftServer<>(marshal,raftListenAddress,logProvider);
  final DelayedRenewableTimeoutService raftTimeoutService=new DelayedRenewableTimeoutService(Clock.SYSTEM_CLOCK,logProvider);
  File raftLogsDirectory=createRaftLogsDirectory(platformModule.storeDir,fileSystem);
  NaiveDurableRaftLog raftLog=new NaiveDurableRaftLog(fileSystem,raftLogsDirectory,new RaftContentSerializer(),platformModule.monitors);
  DurableTermStore termStore=new DurableTermStore(fileSystem,raftLogsDirectory);
  DurableVoteStore voteStore=new DurableVoteStore(fileSystem,raftLogsDirectory);
  life.add(raftLog);
  life.add(termStore);
  life.add(voteStore);
  Supplier<DatabaseHealth> databaseHealthSupplier=dependencies.provideDependency(DatabaseHealth.class);
  RaftMembershipState<CoreMember> raftMembershipState=null;
  try {
    raftMembershipState=new OnDiskRaftMembershipState<>(fileSystem,storeDir,config.get(CoreEdgeClusterSettings.raft_membership_state_size),databaseHealthSupplier,new CoreMarshal());
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
  raft=createRaft(life,loggingOutbound,discoveryService,config,messageLogger,raftLog,termStore,voteStore,myself,logProvider,raftServer,raftTimeoutService,databaseHealthSupplier,raftMembershipState);
  RaftReplicator<CoreMember> replicator=new RaftReplicator<>(raft,myself,new RaftOutbound(loggingOutbound));
  LocalSessionPool localSessionPool=new LocalSessionPool(myself);
  ReplicatedLockStateMachine<CoreMember> replicatedLockStateMachine=new ReplicatedLockStateMachine<>(myself,replicator);
  commitProcessFactory=createCommitProcessFactory(replicator,localSessionPool,replicatedLockStateMachine,dependencies,logging);
  final IdAllocationState idAllocationState;
  try {
    idAllocationState=new OnDiskIdAllocationState(fileSystem,new File(storeDir,"id-alloc-store"),config.get(CoreEdgeClusterSettings.id_alloc_state_size),databaseHealthSupplier);
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
  ReplicatedIdAllocationStateMachine idAllocationStateMachine=new ReplicatedIdAllocationStateMachine(myself,idAllocationState);
  replicator.subscribe(idAllocationStateMachine);
  ReplicatedIdRangeAcquirer idRangeAcquirer=new ReplicatedIdRangeAcquirer(replicator,idAllocationStateMachine,1024,1000,myself,logProvider);
  raftLog.registerListener(replicator);
  long electionTimeout=config.get(CoreEdgeClusterSettings.leader_election_timeout);
  MembershipWaiter<CoreMember> membershipWaiter=new MembershipWaiter<>(myself,platformModule.jobScheduler,electionTimeout * 4,logProvider);
  ReplicatedIdGeneratorFactory replicatedIdGeneratorFactory=createIdGeneratorFactory(fileSystem,idRangeAcquirer,logProvider);
  this.idGeneratorFactory=dependencies.satisfyDependency(replicatedIdGeneratorFactory);
  Long tokenCreationTimeout=config.get(CoreEdgeClusterSettings.token_creation_timeout);
  ReplicatedRelationshipTypeTokenHolder relationshipTypeTokenHolder=new ReplicatedRelationshipTypeTokenHolder(replicator,this.idGeneratorFactory,dependencies,tokenCreationTimeout);
  ReplicatedPropertyKeyTokenHolder propertyKeyTokenHolder=new ReplicatedPropertyKeyTokenHolder(replicator,this.idGeneratorFactory,dependencies,tokenCreationTimeout);
  ReplicatedLabelTokenHolder labelTokenHolder=new ReplicatedLabelTokenHolder(replicator,this.idGeneratorFactory,dependencies,tokenCreationTimeout);
  LifeSupport tokenLife=new LifeSupport();
  this.relationshipTypeTokenHolder=tokenLife.add(relationshipTypeTokenHolder);
  this.propertyKeyTokenHolder=tokenLife.add(propertyKeyTokenHolder);
  this.labelTokenHolder=tokenLife.add(labelTokenHolder);
  dependencies.satisfyDependency(createKernelData(fileSystem,platformModule.pageCache,storeDir,config,graphDatabaseFacade,life));
  headerInformationFactory=createHeaderInformationFactory();
  schemaWriteGuard=createSchemaWriteGuard();
  transactionStartTimeout=config.get(GraphDatabaseSettings.transaction_start_timeout);
  constraintSemantics=new EnterpriseConstraintSemantics();
  registerRecovery(config.get(GraphDatabaseFacadeFactory.Configuration.editionName),life,dependencies);
  publishEditionInfo(dependencies.resolveDependency(UsageData.class));
  ExpiryScheduler expiryScheduler=new ExpiryScheduler(platformModule.jobScheduler);
  Expiration expiration=new Expiration(SYSTEM_CLOCK);
  CoreToCoreClient.ChannelInitializer channelInitializer=new CoreToCoreClient.ChannelInitializer(logProvider);
  CoreToCoreClient coreToCoreClient=life.add(new CoreToCoreClient(logProvider,expiryScheduler,expiration,channelInitializer));
  channelInitializer.setOwner(coreToCoreClient);
  lockManager=dependencies.satisfyDependency(createLockManager(config,logging,replicator,myself,replicatedLockStateMachine));
  CatchupServer catchupServer=new CatchupServer(logProvider,new StoreIdSupplier(platformModule),platformModule.dependencies.provideDependency(TransactionIdStore.class),platformModule.dependencies.provideDependency(LogicalTransactionStore.class),new DataSourceSupplier(platformModule),new CheckpointerSupplier(platformModule.dependencies),config.get(CoreEdgeClusterSettings.transaction_listen_address));
  life.add(CoreServerStartupProcess.createLifeSupport(platformModule.dataSourceManager,replicatedIdGeneratorFactory,raft,new RaftLogReplay(raftLog,logProvider),raftServer,catchupServer,raftTimeoutService,membershipWaiter,config.get(CoreEdgeClusterSettings.join_catch_up_timeout),new RecoverTransactionLogState(dependencies,logProvider,relationshipTypeTokenHolder,propertyKeyTokenHolder,labelTokenHolder),tokenLife));
}
