{
  try {
    long nextId=nextLocalId();
    Pair<Master,Machine> master=broker.getMaster();
    if (nextId == VALUE_REPRESENTING_NULL) {
      Response<IdAllocation> response=master.first().allocateIds(idType);
      IdAllocation allocation=response.response();
      response.close();
      allocationMaster=master.other().getMachineId();
      nextId=storeLocally(allocation);
    }
 else {
      if (master.other().getMachineId() != allocationMaster) {
        throw new ComException("Master changed");
      }
    }
    return nextId;
  }
 catch (  ZooKeeperException e) {
    clusterReceiver.newMaster(e);
    throw e;
  }
catch (  ComException e) {
    clusterReceiver.newMaster(e);
    throw e;
  }
}
