{
  LifeSupport consistencyCheckLife=new LifeSupport();
  try {
    MasterClient masterClient=newMasterClient(masterUri,storeId,consistencyCheckLife);
    consistencyCheckLife.start();
    boolean masterIsOld=MasterClient.CURRENT.compareTo(masterClient.getProtocolVersion()) > 0;
    if (masterIsOld) {
      ClusterMemberVersionCheck checker=new ClusterMemberVersionCheck(clusterMembers,myId,SYSTEM_CLOCK);
      Outcome outcome=checker.doVersionCheck(storeId,VERSION_CHECK_TIMEOUT,SECONDS);
      msgLog.info("Cluster members version  checked: " + outcome);
      if (outcome.hasUnavailable()) {
        throw new UnavailableMembersException(outcome.getUnavailable());
      }
      if (outcome.hasMismatched()) {
        throw new InconsistentlyUpgradedClusterException(storeId,outcome.getMismatched());
      }
    }
    if (cancellationRequest.cancellationRequested()) {
      return false;
    }
    checkDataConsistency(masterClient,txIdStore,storeId,masterUri,masterIsOld);
  }
  finally {
    consistencyCheckLife.shutdown();
  }
  return true;
}
