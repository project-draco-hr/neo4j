{
  FileSystemAbstraction fs=resolver.resolveDependency(FileSystemAbstraction.class);
  LifeSupport life=new LifeSupport();
  try {
    stopServicesAndHandleBranchedStore(BranchedDataPolicy.keep_none);
    final MasterClient copyMaster=newMasterClient(masterUri,null,life);
    life.start();
    console.log("Copying store from master");
    RemoteStoreCopier storeCopier=new RemoteStoreCopier(config,kernelExtensions,console,logging,fs);
    storeCopier.copyStore(new RemoteStoreCopier.StoreCopyRequester(){
      @Override public Response<?> copyStore(      StoreWriter writer){
        return copyMaster.copyStore(new RequestContext(0,config.get(ClusterSettings.server_id).toIntegerIndex(),0,new RequestContext.Tx[0],0,0),writer);
      }
      @Override public void done(){
      }
    }
);
    startServicesAgain();
    console.log("Finished copying store from master");
  }
  finally {
    life.stop();
  }
}
