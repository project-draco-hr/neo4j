{
  String filename=new File(directory.directory(),"mapped.file").getAbsolutePath();
  RandomAccessFile file=resources.add(new RandomAccessFile(filename,"rw"));
  StoreChannel channel=new StoreFileChannel(file.getChannel());
  PersistenceWindowPool pool=new PersistenceWindowPool(new File("test.store"),8,channel,0,false,false,new ConcurrentHashMap<Long,PersistenceRow>(),BrickElementFactory.DEFAULT,PersistenceWindowPool.Monitor.NULL);
  PersistenceRow row=mock(PersistenceRow.class);
  when(row.writeOutAndCloseIfFree(false)).thenThrow(new UnderlyingStorageException("Unable to write record"));
  expectedUnderlyingException.expect(UnderlyingStorageException.class);
  try {
    pool.release(row);
  }
  finally {
    verify(row).unLock();
  }
  pool.close();
  file.close();
}
