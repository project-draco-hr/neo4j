{
  GraphDatabaseService db;
  try {
    db=DatabaseLocator.getGraphDatabase();
    if (db != cachedDb) {
      cachedDb=db;
      if (db instanceof EmbeddedGraphDatabase) {
        cachedServer=ManagementFactory.getPlatformMBeanServer();
      }
 else       if (db instanceof RemoteGraphDatabase) {
        try {
          JMXServiceURL address=new JMXServiceURL(ServerConfiguration.getInstance().get("general.jmx.uri").getValue());
          JMXConnector connector=JMXConnectorFactory.connect(address,null);
          cachedServer=connector.getMBeanServerConnection();
        }
 catch (        MalformedURLException e) {
          throw new RuntimeException(e);
        }
catch (        IOException e) {
          throw new RuntimeException("Unable get JMX access to remote server, monitoring will be disabled.",e);
        }
      }
    }
  }
 catch (  DatabaseBlockedException e1) {
    e1.printStackTrace();
  }
  return cachedServer;
}
