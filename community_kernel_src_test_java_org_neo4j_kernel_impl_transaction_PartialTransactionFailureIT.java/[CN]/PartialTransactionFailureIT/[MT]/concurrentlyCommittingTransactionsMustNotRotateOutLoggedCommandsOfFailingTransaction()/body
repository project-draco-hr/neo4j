{
  final ClassGuardedAdversary adversary=new ClassGuardedAdversary(new CountingAdversary(1,false),"org.neo4j.kernel.impl.nioneo.xa.Command$RelationshipCommand");
  adversary.disable();
  Map<String,String> params=stringMap("logical_log_rotation_threshold","1");
  String storeDir=dir.directory().getAbsolutePath();
  final EmbeddedGraphDatabase db=new TestEmbeddedGraphDatabase(storeDir,params){
    @Override protected FileSystemAbstraction createFileSystemAbstraction(){
      return new AdversarialFileSystemAbstraction(adversary);
    }
  }
;
  Node a, b, c, d;
  Transaction tx=db.beginTx();
  try {
    a=db.createNode();
    b=db.createNode();
    c=db.createNode();
    d=db.createNode();
    tx.success();
  }
  finally {
    tx.finish();
  }
  adversary.enable();
  CountDownLatch latch=new CountDownLatch(1);
  Thread t1=new Thread(createRelationship(db,a,b,latch));
  Thread t2=new Thread(createRelationship(db,c,d,latch));
  t1.start();
  t2.start();
  t1.join(10);
  t2.join(10);
  latch.countDown();
  t1.join(25000);
  t2.join(25000);
  db.shutdown();
  EmbeddedGraphDatabase db2=new TestEmbeddedGraphDatabase(storeDir,stringMap());
  tx=db2.beginTx();
  try {
    Node x=db2.getNodeById(a.getId());
    Node y=db2.getNodeById(b.getId());
    Node z=db2.getNodeById(c.getId());
    Node w=db2.getNodeById(d.getId());
    Iterator<Relationship> itrRelX=x.getRelationships().iterator();
    Iterator<Relationship> itrRelY=y.getRelationships().iterator();
    Iterator<Relationship> itrRelZ=z.getRelationships().iterator();
    Iterator<Relationship> itrRelW=w.getRelationships().iterator();
    if (itrRelX.hasNext() != itrRelY.hasNext()) {
      fail("Node x and y have inconsistent relationship counts");
    }
 else     if (itrRelX.hasNext()) {
      Relationship rel=itrRelX.next();
      assertEquals(rel,itrRelY.next());
      assertFalse(itrRelX.hasNext());
      assertFalse(itrRelY.hasNext());
    }
    if (itrRelZ.hasNext() != itrRelW.hasNext()) {
      fail("Node z and w have inconsistent relationship counts");
    }
 else     if (itrRelZ.hasNext()) {
      Relationship rel=itrRelZ.next();
      assertEquals(rel,itrRelW.next());
      assertFalse(itrRelZ.hasNext());
      assertFalse(itrRelW.hasNext());
    }
  }
  finally {
    try {
      tx.finish();
    }
  finally {
      db2.shutdown();
    }
  }
}
